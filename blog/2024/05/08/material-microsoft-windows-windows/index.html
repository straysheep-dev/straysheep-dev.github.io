
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://straysheep-dev.github.io/blog/2024/05/08/material-microsoft-windows-windows/">
      
      
        <link rel="prev" href="../../07/simple-flatpak-flatpak/">
      
      
        <link rel="next" href="../../../../archive/2025/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Windows - straysheep.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="Windows - straysheep.dev" />
<meta property="og:image" content="https://straysheep-dev.github.io/assets/images/social/blog/2024/05/08/material-microsoft-windows-windows.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://straysheep-dev.github.io/blog/2024/05/08/material-microsoft-windows-windows/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Windows - straysheep.dev" />
<meta property="twitter:image" content="https://straysheep-dev.github.io/assets/images/social/blog/2024/05/08/material-microsoft-windows-windows.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#windows" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="straysheep.dev" class="md-header__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            straysheep.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Windows
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  Main

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../license/" class="md-tabs__link">
        
  
  
    
  
  License

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="straysheep.dev" class="md-nav__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    straysheep.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2019/07/15/-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚≠ê Resources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../15/octicons-alert-16-aide-advanced-intrusion-detection-environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AIDE (Advanced Intrusion Detection Environment)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2023/08/20/simple-ansible-ansible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/07/25/simple-ansible-ansible-molecule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible Molecule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/12/octicons-beaker-16-atomic-red-team-x-unix-artifacts-collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Atomic Red Team x Unix Artifacts Collector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-dns-bind9-dns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BIND9 DNS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02/simple-bitwarden-bitwarden/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    bitwarden
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../15/material-file-tree-triage-auditd-logs-with-check-auditd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triage auditd logs with check-auditd
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/01/20/fontawesome-solid-gears-cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CI/CD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/04/material-clipboard-flow-clipboard-snooping-x11-and-wayland/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clipboard Snooping (X11 and Wayland)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/15/fontawesome-solid-square-binary-compile-static-binaries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Static Binaries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../29/octicons-terminal-16-custom-shell-profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Shell Profiles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-flatpak-flatpak/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    flatpak
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/08/simple-qemu-kvm-kernel-based-virtual-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    KVM (Kernel-based Virtual Machine)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/28/material-code-tags-check-linting-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linting Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2022/08/29/material-magnify-scan-nessus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nessus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/04/18/material-console-network-network-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/01/material-wifi-alert-nzyme-x-simple-raspberrypi-raspberry-pi--simple-proxmox-proxmox--simple-tailscale-tailscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    nzyme x [ Raspberry Pi + Proxmox + Tailscale]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../29/material-file-document-arrow-right-openscap-practical-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenSCAP Practical Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-openwrt-openwrt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenWrt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02/simple-pfsense-pfsense-administration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pfSense administration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-powershell-get-started-with-powerstig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Started with PowerSTIG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../08/13/simple-proxmox-proxmox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Proxmox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/02/22/material-sync-circle-rsync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    rsync
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-snapcraft-snap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    snap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../08/13/material-server-security-wazuh-all-your-things-with-tailscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wazuh all your things with Tailscale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/10/16/material-wifi-cog-wifichallenge-exam--course-review/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    WiFiChallenge Exam &amp; Course Review
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Windows
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Windows
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#licenses" class="md-nav__link">
    <span class="md-ellipsis">
      
        Licenses
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-baselining" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Baselining
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Baselining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-the-registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup the Registry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lgpoexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        LGPO.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerstig" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerSTIG
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Active Directory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Active Directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ad-installing-the-ad-rsat-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: Installing the AD RSAT Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ad-rsat-tool-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: RSAT Tool Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ad-group-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: Group Policy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-windows-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Windows Security
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Managing Windows Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-device-lock" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Device Lock
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender-cmdlets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Defender Cmdlets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlled-folder-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controlled Folder Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-controlled-folders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable Controlled Folders
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-controlled-folder-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Customize Controlled Folder Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-attack-surface-reduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASR (Attack Surface Reduction)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-sandbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Sandbox">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windows-sandbox-vpn" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox + VPN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-sandbox-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wsl" class="md-nav__link">
    <span class="md-ellipsis">
      
        WSL
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WSL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communicating-with-hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      
        Communicating with Hyper-V
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-inbound-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Inbound Connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb-passthrough" class="md-nav__link">
    <span class="md-ellipsis">
      
        USB Passthrough
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USB Passthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traverse-external-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Traverse External Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usbipd" class="md-nav__link">
    <span class="md-ellipsis">
      
        USBIPD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        UDEV Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-via-local-ssh-tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect via Local SSH Tunnel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-directly" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect Directly
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpg-ssh-git-yubikey" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPG + SSH + Git + Yubikey
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-passthrough" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU Passthrough
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#miscellaneous" class="md-nav__link">
    <span class="md-ellipsis">
      
        Miscellaneous
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hyper-V">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-paths" class="md-nav__link">
    <span class="md-ellipsis">
      
        Default Paths
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#importing-exporting-vms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Importing / Exporting VM's
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-vms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloning VM's
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-ubuntu-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an Ubuntu VM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating an Ubuntu VM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Manual Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expand-the-disk-space" class="md-nav__link">
    <span class="md-ellipsis">
      
        Expand the Disk Space
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enhanced-session-login-stuck-on-blue-screen" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enhanced Session Login Stuck on Blue Screen
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-windows-developer-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a Windows Developer VM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nested-virtualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Virtualization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#share-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Share Resources
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Share Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clipboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clipboard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#share-folders-local-drives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Share Folders, Local Drives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-malware-analysis-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a Malware Analysis VM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hyper-V Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyper-v-default-switch-has-no-dhcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Default Switch has no DHCP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-network-performance-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Network Performance Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-default-network-doesnt-have-internet-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Default Network doesn't have internet access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#powershell-versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Versions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Script Execution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Language Mode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-jea" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell JEA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-protected-event-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Protected Event Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winget" class="md-nav__link">
    <span class="md-ellipsis">
      
        Winget
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Winget">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Git
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-open-ssh-beta" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Open SSH Beta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-windows-terminal" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Windows Terminal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-usbipd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install USBIPD
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Accounts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User Accounts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#active-directory_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Active Directory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local System
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Account Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#honey-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Honey Accounts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC Prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uac-prompt-for-local-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt for local users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uac-prompt-for-local-admins" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt for local admins
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Firewall Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-firewall-rules-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Firewall Rules (PowerShell)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-firewall-rules-cmdexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Firewall Rules (cmd.exe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#netsh-port-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Netsh Port Proxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockinboundalways-allowinboundrules-false" class="md-nav__link">
    <span class="md-ellipsis">
      
        blockinboundalways / -AllowInboundRules False
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llmnr" class="md-nav__link">
    <span class="md-ellipsis">
      
        LLMNR
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mitigate-ipv6-mitm-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mitigate IPv6 MitM Attacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-smb-signing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable SMB Signing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filesystem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filesystem
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filesystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#takeownexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        takeown.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icaclsexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        icacls.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-access-control-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET Access Control Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-access-audit-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET Access Audit Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb" class="md-nav__link">
    <span class="md-ellipsis">
      
        SMB
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysinternals" class="md-nav__link">
    <span class="md-ellipsis">
      
        SysInternals
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SysInternals">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accesschk" class="md-nav__link">
    <span class="md-ellipsis">
      
        AccessChk
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sysmon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Sysmon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cleanup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tune-a-config-with-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tune a Config (with PowerShell)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Logging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-size" class="md-nav__link">
    <span class="md-ellipsis">
      
        Log Size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Defender Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASR Events
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logon-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logon Events
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-block-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Script Block Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transcription-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transcription Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sysmon Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysmon-event-ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon Event IDs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-22-dns-queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 22: DNS Queries
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-3-network-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 3: Network Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-1-process-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 1: Process Creation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-10-process-accessed" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 10: Process Accessed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenSSH
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduled-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scheduled Tasks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scheduled Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-audit-task-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Log &amp; Audit Task Creation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wmi" class="md-nav__link">
    <span class="md-ellipsis">
      
        WMI
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disk-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disk Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disk Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-and-unmount-volumes-and-drives-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mount and Unmount Volumes and Drives (GUI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mount-and-unmount-volumes-and-drives-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mount and Unmount Volumes and Drives (CLI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extend-the-c-drive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extend the C Drive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-automatic-mounting-of-new-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prevent Automatic Mounting of New Volumes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#efi-partition" class="md-nav__link">
    <span class="md-ellipsis">
      
        EFI Partition
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-id-strings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device ID Strings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enum-device-id-strings-cmdexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enum Device ID Strings (cmd.exe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enum-device-id-strings-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enum Device ID Strings (PowerShell)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deny-execute-access-disable-autorun" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deny Execute Access, Disable Autorun
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-or-disable-pnp-devices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable or Disable PnP Devices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blocking-iso-mounting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking ISO Mounting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Blocking ISO Mounting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-an-iso-for-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an ISO for Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_30" >
        
          
          <label class="md-nav__link" for="__nav_3_30" id="__nav_3_30_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_30_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_30">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-05-08 00:00:00+00:00" class="md-ellipsis">May 8, 2024</time>
                      </div>
                    </li>
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 13h1.5v2.82l2.44 1.41-.75 1.3L15 16.69zm4-5H5v11h4.67c-.43-.91-.67-1.93-.67-3a7 7 0 0 1 7-7c1.07 0 2.09.24 3 .67zM5 21a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v6.1c1.24 1.26 2 2.99 2 4.9a7 7 0 0 1-7 7c-1.91 0-3.64-.76-4.9-2zm11-9.85A4.85 4.85 0 0 0 11.15 16c0 2.68 2.17 4.85 4.85 4.85A4.85 4.85 0 0 0 20.85 16c0-2.68-2.17-4.85-4.85-4.85"/></svg>
                          <time datetime="2025-06-15 00:00:00+00:00" class="md-ellipsis">June 15, 2025</time>
                        </div>
                      </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              87 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#licenses" class="md-nav__link">
    <span class="md-ellipsis">
      
        Licenses
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-baselining" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Baselining
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Baselining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-the-registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup the Registry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lgpoexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        LGPO.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerstig" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerSTIG
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Active Directory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Active Directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ad-installing-the-ad-rsat-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: Installing the AD RSAT Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ad-rsat-tool-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: RSAT Tool Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ad-group-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        AD: Group Policy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-windows-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Windows Security
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Managing Windows Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-device-lock" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Device Lock
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender-cmdlets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Defender Cmdlets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlled-folder-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controlled Folder Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-controlled-folders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable Controlled Folders
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-controlled-folder-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Customize Controlled Folder Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-attack-surface-reduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASR (Attack Surface Reduction)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-sandbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Sandbox">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windows-sandbox-vpn" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox + VPN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-sandbox-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Sandbox Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wsl" class="md-nav__link">
    <span class="md-ellipsis">
      
        WSL
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WSL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communicating-with-hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      
        Communicating with Hyper-V
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-inbound-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Inbound Connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb-passthrough" class="md-nav__link">
    <span class="md-ellipsis">
      
        USB Passthrough
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USB Passthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traverse-external-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Traverse External Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usbipd" class="md-nav__link">
    <span class="md-ellipsis">
      
        USBIPD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        UDEV Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-via-local-ssh-tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect via Local SSH Tunnel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-directly" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect Directly
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpg-ssh-git-yubikey" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPG + SSH + Git + Yubikey
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-passthrough" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU Passthrough
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#miscellaneous" class="md-nav__link">
    <span class="md-ellipsis">
      
        Miscellaneous
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hyper-V">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-paths" class="md-nav__link">
    <span class="md-ellipsis">
      
        Default Paths
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#importing-exporting-vms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Importing / Exporting VM's
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-vms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloning VM's
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-ubuntu-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an Ubuntu VM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating an Ubuntu VM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Manual Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expand-the-disk-space" class="md-nav__link">
    <span class="md-ellipsis">
      
        Expand the Disk Space
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enhanced-session-login-stuck-on-blue-screen" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enhanced Session Login Stuck on Blue Screen
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-windows-developer-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a Windows Developer VM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nested-virtualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Virtualization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#share-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Share Resources
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Share Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clipboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clipboard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#share-folders-local-drives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Share Folders, Local Drives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-malware-analysis-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a Malware Analysis VM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hyper-V Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyper-v-default-switch-has-no-dhcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Default Switch has no DHCP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-network-performance-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Network Performance Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-v-default-network-doesnt-have-internet-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hyper-V Default Network doesn't have internet access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#powershell-versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Versions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Script Execution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Language Mode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-jea" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell JEA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-protected-event-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Protected Event Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winget" class="md-nav__link">
    <span class="md-ellipsis">
      
        Winget
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Winget">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Git
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-open-ssh-beta" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Open SSH Beta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-windows-terminal" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Windows Terminal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-usbipd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install USBIPD
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Accounts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User Accounts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#active-directory_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Active Directory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local System
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Account Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#honey-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Honey Accounts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC Prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uac-prompt-for-local-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt for local users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uac-prompt-for-local-admins" class="md-nav__link">
    <span class="md-ellipsis">
      
        UAC Prompt for local admins
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Firewall Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-firewall-rules-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Firewall Rules (PowerShell)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-firewall-rules-cmdexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Managing Firewall Rules (cmd.exe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#netsh-port-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Netsh Port Proxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockinboundalways-allowinboundrules-false" class="md-nav__link">
    <span class="md-ellipsis">
      
        blockinboundalways / -AllowInboundRules False
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llmnr" class="md-nav__link">
    <span class="md-ellipsis">
      
        LLMNR
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mitigate-ipv6-mitm-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mitigate IPv6 MitM Attacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-smb-signing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable SMB Signing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filesystem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filesystem
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filesystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#takeownexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        takeown.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icaclsexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        icacls.exe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-access-control-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET Access Control Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-access-audit-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET Access Audit Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb" class="md-nav__link">
    <span class="md-ellipsis">
      
        SMB
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysinternals" class="md-nav__link">
    <span class="md-ellipsis">
      
        SysInternals
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SysInternals">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accesschk" class="md-nav__link">
    <span class="md-ellipsis">
      
        AccessChk
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sysmon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Sysmon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cleanup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tune-a-config-with-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tune a Config (with PowerShell)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Logging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-size" class="md-nav__link">
    <span class="md-ellipsis">
      
        Log Size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Windows Defender Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASR Events
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logon-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logon Events
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        PowerShell Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-block-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Script Block Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transcription-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transcription Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sysmon Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysmon-event-ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysmon Event IDs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-22-dns-queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 22: DNS Queries
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-3-network-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 3: Network Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-1-process-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 1: Process Creation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id-10-process-accessed" class="md-nav__link">
    <span class="md-ellipsis">
      
        ID 10: Process Accessed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenSSH
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduled-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scheduled Tasks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scheduled Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-audit-task-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Log &amp; Audit Task Creation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wmi" class="md-nav__link">
    <span class="md-ellipsis">
      
        WMI
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disk-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disk Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disk Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-and-unmount-volumes-and-drives-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mount and Unmount Volumes and Drives (GUI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mount-and-unmount-volumes-and-drives-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mount and Unmount Volumes and Drives (CLI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extend-the-c-drive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extend the C Drive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-automatic-mounting-of-new-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prevent Automatic Mounting of New Volumes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#efi-partition" class="md-nav__link">
    <span class="md-ellipsis">
      
        EFI Partition
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-id-strings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device ID Strings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enum-device-id-strings-cmdexe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enum Device ID Strings (cmd.exe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enum-device-id-strings-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enum Device ID Strings (PowerShell)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deny-execute-access-disable-autorun" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deny Execute Access, Disable Autorun
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-or-disable-pnp-devices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable or Disable PnP Devices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blocking-iso-mounting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking ISO Mounting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Blocking ISO Mounting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-an-iso-for-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an ISO for Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="windows"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12V6.75l6-1.32v6.48zm17-9v8.75l-10 .15V5.21zM3 13l6 .09v6.81l-6-1.15zm17 .25V22l-10-1.91V13.1z"/></svg></span> Windows</h1>
<p>Various configuration settings and notes for Microsoft Windows operating systems.</p>
<!-- more -->

<p><em>This file is originally from <a href="https://github.com/straysheep-dev/windows-configs">straysheep-dev/windows-configs</a>.</em></p>
<h2 id="licenses">Licenses</h2>
<p>Unless a different license is included with a file as <code>&lt;filename&gt;.copyright-notice</code> all files are released under the MIT license.</p>
<p>Examples in this README taken and adapted from the Microsoft documents:</p>
<ul>
<li>Microsoft Docs Examples:<ul>
<li><a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a></li>
<li><a href="https://github.com/MicrosoftDocs/defender-docs/blob/public/LICENSE">MIT</a></li>
</ul>
</li>
<li>Win32-OpenSSH Wiki Examples:<ul>
<li><a href="https://github.com/PowerShell/Win32-OpenSSH/wiki">https://github.com/PowerShell/Win32-OpenSSH/wiki</a></li>
</ul>
</li>
<li>Stack Overflow Licensing:<ul>
<li><a href="https://stackoverflow.com/legal/terms-of-service#licensing">https://stackoverflow.com/legal/terms-of-service#licensing</a></li>
<li><a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA-4.0</a></li>
</ul>
</li>
</ul>
<h2 id="windows-baselining">Windows Baselining</h2>
<p>Creating a security baseline for Windows.</p>
<h3 id="backup-the-registry">Backup the Registry</h3>
<p>Before making changes, it's useful to create a backup of the registry in a default or working state.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/enable-computerrestore?view=powershell-5.1">Enable-ComputerRestore</a></li>
<li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/checkpoint-computer?view=powershell-5.1">CheckPoint-Computer</a></li>
<li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/restore-computer?view=powershell-5.1">Restore-Computer</a></li>
</ul>
<p>To create a system restore point:
<div class="highlight"><pre><span></span><code><span class="nb">Enable-ComputerRestore</span> <span class="n">-Drive</span> <span class="s2">&quot;C:\&quot;</span>
<span class="nb">Checkpoint-Computer</span> <span class="n">-Description</span> <span class="s2">&quot;First restore point&quot;</span>
</code></pre></div></p>
<p>There are multiple restore point types:</p>
<ul>
<li><code>APPLICATION_INSTALL</code></li>
<li><code>APPLICATION_UNINSTALL</code></li>
<li><code>DEVICE_DRIVER_INSTALL</code></li>
<li><code>MODIFY_SETTINGS</code></li>
<li><code>CANCELLED_OPERATION</code></li>
</ul>
<p>For registry changes specifically, <code>APPLICATION_INSTALL</code> is the type to use. It's also the default type, so it's not necessary to specify it on the commandline.</p>
<p>List all system restore points:
<div class="highlight"><pre><span></span><code><span class="nb">Get-ComputerRestorePoint</span>
</code></pre></div></p>
<p>After making changes, revert to a specific restore point:
<div class="highlight"><pre><span></span><code><span class="nb">Restore-Computer</span> <span class="n">-RestorePoint</span> <span class="n">1</span>
</code></pre></div></p>
<p>The restore process can take several minutes, even when reverting a single change to the registry. Generally it takes about 3-4 minutes for local test VM's.</p>
<h3 id="lgpoexe">LGPO.exe</h3>
<p>See the tools available in the <a href="https://www.microsoft.com/en-us/download/details.aspx?id=55319">Microsoft Security Compliance Toolkit</a></p>
<p>Choose what tools and policies to download that you'd like to apply to your environment.</p>
<p>The idea with the <code>.PolicyRules</code> files is they are configurations that are pre-made by Microsoft and ready to be installed using <code>LGPO.exe</code></p>
<p>You can do all of this manually with PowerShell, and you will ultimately want to familiarize yourself with the descriptions of each setting should you run into any issues, but this will save a ton of time in getting things up and running.</p>
<p>Use <code>PolicyAnalyzer.exe</code> to view the <code>*.PolicyRules</code> files, compare them to other <code>*.PolicyRules</code> files or even your current system settings.</p>
<p>Use <code>LGPO.exe</code> to apply the configurations found in the <code>*.PolicyRules</code> files to your system.</p>
<p>For example the you might apply the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-configuration-framework/windows-security-baselines">Security Baselines</a> for both Windows 11 Pro and the latest available version of Microsoft Edge.</p>
<p>Deploy and test these configurations in a temporary or virtual environment first, either a VM (local or cloud) or enabled the <a href="https://techcommunity.microsoft.com/t5/windows-kernel-internals-blog/windows-sandbox/ba-p/301849">Windows Sandbox</a> feature.</p>
<p>Windows Sandbox is a temporary, and (depending on your <code>.wsb</code> configuration) fully isolated environment that can be started very quickly from either launching the application as you would any other, or by running a <code>.wsb</code> <a href="https://github.com/MicrosoftDocs/windows-itpro-docs/blob/public/windows/security/threat-protection/windows-sandbox/windows-sandbox-configure-using-wsb-file.md">configuration file</a>.</p>
<h3 id="powerstig">PowerSTIG</h3>
<p><em>This is covered in <a href="../../../07/19/material-powershell-get-started-with-powerstig/">Getting Started with PowerSTIG</a>.</em></p>
<h2 id="active-directory">Active Directory</h2>
<h3 id="ad-installing-the-ad-rsat-tools">AD: Installing the AD RSAT Tools</h3>
<p>You no longer need to download the AD RSAT packages from Microsoft's website, instead these are included as Windows Features on Demand. The AD RSAT tools come available by default in most Windows Server installations. However you can add the capability manually to a workstation by following the references below.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/remote/remote-server-administration-tools#install-uninstall-and-turn-offon-rsat-tools">Installing RSAT Tools</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/features-on-demand-v2--capabilities?view=windows-11#using-dism-add-capability-to-add-or-remove-fods">Using DISM</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/dism-capabilities-package-servicing-command-line-options?view=windows-11">DISM CLI Options</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/features-on-demand-non-language-fod?view=windows-11#remote-server-administration-tools-rsat">List of RSAT Modules</a></li>
</ul>
<p>You do not need to enable and install every feature to start working with AD. Some essentials, considering this is likely being added to a workstation or server (separate from the DC):</p>
<ul>
<li>Active Directory Domain Services and Lightweight Directory Services Tools</li>
<li>Active Directory Certificate Services Tools</li>
<li>Group Policy Management Tools</li>
</ul>
<p>To install via the GUI, search for "RSAT" then select the features you want to install:
- Settings &gt; Apps &gt; Optional Features &gt; View Features &gt; Search "RSAT"</p>
<p>To install via <code>Get-WindowsFeature</code> (newer):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WindowsFeature</span> <span class="n">-Name</span> <span class="n">RSAT</span><span class="p">*</span>
<span class="nb">Install-WindowsFeature</span> <span class="n">-Name</span> <span class="n">RSAT</span> <span class="n">-IncludeManagementTools</span>
<span class="nb">Install-WindowsFeature</span> <span class="n">-Name</span> <span class="s2">&quot;RSAT&quot;</span><span class="p">,</span><span class="s2">&quot;AD-Domain-Services&quot;</span> <span class="n">-IncludeManagementTools</span>
</code></pre></div>
<p>To install via <code>DISM</code> (older):</p>
<div class="highlight"><pre><span></span><code>DISM /online /get-capabilities
DISM /online /add-capability /capabilityname:&lt;capability-name&gt;
DISM /online /add-capability /capabilityname:Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0
</code></pre></div>
<h3 id="ad-rsat-tool-usage">AD: RSAT Tool Usage</h3>
<p>The cmdlet syntax is similar to other PowerShell cmdlets. PowerView has great examples of how you can enumerate AD objects, and uses mostly the same syntax as the AD RSAT modules. PowerView is the tool to enumerate AD if you do not have the AD RSAT modules installed on an end point and lack permissions to install them. Note that it will need allowed by AV / EDR.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">AD RSAT Modules</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a></li>
</ul>
<h3 id="ad-group-policy">AD: Group Policy</h3>
<p>Update Group Policy to sync with the Domain Controller via <code>cmd.exe</code>:</p>
<div class="highlight"><pre><span></span><code>gpupdate.exe
</code></pre></div>
<p>Push updates to Group Policy to sync with the Domain Controller via PowerShell:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/grouppolicy/invoke-gpupdate?view=windowsserver2022-ps">Invoke-GPUpdate</a></li>
<li><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134201(v=ws.11)">Force a Remote Group Policy Refresh (GPUpdate)</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-GPUpdate</span> <span class="n">-Computer</span> <span class="s2">&quot;DOMAIN\COMPUTER-01&quot;</span> <span class="n">-Target</span> <span class="s2">&quot;User&quot;</span> <span class="n">-RandomDelayInMinutes</span> <span class="n">0</span> <span class="n">-Force</span>
</code></pre></div>
<p><em>NOTE: some GPO's do not appear configured in the gpedit.msc snap in on endpoints, but will appear if you check their registry.</em></p>
<p>One example of this is Disabling Link-Local Multicast Name Resolution (LLMNR) protocol.</p>
<p>Setting Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client &gt; Turn off multicast name resolution to Enabled on the Domain Controller and pushing the update with <code>Invoke-GPUpdate</code> or similar will not display this policy as Enabled on the endpoints, however it will show as set in their registry. This can be tested by changing the policy on the DC and refreshing each endpoint before checking again with <code>Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient"</code>.</p>
<h2 id="managing-windows-security">Managing Windows Security</h2>
<h3 id="configuring-device-lock">Configuring Device Lock</h3>
<ul>
<li><a href="https://superuser.com/questions/1737726/windows-10-ask-password-when-return-from-sleep">Lock Windows When Screen Turns Off</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/client-management/mdm/policy-csp-admx-power#pw_promptpasswordonresume">PromptPasswordOnResume</a></li>
</ul>
<p>Require authentication after resuming from sleep (this should be on by default):</p>
<ul>
<li>Local Computer Policy &gt; User Configuration &gt; Administrative Templates &gt; System &gt; Power Management &gt; "Prompt for password on resume from hibernate/suspend"</li>
<li>You only need to run this as admin to apply this setting system-wide</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">If</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="s2">&quot;HKCU:\SOFTWARE\Policies\Microsoft\Windows\System\Power&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&quot;HKCU:\SOFTWARE\Policies\Microsoft\Windows\System\Power&quot;</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="p">}</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKCU:\SOFTWARE\Policies\Microsoft\Windows\System\Power&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;PromptPasswordOnResume&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;1&quot;</span>
</code></pre></div>
<p>Require authentication (immediately) after screen turns off:</p>
<ul>
<li>This has no GPO equivalent</li>
<li>This also appears to have no GUI configuration option either</li>
<li>This setting must be configured separately for each user, including the admin account</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKCU:\Control Panel\Desktop&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DelayLockInterval&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0&quot;</span>
</code></pre></div>
<h3 id="windows-defender-cmdlets">Windows Defender Cmdlets</h3>
<p><a href="https://docs.microsoft.com/en-us/powershell/module/defender/?view=windowsserver2022-ps">https://docs.microsoft.com/en-us/powershell/module/defender/?view=windowsserver2022-ps</a></p>
<table>
<thead>
<tr>
<th>Cmdlet</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Add-MpPreference</code></td>
<td>Modifies settings for Windows Defender.</td>
</tr>
<tr>
<td><code>Get-MpComputerStatus</code></td>
<td>Gets the status of antimalware software on the computer.</td>
</tr>
<tr>
<td><code>Get-MpPreference</code></td>
<td>Gets preferences for the Windows Defender scans and updates.</td>
</tr>
<tr>
<td><code>Get-MpThreat</code></td>
<td>Gets the history of threats detected on the computer.</td>
</tr>
<tr>
<td><code>Get-MpThreatCatalog</code></td>
<td>Gets known threats from the definitions catalog.</td>
</tr>
<tr>
<td><code>Get-MpThreatDetection</code></td>
<td>Gets active and past malware threats that Windows Defender detected.</td>
</tr>
<tr>
<td><code>Remove-MpPreference</code></td>
<td>Removes exclusions or default actions.</td>
</tr>
<tr>
<td><code>Remove-MpThreat</code></td>
<td>Removes active threats from a computer.</td>
</tr>
<tr>
<td><code>Set-MpPreference</code></td>
<td>Configures preferences for Windows Defender scans and updates.</td>
</tr>
<tr>
<td><code>Start-MpScan</code></td>
<td>Starts a scan on a computer.</td>
</tr>
<tr>
<td><code>Start-MpWDOScan</code></td>
<td>Starts a Windows Defender offline scan.</td>
</tr>
<tr>
<td><code>Update-MpSignature</code></td>
<td>Updates the antimalware definitions on a computer.</td>
</tr>
</tbody>
</table>
<h3 id="controlled-folder-access">Controlled Folder Access</h3>
<blockquote>
<p>Protect your data from malicious apps such as ransomware</p>
</blockquote>
<p>Write access must be granted to applications before modifications can be made to files within folders you define as protected. This is often the home directories under <code>C:\Users</code>, but can also be filesystems on external drives.</p>
<h3 id="enable-controlled-folders">Enable Controlled Folders</h3>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-controlled-folders?view=o365-worldwide">https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-controlled-folders?view=o365-worldwide</a></p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-MpPreference</span> <span class="n">-EnableControlledFolderAccess</span> <span class="n">Enabled</span>
<span class="nb">Set-MpPreference</span> <span class="n">-EnableControlledFolderAccess</span> <span class="n">AuditMode</span> <span class="c"># Enable the audit feature only</span>
<span class="nb">Set-MpPreference</span> <span class="n">-EnableControlledFolderAccess</span> <span class="n">Disabled</span>  <span class="c"># Turn off Controlled Folder Access</span>
</code></pre></div>
<h3 id="customize-controlled-folder-access">Customize Controlled Folder Access</h3>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-controlled-folders?view=o365-worldwide">https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-controlled-folders?view=o365-worldwide</a></p>
<blockquote>
<p><strong>IMPORTANT</strong>: Use <code>Add-MpPreference</code> to append or add apps to the list and not <code>Set-MpPreference</code>. Using the <code>Set-MpPreference</code> cmdlet will overwrite the existing list.</p>
</blockquote>
<p>Add/remove protection for a folder:
<div class="highlight"><pre><span></span><code><span class="nb">Add-MpPreference</span> <span class="n">-ControlledFolderAccessProtectedFolders</span> <span class="s2">&quot;c:\path\to\folder&quot;</span>
<span class="nb">Remove-MpPreference</span> <span class="n">-ControlledFolderAccessProtectedFolders</span> <span class="s2">&quot;c:\path\to\folder&quot;</span>
</code></pre></div></p>
<p>Add/remove an application's access to protected folders:
<div class="highlight"><pre><span></span><code><span class="nb">Add-MpPreference</span> <span class="n">-ControlledFolderAccessAllowedApplications</span> <span class="s2">&quot;c:\apps\test.exe&quot;</span>
<span class="nb">Remove-MpPreference</span> <span class="n">-ControlledFolderAccessAllowedApplications</span> <span class="s2">&quot;c:\apps\test.exe&quot;</span>
</code></pre></div></p>
<h3 id="asr-attack-surface-reduction">ASR (Attack Surface Reduction)</h3>
<ul>
<li><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-deployment?view=o365-worldwide">ASR Overview</a></li>
<li><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide">Rule List Reference</a></li>
<li><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#asr-rule-to-guid-matrix">Rule GUIDs</a></li>
<li><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-attack-surface-reduction?view=o365-worldwide#powershell">Manage ASR Rules with PowerShell</a></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">Rule Name</th>
<th style="text-align: left;">Rule GUID</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Block abuse of exploited vulnerable signed drivers</td>
<td style="text-align: left;">56a863a9-875e-4185-98a7-b882c64b5ce5</td>
</tr>
<tr>
<td style="text-align: left;">Block Adobe Reader from creating child processes</td>
<td style="text-align: left;">7674ba52-37eb-4a4f-a9a1-f0f9a1619a2c</td>
</tr>
<tr>
<td style="text-align: left;">Block all Office applications from creating child processes</td>
<td style="text-align: left;">d4f940ab-401b-4efc-aadc-ad5f3c50688a</td>
</tr>
<tr>
<td style="text-align: left;">Block credential stealing from the Windows local security authority subsystem (lsass.exe)</td>
<td style="text-align: left;">9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2</td>
</tr>
<tr>
<td style="text-align: left;">Block executable content from email client and webmail</td>
<td style="text-align: left;">be9ba2d9-53ea-4cdc-84e5-9b1eeee46550</td>
</tr>
<tr>
<td style="text-align: left;">Block executable files from running unless they meet a prevalence, age, or trusted list criterion</td>
<td style="text-align: left;">01443614-cd74-433a-b99e-2ecdc07bfc25</td>
</tr>
<tr>
<td style="text-align: left;">Block execution of potentially obfuscated scripts</td>
<td style="text-align: left;">5beb7efe-fd9a-4556-801d-275e5ffc04cc</td>
</tr>
<tr>
<td style="text-align: left;">Block JavaScript or VBScript from launching downloaded executable content</td>
<td style="text-align: left;">d3e037e1-3eb8-44c8-a917-57927947596d</td>
</tr>
<tr>
<td style="text-align: left;">Block Office applications from creating executable content</td>
<td style="text-align: left;">3b576869-a4ec-4529-8536-b80a7769e899</td>
</tr>
<tr>
<td style="text-align: left;">Block Office applications from injecting code into other processes</td>
<td style="text-align: left;">75668c1f-73b5-4cf0-bb93-3ecf5cb7cc84</td>
</tr>
<tr>
<td style="text-align: left;">Block Office communication application from creating child processes</td>
<td style="text-align: left;">26190899-1602-49e8-8b27-eb1d0a1ce869</td>
</tr>
<tr>
<td style="text-align: left;">Block persistence through WMI event subscription (File and folder exclusions not supported).</td>
<td style="text-align: left;">e6db77e5-3df2-4cf1-b95a-636979351e5b</td>
</tr>
<tr>
<td style="text-align: left;">Block process creations originating from PSExec and WMI commands</td>
<td style="text-align: left;">d1e49aac-8f56-4280-b9ba-993a6d77406c</td>
</tr>
<tr>
<td style="text-align: left;">Block untrusted and unsigned processes that run from USB</td>
<td style="text-align: left;">b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4</td>
</tr>
<tr>
<td style="text-align: left;">Block Win32 API calls from Office macros</td>
<td style="text-align: left;">92e97fa1-2edf-4476-bdd6-9dd0b4dddc7b</td>
</tr>
<tr>
<td style="text-align: left;">Use advanced protection against ransomware</td>
<td style="text-align: left;">c1db55ab-c21a-4637-bb3f-a12568109d35</td>
</tr>
</tbody>
</table>
</blockquote>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#asr-rule-modes">ASR rules can be set in multiple modes</a>:</p>
<ul>
<li><code>0</code> = Not configured / Disabled</li>
<li><code>1</code> = Block</li>
<li><code>2</code> = Audit</li>
<li><code>6</code> = Warn</li>
</ul>
<p>Set a rule by it's GUID with PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="p">&lt;</span><span class="n">guid</span><span class="p">&gt;</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="p">&lt;</span><span class="n">mode</span><span class="p">&gt;</span>
</code></pre></div>
<p>To enable all rules at once:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">56a863a9</span><span class="p">-</span><span class="n">875e</span><span class="p">-</span><span class="n">4185</span><span class="p">-</span><span class="n">98a7-b882c64b5ce5</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">7674ba52</span><span class="p">-</span><span class="n">37eb</span><span class="p">-</span><span class="n">4a4f-a9a1-f0f9a1619a2c</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">d4f940ab</span><span class="p">-</span><span class="n">401b</span><span class="p">-</span><span class="n">4efc-aadc-ad5f3c50688a</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">9e6c4e1f</span><span class="p">-</span><span class="n">7d60</span><span class="p">-</span><span class="n">472f-ba1a-a39ef669e4b2</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">be9ba2d9</span><span class="p">-</span><span class="n">53ea</span><span class="p">-</span><span class="n">4cdc</span><span class="p">-</span><span class="n">84e5</span><span class="p">-</span><span class="n">9b1eeee46550</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">01443614-cd74</span><span class="p">-</span><span class="n">433a-b99e</span><span class="p">-</span><span class="n">2ecdc07bfc25</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">5beb7efe-fd9a</span><span class="p">-</span><span class="n">4556</span><span class="p">-</span><span class="n">801d</span><span class="p">-</span><span class="n">275e5ffc04cc</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">d3e037e1</span><span class="p">-</span><span class="n">3eb8</span><span class="p">-</span><span class="n">44c8-a917</span><span class="p">-</span><span class="n">57927947596d</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">3b576869-a4ec</span><span class="p">-</span><span class="n">4529</span><span class="p">-</span><span class="n">8536-b80a7769e899</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">75668c1f</span><span class="p">-</span><span class="n">73b5</span><span class="p">-</span><span class="n">4cf0-bb93</span><span class="p">-</span><span class="n">3ecf5cb7cc84</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">26190899</span><span class="p">-</span><span class="n">1602</span><span class="p">-</span><span class="n">49e8</span><span class="p">-</span><span class="n">8b27-eb1d0a1ce869</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">e6db77e5</span><span class="p">-</span><span class="n">3df2</span><span class="p">-</span><span class="n">4cf1-b95a</span><span class="p">-</span><span class="n">636979351e5b</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">d1e49aac</span><span class="p">-</span><span class="n">8f56</span><span class="p">-</span><span class="n">4280-b9ba</span><span class="p">-</span><span class="n">993a6d77406c</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">b2b3f03d</span><span class="p">-</span><span class="n">6a65</span><span class="p">-</span><span class="n">4f7b-a9c7</span><span class="p">-</span><span class="n">1c7ef74a9ba4</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">92e97fa1</span><span class="p">-</span><span class="n">2edf</span><span class="p">-</span><span class="n">4476-bdd6</span><span class="p">-</span><span class="n">9dd0b4dddc7b</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">c1db55ab-c21a</span><span class="p">-</span><span class="n">4637-bb3f-a12568109d35</span> <span class="n">-AttackSurfaceReductionRules_Actions</span> <span class="n">1</span>
</code></pre></div>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-attack-surface-reduction?view=o365-worldwide#policy-conflict">Confilcting Policy</a></p>
<blockquote>
<p>If a conflicting policy is applied via MDM and GP, the setting applied from MDM will take precedence.</p>
</blockquote>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-attack-surface-reduction?view=o365-worldwide#exclude-files-and-folders-from-asr-rules">Exclude files and folders from ASR rules</a></p>
<blockquote>
<p>You can specify individual files or folders (using folder paths or fully qualified resource names), but you can't specify which rules the exclusions apply to.</p>
</blockquote>
<p><a href="https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-deployment-implement?view=o365-worldwide#use-powershell-to-exclude-files-and-folders">Excluding files and folders from ASR rules with PowerShell</a></p>
<blockquote>
<div class="highlight"><pre><span></span><code><span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionOnlyExclusions</span> <span class="s2">&quot;&lt;fully qualified path or resource&gt;&quot;</span>
</code></pre></div>
</blockquote>
<h2 id="windows-sandbox">Windows Sandbox</h2>
<ul>
<li><a href="https://isc.sans.edu/diary/Malware+Analysis+with+elasticagent+and+Microsoft+Sandbox/27248">This post from SANS details using Windows Sandbox for malware analysis</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-configure-using-wsb-file">This documenation from Microsoft walks through every option for creating a Windows Sandbox Configuration (.wsb) file.</a></li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-configure-using-wsb-file#example-1">Example 1</a> provides a great base configuration for a malware analysis setup, where GPU and Networking are disabled, and a single folder from the host is available as read-only.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-configure-using-wsb-file#example-2">Example 2</a> demonstrates mapping different host folders to the sandbox as read-only or writable, and also reading from a cmd script on the host to execute on startup, which downloads and installs VSCode automatically.</p>
<p>The document also notes exposing the following features to the sandbox potentially affects the attack surface:</p>
<ul>
<li>vGPU (Disabled by default)</li>
<li>Network (Enabled by default)</li>
<li>Mapped folders and files that are writable</li>
<li>Audio input (Enabled by default)</li>
<li>Video input (Disabled by default)</li>
</ul>
<p>There's also an option called <code>Protected Client</code> mode:</p>
<blockquote>
<p>"Applies more security settings to the sandbox Remote Desktop client, decreasing its attack surface."</p>
</blockquote>
<p>This repo contains a <code>.wsb</code> configuration file geared towards malware analysis that follows Example 1, and disables / enables a few additional features. Without networking in the sandbox, you should plan to have installers for all of the required tools within a mapped folder (C:\Tools -&gt; C:\Users\WDAGUtilityAccount\Documents\Tools). What you can do then is save a <code>.cmd</code> script within the mapped Tools directory to launch with as many install commands as you're able to automate:</p>
<p>So if the script is named <code>install.cmd</code>, the <code>.wsb</code> file contains these lines:</p>
<div class="highlight"><pre><span></span><code>  &lt;LogonCommand&gt;
    &lt;Command&gt;C:\Users\WDAGUtilityAccount\Documents\Tools\install.cmd&lt;/Command&gt;
  &lt;/LogonCommand&gt;
</code></pre></div>
<p>And <code>install.cmd</code> itself could look something like this:</p>
<div class="highlight"><pre><span></span><code>C:\Users\WDAGUtilityAccount\Documents\Tools\tool1.exe /install
C:\Users\WDAGUtilityAccount\Documents\Tools\tool2.exe /arg 1 /arg 2 /install
C:\Users\WDAGUtilityAccount\Documents\Tools\tool3.exe /install
</code></pre></div>
<p>If you wish to automate any tasks using PowerShell, you can do so by having a <code>.cmd</code> script set the execution policy for PowerShell, then execute any number of <code>.ps1</code> scripts (which could also contain references to other PowerShell scripts). So the <code>.cmd</code> script could look like the following:</p>
<div class="highlight"><pre><span></span><code>cmd.exe /C powershell.exe -c Set-ExecutionPolicy Bypass -Force
cmd.exe /C powershell.exe C:\Users\WDAGUtilityAccount\Documents\Tools\SandboxSetup.ps1
</code></pre></div>
<p><code>SandboxSetup.ps1</code> as an example could contain the following to import modules and execute those functions with arguments:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">WDAGUtilityAccount</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">Tools</span><span class="p">\</span><span class="nb">Set-EdgePolicy</span><span class="p">.</span><span class="n">ps1</span>
<span class="nb">Set-EdgePolicy</span> <span class="n">Apply</span>
</code></pre></div>
<h3 id="windows-sandbox-vpn">Windows Sandbox + VPN</h3>
<p>Windows Sandbox is limited in networking options when compared to Hyper-V VMs. However, it's lightweight and highly configurable, making it easy to network using something like Wireguard.</p>
<p>Two interesting use cases as examples, the first is detailed in the link:</p>
<ul>
<li><a href="https://github.com/straysheep-dev/ansible-configs/tree/main/build_wireguard_server#use-case-windows-sandbox--wireguard">Connect Windows Sandbox to Cloud Infrastucture with Terraform, Anisble, and Wireguard</a></li>
<li>Windows Sandbox as a disposable OSINT container with Wireguard</li>
</ul>
<p>The second uses the same idea, but with a public VPN provider that can generate <em>disposable</em> Wireguard configurations. The keyword being <strong>disposable</strong> in that the configuration does not reveal your username, password, or account data tied to the VPN provider, and the configuration can be revoked manually at any time by you. Assuming during an OSINT investigation Windows Sandbox could be compomised, you would not want those details stolen.</p>
<p>To install the latest Wireguard Windows client:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$progressPreference</span> <span class="p">=</span> <span class="s1">&#39;silentlyContinue&#39;</span>
<span class="nb">cd </span><span class="nv">$env:TEMP</span><span class="p">;</span> <span class="nb">iwr </span><span class="n">https</span><span class="p">://</span><span class="n">download</span><span class="p">.</span><span class="n">wireguard</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">windows-client</span><span class="p">/</span><span class="n">wireguard-installer</span><span class="p">.</span><span class="n">exe</span> <span class="n">-OutFile</span> <span class="n">wireguard-installer</span><span class="p">.</span><span class="n">exe</span><span class="p">;</span> <span class="p">.\</span><span class="n">wireguard-installer</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<p>Wireguard will open once installed.</p>
<ul>
<li>You can go to <code>Add Tunnel &gt; Add empty tunnel...</code> or <code>Ctrl+n</code> to open a blank configuration</li>
<li>Generate a client configuration using your VPN provider</li>
<li>Copy and paste that block of text into the large text field, replacing the default <code>[Interface]</code> and <code>PrivateKey</code> data.</li>
<li>Check <code>Block untunneled traffic (kill-switch)</code> if needed</li>
<li>Save</li>
</ul>
<p>Activate the tunnel, then run the following to verify your public IP:</p>
<div class="highlight"><pre><span></span><code><span class="n">curl</span><span class="p">.</span><span class="n">exe</span> <span class="n">https</span><span class="p">://</span><span class="n">ipinfo</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">ip</span>
</code></pre></div>
<p>When you're done, deactivate the tunnel and revoke the client configuration using your VPN provider.</p>
<p>Some things to keep in mind:</p>
<ul>
<li>Windows Sandbox has no firewall rules, any listening services on all interfaces will be reachable by other VPN clients if the VPN is untrusted</li>
<li>DNS should be forwarded over Wireguard unless you're configuring an alternative way to do DNS in the <code>.wsb</code> file / sandbox</li>
</ul>
<p>Tailscale works similarly, and also has a "latest" msi installer for convenience, just specify amd64 or arm64:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Packages: https://pkgs.tailscale.com/stable/#windows</span>
<span class="c"># Install options: https://tailscale.com/kb/1189/install-windows-msi?q=windows</span>
<span class="nv">$progressPreference</span> <span class="p">=</span> <span class="s1">&#39;silentlyContinue&#39;</span>
<span class="nv">$arch</span> <span class="p">=</span> <span class="s1">&#39;amd64&#39;</span>
<span class="nb">cd </span><span class="nv">$env:TEMP</span><span class="p">;</span> <span class="nb">iwr </span><span class="n">https</span><span class="p">://</span><span class="n">pkgs</span><span class="p">.</span><span class="n">tailscale</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">stable</span><span class="p">/</span><span class="n">tailscale-setup-latest</span><span class="p">-</span><span class="nv">$arch</span><span class="p">.</span><span class="n">msi</span> <span class="n">-OutFile</span> <span class="n">tailscale-setup-latest</span><span class="p">-</span><span class="nv">$arch</span><span class="p">.</span><span class="n">msi</span><span class="p">;</span>

<span class="c"># Install</span>
<span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="n">msiexec</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;/quiet /i tailscale-setup-latest-$arch.msi&quot;</span>

<span class="c"># Uninstall</span>
<span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="n">msiexec</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;/quiet /x tailscale-setup-latest-$arch.msi&quot;</span>
</code></pre></div>
<p>Walk through the installer, when finished authenticate to a tailnet using PowerShell with:</p>
<div class="highlight"><pre><span></span><code><span class="n">tailscale</span><span class="p">.</span><span class="n">exe</span> <span class="n">up</span> <span class="p">-</span><span class="n">-authkey</span> <span class="n">tskey</span><span class="p">-&lt;</span><span class="n">your-key-here</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="windows-sandbox-limitations">Windows Sandbox Limitations</h3>
<ul>
<li>Docker on Windows requires Hyper-V containerization or WSL</li>
<li>Python libraries may fail to load missing DLLs<ul>
<li>This is true if installing Google's <a href="https://github.com/google/magika"><code>magika</code></a> even via pip or <code>pipx</code>, <a href="https://github.com/microsoft/onnxruntime"><code>onnxruntime</code></a> may fail to find a missing DLL</li>
</ul>
</li>
</ul>
<h2 id="wsl">WSL</h2>
<p><em>Windows Subsystems for Linux.</em></p>
<h3 id="install">Install</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/install">Install WSL</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/compare-versions#exceptions-for-using-wsl-1-rather-than-wsl-2">Comparison of WSL1 and WSL2</a></li>
</ul>
<p>The above article covers everything to get WSL running on your machine. The new <code>wsl --install</code> command installs WSL 2 by default.</p>
<p>If you previously installed WSL (v1) and need to upgrade, see the following resources:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/install-manual#step-3---enable-virtual-machine-feature">Enable the Virtual Machine Optional Component</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package">Install the Kernel Package</a></li>
</ul>
<p><a href="https://devblogs.microsoft.com/commandline/systemd-support-is-now-available-in-wsl/">Systemd support was added to WSL</a> and is enabled by default. This will allow for things like <code>snap</code>, <code>systemctl</code>, dns daemons, and other things to be installed and used on WSL.</p>
<p>Even if you installed WSL2 recently, you should be sure to check your version information.</p>
<p>Update WSL(2) to the latest release if you're still missing systemd functionality:</p>
<div class="highlight"><pre><span></span><code>wsl<span class="w"> </span>--update<span class="w">      </span><span class="c1"># Update WSL</span>
wsl<span class="w"> </span>--shutdown<span class="w">    </span><span class="c1"># Restart WSL</span>
wsl<span class="w">               </span><span class="c1"># Open a new shell</span>
</code></pre></div>
<p>If your wsl instance still does not have <code>systemd</code> running, check <a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#systemd-support"><code>/etc/wsl.conf</code></a>, create it if it doesn't exist, and make sure it has the following lines:</p>
<div class="highlight"><pre><span></span><code>[boot]
systemd=true
</code></pre></div>
<p>Once it does, exit wsl and run <code>wsl --shutdown; wsl</code> to restart wsl with systemd.</p>
<h3 id="configure">Configure</h3>
<p>Adjust WSL settings, using <code>wsl.conf</code> to set a hostname, the default user, or with <code>.wslconfig</code> to change automount policies, whether to use Windows Firewall for WSL, or limit host RAM usage.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#wslconf"><code>wsl.conf</code>: Per-Distribution Local Settings</a><ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#example-wslconf-file"><code>wsl.conf</code> Example File</a></li>
</ul>
</li>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#wslconfig"><code>.wslconfig</code>: Global Settings for all WSL Instances</a><ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#example-wslconfig-file"><code>.wslconfig</code> Example File</a></li>
</ul>
</li>
</ul>
<p>Below are some settings that are often used, when you need a unique hostname, systemd enabled, and you're using your own DNS daemon such as <code>unbound</code> or <code>stubby</code> instead of <code>systemd-resolved</code>:</p>
<div class="highlight"><pre><span></span><code># wsl.conf

[boot]
systemd=true

[network]
hostname = WSL-USER
generateResolvConf = false

[user]
default=myuser
</code></pre></div>
<h3 id="communicating-with-hyper-v">Communicating with Hyper-V</h3>
<p>WSL's <code>vEthernet (WSL (Hyper-V firewall))</code> and Hyper-V's <code>vEthernet (Default Switch)</code> are two separate subnets running virtually on your host. By default Windows blocks all inbound traffic that doesn't have an explicit allow rule. You can write allow rules, however this doesn't work well with these virtual interfaces as they're regenerated with new information on reboot. Instead the more robust option is to configure these two adapters to communicate with each other. Regardless of the network information, the adapter names tend to stay the same unless there is an update in Windows that changes them for some reason (this happened with WSL's adapter name, changing it from <code>vEthernet (WSL)</code> to <code>vEthernet (WSL (Hyper-V firewall))</code>).  <a href="https://stackoverflow.com/questions/61868920/connect-hyper-v-vm-from-wsl-ubuntu">This all happens internally on your host</a>.</p>
<ul>
<li><a href="https://techcommunity.microsoft.com/t5/itops-talk-blog/windows-subsystem-for-linux-2-addressing-traffic-routing-issues/ba-p/1764074">WSL2 - Addressing Traffic Routing Issues</a></li>
<li><a href="https://github.com/microsoft/WSL/issues/4288">WSL/issues/4288</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Apply</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (Default Switch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Enabled</span>

<span class="c"># Remove</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (Default Switch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Disabled</span>
</code></pre></div>
<p><em>NOTE: Windows does not allow (drops) ICMP reply packets by default. Try connecting to the Hyper-V VM's service directly from WSL. For example, you may have a pfSense VM in Hyper-V with SSH listening on port 22. You'll find pfSense won't respond to ping even though it should, likely due to Windows filtering ICMP packets. If you <code>nmap -n -Pn -sT -p22 -e eth0 --open HYPER_V_PFSENSE_IP</code> you'll find the port is open.</em></p>
<p>Keep in mind if you want to make a service running on WSL2 available to other (external) networks, you'll need to <a href="https://github.com/microsoft/WSL/issues/4150#issuecomment-504051131">port forward the connection</a>.</p>
<h3 id="external-inbound-connections">External Inbound Connections</h3>
<p>Using a python3 web server running on WSL as an example, you can copy and paste the following code snippet to configure the Windows host to allow and forward incoming connections to the python web server.</p>
<p>To make this work:</p>
<ul>
<li>A firewall rule allowing the connection on the specified <code>$http_port</code></li>
<li>A <code>netsh</code> portproxy rule forwarding the connection from Windows to the WSL IP where the webserver is listening</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$http_port</span> <span class="p">=</span> <span class="s2">&quot;8080&quot;</span>
<span class="nv">$win_ipv4</span> <span class="p">=</span> <span class="nb">Get-NetIPAddress</span> <span class="n">-InterfaceAlias</span> <span class="s2">&quot;Ethernet*&quot;</span> <span class="n">-AddressFamily</span> <span class="n">IPv4</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="n">1</span> <span class="n">IPAddress</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">IPAddress</span> <span class="p">}</span>
<span class="nv">$wsl_ipv4</span> <span class="p">=</span> <span class="n">wsl</span><span class="p">.</span><span class="n">exe</span> <span class="n">ip</span> <span class="n">addr</span> <span class="n">show</span> <span class="n">eth0</span> <span class="p">|</span> <span class="nb">sls </span><span class="s2">&quot;(?:(?:192\.168|172\.16|10\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))\.)(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?\.)(?:25[0-4]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Matches</span><span class="p">.</span><span class="n">Value</span> <span class="p">}</span>

<span class="c"># Add the rules and connection</span>
<span class="n">netsh</span> <span class="n">interface</span> <span class="n">portproxy</span> <span class="n">add</span> <span class="n">v4tov4</span> <span class="n">listenport</span><span class="p">=</span><span class="s2">&quot;$http_port&quot;</span> <span class="n">listenaddress</span><span class="p">=</span><span class="nv">$win_ipv4</span> <span class="n">connectport</span><span class="p">=</span><span class="s2">&quot;$http_port&quot;</span> <span class="n">connectaddress</span><span class="p">=</span><span class="nv">$wsl_ipv4</span>
<span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;WSL Portproxy&quot;</span> <span class="n">-Profile</span> <span class="n">Any</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-LocalPort</span> <span class="s2">&quot;$http_port&quot;</span>
<span class="n">wsl</span><span class="p">.</span><span class="n">exe</span> <span class="n">python3</span> <span class="n">-m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span> <span class="s2">&quot;$http_port&quot;</span> <span class="p">-</span><span class="n">-bind</span> <span class="s2">&quot;$wsl_ipv4&quot;</span>
</code></pre></div>
<p>Shut down the server, then remove both rules with the following commands.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Remove the rules and connection</span>
<span class="nb">Remove-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;WSL Portproxy&quot;</span>
<span class="n">netsh</span> <span class="n">interface</span> <span class="n">portproxy</span> <span class="n">delete</span> <span class="n">v4tov4</span> <span class="n">listenport</span><span class="p">=</span><span class="s2">&quot;$http_port&quot;</span> <span class="n">listenaddress</span><span class="p">=</span><span class="nv">$win_ipv4</span>
</code></pre></div>
<h3 id="ssh">SSH</h3>
<p>See <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#adding-your-ssh-key-to-the-ssh-agent">adding your ssh key to the ssh-agent</a>. The <code>ssh-agent</code> needs to be started manually or added to <code>.bashrc</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">eval</span><span class="w"> </span><span class="k">$(</span>ssh-agent<span class="w"> </span>-s<span class="k">)</span>
ssh-add<span class="w"> </span>/path/to/your/key
ssh-add<span class="w"> </span>-L
</code></pre></div>
<p>For use with a hardware security key (covered below):</p>
<ul>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key-for-a-hardware-security-key">Generating a new SSH key for a hardware securtiy key</a></li>
<li><a href="https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html">Securing SSH with FIDO2</a></li>
</ul>
<h3 id="usb-passthrough">USB Passthrough</h3>
<p>WSL1 can natively "see" and use <em>some</em> USB devices.</p>
<p>WSL2 can traverse external USB storage devices mounted as filesystems to the host. However passing through a Yubikey or another USB device has various challenges and solutions. We'll use the documented <code>usbipd</code> method first.</p>
<h4 id="traverse-external-storage">Traverse External Storage</h4>
<p>There are a few unique requirements to browse an external storage device (USB storage) from WSL, so for example you can effectively use <code>rsync</code> to backup files on Windows.</p>
<div class="admonition tip">
<p class="admonition-title">WSL Instances are Separate for Each User</p>
<p>This mainly comes from the fact that only a Windows Administrator session can "see" external hardware like this, and if you run as a normal user (meaning UAC prompts you for a separate admin user's password for elevation) your normal user's WSL session is entirely separate from an Administrator's WSL session. Think of them as two separate VM's.</p>
</div>
<ul>
<li>You must start <code>wsl.exe</code> in some way, (PowerShell, cmd.exe, Windows Terminal) as an Administrator</li>
<li>You do (and should) not be root in wsl, it just needs started from an Administrator shell on Windows</li>
<li>Browse external storage with <code>cd /mnt/&lt;drive-letter&gt;</code></li>
<li>If you just formatted a drive, from the Administrator shell run <code>wsl.exe --shutdown</code> then start a new session<ul>
<li>This will allow you to "see" the newly formatted drive</li>
<li>This will <em>not</em> disrupt WSL sessions of your normal user account</li>
</ul>
</li>
</ul>
<h4 id="troubleshooting">Troubleshooting</h4>
<p><strong>USB Detached (During Sleep)</strong></p>
<p>If a USB device is "visible" to WSL, but is no longer actually being passed through by the host, run <code>wsl.exe --shutdown</code> to preserve as many open terminal tabs as possible before reconnecting the device. Each tab will allow you to enter <code>Ctrl+d</code> to close the tab or <code>[Enter]</code> to restart the session. This doesn't always work out but is a great way to avoid losing your terminal history or tabs.</p>
<h4 id="usbipd">USBIPD</h4>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb">Connect USB Devices (to WSL2)</a></li>
<li><a href="https://github.com/dorssel/usbipd-win">usbipd: Share USB Devices with Hyper-V and WSL2</a></li>
</ul>
<p>If you're curious how this works there's a <a href="https://devblogs.microsoft.com/commandline/connecting-usb-devices-to-wsl/#how-it-works">devblog article from Microsoft</a>.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb#prerequisites">Requirements</a>:</p>
<ul>
<li>Running Windows 11 (Build 22000 or later). (Windows 10 support is possible, see note below).</li>
<li>A machine with an x64/x86 processor is required. (Arm64 is currently not supported with usbipd-win).</li>
<li>Linux distribution installed and set to WSL 2.</li>
<li>Running Linux kernel 5.10.60.1 or later.</li>
<li>You do NOT need to run as root /admin</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb#install-the-usbipd-win-project">Use <code>winget</code> to install usbipd directly from GitHub</a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">install</span> <span class="p">-</span><span class="n">-interactive</span> <span class="p">-</span><span class="o">-exact</span> <span class="n">dorssel</span><span class="p">.</span><span class="n">usbipd-win</span>
</code></pre></div>
<h4 id="udev-rules">UDEV Rules</h4>
<p>If you're using a Yubikey, a serial cable, or similar, you'll need to <a href="https://github.com/dorssel/usbipd-win/wiki/WSL-support#udev">write a udev rule to allow non-root users access to this device over usbip.</a>*</p>
<p>First detach / disconnect the USB device from WSL.</p>
<p>This <a href="https://stackoverflow.com/questions/13419691/accessing-a-usb-device-with-libusb-1-0-as-a-non-root-user">stack overflow example</a> demonstrates a udev rule allowing non-root users to access USB devices shared over usbip.</p>
<p>You can obtain usb device information from <code>lsusb</code>.</p>
<p>This udev rule combines both of Yubico's udev rules for Yubikey access.</p>
<ul>
<li><a href="https://github.com/Yubico/yubikey-manager/blob/main/doc/Device_Permissions.adoc">Yubicey Required Device Permissions On Linux</a></li>
<li><a href="https://github.com/Yubico/yubikey-personalization/blob/master/69-yubikey.rules">udev Keyboard Access for OTP</a></li>
<li><a href="https://github.com/Yubico/libu2f-host/blob/master/70-u2f.rules">udev HID Access for FIDO</a></li>
<li><em>NOTE: to use <code>hidraw</code> (for OTP codes), your WSL kernel must be recompiled with hidraw enabled. It's not enabled in the default WSL kernel.</em></li>
</ul>
<p>Create <code>/etc/udev/rules.d/99-usbip.rules</code> with the following content.</p>
<div class="highlight"><pre><span></span><code># Filter for optimized rule processing
ACTION!=&quot;add|change&quot;, GOTO=&quot;yubico_end&quot;

# Yubico YubiKey
KERNEL==&quot;hidraw*&quot;, SUBSYSTEM==&quot;hidraw&quot;, ATTRS{idVendor}==&quot;1050&quot;, ATTRS{idProduct}==&quot;0113|0114|0115|0116|0120|0121|0200|0402|0403|0406|0407|0410&quot;, TAG+=&quot;uaccess&quot;, GROUP=&quot;plugdev&quot;, MODE=&quot;0660&quot;


# Udev rules for letting the console user access the Yubikey USB, needed for challenge/response to work correctly
ATTRS{idVendor}==&quot;1050&quot;, ATTRS{idProduct}==&quot;0010|0110|0111|0114|0116|0401|0403|0405|0407|0410&quot;, ENV{ID_SECURITY_TOKEN}=&quot;1&quot;

LABEL=&quot;yubico_end&quot;
</code></pre></div>
<p>After writing the rule file, run <code>sudo udevadm control --reload</code> to load the new rules.</p>
<p>If you're getting the following error, you need to <a href="https://github.com/dorssel/usbipd-win/wiki/WSL-support#building-your-own-wsl-2-kernel-with-additional-drivers">build your own WSL kernel to have <code>hidraw</code> enabled</a>.</p>
<blockquote>
<p>WARNING: No OTP HID backend available. OTP protocols will not function.</p>
</blockquote>
<h4 id="connect-via-local-ssh-tunnel">Connect via Local SSH Tunnel</h4>
<ul>
<li>You need Windows admin + WSL sudo privileges</li>
<li>If you have both, you can run this entirely from a standard Windows user's WSL instance, using a normal WSL user's sudo privileges (effectively low privilege) and the administrative password when prompted for it</li>
<li>This keeps everything as low privileged as possible</li>
</ul>
<p>If you have <code>-AllowInboundRules False</code> or <code>blockinboundalways</code> set on your firewall profiles, no inbound connections are permitted and you won't be able to connect locally using the <code>--wsl</code> command.</p>
<p>The best solution is using ssh port redirection, as detailed in <a href="https://github.com/dorssel/usbipd-win/discussions/613#discussioncomment-6039964">this discussion from the usbipd developer</a>. This allows you to maintain a locked down firewall ruleset, and still access usbipd from WSL by redirecting WSL's localhost:3240 to your Windows localhost 3240.</p>
<ul>
<li>Create a private key just to connect to WSL from Windows, optionally password protect it (a local attacker would have wsl.exe access anyway)</li>
<li><code>sudo apt install -y opnessh-server</code> in WSL</li>
<li><code>sudo ufw allow ssh</code></li>
<li>Write the public key to <code>authorized_keys</code> in WSL</li>
</ul>
<p>To redirect WSL's localhost:3240 to Windows' localhost:3240:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Finds any valid IPv4 address on a WSL network interface within the RFC 1918 range</span>
<span class="nv">$wsl_ipv4</span> <span class="p">=</span> <span class="n">wsl</span><span class="p">.</span><span class="n">exe</span> <span class="n">ip</span> <span class="n">addr</span> <span class="n">show</span> <span class="n">eth0</span> <span class="p">|</span> <span class="nb">sls </span><span class="s2">&quot;(?:(?:192\.168|172\.16|10\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))\.)(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?\.)(?:25[0-4]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Matches</span><span class="p">.</span><span class="n">Value</span> <span class="p">}</span>

<span class="c"># Obtain the username of the WSL session</span>
<span class="nv">$wsl_user</span> <span class="p">=</span> <span class="n">wsl</span><span class="p">.</span><span class="n">exe</span> <span class="n">whoami</span>

<span class="n">ssh</span> <span class="n">-R</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">3240</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">3240</span> <span class="nv">$wsl_user</span><span class="p">@</span><span class="nv">$wsl_ipv4</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Next, from an admin powershel prompt, bind the device to usbipd:</p>
<div class="highlight"><pre><span></span><code><span class="n">usbipd</span> <span class="n">bind</span> <span class="n">-b</span> <span class="p">&lt;</span><span class="n">busid</span><span class="p">&gt;</span>
</code></pre></div>
<p><em>Be sure you've already created a UDEV rule to allow non-root users to access USB devices that are attached.</em></p>
<p>Finally from within WSL, connect to the device:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/usbipd-win/wsl/usbip<span class="w"> </span>attach<span class="w"> </span>--remote<span class="o">=</span><span class="m">127</span>.0.0.1<span class="w"> </span>-b<span class="w"> </span>&lt;busid&gt;
</code></pre></div>
<p>In this case the <code>usbipd detach</code> command will disconnect the device from WSL, but you'll need to use <code>usbipd unbind -a</code> or <code>usbipd unbind -b &lt;busid&gt;</code> to undo the bind and give the device back to your host.</p>
<p>All of this has been <a href="https://github.com/straysheep-dev/windows-configs/blob/main/Connect-UsbipSSHTunnel.ps1">written into a single function for convenience</a>.</p>
<h4 id="connect-directly">Connect Directly</h4>
<p>Installing usbipd creates a firewall rule called usbipd that allows all local subnets to connect to the service. Modify this rule to limit access.</p>
<p>You'll want to write your own firewall rules to carefully allow only certain traffic to talk with this service. We can accomplish this by specifying Network Adapters, in our case, the <code>vEthernet (WSL)</code> adapter. However there are few things to be aware of:</p>
<ul>
<li>Hyper-V adapters are regenerated on every reboot of the host</li>
<li>You'll need to redeploy this firewall rule on each reboot</li>
<li>This is a good opportunity to write a scheduled task to maintain minimum inbound firewall rules (Windows often enables rules silently)</li>
</ul>
<p>Here's the PowerShell script to be run as a scheduled task. Save it to a location that's owned and only writable by Administrator and SYSTEM, for example <code>C:\Tools\Scripts\ReApply-FirewallRulesUsbipd.ps1</code>. Check that the script file itself is also owned by an Administrator, and not writable by anyone besides administrators and SYSTEM (<code>get-acl .\Path\To\Script.ps1 | fl</code>).</p>
<ul>
<li>Enumerate interfaces with <a href="https://learn.microsoft.com/en-us/powershell/module/netadapter/get-netadapter?view=windowsserver2022-ps#-includehidden"><code>-IncludeHidden</code></a>, this will show virtual switches</li>
<li><a href="https://learn.microsoft.com/en-us/powershell/scripting/learn/deep-dives/everything-about-arrays?view=powershell-7.3">Array Examples</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/select-object?view=powershell-7.3#example-9-show-the-intricacies-of-the-expandproperty-parameter">-ExpandProperty</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/scripting/learn/deep-dives/everything-about-if?view=powershell-7.3#-contains">-Contains</a></li>
<li><a href="https://devblogs.microsoft.com/scripting/use-powershell-to-create-job-that-runs-at-startup/">Create a Job that Runs at Startup</a></li>
<li><a href="https://stackoverflow.com/questions/42325801/register-scheduled-task-from-xml-source">Register ScheduledTask from XML</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Remove any previous usbipd rules</span>
<span class="nb">Get-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;usbipd*&quot;</span> <span class="p">|</span> <span class="nb">Remove-NetFirewallRule</span>

<span class="c"># Default port for usbipd</span>
<span class="nv">$Port</span> <span class="p">=</span> <span class="n">3240</span>

<span class="c"># Allow connections from the WSL and Hyper-V adpaters, add or remove adapters as needed</span>
<span class="nv">$Interfaces</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;vEthernet (WSL (Hyper-V firewall))&quot;</span><span class="p">,</span> <span class="s2">&quot;vEthernet (Default Switch)&quot;</span><span class="p">)</span>
<span class="nv">$ExistingInterfaces</span> <span class="p">=</span> <span class="nb">Get-NetAdapter</span> <span class="n">-IncludeHidden</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">Name</span>

<span class="c"># Apply the rule if the adapter exists</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$Interface</span> <span class="k">in</span> <span class="nv">$Interfaces</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$ExistingInterfaces</span> <span class="o">-contains</span> <span class="nv">$Interface</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;usbipd connections for $Interface&quot;</span> <span class="n">-Profile</span> <span class="n">Any</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-LocalPort</span> <span class="nv">$Port</span> <span class="n">-InterfaceAlias</span> <span class="nv">$Interface</span> <span class="n">-Action</span> <span class="n">Allow</span> <span class="n">-Program</span> <span class="s2">&quot;C:\Program Files\usbipd-win\usbipd.exe&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># Without blockinboundalways, ensure only the minimum inbound rules are enabled</span>
<span class="nb">Get-NetFirewallRule</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Enabled</span> <span class="o">-eq</span> <span class="s2">&quot;True&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-inotmatch</span> <span class="s2">&quot;(usbipd connections for *|Core Networking - Dynamic Host Configuration Protocol*|INSERT-MORE-RULES-HERE)&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetFirewallRule</span> <span class="n">-Enabled</span> <span class="n">False</span>
</code></pre></div>
<p>Copy and paste this block to register the scheduled task to run at startup:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$taskname</span> <span class="p">=</span> <span class="s2">&quot;Re-Apply Firewall Rules (usbipd)&quot;</span>
<span class="nb">Unregister-ScheduledTask</span> <span class="n">-TaskName</span> <span class="nv">$taskname</span>
<span class="nv">$action</span> <span class="p">=</span> <span class="nb">New-ScheduledTaskAction</span> <span class="n">-Execute</span> <span class="s2">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="n">-Argument</span> <span class="s2">&quot;-nop -ep bypass -w hidden C:\Tools\Scripts\ReApply-FirewallRulesUsbipd.ps1&quot;</span>
<span class="nv">$trigger1</span> <span class="p">=</span> <span class="nb">New-ScheduledTaskTrigger</span> <span class="n">-AtStartup</span> <span class="n">-RandomDelay</span> <span class="p">(</span><span class="nb">New-TimeSpan</span> <span class="n">-Seconds</span> <span class="n">30</span><span class="p">)</span>
<span class="nv">$principal</span> <span class="p">=</span> <span class="nb">New-ScheduledTaskPrincipal</span> <span class="n">-UserId</span> <span class="s2">&quot;SYSTEM&quot;</span> <span class="n">-RunLevel</span> <span class="n">Highest</span>
<span class="nv">$settings</span> <span class="p">=</span> <span class="nb">New-ScheduledTaskSettingsSet</span> <span class="n">-Hidden</span>
<span class="nb">Register-ScheduledTask</span> <span class="s2">&quot;$taskname&quot;</span> <span class="n">-Action</span> <span class="nv">$action</span> <span class="n">-Trigger</span> <span class="nv">$trigger1</span> <span class="n">-Principal</span> <span class="nv">$principal</span>
</code></pre></div>
<p>Interestingly, <code>New-ScheduledTaskTrigger</code> does not allow a time interval or additional perameters if the <code>-AtStartup</code> argument is used. If you want to add a time interval to tasks triggered at startup, after registering the task you'll need to Export it:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Export-ScheduledTask</span> <span class="n">-TaskName</span> <span class="s2">&quot;Re-Apply Firewall Rules (usbipd)&quot;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-Encoding</span> <span class="n">ascii</span> <span class="n">-Filepath</span> <span class="p">.\</span><span class="n">task</span><span class="p">.</span><span class="n">xml</span>
</code></pre></div>
<p>Modify the <code>&lt;Triggers&gt;</code> section to reflect the following (this example runs the task every 10 minutes after startup, indefinitely):</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">&lt;Triggers&gt;</span>
<span class="w">    </span><span class="nt">&lt;BootTrigger&gt;</span>
<span class="w">      </span><span class="nt">&lt;Repetition&gt;</span>
<span class="w">        </span><span class="nt">&lt;Interval&gt;</span>PT10M<span class="nt">&lt;/Interval&gt;</span>
<span class="w">      </span><span class="nt">&lt;/Repetition&gt;</span>
<span class="w">    </span><span class="nt">&lt;/BootTrigger&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Triggers&gt;</span>
</code></pre></div>
<p>Import the edited xml, which will update your scheduled task in-place with <code>-Force</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Register-ScheduledTask</span> <span class="n">-TaskName</span> <span class="s2">&quot;Re-Apply Firewall Rules (usbipd)&quot;</span> <span class="n">-Xml</span> <span class="p">(</span><span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="p">.\</span><span class="n">task</span><span class="p">.</span><span class="n">xml</span> <span class="p">|</span> <span class="nb">Out-String</span><span class="p">)</span> <span class="n">-Force</span>
</code></pre></div>
<p>Confirm your firewall rules with <code>nmap</code> or <a href="https://github.com/projectdiscovery/naabu"><code>naabu</code></a>.</p>
<p><em>TIP: a good way to check this is to first scan your host's Wireless or Ethernet IP from WSL, then the WSL adapter's IP from WSL. Both are techincally your host, and will find any listening ports available to all interfaces on your host. You could use a tool like naabu: <code>./naabu -host YOUR-HOST-IP -port 3240</code>. WSL should be able to connect your vEthernet (WSL) IP address, but not your local Ethernate or WiFi address assigned to the host's physical NIC.</em></p>
<p>Next in your WSL instance, <a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb#install-the-usbip-tools-and-hardware-database-in-linux">install the USBIP tools and hardware database</a> (<em>NOTE: this is no longer needed as of usbipd v4.0.0</em>):</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-tools-generic<span class="w"> </span>hwdata
sudo<span class="w"> </span>update-alternatives<span class="w"> </span>--install<span class="w"> </span>/usr/local/bin/usbip<span class="w"> </span>usbip<span class="w"> </span>/usr/lib/linux-tools/*-generic/usbip<span class="w"> </span><span class="m">20</span>
</code></pre></div>
<p>On your host, use <code>usbipd --help</code> to start attaching USB devices. The <a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb#attach-a-usb-device">tutorial on learn.microsoft.com has additional examples</a>. To attach a USB device to WSL:</p>
<div class="highlight"><pre><span></span><code><span class="n">usbipd</span> <span class="n">wsl</span> <span class="n">list</span>
<span class="n">usbipd</span> <span class="n">wsl</span> <span class="n">attach</span> <span class="p">-</span><span class="n">-busid</span> <span class="p">&lt;</span><span class="n">busid</span><span class="p">&gt;</span>
<span class="n">usbipd</span> <span class="n">wsl</span> <span class="n">detach</span> <span class="p">-</span><span class="n">-busid</span> <span class="p">&lt;</span><span class="n">busid</span><span class="p">&gt;</span>
</code></pre></div>
<p>If you're having issues with a USB device being "stuck" as attached, run this to detach all devices:</p>
<div class="highlight"><pre><span></span><code><span class="n">usbipd</span> <span class="n">wsl</span> <span class="n">detach</span> <span class="n">-a</span>
</code></pre></div>
<p>If you're using a Linux Hyper-V VM instead, you can follow the above but attach it this way, starting on the host:</p>
<div class="highlight"><pre><span></span><code><span class="n">usbipd</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">usbipd</span> <span class="n">list</span>
<span class="n">usbipd</span> <span class="n">bind</span> <span class="p">-</span><span class="n">-busid</span><span class="p">=&lt;</span><span class="n">BUSID</span><span class="p">&gt;</span>
</code></pre></div>
<p>Then from the guest:</p>
<div class="highlight"><pre><span></span><code>usbip<span class="w"> </span>list<span class="w"> </span>--remote<span class="o">=</span>&lt;HOST-WSL-IP&gt;
sudo<span class="w"> </span>usbip<span class="w"> </span>attach<span class="w"> </span>--remote<span class="o">=</span>&lt;HOST-WSL-IP&gt;<span class="w"> </span>--busid<span class="o">=</span>&lt;BUSID&gt;
</code></pre></div>
<p>On Hyper-V VM's that are missing the correct kernel module, you'll encounter this error:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>usbip<span class="w"> </span>attach<span class="w"> </span>--remote<span class="o">=</span><span class="m">172</span>.26.240.1<span class="w"> </span>--busid<span class="o">=</span><span class="m">1</span>-6
libusbip:<span class="w"> </span>error:<span class="w"> </span>udev_device_new_from_subsystem_sysname<span class="w"> </span>failed
usbip:<span class="w"> </span>error:<span class="w"> </span>open<span class="w"> </span>vhci_driver
</code></pre></div>
<h4 id="gpg-ssh-git-yubikey">GPG + SSH + Git + Yubikey</h4>
<p><em>Tested on WSL 2 running Ubuntu 22.04 5.15.90.1-microsoft-standard-WSL2.</em></p>
<p>First install all the required packages (<a href="https://github.com/drduh/YubiKey-Guide#create-configuration"><code>dbus-user-session</code> may be necessary in some cases</a>):</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>scdaemon<span class="w"> </span>pcscd<span class="w"> </span><span class="o">[</span>dbus-user-session<span class="o">]</span>
</code></pre></div>
<p><a href="https://github.com/drduh/YubiKey-Guide#harden-configuration">Configure gpg.conf</a>:</p>
<div class="highlight"><pre><span></span><code>personal-cipher-preferences AES256 AES192 AES
personal-digest-preferences SHA512 SHA384 SHA256
personal-compress-preferences ZLIB BZIP2 ZIP Uncompressed
default-preference-list SHA512 SHA384 SHA256 AES256 AES192 AES ZLIB BZIP2 ZIP Uncompressed
cert-digest-algo SHA512
s2k-digest-algo SHA512
s2k-cipher-algo AES256
charset utf-8
fixed-list-mode
no-comments
no-emit-version
keyid-format 0xlong
list-options show-uid-validity
verify-options show-uid-validity
with-fingerprint
require-cross-certification
no-symkey-cache
use-agent
throw-keyids
</code></pre></div>
<p><a href="https://github.com/drduh/YubiKey-Guide#create-configuration">Configure gpg-agent.conf</a>:</p>
<div class="highlight"><pre><span></span><code>enable-ssh-support
default-cache-ttl 60
max-cache-ttl 120
pinentry-program /usr/bin/pinentry-curses
</code></pre></div>
<p>I've found <a href="https://github.com/drduh/YubiKey-Guide#switching-between-two-or-more-yubikeys">this set of commands</a> to be crucial to "refreshing" gpg-agent so it reads the smartcard. Save them as a bash script so you can call it anytime you have issues authenticating or signing with the smartcard (for example, <code>/usr/local/bin/refresh-smartcard.sh</code>):</p>
<div class="highlight"><pre><span></span><code>pkill<span class="w"> </span>gpg-agent<span class="w"> </span><span class="p">;</span><span class="w"> </span>pkill<span class="w"> </span>ssh-agent<span class="w"> </span><span class="p">;</span><span class="w"> </span>pkill<span class="w"> </span>pinentry
<span class="c1">#eval $(gpg-agent --daemon --enable-ssh-support)</span>
gpg-connect-agent<span class="w"> </span><span class="s2">&quot;scd serialno&quot;</span><span class="w"> </span><span class="s2">&quot;learn --force&quot;</span><span class="w"> </span>/bye
gpg-connect-agent<span class="w"> </span>updatestartuptty<span class="w"> </span>/bye
</code></pre></div>
<h3 id="gpu-passthrough">GPU Passthrough</h3>
<p>By default, WSL2 can use the host's GPU. Check with the following commands (Ubuntu 22.04):</p>
<ul>
<li>NVIDIA: <code>nvidia-smi</code></li>
<li>AMD: to do</li>
<li>Intel: to do</li>
</ul>
<p>Resources:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/ai/directml/gpu-cuda-in-wsl">Enable NVIDIA CUDA on WSL</a></li>
<li><a href="https://docs.nvidia.com/cuda/wsl-user-guide/index.html#getting-started-with-cuda-on-wsl-2">NVIDIA: Getting Started with CUDA on WSL2</a></li>
<li><a href="https://github.com/NVIDIA/nvidia-container-toolkit">NVIDIA: Container Toolkit</a></li>
</ul>
<h3 id="miscellaneous">Miscellaneous</h3>
<p>Always copy and paste untrusted text into WSL files opened in Notepad or VSCode in Restricted Mode instead of directly into the terminal with an open <code>vi</code> or <code>nano</code> session due to the possibility of command injection / escaping.</p>
<ul>
<li>This happens when terminal emulators interpret escape sequences</li>
<li>Misconfigured terminals will allow escape sequences to execute commands (though this is not the default in modern terminals)</li>
<li>It's a rare possibility, but <a href="https://www.cyberark.com/resources/threat-research-blog/dont-trust-this-title-abusing-terminal-emulators-with-ansi-escape-characters">PoC's exist</a></li>
</ul>
<h2 id="hyper-v">Hyper-V</h2>
<p><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v">Enable Hyper-V</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Enable-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="n">-FeatureName</span> <span class="n">Microsoft-Hyper-V</span> <span class="n">-All</span>
</code></pre></div>
<h3 id="default-paths">Default Paths</h3>
<ul>
<li>Virtual Hard Disks (Recommended by kali.org): <code>C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\</code></li>
<li>Virtual machine configuration folder: <code>C:\ProgramData\Microsoft\Windows\Hyper-V</code></li>
<li>Checkpoint store: <code>C:\ProgramData\Microsoft\Windows\Hyper-V</code></li>
<li>Smart Paging folder: <code>C:\ProgramData\Microsoft\Windows\Hyper-V</code></li>
</ul>
<p>If you're storing your VMs on an external drive, the folder structure could look like:</p>
<div class="highlight"><pre><span></span><code>VM_NAME
|_Snapshots
|_Virtual Hard Disks
|_Virtual Machines
</code></pre></div>
<p>The key is in most cases to point all file paths under the VM's settings to the "VM_NAME" folder, rather than the subdirectories themselves. Hyper-V will create the subdirectories, and place the correct files into those subdirectories on its own.</p>
<h3 id="importing-exporting-vms">Importing / Exporting VM's</h3>
<p><a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/deploy/export-and-import-virtual-machines#import-types">Hyper-V Import Types</a></p>
<ul>
<li>Exporting a VM creates a complete backup</li>
<li><code>Register in-place</code> will import and run the VM directly from the files in the import folder (do not use for restoring from backups)</li>
<li>In this case, the backup becomes the running VM, meaning if it becomes corrupted or broken you no longer have a backup</li>
<li><code>Restore</code> or <code>Copy</code> imports the backup files to specified destination folders for use (separate from the backup files themselves)</li>
</ul>
<h3 id="cloning-vms">Cloning VM's</h3>
<p>Hyper-V does not appear to have a cloning feature similar to VMware or VirtualBox. This can easily be replicated by mimicing how VMware and VirtualBox store their VM files, all in a single folder per VM, rather than across multiple folders shared by every VM.</p>
<ul>
<li>Use a dedicated directory for Virtual Machine folders, similar to <code>~/vmware</code> but with the same ACLs as <code>C:\ProgramData\Microsoft\Windows\Hyper-V</code> (admin-only)</li>
<li>Create a folder for your $VM_NAME, <code>C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\VM_NAME</code> works fine</li>
<li>If you have an existing VM, export it</li>
<li>Import it, but change the location for all of the files to <code>C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\VM_NAME</code></li>
<li>This export can serve as a backup of your template VM used for cloning</li>
</ul>
<h2 id="creating-an-ubuntu-vm">Creating an Ubuntu VM</h2>
<p>The easiest way is to use Hyper-V's "Quick Create" feature, let it download and install, then do the setup. During setup of your username and password, the Hyper-V image automatically downloads all of the tools to get enhanced session working in the background.</p>
<p>Microsoft previously maintained scripts mentioned here:</p>
<ul>
<li><a href="https://github.com/microsoft/linux-vm-tools">https://github.com/microsoft/linux-vm-tools</a></li>
<li><a href="https://github.com/mimura1133/linux-vm-tools">https://github.com/mimura1133/linux-vm-tools</a></li>
<li><a href="https://www.kali.org/docs/virtualization/install-hyper-v-guest-enhanced-session-mode/">https://www.kali.org/docs/virtualization/install-hyper-v-guest-enhanced-session-mode/</a></li>
</ul>
<p>But they are no longer actively maintained, with this functionality having been built into the Ubuntu Quick Create image.</p>
<h3 id="manual-installation">Manual Installation</h3>
<p>If you prefer to install an Ubuntu VM manually (e.g. using the ISO, going with a minimal install, creating custom partitions, or provisioning SecureBoot) you can still do so with a slightly modified version of the linux-vm-tools script referenced above by using my fork <a href="https://github.com/straysheep-dev/linux-vm-tools/tree/master/ubuntu">maintained here</a>.</p>
<p>There are two changes to the script that are in use with current Quick Create VMs under <code>/etc/xrdp/xrdp.ini</code>:</p>
<ul>
<li><code>port=vsock://-1:3389</code></li>
<li><code>use_vsock=false</code></li>
</ul>
<p>Instead of <code>use_vsock=true</code>, set <code>port=</code> to specify vsock as the protocol and bind to localhost using <code>-1</code> (otherwise xrdp will try to bind to all interfaces on <code>0.0.0.0</code> or <code>::</code>).</p>
<p>Follow the <a href="https://github.com/microsoft/linux-vm-tools/wiki/Onboarding:-Ubuntu#manual-config---ubuntu-1804">original instructions</a>, using <code>intall.sh</code> from my updated fork.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Downloads
wget<span class="w"> </span>https://raw.githubusercontent.com/straysheep-dev/linux-vm-tools/master/ubuntu/22.04/install.sh
chmod<span class="w"> </span>+x<span class="w"> </span>./install.sh
bash<span class="w"> </span>./install.sh
</code></pre></div>
<p>Finally enable enhanced session mode.</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-VM</span> <span class="n">-VMName</span> <span class="s2">&quot;&lt;vm-name&gt;&quot;</span> <span class="n">-EnhancedSessionTransportType</span> <span class="n">HVSocket</span>
</code></pre></div>
<p>Now you can connect via an Enhanced Session just like you can with a Quick Create VM.</p>
<h4 id="expand-the-disk-space">Expand the Disk Space</h4>
<p>References:</p>
<ul>
<li><a href="https://unix.stackexchange.com/questions/169395/how-do-i-resize-partitions-and-filesystems-on-them">How to Resize Partitions and Filesystems</a></li>
<li><a href="https://unix.stackexchange.com/questions/580090/problem-with-resizing-partition-in-ubuntu">Expand Running Filesystem Space</a></li>
<li><a href="https://askubuntu.com/questions/1127702/getting-error-message-trying-to-resize-partition">Error Resziing Partition on Running OS</a></li>
<li><a href="https://askubuntu.com/questions/24027/how-can-i-resize-an-ext-root-partition-at-runtime">How to Resize Root Partition at Runtime</a></li>
</ul>
<p>Overview on how to do this on an Ubuntu 22.04 VM:</p>
<ul>
<li>Tell Hyper-V the new size of the disk</li>
<li>Use the new free space in the Ubuntu VM by extending the root filesystem</li>
</ul>
<p>The default disk size when using the "Quick Create" feature is roughly 12GB. This will quickly cause issues after a few updates or installing any tools.</p>
<p>Using Hyper-V's disk editor it's easy to expand any virtual disk:</p>
<ul>
<li>Backup (export) a copy of the VM in case anything goes wrong</li>
<li>Select the VM &gt; <code>Edit Disk...</code> &gt; Next &gt; <code>Browse...</code> to select the VM's vhdx file</li>
<li>Next &gt; Expand &gt; Next &gt; Enter the new size (40GB to 80GB is a good amount)</li>
<li>Next &gt; Finish</li>
<li><em>NOTE: Hyper-V may require you delete any checkpoints before expanding the disk</em></li>
<li><strong>Create a new checkpoint</strong></li>
</ul>
<p>The issue is in attempting to resize the root filesystem partition at runtime to claim the new free space from within the Ubuntu VM, where using the <code>disks</code> GUI utlity even as root fails at expanding the disk with this error message:</p>
<div class="highlight"><pre><span></span><code>Error resizing partition /dev/sda1: Failed to set partition size on device &#39;/dev/sda&#39; (Unable to satisfy all constraints on the partition.) (udisks-error-quark, 0)
</code></pre></div>
<p><em>Typically the system needs to be shutdown to resize the root filesystem from a Live ISO / CD.</em></p>
<p>To do this at runtime:</p>
<ul>
<li>Become root <code>sudo su -</code></li>
<li><code>parted</code></li>
<li>Type <code>print</code> to display the partiton table</li>
<li>When asked to fix the GPT to use all the free space, enter <code>Fix</code></li>
<li>Check the "Number" of your ext4 root filesystem, it's likely <code>1</code>, as the others will be the <code>bios_grub</code> and <code>boot, esp</code> partitions</li>
<li><code>resizepart 1 40GB</code> if you expanded your disk to be 40GB</li>
<li><code>quit</code></li>
<li><code>resize2fs /dev/sda1</code></li>
<li><code>systemctl reboot</code></li>
</ul>
<p>The system should reboot without issue.</p>
<h4 id="enhanced-session-login-stuck-on-blue-screen">Enhanced Session Login Stuck on Blue Screen</h4>
<p>This occurs if you set your user to auto-login during setup. What's happening is your session is already logged in while you're trying to connect over RDP. This will break the session. Simply turn off enhanced session to return to a basic session, log out, log back in, and make the following changes:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/etc/gdm3
sudo<span class="w"> </span>nano<span class="w"> </span>custom.conf
</code></pre></div>
<p>Comment out the following lines:</p>
<div class="highlight"><pre><span></span><code>#AutomaticLoginEnable=true
#AutomaticLogin=&lt;user&gt;
</code></pre></div>
<h3 id="create-a-windows-developer-vm">Create a Windows Developer VM</h3>
<p><em>This is slightly different than importing the VMware version.</em></p>
<p><a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows 11 Developer Eval VM</a></p>
<ul>
<li>Extract the vhdx file from the zip archive</li>
<li>Place it into your preferred directory for vhdx files (default = <code>C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\</code>)</li>
<li>Create a new virtual machine, and when choosing a hard disk point it to this vhdx file</li>
</ul>
<p>Make any additional changes after, like changing memory size and CPU count, before taking an initial snapshot.</p>
<h3 id="nested-virtualization">Nested Virtualization</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/nested-virtualization">What is Nested Virtualization?</a></li>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/enable-nested-virtualization">Enable Nested Virtualization</a></li>
</ul>
<p>For WSL2 to work within a Hyper-V guest you'll need to enable nested virtualization:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-VMProcessor</span> <span class="n">-VMName</span> <span class="n">WinDev2308Eval</span> <span class="n">-ExposeVirtualizationExtensions</span> <span class="nv">$true</span>
</code></pre></div>
<h3 id="share-resources">Share Resources</h3>
<p><em>Sharing resources between the guest and host.</em></p>
<h4 id="clipboard">Clipboard</h4>
<p>Connecting over an Enhanced Sessions allows you to copy and paste text or files into the guest like you would on the host.</p>
<ul>
<li>When connected over an Enhanced Session, the guest can access and set the host's clipboard</li>
<li>You cannot initiate a copy or paste from a guest to the host (meaning there's no API the guest processes can use to initiate changes to the host)</li>
<li>The host and hypervisor control the copy and paste functionality</li>
</ul>
<p>The guest VM cannot access the host clipboard in the following cases:</p>
<ul>
<li>When the VM is Paused</li>
<li>While you're disconnected from the session but the VM is still running</li>
<li>When connected over a Basic Session</li>
</ul>
<h4 id="session-settings">Session Settings</h4>
<p>Adjusting session settings:</p>
<ul>
<li>When connecting to a VM and you're setting a display pixel size, instead choose <code>Show Options</code></li>
<li>Make changes under the Display tab</li>
<li>Make changes under the Local Resources tab &gt; <code>Settings...</code> / <code>More...</code></li>
</ul>
<p>Save these settings to always reconnect with them automatically applied in the future:</p>
<ul>
<li>After choosing <code>Show Options</code>, look at the bottom of the Display tab</li>
<li>Check <code>Save my settings for future connections to this virtual machine</code></li>
</ul>
<p>If you ever need to revise these settings:</p>
<ul>
<li>Open Hyper-V Manager</li>
<li>Select the VM, choose <code>Edit Session Settings...</code></li>
</ul>
<h4 id="share-folders-local-drives">Share Folders, Local Drives</h4>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/learn-more/Use-local-resources-on-Hyper-V-virtual-machine-with-VMConnect">Share Local Resources with a VM</a></li>
</ul>
<p>This isn't as granular as what VMware offers, but it works without networking:</p>
<ul>
<li>When connecting to a VM and you're setting a display pixel size, instead choose "Show Options"</li>
<li>Local Resources &gt; Local devices and resources &gt; More &gt; Drives</li>
</ul>
<p>You'll need to dedicate an entire drive mount to be shared, it's also R/W by default. This isn't as convenient, but a dedicated partition can be created with the disks utilities in Windows.</p>
<h3 id="create-a-malware-analysis-vm">Create a Malware Analysis VM</h3>
<p>First review Microsoft's security checklist for both the Hyper-V host and guest VM's.</p>
<p><em>Note that not everything will apply to this use case.</em></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/plan/plan-hyper-v-security-in-windows-server">Hyper-V Security Checklist</a></li>
</ul>
<p>Next move on to the following resources and steps:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/about/">Hyper-V Intro</a></li>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/reference/hyper-v-architecture">Hyper-V Architecture</a></li>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/reference/integration-services">Hyper-V Integration Services</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/plan/plan-hyper-v-networking-in-windows-server">Hyper-V Networking</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/learn-more/Use-local-resources-on-Hyper-V-virtual-machine-with-VMConnect">Share Local Resources with a VM</a></li>
<li><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/enhanced-session-mode">Share Devices with a VM</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb">Connect USB Devices (to WSL2)</a><ul>
<li><a href="https://github.com/dorssel/usbipd-win">usbipd: Share USB Devices with Hyper-V and WSL2</a></li>
</ul>
</li>
<li><a href="https://zeltser.com/free-malware-analysis-windows-vm/">Zeltser: Malware Analysis VM Quick Start</a></li>
<li><a href="https://zeltser.com/build-malware-analysis-toolkit/">Zeltser: Malware Analysis VM Detailed Setup</a></li>
</ul>
<p>Review the following VM settings:</p>
<ul>
<li>[ ] Settings &gt; Hardware &gt; SCSI Controller, check for any shared drives or disk drives</li>
<li>[ ] Settings &gt; Hardware &gt; Network Adapter, ensure the correct adapter is connected<ul>
<li>You likely want a Private Virtual Switch that's entirely logical and not connected to the host</li>
<li>Virtual Switch Manager &gt; New virtual network switch &gt; Private &gt; Create Virtual Switch, give it a name like "Analysis", click Apply</li>
</ul>
</li>
<li>[ ] Settings &gt; Management &gt; Integration Services &gt; uncheck everything here</li>
<li>[ ] Settings &gt; Hardware &gt; Security &gt; Enable Shielding for Windows guests, Linux guests may have issues with this feature</li>
</ul>
<p>Review the following resources when connecting to the VM (RDP Enhanced Session):</p>
<ul>
<li>[ ] When connecting, you'll see a "Display configuration" menu window to configure screen size, choose "Show Options", then the Local Resources tab</li>
<li>[ ] Uncheck any items you do not wish to share (likely all of them in this case)</li>
<li>[ ] Local Resources &gt; uncheck all</li>
<li>[ ] Local Resources &gt; Remote Audio &gt; Settings &gt; Do not play / Do not record</li>
<li>[ ] Local Resources &gt; Local devices and resources &gt; More &gt; uncheck all</li>
</ul>
<p>What session type to use:</p>
<ul>
<li>Enhanced: With all Integration Services disabled, and not sharing any local resources, you can still connect with Clipboard support for general pentesting</li>
<li>Basic: With all of the above steps followed to disable everything, you'd typically do setup with an Enhanced Session and reconnect via Basic to detonate malware</li>
</ul>
<h3 id="hyper-v-troubleshooting">Hyper-V Troubleshooting</h3>
<p>There are a number of issues with managing networking in Hyper-V. These items are listed in order of what's most common to least common.</p>
<h4 id="hyper-v-default-switch-has-no-dhcp">Hyper-V Default Switch has no DHCP</h4>
<p><em>NOTE: The Default Switch is supposed to provide DHCP to connected guests, however it often doesn't if strict firewall rules are in place.</em></p>
<p>Guests aren't assigned an IP address when connected to the Default Switch. This requires manually logging into the guest and assigning network information. What makes this more complicated is the subnet and gateway for this swtich changes every time the system reboots.</p>
<p><a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/setup-nat-network#create-a-nat-virtual-network">Creating a NAT virtual internal network</a> with a static IP essentially solves this problem. It does not do DHCP, which the Default Switch appears to no longer do in some cases, but when guests are assigned static IP and route information you no longer need to update it on each reboot since this NAT network stays static. The tradeoff if you can only have one NAT network like this per host, so if you have an application that requires a custom NAT network to function, this may not work for you.</p>
<p>With that said, if <code>Get-NetNat</code> returns no interfaces, you can create a custom NAT switch and network using the following:</p>
<ul>
<li>10.55.55.1/24 is chosen since it's relatively obscure and unique, meaning it won't collide with common home wifi, office, or Hyper-V subnets</li>
<li>SOHO routers will often default to the range of 192.168.0.0/16</li>
<li>Hyper-V tends to use the subnet range of 172.16.0.0/12</li>
<li>VPNs and corporate networks will use the range of 10.0.0.0/8, be sure to review any existing network configurations or requirements before using 10.55.55.1/24</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">New-VMSwitch</span> <span class="n">-SwitchName</span> <span class="s2">&quot;CustomNATSwitch&quot;</span> <span class="n">-SwitchType</span> <span class="n">Internal</span>
<span class="nv">$ifindex</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-NetAdapter</span> <span class="n">-IncludeHidden</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s2">&quot;vEthernet (CustomNATSwitch)&quot;</span> <span class="p">}).</span><span class="n">ifIndex</span>
<span class="nb">New-NetIPAddress</span> <span class="n">-IPAddress</span> <span class="n">10</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">1</span> <span class="n">-PrefixLength</span> <span class="n">24</span> <span class="n">-InterfaceIndex</span> <span class="nv">$ifindex</span>
<span class="nb">New-NetNat</span> <span class="n">-Name</span> <span class="n">CustomNATNetwork</span> <span class="n">-InternalIPInterfaceAddressPrefix</span> <span class="n">10</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
</code></pre></div>
<p>To remove the NAT network and switch:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetNat</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s2">&quot;CustomNATNetwork&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Remove-NetNat</span>
<span class="nb">Get-VMSwitch</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">SwitchName</span> <span class="o">-eq</span> <span class="s2">&quot;CustomNATSwitch&quot;</span> <span class="p">|</span> <span class="nb">Remove-VMSwitch</span>
</code></pre></div>
<p>If you want to be able to reach VM's on this switch from the host or WSL, you'll need to enable forwarding, as mentioned above in the section titled <a href="#communicating-with-hyper-v">Communicating with Hyper-V</a>. Just remember, the Windows host is likely filtering <code>ping</code> packets. Try <code>ssh</code>, <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-ps"><code>Test-NetConnection</code></a>, <a href="https://nmap.org/"><code>nmap</code></a>, or <a href="https://github.com/projectdiscovery/naabu"><code>naabu</code></a> to verify connectivity.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Apply</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (CustomNATSwitch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Enabled</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Enabled</span>

<span class="c"># Remove</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (CustomNATSwitch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Disabled</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Disabled</span>
</code></pre></div>
<p><strong>Use case</strong>: a router VM like pfSense or Ubuntu Server with static "WAN" IP can be assigned and use this custom NAT switch.</p>
<ul>
<li>The "router" VM will always have public internet access via NAT</li>
<li>Connect other VM's to the "router" VM's "LAN" interfaces, if it's running as a router it will handle DHCP and more if configured to do so</li>
</ul>
<h4 id="hyper-v-network-performance-issues">Hyper-V Network Performance Issues</h4>
<p><em>The easiest and safest test is Google's built in speed test, just search for it in Google.</em></p>
<ul>
<li>If you have a guest networked behind another guest in a Private Network, it may have reduced network speed; move it to the vEthernet Default Switch<ul>
<li>In one case, guests were networked behind a pfSense VM</li>
<li>Performance was generally fine for weeks until one day it dropped to unusable speeds</li>
<li>Traffic path was VM -&gt; pfSense LAN (Hyper-V Private Switch) -&gt; pfSense WAN (Hyper-V Default Switch) -&gt; Public Internet</li>
<li>pfSense VM wasn't low on resources, had normal network speed from it's WAN side (ping)</li>
<li>All guests experienced this, and had normal performance when directly networked to the vEthernet Hyper-V switch instead</li>
</ul>
</li>
<li><a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/poor-network-performance-hyper-v-host-vm">Poor Network Performance on VM's if VMQ is Enabled</a><ul>
<li>Disable VMQ (set value to 0)</li>
<li>Set a static MAC address</li>
</ul>
</li>
</ul>
<h4 id="hyper-v-default-network-doesnt-have-internet-access">Hyper-V Default Network doesn't have internet access</h4>
<p>This appeared solved, but continues to behave strangely. I wanted to document this as I continue to use Hyper-V.</p>
<p>Symptoms:
- Hyper-V Default Switch does not have an IP address according to <code>Get-VMNetworkAdapter -ManagementOS</code> (but shows one under <code>ipconfig</code>)
- Hyper-V Default Switch shows as "Status: Operational" but "Connectivity IPv4/6: Disconnected" under Setting &gt; Network &amp; Internet &gt; Advanced network settings &gt; Hardware and connection properties
- "Hyper-V Extensible Virtual Switch" cannot be checked under Control Panel &gt; Network and Internet &gt; Network Connections &gt; Right-Click Interface &gt; Properties</p>
<p>Tried:
- Updating NIC driver (this appeared to work until two reboots later, so it may have "started" something on the system, or it was just behaving normally that time)
- <code>Get-Service vmms | Restart-Service</code>
- Enable "Hyper-V Extensible Virtual Switch" under the NIC properties (it doesn't allow you to enable it, and alerts you that it must be disabled)
- Disable the ethernet adapter port and reboot</p>
<p>What's worked:
- Assigning a static IP and route manually within the guest VM</p>
<p>Here's how you can do this with <code>ip</code> (temporarily):
<div class="highlight"><pre><span></span><code><span class="c1"># Flush the interface information to start over, do this no matter which option you choose</span>
sudo<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>flush<span class="w"> </span>dev<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEV_NAME</span><span class="s2">&quot;</span><span class="w"> </span>scope<span class="w"> </span>global

<span class="nv">DEV_NAME</span><span class="o">=</span><span class="s1">&#39;eth0&#39;</span>
<span class="nv">IP4_ADDR</span><span class="o">=</span><span class="s1">&#39;172.26.240.13&#39;</span>
<span class="nv">IP4_CIDR</span><span class="o">=</span><span class="s1">&#39;20&#39;</span>
<span class="nv">IP4_GATEWAY</span><span class="o">=</span><span class="s1">&#39;172.26.240.1&#39;</span>

<span class="c1"># Flush the interface information to start over, do this no matter which option you choose</span>
sudo<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>flush<span class="w"> </span>dev<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEV_NAME</span><span class="s2">&quot;</span><span class="w"> </span>scope<span class="w"> </span>global
sudo<span class="w"> </span>ip<span class="w"> </span>address<span class="w"> </span>add<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$IP4_ADDR</span><span class="s2">&quot;</span>/<span class="s2">&quot;</span><span class="nv">$IP4_CIDR</span><span class="s2">&quot;</span><span class="w"> </span>dev<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEV_NAME</span><span class="s2">&quot;</span>
sudo<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$IP4_GATEWAY</span><span class="s2">&quot;</span><span class="w"> </span>dev<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEV_NAME</span><span class="s2">&quot;</span>
</code></pre></div></p>
<p>Or <code>nmcli</code> (persists reboots):
<div class="highlight"><pre><span></span><code><span class="c1"># Flush the interface information to start over, do this no matter which option you choose</span>
sudo<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>flush<span class="w"> </span>dev<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEV_NAME</span><span class="s2">&quot;</span><span class="w"> </span>scope<span class="w"> </span>global

<span class="c1"># &quot;$CONN_NAME&quot; is the connection profile name tied to your &quot;$DEV_NAME&quot;</span>
<span class="c1"># Obtain all current profile names with `nmcli connection show`</span>
sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>modify<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONN_NAME</span><span class="s2">&quot;</span><span class="w"> </span>ipv4.addresses<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$IP4_ADDR</span><span class="s2">&quot;</span>/<span class="s2">&quot;</span><span class="nv">$IP4_CIDR</span><span class="s2">&quot;</span>
sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>modify<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONN_NAME</span><span class="s2">&quot;</span><span class="w"> </span>ipv4.gateway<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$IP4_GATEWAY</span><span class="s2">&quot;</span>
sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>modify<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONN_NAME</span><span class="s2">&quot;</span><span class="w"> </span>connection.autoconnect<span class="w"> </span>yes
</code></pre></div></p>
<ul>
<li>Rebooting a VM until it "wakes up" the Default Switch in Hyper-V (this appears to work, allowing me to assign a static IP from within the guest)</li>
<li>Restarting the <code>NetworkManager</code> service (or your equivalent) from within a guest</li>
<li>Hyper-V Default Switch still shows "Connectivity IPv4/6: Disconnected" even when it's working</li>
<li>Hyper-V Extensible Virtual Switch is still unchecked even when it's working</li>
</ul>
<h2 id="powershell">PowerShell</h2>
<h3 id="powershell-versions">PowerShell Versions</h3>
<ul>
<li>Recent PowerShell versions since v2 have improved security features</li>
<li>v2 can still be found installed on some systems, even if v5 is the default</li>
<li><a href="https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/">Lee Holmes: Detecting and Preventing PowerShell Downgrade Attacks</a></li>
</ul>
<p>Version downgrade attacks:</p>
<div class="highlight"><pre><span></span><code><span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-v</span> <span class="n">2</span> <span class="n">-command</span> <span class="s2">&quot;...&quot;</span>
</code></pre></div>
<p>Disable PowerShell v2 (if nothing in your environment relies on it):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="p">|</span> <span class="nb">where </span><span class="n">FeatureName</span> <span class="o">-Like</span> <span class="n">MicrosoftWindowsPowerShellV2</span> <span class="p">|</span> <span class="nb">Disable-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="n">-NoRestart</span> <span class="n">-WarningAction</span> <span class="k">Continue</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$nul</span>
<span class="nb">Get-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="p">|</span> <span class="nb">where </span><span class="n">FeatureName</span> <span class="o">-Like</span> <span class="n">MicrosoftWindowsPowerShellV2Root</span> <span class="p">|</span> <span class="nb">Disable-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="n">-NoRestart</span> <span class="n">-WarningAction</span> <span class="k">Continue</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$nul</span>
</code></pre></div>
<h3 id="script-execution">Script Execution</h3>
<ul>
<li><code>Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell"</code></li>
<li>
<p><code>Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on Script Execution</code></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.3#use-group-policy-to-manage-execution-policy">Set Script Execution via GPO</a></p>
</li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.3#manage-signed-and-unsigned-scripts">Manage Signed and Unsigned Scripts</a></li>
</ul>
<table>
<thead>
<tr>
<th>Group Policy</th>
<th>Execution Policy</th>
</tr>
</thead>
<tbody>
<tr>
<td>Allow all scripts</td>
<td>Unrestricted</td>
</tr>
<tr>
<td>Allow local scripts and remote signed scripts</td>
<td>RemoteSigned</td>
</tr>
<tr>
<td>Allow only signed scripts</td>
<td>AllSigned</td>
</tr>
<tr>
<td>Disabled</td>
<td>Restricted</td>
</tr>
</tbody>
</table>
<p><em>If script execution is set to <code>RemoteSigned</code>, you can unblock a PowerShell script downloaded from the internet to run it with <code>Unblock-File</code>.</em></p>
<p>Set Script Execution to RemoteSigned:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$null</span> <span class="p">=</span> <span class="nb">New-Item</span> <span class="nv">$basePath</span> <span class="n">-Force</span>
<span class="p">}</span>

<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScripts</span> <span class="n">-Value</span> <span class="s2">&quot;1&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">ExecutionPolicy</span> <span class="n">-Value</span> <span class="s2">&quot;RemoteSigned&quot;</span>
</code></pre></div>
<p>Remove Script Execution Policy:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScripts</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">ExecutionPolicy</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="powershell-language-mode">PowerShell Language Mode</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.3">About Language Modes</a></li>
<li><a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">DevBlogs: Constrained Language Mode</a></li>
</ul>
<p>Get current Language Mode:
<div class="highlight"><pre><span></span><code><span class="nv">$ExecutionContext</span><span class="p">.</span><span class="n">SessionState</span><span class="p">.</span><span class="n">LanguageMode</span>
</code></pre></div></p>
<h3 id="powershell-jea">PowerShell JEA</h3>
<p><em>Just Enough Admin</em></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview?view=powershell-7.3">JEA Overview</a></li>
</ul>
<h3 id="powershell-protected-event-logging">PowerShell Protected Event Logging</h3>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#protected-event-logging">Protected Event Logging</a></p>
<ul>
<li>Requires a public key be made and distributed to all machines</li>
<li>Some applications that participate in Protected Event Logging will encrypt log data with your public key</li>
<li>Ship logs to a central SIEM, where they can be decrypted</li>
</ul>
<h2 id="winget">Winget</h2>
<p>The Windows Package Manager</p>
<ul>
<li>https://github.com/microsoft/winget-cli/releases</li>
<li>https://learn.microsoft.com/en-us/windows/package-manager/winget/</li>
</ul>
<h3 id="install_1">Install</h3>
<p>Winget appears to be available by default on Windows 11 now. But it's not available by default in Windows Sandbox instances or Windows Server.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/package-manager/winget/#install-winget-on-windows-sandbox">Install the latest version of Winget in Windows Sandbox (or anywhere programmatically)</a>:</p>
<div class="admonition note">
<p class="admonition-title">If the Install Fails</p>
<p>Be sure to check the link above for the latest URI paths if any component was updated since writing this, otherwise the install may fail.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="nv">$progressPreference</span> <span class="p">=</span> <span class="s1">&#39;silentlyContinue&#39;</span>
<span class="nb">Write-Information</span> <span class="s2">&quot;Downloading WinGet and its dependencies...&quot;</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">https</span><span class="p">://</span><span class="n">aka</span><span class="p">.</span><span class="n">ms</span><span class="p">/</span><span class="n">getwinget</span> <span class="n">-OutFile</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">DesktopAppInstaller_8wekyb3d8bbwe</span><span class="p">.</span><span class="n">msixbundle</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">https</span><span class="p">://</span><span class="n">aka</span><span class="p">.</span><span class="n">ms</span><span class="p">/</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">VCLibs</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">14</span><span class="p">.</span><span class="n">00</span><span class="p">.</span><span class="n">Desktop</span><span class="p">.</span><span class="n">appx</span> <span class="n">-OutFile</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">VCLibs</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">14</span><span class="p">.</span><span class="n">00</span><span class="p">.</span><span class="n">Desktop</span><span class="p">.</span><span class="n">appx</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">microsoft</span><span class="p">/</span><span class="n">microsoft-ui-xaml</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v2</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">3</span><span class="p">/</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">UI</span><span class="p">.</span><span class="n">Xaml</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">appx</span> <span class="n">-OutFile</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">UI</span><span class="p">.</span><span class="n">Xaml</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">appx</span>
<span class="nb">Add-AppxPackage</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">VCLibs</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">14</span><span class="p">.</span><span class="n">00</span><span class="p">.</span><span class="n">Desktop</span><span class="p">.</span><span class="n">appx</span>
<span class="nb">Add-AppxPackage</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">UI</span><span class="p">.</span><span class="n">Xaml</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">appx</span>
<span class="nb">Add-AppxPackage</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">DesktopAppInstaller_8wekyb3d8bbwe</span><span class="p">.</span><span class="n">msixbundle</span>
</code></pre></div>
<blockquote>
<p>If you would like a preview or different version of the Package Manager, go to https://github.com/microsoft/winget-cli/releases. Copy the URL of the version you would prefer and update the above Uri.</p>
</blockquote>
<div class="admonition tip">
<p class="admonition-title">Installing on Windows Server</p>
<p>If installing winget on an evaluation copy of Windows Server, you will need to download the msixbundle file and license xml file from GitHub's release page. Otherwise you'll get a license error.</p>
<p>See <a href="https://github.com/microsoft/winget-cli/issues/700#issuecomment-874084714">issue #700</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Download the msixbundle and xml license file from the latest releases.</span>
<span class="c"># https://github.com/microsoft/winget-cli/releases</span>
<span class="c"># Use Add-AppxProvisionedPackage to use the -LicensePath argument.</span>
<span class="nb">Add-AppxProvisionedPackage</span> <span class="n">-Online</span> <span class="n">-PackagePath</span> <span class="p">.\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">DesktopAppInstaller_8wekyb3d8bbwe</span><span class="p">.</span><span class="n">msixbundle</span> <span class="n">-LicensePath</span> <span class="p">.\</span><span class="n">08d8788d59cf47ed9bf42c31e31f8efa_License1</span><span class="p">.</span><span class="n">xml</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>To pull the latest release and install it automatically:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$progressPreference</span> <span class="p">=</span> <span class="s1">&#39;silentlyContinue&#39;</span>
<span class="nv">$url</span> <span class="p">=</span> <span class="s2">&quot;https://api.github.com/repos/microsoft/winget-cli/releases/latest&quot;</span>
<span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;$url&quot;</span>
<span class="c"># You need to use ConvertTo-Json to &quot;see&quot; the full structure and obtain the path</span>
<span class="c">#$response_json = $response | ConvertTo-Json</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$link</span> <span class="k">in</span> <span class="nv">$response</span><span class="p">.</span><span class="n">assets</span><span class="p">.</span><span class="n">browser_download_url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$basename</span> <span class="p">=</span> <span class="nv">$link</span> <span class="p">|</span> <span class="nb">Split-Path</span> <span class="n">-leaf</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;Downloading $basename...&quot;</span>
    <span class="nb">iwr </span><span class="n">-Uri</span> <span class="nv">$link</span> <span class="n">-Out</span> <span class="nv">$basename</span>
    <span class="c"># Get the necessary files as variables</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$basename</span> <span class="o">-imatch</span> <span class="s2">&quot;msixbundle&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$msixbundle_file</span> <span class="p">=</span> <span class="nv">$basename</span>
    <span class="p">}</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$basename</span> <span class="o">-imatch</span> <span class="s2">&quot;License1.xml&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$license_file</span> <span class="p">=</span> <span class="nv">$basename</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c"># Now with all files downloaded, install the msixbundle</span>
<span class="nb">Add-AppxProvisionedPackage</span> <span class="n">-Online</span> <span class="n">-PackagePath</span> <span class="nv">$msixbundle_file</span> <span class="n">-LicensePath</span> <span class="nv">$license_file</span> <span class="n">-Verbose</span>
</code></pre></div>
</div>
<h3 id="installing-git">Installing Git</h3>
<ul>
<li><a href="https://git-scm.com/download/win">git-scm.com/download/win</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">show</span> <span class="p">-</span><span class="n">-id</span> <span class="n">Git</span><span class="p">.</span><span class="n">Git</span>
<span class="n">winget</span> <span class="n">install</span> <span class="p">-</span><span class="n">-id</span> <span class="n">Git</span><span class="p">.</span><span class="n">Git</span> <span class="n">-e</span> <span class="p">-</span><span class="n">-source</span> <span class="n">winget</span>
</code></pre></div>
<h3 id="installing-open-ssh-beta">Installing Open SSH Beta</h3>
<ul>
<li><a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH">github.com/PowerShell/Win32-OpenSSH</a></li>
</ul>
<p>The beta version of OpenSSH is part of the PowerShell project and often contains additional (essential) features missing from the stable version.</p>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">search</span> <span class="s2">&quot;openssh beta&quot;</span>
<span class="n">winget</span> <span class="n">install</span> <span class="s2">&quot;openssh beta&quot;</span>
<span class="n">winget</span> <span class="n">uninstall</span> <span class="s2">&quot;openssh beta&quot;</span>
</code></pre></div>
<h3 id="installing-windows-terminal">Installing Windows Terminal</h3>
<ul>
<li><a href="https://github.com/microsoft/terminal?tab=readme-ov-file#via-windows-package-manager-cli-aka-winget">github.com/microsoft/terminal</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">install</span> <span class="p">-</span><span class="n">-id</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">WindowsTerminal</span> <span class="n">-e</span>
</code></pre></div>
<h3 id="install-usbipd">Install USBIPD</h3>
<ul>
<li><a href="https://github.com/dorssel/usbipd-win">github.com/dorssel/usbipd-win</a></li>
</ul>
<p>This project is being developed to allow TCP/IP passthrough of USB devices to WSL2 and Hyper-V VM's on Windows.</p>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">install</span> <span class="p">-</span><span class="n">-interactive</span> <span class="p">-</span><span class="o">-exact</span> <span class="n">dorssel</span><span class="p">.</span><span class="n">usbipd-win</span>
</code></pre></div>
<h2 id="user-accounts">User Accounts</h2>
<h3 id="active-directory_1">Active Directory</h3>
<p>To do</p>
<h3 id="local-system">Local System</h3>
<p><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/new-localuser?view=powershell-5.1">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/new-localuser?view=powershell-5.1</a></p>
<ol>
<li>Create a local user
<div class="highlight"><pre><span></span><code><span class="nv">$Password</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="n">-AsSecureString</span>
<span class="nb">New-LocalUser</span> <span class="s2">&quot;User2&quot;</span> <span class="n">-Password</span> <span class="nv">$Password</span> <span class="n">-FullName</span> <span class="s2">&quot;Second User&quot;</span> <span class="n">-Description</span> <span class="s2">&quot;Description of this account.&quot;</span>
<span class="n">Name</span>    <span class="n">Enabled</span>  <span class="n">Description</span>
<span class="p">----</span>    <span class="p">-------</span>  <span class="p">-----------</span>
<span class="n">User2</span>  <span class="n">True</span>     <span class="n">Description</span> <span class="n">of</span> <span class="n">this</span> <span class="n">account</span><span class="p">.</span>
</code></pre></div></li>
</ol>
<p><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/add-localgroupmember?view=powershell-5.1">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/add-localgroupmember?view=powershell-5.1</a></p>
<ol>
<li>Add the local user to a group; add them to "Users" so they may login</li>
</ol>
<p>Add a local user to the Users group
<div class="highlight"><pre><span></span><code><span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="s2">&quot;Users&quot;</span> <span class="n">-Member</span> <span class="n">User2</span>
</code></pre></div></p>
<p>Add a local user to the Administrators group (only do this if <a href="#uac-prompt">UAC</a> is configured correctly and the account will only be used for administration)
<div class="highlight"><pre><span></span><code><span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="s2">&quot;Administrators&quot;</span> <span class="n">-Member</span> <span class="n">User2</span>
</code></pre></div></p>
<p>You can run commands as another user, you'll be prompted for a password similar to <code>sudo</code>:
<div class="highlight"><pre><span></span><code><span class="n">runas</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">User2</span> <span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>
<span class="n">runas</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Hostname</span><span class="p">\</span><span class="n">DomainUser2</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ep</span> <span class="n">bypass</span> <span class="n">-nop</span> <span class="n">-w</span> <span class="n">hidden</span> <span class="nb">iex </span><span class="p">&lt;</span><span class="n">payload</span><span class="p">&gt;</span>
<span class="n">runas</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Domain</span><span class="p">\</span><span class="n">DomainUser2</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ep</span> <span class="n">bypass</span> <span class="n">-nop</span> <span class="n">-w</span> <span class="n">hidden</span> <span class="nb">iex </span><span class="p">&lt;</span><span class="n">payload</span><span class="p">&gt;</span>
</code></pre></div></p>
<p>See <a href="https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/windows-local-privilege-escalation/access-tokens.md#credentials-user-impersonation">HackTricks - Credential User Impersonation</a> for more on this.</p>
<h3 id="account-policy">Account Policy</h3>
<p>To do</p>
<h3 id="honey-accounts">Honey Accounts</h3>
<p>References:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=1w0btuMAvZk">ippsec - Creating Webhooks in Slack for PowerShell</a></li>
<li><a href="https://www.youtube.com/watch?v=J9owPmgmfvo">ippsec - Send Notifications to Slack via Scheduled Task Event Filter</a></li>
<li><a href="https://github.com/strandjs/IntroLabs/blob/master/IntroClassFiles/Tools/IntroClass/honeyuser/honeyuser.md">Active Defense &amp; Cyber Deception - Honey User</a></li>
</ul>
<p>How this works:</p>
<ul>
<li>Create a new user account that will never be used for production</li>
<li>Create an alert to trigger on <em>any</em> attempt to login to this account</li>
<li>Periodically login to this account and update it's password so it's not obvious it's a honey account when adversaries enumerate your AD environment</li>
</ul>
<p>This will detect password spraying. A smaller organization would benefit from having this configured to use Slack or Discord for notifications, where a SIEM would be the better option on a larger scale.</p>
<h2 id="uac-prompt">UAC Prompt</h2>
<p>What the UAC prompt is and how / why it works:</p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-account-control-behavior-of-the-elevation-prompt-for-standard-users#best-practices">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-account-control-behavior-of-the-elevation-prompt-for-standard-users#best-practices</a></p>
<blockquote>
<p>Countermeasure
Configure the User Account Control: Behavior of the elevation prompt for standard users to Automatically deny elevation requests. This setting requires the user to log on with an administrative account to run programs that require elevation of privilege. As a security best practice, standard users should not have knowledge of administrative passwords. However, if your users have both standard and administrator-level accounts, we recommend setting Prompt for credentials so that the users do not choose to always log on with their administrator accounts, and they shift their behavior to use the standard user account.</p>
</blockquote>
<p>What the Secure Desktop is and how / why it works:</p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-account-control-switch-to-the-secure-desktop-when-prompting-for-elevation#best-practices">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-account-control-switch-to-the-secure-desktop-when-prompting-for-elevation#best-practices</a></p>
<blockquote>
<p>Enable the User Account Control: Switch to the secure desktop when prompting for elevation setting. The secure desktop helps protect against input and output spoofing by presenting the credentials dialog box in a protected section of memory that is accessible only by trusted system processes.</p>
</blockquote>
<p>The secure desktop will obscure the entire desktop behind the prompt, where instead the 'insecure' prompt will leave all of the desktop windows visible.</p>
<p>You can see the difference by changing this value (0x1=enabled, 0x0=disabled) here:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Enabled</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;PromptOnSecureDesktop&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x1&quot;</span>
<span class="c"># Disabled</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;PromptOnSecureDesktop&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x0&quot;</span>
</code></pre></div>
<p>You can easily test if UAC is enabled for administrative actions by running the following:</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/authentication-credentials-uac-and-efs.md#uac-disabled</span>
<span class="nb">Start-Process</span> <span class="n">powershell</span> <span class="n">-Verb</span> <span class="n">runAs</span> <span class="s2">&quot;notepad.exe&quot;</span>
</code></pre></div>
<p>If you are not prompted to allow <code>notepad</code> to run, then UAC is not enabled.</p>
<h3 id="uac-prompt-for-local-users">UAC Prompt for local users</h3>
<p>See the following documentation for guidance:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/12867da0-2e4e-4a4f-9dc4-84a7f354c8d9">Microsoft Docs, Open Specifications on all UAC settings</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-account-control-behavior-of-the-elevation-prompt-for-standard-users#best-practices">Microsoft Docs, UAC Best Practices</a></li>
<li><a href="https://devblogs.microsoft.com/oldnewthing/20160816-00/?p=94105">DevBlogs, UAC Settings</a></li>
<li><a href="https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/authentication-credentials-uac-and-efs.md#uac">HackTricks, UAC Bypass</a></li>
<li><a href="https://www.fuzzysecurity.com/tutorials/27.html">FuzzySecurity, UAC Attacks</a></li>
</ul>
<p><strong>Summary</strong></p>
<p>If these are not set, you are potentially vulnerable to UAC bypass:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Check if UAC is active in Admin Approval Mode (value of 1) or inactive (value of 0), you will always want this active</span>
<span class="c"># https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/958053ae-5397-4f96-977f-b7700ee461ec</span>
<span class="nb">Get-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;EnableLUA&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;EnableLUA&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x1&quot;</span>

<span class="c"># Ensure all UAC prompts happen via the secure desktop prompt</span>
<span class="c"># https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/9ad50fd3-4d8d-4870-9f5b-978ce292b9d8</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;PromptOnSecureDesktop -Type DWord -Value &quot;</span><span class="n">0x1</span><span class="s2">&quot;</span>

<span class="s2"># Require credentials when running as Admin</span>
<span class="s2"># https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/341747f5-6b5d-4d30-85fc-fa1cc04038d4</span>
<span class="s2">Set-ItemProptery -Path &quot;</span><span class="n">HKLM</span><span class="p">:\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">Policies</span><span class="p">\</span><span class="n">System</span><span class="s2">&quot; -Name &quot;</span><span class="n">ConsentPromptBehaviorAdmin</span><span class="s2">&quot; -Type DWord -Value &quot;</span><span class="n">0x1</span><span class="s2">&quot;</span>

<span class="s2"># Deny all elevation for standard users</span>
<span class="s2"># https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/15f4f7b3-d966-4ff4-8393-cb22ea1c3a63</span>
<span class="s2">Set-ItemProperty -Path &quot;</span><span class="n">HKLM</span><span class="p">:\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">Policies</span><span class="p">\</span><span class="n">System</span><span class="s2">&quot; -Name &quot;</span><span class="n">ConsentPromptBehaviorUser</span><span class="s2">&quot; -Type DWord -Value &quot;</span><span class="n">0x0</span><span class="s2">&quot;</span>
<span class="s2"># Require credentials for standard users</span>
<span class="s2">Set-ItemProperty -Path &quot;</span><span class="n">HKLM</span><span class="p">:\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">Policies</span><span class="p">\</span><span class="n">System</span><span class="s2">&quot; -Name &quot;</span><span class="n">ConsentPromptBehaviorUser</span><span class="s2">&quot; -Type DWord -Value &quot;</span><span class="n">0x1</span><span class="s2">&quot;</span>
</code></pre></div>
<p>The recommended setting is to automatically deny elevation of privileges to standard users.</p>
<p>If a user regularly requires administrative access, it's recommended to instead prompt for admin credentials. This way administrative tasks are performed only when needed, and the account is otherwise running in the context of a standard user.</p>
<ul>
<li><code>0x0</code> = Automatically deny (all UAC actions require logging in as admin, best)</li>
<li><code>0x1</code> = Prompt for credentials on the secure desktop (recommended if not 0x0)</li>
<li><code>0x2</code> = Prompt for credentials (Default)</li>
</ul>
<p>This setting prevents standard users from performing administrative actions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;ConsentPromptBehaviorUser&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x0&quot;</span>
</code></pre></div>
<p>Alternatively, this allows the user to elevate privileges temporarily using the separate administrative account's credentials:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;ConsentPromptBehaviorUser&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x1&quot;</span>
</code></pre></div>
<h3 id="uac-prompt-for-local-admins">UAC Prompt for local admins</h3>
<ul>
<li><code>0x0</code> = Elevate without prompting (perform admin actions automatically, dangerous)</li>
<li><code>0x1</code> = Prompt for credentials (username / password) on the secure desktop</li>
<li><code>0x2</code> = Prompt for interaction (y/n dialogue) on the secure desktop</li>
</ul>
<p>This will prompt the administrator account for any valid administrator credentials via the secure desktop to take actions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProptery</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;ConsentPromptBehaviorAdmin&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x1&quot;</span>
</code></pre></div>
<p>When logged in as an admin, this will prompt the user with a yes/no dialogue instead of credentials before performing actions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProptery</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;ConsentPromptBehaviorAdmin&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="s2">&quot;0x2&quot;</span>
</code></pre></div>
<h2 id="network">Network</h2>
<p>Display general network information
<div class="highlight"><pre><span></span><code>ipconfig
ipconfig /all
</code></pre></div></p>
<p>Flush the DNS cache
<div class="highlight"><pre><span></span><code>ipconfig /flushdns
</code></pre></div></p>
<p>Show all active protocols and connections
<div class="highlight"><pre><span></span><code>netstat -ano
</code></pre></div></p>
<p>Show the executable involved in creating all active protocols and connections
<div class="highlight"><pre><span></span><code>netstat -abno    # Requires Administrative privileges
</code></pre></div></p>
<p>Display the arp table
<div class="highlight"><pre><span></span><code>arp -a
</code></pre></div></p>
<p>Display the routing table
<div class="highlight"><pre><span></span><code>route print
</code></pre></div></p>
<p>Additional tools for network visibility:</p>
<ul>
<li><a href="https://www.wireshark.org/">https://www.wireshark.org/</a></li>
<li><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/tcpview">https://learn.microsoft.com/en-us/sysinternals/downloads/tcpview</a></li>
</ul>
<h3 id="troubleshooting_1">Troubleshooting</h3>
<p>Sometimes when trying to start a service on a specific port (<code>py -m http.server 8080 --bind &lt;your-ip&gt;</code>) you'll receive an error about lacking permissions even if you're running as administrator.</p>
<p><a href="https://stackoverflow.com/questions/10461257/an-attempt-was-made-to-access-a-socket-in-a-way-forbidden-by-its-access-permissi">https://stackoverflow.com/questions/10461257/an-attempt-was-made-to-access-a-socket-in-a-way-forbidden-by-its-access-permissi</a></p>
<p>This is often caused by a socket already being used by another service. Use <code>netstat</code> to review and remediate this:</p>
<div class="highlight"><pre><span></span><code><span class="n">NETSTAT</span><span class="p">.</span><span class="n">EXE</span> <span class="n">-abno</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;8080&quot;</span> <span class="n">-Context</span> <span class="n">2</span><span class="p">,</span><span class="n">2</span>

    <span class="n">TCP</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">7680</span>           <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">0</span>              <span class="n">LISTENING</span>       <span class="n">7176</span>
   <span class="n">Can</span> <span class="n">not</span> <span class="n">obtain</span> <span class="n">ownership</span> <span class="n">information</span>
<span class="p">&gt;</span>   <span class="n">TCP</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8080</span>           <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">0</span>              <span class="n">LISTENING</span>       <span class="n">2564</span>
   <span class="no">[spoolsv.exe]</span>
    <span class="n">TCP</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8443</span>           <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">0</span>              <span class="n">LISTENING</span>       <span class="n">2564</span>
    <span class="n">TCP</span>    <span class="p">[::]:</span><span class="n">7680</span>              <span class="p">[::]:</span><span class="n">0</span>                 <span class="n">LISTENING</span>       <span class="n">7176</span>
   <span class="n">Can</span> <span class="n">not</span> <span class="n">obtain</span> <span class="n">ownership</span> <span class="n">information</span>
<span class="p">&gt;</span>   <span class="n">TCP</span>    <span class="p">[::]:</span><span class="n">8080</span>              <span class="p">[::]:</span><span class="n">0</span>                 <span class="n">LISTENING</span>       <span class="n">2564</span>
   <span class="no">[spoolsv.exe]</span>
    <span class="n">TCP</span>    <span class="p">[::]:</span><span class="n">8443</span>              <span class="p">[::]:</span><span class="n">0</span>                 <span class="n">LISTENING</span>       <span class="n">2564</span>


<span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nb">Stop-Process</span> <span class="n">-Name</span> <span class="n">spoolsv</span>
</code></pre></div>
<p>In the above case, a meterpreter session had migrated to the <code>spoolsv.exe</code> process and was port forwarding traffic on tcp/8080.</p>
<h3 id="dns">DNS</h3>
<p><strong>DNS on Windows 11 Clients</strong></p>
<p>You can configure DNS over HTTPS for <em>all</em> interfaces with the following.</p>
<ul>
<li>"Settings" &gt; "Network &amp; internet"</li>
<li>Choose "Wi-Fi" or "Ethernet", depending on your current connection</li>
<li>Choose "Hardware properties" (you can also select the active network connection and under DNS settings choose <code>Change DNS settings for all networks</code>)</li>
<li>Choose "Edit" under the block with "DNS server assignment"</li>
<li>IPv4 &gt; On</li>
<li>Preferred DNS (can be Quad9 or Cloudflare, Windows has these templates built in now)</li>
<li>DNS over HTTPS &gt; On (automatic template)</li>
<li>This will autofill the URL for DoH connections</li>
<li>Ensure "Fallback to plaintext" &gt; Off</li>
</ul>
<p>When finished, you'll see <code>(Encrypted)</code> next to each DNS server entry.</p>
<p>You can fill out 2 IPv4 and 2 IPv6 DNS settings, and Windows will enforce this DNS configuration for every Wi-Fi or Ethernet network you connect to.</p>
<p>For an Active Directory client, you'll need at least <em>one</em> of the primary DNS servers to point to a domain-joined DNS server, with the fallback DNS being one of Cloudflare's or Quad9's public servers.</p>
<p><strong>DNS on Windows Server</strong></p>
<p><a href="https://docs.quad9.net/Setup_Guides/DNS_Forwarders/Windows_Server/">The Quad9 documentation demonstrates the steps required to configure Windows DNS Server for DNS forwarding</a>. You could replicate those steps for Google (<code>8.8.8.8</code>) and Cloudflare (<code>1.1.1.1</code>).</p>
<h3 id="firewall-rules">Firewall Rules</h3>
<p>Open Windows Defender Firewall from an elevated PowerShell prompt with:</p>
<div class="highlight"><pre><span></span><code><span class="n">wf</span><span class="p">.</span><span class="n">msc</span>
</code></pre></div>
<p>The way Windows Defender Firewall works is when it's enabled, the default policies take precedence, followed by any specific rules as exceptions.</p>
<p>When it's disabled, <em>no</em> rules work.</p>
<p>This means if you want to deploy a highly customized rule set, backup, then wipe the entire default rule set, set your default policies, then add your own rules.</p>
<p>In other words:</p>
<ul>
<li>If the default inbound policy is set to block, you will need to create inbound rules.</li>
<li>If the default inbound policy is set to allow, you will need to create block rules.</li>
</ul>
<p>If you're an admin on a machine using a low privileged account for regular use, and need to review the firewall GUI without logging out, you can open an administrative PowerShell prompt and run <code>C:\Windows\System32\WF.msc</code></p>
<p>Example baseline policy executed in <code>cmd.exe</code>:</p>
<div class="highlight"><pre><span></span><code>netsh advfirewall set allprofiles state on
netsh advfirewall set allprofiles firewallpolicy blockinboundalways,allowoutbound
netsh advfirewall set allprofiles logging droppedconnections enable
netsh advfirewall set allprofiles settings inboundusernotification enable
netsh advfirewall set allprofiles settings remotemanagement disable
netsh advfirewall set allprofiles logging maxfilesize 8000
netsh advfirewall set allprofiles logging filename %systemroot%\system32\LogFiles\Firewall\pfirewall.log

netsh advfirewall show currentprofile
</code></pre></div>
<p>Example baseline policy executed in <code>PowerShell</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://docs.microsoft.com/en-us/powershell/module/netsecurity/set-netfirewallprofile?view=windowsserver2022-ps</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-Enabled</span> <span class="n">True</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-DefaultInboundAction</span> <span class="n">Block</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-AllowInboundRules</span> <span class="n">True</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-AllowUnicastResponseToMulticast</span> <span class="n">False</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-NotifyOnListen</span> <span class="n">True</span> <span class="c"># Windows displays a notification when blocking an application</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-LogFileName</span> <span class="s2">&quot;%systemroot%\system32\LogFiles\Firewall\pfirewall.log&quot;</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-LogMaxSizeKilobytes</span> <span class="n">8000</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-LogAllowed</span> <span class="n">False</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-All</span> <span class="n">-LogBlocked</span> <span class="n">True</span>
<span class="nb">Set-NetConnectionProfile</span> <span class="n">-NetworkCategory</span> <span class="n">Public</span>
</code></pre></div>
<p><em>NOTE: these baselines are fairly close to the defaults, and are mainly for reference.</em></p>
<h3 id="managing-firewall-rules-powershell">Managing Firewall Rules (PowerShell)</h3>
<p>There are three different network profiles in Windows:</p>
<table>
<thead>
<tr>
<th>Profile</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Public</strong></td>
<td>Considered untrusted, similar to being publicly accessible on the internet</td>
</tr>
<tr>
<td><strong>Domain</strong></td>
<td>Considered trusted, typically a managed corporate network</td>
</tr>
<tr>
<td><strong>Private</strong></td>
<td>Considered trusted, a 'home' network</td>
</tr>
</tbody>
</table>
<p>Get information about all, or a specific, network profile:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallProfile</span>
<span class="nb">Get-NetFirewallProfile</span> <span class="n">-Name</span> <span class="n">Domain</span>
<span class="nb">Get-NetFirewallProfile</span> <span class="n">-Name</span> <span class="n">Private</span>
<span class="nb">Get-NetFirewallProfile</span> <span class="n">-Name</span> <span class="n">Public</span>
</code></pre></div></p>
<p>Get information about all network interfaces:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetConnectionProfile</span>
</code></pre></div></p>
<p>Sometimes you need to change the profile of a specific network interface, here's how with PowerShell:
<div class="highlight"><pre><span></span><code><span class="nb">Set-NetConnectionProfile</span> <span class="n">-InterfaceAlias</span> <span class="n">EthernetX</span> <span class="n">-NetworkCategory</span> <span class="n">Public</span>
</code></pre></div></p>
<p>This is important to manually configure on multi-homed and domain joined systems. It's possible Windows will automatically and incorrectly assign Public / Private networking profiles to the wrong interfaces, exposing services to untrusted networks.</p>
<p><em>NOTE: You can also review the active network profile per interface under Settings &gt; Network &amp; Internet &gt; EthernetX Properties.</em></p>
<p>Get general information about the firewall rules:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallProfile</span> <span class="n">-All</span>
<span class="nb">Get-NetFirewallRule</span> <span class="n">-All</span>
<span class="nb">Get-NetFirewallRule</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Enabled</span> <span class="n">True</span> <span class="n">-Action</span> <span class="n">Allow</span>
<span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">-Property</span> <span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">22</span>
</code></pre></div></p>
<p>Turn off the firewall for all profiles:
<div class="highlight"><pre><span></span><code><span class="nb">Set-NetFirewallProfile</span> <span class="n">-Enabled</span> <span class="n">False</span>
</code></pre></div></p>
<p>Enable the firewall on the Public profile:
<div class="highlight"><pre><span></span><code><span class="nb">Set-NetFirewallProfile</span> <span class="n">-Enabled</span> <span class="n">True</span> <span class="n">-Name</span> <span class="n">Public</span>
</code></pre></div></p>
<p>Add inbound rules for RDP and SSH:
<div class="highlight"><pre><span></span><code><span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;Remote Desktop&quot;</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-LocalPort</span> <span class="n">3389</span> <span class="n">-Action</span> <span class="n">Allow</span> <span class="n">-Enabled</span> <span class="n">True</span>
<span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;SSH&quot;</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-LocalPort</span> <span class="n">22</span> <span class="n">-Action</span> <span class="n">Allow</span> <span class="n">-Enabled</span> <span class="n">True</span>
</code></pre></div></p>
<p>Delete inbound rules for RDP and SSH:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;Remote Desktop&quot;</span> <span class="p">|</span> <span class="nb">Remove-NetFirewallRule</span>
<span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">22</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Get-NetFirewallRule</span> <span class="p">|</span> <span class="nb">where </span><span class="n">-Property</span> <span class="n">displayname</span> <span class="o">-Contains</span> <span class="s2">&quot;SSH&quot;</span> <span class="p">|</span> <span class="nb">Remove-NetFirewallRule</span>
</code></pre></div></p>
<p>Working with firewall rules in PowerShell on Windows is a bit strange because <code>-NetFirewallRule</code> results do not contain the same information as <code>-NetFirewallPortFilter</code> to parse. This means you'll need to use both (like the example above) and confirm the <code>DisplayName</code> or the more unique <code>Name</code> of the rule before deleting it, as multiple rules can exist for the same port. If you're not specific, and simply pipe all results out to <code>Remove-NetFirewallRule</code> you can end up unintentionally deleting additional rules.</p>
<p>You can be more specific to delete anything matching precise criteria like this:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">5353</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Get-NetFirewallRule</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Direction</span> <span class="o">-eq</span> <span class="s2">&quot;Inbound&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Action</span> <span class="o">-eq</span> <span class="s2">&quot;Allow&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Enabled</span> <span class="o">-eq</span> <span class="s2">&quot;True&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Profile</span> <span class="o">-eq</span> <span class="s2">&quot;Public&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-match</span> <span class="s2">&quot;mDNS&quot;</span><span class="p">}</span>
</code></pre></div></p>
<p>On a default Windows 10 install, this should match only a single rule. Append <code>| Remove-NetFirewallRule</code> to the above command to delete it.</p>
<p>Look for rules with specific ports:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">20</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">445</span> <span class="p">}</span>
</code></pre></div></p>
<p>Look for rules with specific ports, and print their related complete rule entry to parse further:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">20</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-eq</span> <span class="n">445</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Get-NetFirewallRule</span>
</code></pre></div></p>
<p>Look for rules within a range of ports:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallPortFilter</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-ge</span> <span class="n">20</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LocalPort</span> <span class="o">-le</span> <span class="n">445</span> <span class="p">}</span>
</code></pre></div></p>
<p>Load all active / allowed inbound port rules into the variable '$inboundrules':
<div class="highlight"><pre><span></span><code><span class="nv">$inboundrules</span> <span class="p">=</span> <span class="nb">Get-NetFirewallRule</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Direction</span> <span class="o">-like</span> <span class="s2">&quot;Inbound&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Action</span> <span class="o">-like</span> <span class="s2">&quot;Allow&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Enabled</span> <span class="o">-like</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></p>
<p>List firewall rule name + display name for all active / allowed inbound ports:
<div class="highlight"><pre><span></span><code><span class="nv">$inboundrules</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Name</span><span class="p">,</span><span class="n">DisplayName</span>
</code></pre></div></p>
<p>List all unique active / allowed  inbound ports:
<div class="highlight"><pre><span></span><code><span class="nv">$inboundrules</span> <span class="p">|</span> <span class="nb">Get-NetFirewallPortFilter</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">LocalPort</span> <span class="n">-Unique</span>
</code></pre></div></p>
<p>List DisplayName + rule information</p>
<p><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/out-string?view=powershell-7.2">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/out-string?view=powershell-7.2</a></p>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.string.trim?view=net-6.0#system-string-trim">https://docs.microsoft.com/en-us/dotnet/api/system.string.trim?view=net-6.0#system-string-trim</a></p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="n">-Direction</span> <span class="s2">&quot;Inbound&quot;</span> <span class="n">-Enabled</span> <span class="s2">&quot;true&quot;</span> <span class="n">-Action</span> <span class="s2">&quot;Allow&quot;</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">DisplayName</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Profile</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
     <span class="nv">$_</span> <span class="p">|</span> <span class="nb">Get-NetFirewallPortFilter</span>
<span class="p">}</span>
</code></pre></div>
<p>List DisplayName + port information for all inbound rules currently enabled and allowed:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="n">-Direction</span> <span class="s2">&quot;Inbound&quot;</span> <span class="n">-Enabled</span> <span class="s2">&quot;true&quot;</span> <span class="n">-Action</span> <span class="s2">&quot;Allow&quot;</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
    <span class="nb">echo </span><span class="s2">&quot;&quot;</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">DisplayName</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Profile</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Get-NetFirewallPortFilter</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Protocol</span><span class="p">,</span><span class="n">LocalPort</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>Example result of the previous command:</p>
<div class="highlight"><pre><span></span><code>...
DisplayName : Microsoft Edge (mDNS-In)
Profile : Any
Protocol  : UDP
LocalPort : 5353

DisplayName : Cortana
Profile : Domain, Private, Public
Protocol  : Any
LocalPort : Any
...
</code></pre></div>
<p>Knowing the format of the above results, you can do a context search by appending <code>| Select-String "&lt;port&gt;" -Context 3,0</code>, which will print <em>only</em> the results matching <code>&lt;port&gt;</code>. For example to get all enabled and allowed inbound rules matching port 5353:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="n">-Direction</span> <span class="s2">&quot;Inbound&quot;</span> <span class="n">-Enabled</span> <span class="s2">&quot;true&quot;</span> <span class="n">-Action</span> <span class="s2">&quot;Allow&quot;</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
    <span class="nb">echo </span><span class="s2">&quot;&quot;</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">DisplayName</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Profile</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">(</span><span class="nv">$_</span> <span class="p">|</span> <span class="nb">Get-NetFirewallPortFilter</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">Protocol</span><span class="p">,</span><span class="n">LocalPort</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">trim</span><span class="p">()</span>
<span class="p">}</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;5353&quot;</span> <span class="n">-Context</span> <span class="n">3</span><span class="p">,</span><span class="n">0</span>
</code></pre></div></p>
<p>You can take any commands that have extensive output and use a context search to obtain the rule name based on the port with something like <code>Select-String "&lt;port&gt;" -Context &lt;lines-before&gt;,&lt;lines-after&gt;</code>.</p>
<p>Get all active rules permitting inbound traffic, that are lacking a description (good indicator of third party or possibly malicious rules):
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Enabled</span> <span class="o">-eq</span> <span class="s2">&quot;True&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Direction</span> <span class="o">-eq</span> <span class="s2">&quot;Inbound&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Action</span> <span class="o">-eq</span> <span class="s2">&quot;Allow&quot;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Description</span> <span class="o">-eq</span> <span class="nv">$nul</span> <span class="p">}</span>
</code></pre></div></p>
<p>Get all active inbound firewall rules and disable them:
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFirewallRule</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">-Property</span> <span class="n">Direction</span> <span class="o">-eq</span> <span class="n">Inbound</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">-Property</span> <span class="n">Enabled</span> <span class="o">-eq</span> <span class="n">True</span> <span class="p">|</span> <span class="nb">Set-NetFirewallRule</span> <span class="n">-Enabled</span> <span class="o">-eq</span> <span class="n">False</span>
</code></pre></div></p>
<p>Disable all rule names matching regex "Cast to Device*":
<div class="highlight"><pre><span></span><code><span class="nb">Set-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;Cast to Device*&quot;</span> <span class="n">-Enabled</span> <span class="n">False</span>
</code></pre></div></p>
<p>Set rule names matching regex "mDNS<em>" or "LLMNR</em>" to block:
<div class="highlight"><pre><span></span><code><span class="nb">Set-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;mDNS*&quot;</span> <span class="p">|</span> <span class="nb">Set-NetFirewallRule</span> <span class="n">-Action</span> <span class="s2">&quot;Block&quot;</span>
<span class="nb">Set-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&quot;*LLMNR*&quot;</span> <span class="p">|</span> <span class="nb">Set-NetFirewallRule</span> <span class="n">-Action</span> <span class="s2">&quot;Block&quot;</span>
</code></pre></div></p>
<h3 id="managing-firewall-rules-cmdexe">Managing Firewall Rules (cmd.exe)</h3>
<p>cmd.exe / netsh.exe basics:
<div class="highlight"><pre><span></span><code>netsh advfirewall show all
netsh advfirewall show allprofiles
netsh advfirewall show currentprofile
netsh advfirewall set domainprofile state on
netsh advfirewall set privateprofile state off
netsh advfirewall set allprofiles state off
netsh advfirewall firewall show rule all
netsh advfirewall firewall show rule all dir=in
netsh advfirewall firewall show rule name=&quot;&lt;rule-name&gt;&quot;
</code></pre></div></p>
<p>Limit output by listing only all enabled, inbound rules, rule name, profile, and local port:
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall show rule name=all dir=in | findstr /BR /C:&quot;Rule Name&quot; /C:&quot;-&quot; /C:&quot;Enabled&quot; /C:&quot;Profiles&quot; /C:&quot;LocalPort&quot; /C:&quot;Action:.*Allow&quot; /C:&quot;^$&quot;

# Example output:

Rule Name:                            Remote Event Log Management (NP-In)
----------------------------------------------------------------------
Enabled:                              No
Profiles:                             Domain
LocalPort:                            445
Action:                               Allow
</code></pre></div></p>
<p>This will do the equivalent of <code>-B</code> / <code>-A</code> in <code>grep</code> to search for rules based on LocalPort, but PowerShell is required:
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall show rule name=all dir=in | Select-String &quot;LocalPort:.*443&quot; -Context 10,10
netsh advfirewall firewall show rule name=all dir=in | Select-String &quot;Rule Name:.*SSH&quot; -Context 10,10
</code></pre></div></p>
<p>Add inbound rules for RDP and SSH:
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; dir=in protocol=TCP localport=3389 action=allow
netsh advfirewall firewall add rule name=&quot;SSH&quot; dir=in protocol=TCP localport=22 action=allow
</code></pre></div></p>
<p>Add outbound egress rules:
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall add rule name=&quot;Egress 10.0.0.0/8&quot; dir=out protocol=any action=block remoteip=10.0.0.0/8
netsh advfirewall firewall add rule name=&quot;Default Gateway&quot; dir=out protocol=any remoteip=&lt;gateway-ip&gt; interfacetype=lan action=allow
netsh advfirewall firewall add rule name=&quot;Egress fc00::/7&quot; dir=out protocol=any action=block remoteip=fc00::/7
</code></pre></div></p>
<p>Delete a rule called "Remote Desktop"
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall delete rule name=&quot;Remote Desktop&quot;
</code></pre></div></p>
<p>Delete all rules for local port tcp/80:
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall delete rule name=all protocol=tcp localport=80
</code></pre></div></p>
<p>Reset Firewall (To Defaults)
<div class="highlight"><pre><span></span><code>netsh advfirewall reset
</code></pre></div></p>
<h3 id="netsh-port-proxy">Netsh Port Proxy</h3>
<p><a href="https://www.sans.org/blog/pen-test-poster-white-board-cmd-exe-c-netsh-interface/">https://www.sans.org/blog/pen-test-poster-white-board-cmd-exe-c-netsh-interface/</a></p>
<p>Windows <code>Net Shell</code> command</p>
<ul>
<li>Using 0.0.0.0 as the listen address makes the portproxy bind to all interfaces</li>
<li>Using v4tov6 allows bidirectional IPv4 and IPv6 usage</li>
</ul>
<div class="highlight"><pre><span></span><code>netsh interface portproxy show all
netsh interface portproxy show v4tov4
netsh interface portproxy show v4tov6
netsh interface portproxy show v6tov4
netsh interface portproxy show v6tov6

netsh interface portproxy add v4tov4 listenaddress=&lt;local-addr&gt; listenport=&lt;local-port&gt; connectaddress=&lt;dest-addr&gt; connectport=&lt;dest-port&gt;
netsh interface portproxy add v4tov4 listenaddress=&lt;jump-box-addr&gt; listenport=&lt;jump-box-port&gt; connectaddress=&lt;attacker-addr&gt; connectport=&lt;attacker-web-server-port&gt;
netsh interface portproxy add v4tov4 listenport=8443 listenaddress=10.0.0.15 connectport=443 connectaddress=172.16.1.28
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=172.16.1.28
</code></pre></div>
<p>Forwards traffic hitting victim's / jump box's <code>listenaddress:listenport</code> to attacker's <code>connectaddress:connectport</code></p>
<h3 id="blockinboundalways-allowinboundrules-false">blockinboundalways / -AllowInboundRules False</h3>
<p>To drop all inbound connections even if Windows has a default allow rule for the service:</p>
<div class="highlight"><pre><span></span><code><span class="c">#cmd.exe</span>
<span class="n">netsh</span> <span class="n">advfirewall</span> <span class="nb">set </span><span class="n">allprofiles</span> <span class="n">firewallpolicy</span> <span class="n">blockinboundalways</span><span class="p">,</span><span class="n">allowoutbound</span>

<span class="c">#powershell</span>
<span class="nb">Set-NetFirewallProfile</span> <span class="n">-AllowInboundRules</span> <span class="n">False</span>
</code></pre></div>
<ul>
<li>On domain joined workstations, this will not disrupt connections to server file shares and stops lateral movement between workstations</li>
<li>Workstation typically should not need to talk to each other, with the server being the central point of authentication</li>
<li>On personal, non domain joined workstations this should be the default setting, and an absolute must for travel / using untrusted LAN and WiFi networks</li>
</ul>
<p><strong>Keep in mind on cloud instances of Windows in Azure / AWS / GCP this will likely lock you out of the machine</strong></p>
<p>To enable this setting from within the GUI:</p>
<ul>
<li><code>Network &amp; Internet Settings &gt; Status &gt; Windows Firewall</code></li>
<li>For all three, <code>Domain</code>, <code>Public</code>, <code>Private</code>:</li>
<li>Set to <code>On</code></li>
<li>Check <code>Blocks all incoming connections, including those on the list of allowed apps.</code></li>
</ul>
<p>To turn off this setting via the GUI:
- Uncheck <code>Blocks all incoming connections, including those on the list of allowed apps.</code></p>
<h3 id="llmnr">LLMNR</h3>
<p><a href="https://www.blackhillsinfosec.com/how-to-disable-llmnr-why-you-want-to/">https://www.blackhillsinfosec.com/how-to-disable-llmnr-why-you-want-to/</a></p>
<p>Disable via GPO:</p>
<ul>
<li>Group Policy Management</li>
<li>Forest: <code>&lt;DOMAIN&gt;.local</code> &gt; Domains &gt; <code>&lt;DOMAIN&gt;.local</code> &gt; <code>Right-Click</code></li>
<li>Create a GPO in this domain, and Link it here...</li>
<li>Name it "LLMNR" or something meaningful, click OK</li>
<li>Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client</li>
<li>Turn Off Multicast Name Resolution &gt; Enabled</li>
<li><code>Right-Click</code> the policy name under <code>&lt;DOMAIN&gt;.local</code> and choose <code>Enforced</code></li>
</ul>
<p><em>You'll need to restart the endpoints, or refresh the group policy on each endpoint manually to ensure these changes take effect immediately</em></p>
<p>Update Group Policy via PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ADComputer</span> <span class="n">-filter</span> <span class="p">*</span> <span class="p">|</span> <span class="k">foreach</span><span class="p">{</span> <span class="nb">Invoke-GPUpdate</span> <span class="n">-computer</span> <span class="nv">$_</span><span class="p">.</span><span class="n">name</span> <span class="n">-RandomDelayInMinutes</span> <span class="n">0</span> <span class="n">-force</span><span class="p">}</span>
</code></pre></div>
<p>Update Group Policy via cmd.exe:</p>
<div class="highlight"><pre><span></span><code>gpupdate
</code></pre></div>
<p>Disable LLMNR via PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="k">If</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient&quot;</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="p">}</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;EnableMulticast&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="n">0</span>
</code></pre></div>
<p>Disable LLMNR via cmd.exe:</p>
<div class="highlight"><pre><span></span><code>REG ADD  ‚ÄúHKLM\Software\policies\Microsoft\Windows NT\DNSClient‚Äù
REG ADD  ‚ÄúHKLM\Software\policies\Microsoft\Windows NT\DNSClient‚Äù /v ‚Äù EnableMulticast‚Äù /t REG_DWORD /d ‚Äú0‚Äù /f
</code></pre></div>
<h3 id="mitigate-ipv6-mitm-attacks">Mitigate IPv6 MitM Attacks</h3>
<p><a href="https://academy.tcm-sec.com/p/practical-ethical-hacking-the-complete-course">https://academy.tcm-sec.com/p/practical-ethical-hacking-the-complete-course</a></p>
<p><a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/</a></p>
<p><a href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/</a></p>
<p>There are three predefined firewall rules to change from allow to block.</p>
<p>This walks through setting these rules as a GPO on a Domain Controller, but you can create the same rules manually on endpoints via Windows Defender Firewall.</p>
<p>Test these rules in an environment with ADCS configured by enabling them, updating Group Policy on each machine, then rebooting endpoints and signing in as a Domain Admin on any of them with mitm6 running. The attack(s) will no longer fire when these rules are in place.</p>
<p>Here are the commands to run on the attacker machine:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># In one terminal window:</span>
sudo<span class="w"> </span>/home/kali/.local/bin/mitm6<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-v<span class="w"> </span>-d<span class="w"> </span>TESTDOMAIN.local
<span class="c1"># In another:</span>
impacket-ntlmrelayx<span class="w"> </span>-6<span class="w"> </span>-t<span class="w"> </span>ldaps://&lt;dc-ip&gt;<span class="w"> </span>-wh<span class="w"> </span>fakewpad.testdomain.local<span class="w"> </span>-l<span class="w"> </span>loot
</code></pre></div>
<ul>
<li>Group Policy Management</li>
<li>Forest: <code>&lt;DOMAIN&gt;.local</code> &gt; Domains &gt; <code>&lt;DOMAIN&gt;.local</code> &gt; <code>Right-Click</code></li>
<li>Create a GPO in this domain, and Link it here...</li>
<li>Name it "IPv6" or something meaningful, click OK
Computer Configuration &gt; Windows Settings &gt; Security Settings &gt; Windows Defender Firewall with Advanced Security &gt; Windows Defender Firewall with Advanced Security &gt; [Inbound|Outbound] Rules</li>
<li>
<p>Create new custom rules for all three, there are usually none defined in Group Policy Management on the DC when defining a new GPO.</p>
</li>
<li>
<p>(Inbound) Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPV6-IN)</p>
<ul>
<li>Name: Block - (DHCPV6-In)</li>
<li>Protocol type: UDP</li>
<li>Protocol number: 17</li>
<li>Local Port: Specific Ports, 546</li>
<li>Remote Port: Specific Ports, 547</li>
<li>This program: %SystemRoot%\system32\svchost.exe</li>
</ul>
</li>
<li>
<p>(Inbound) Core Networking - Router Advertisement (ICMPv6-IN)</p>
<ul>
<li>Name: Block - Router Advertisement (ICMPv6-In)</li>
<li>Protocol type: ICMPv6</li>
<li>Protocol number: 58</li>
<li>Local port: All Ports</li>
<li>Remote port: All Ports</li>
<li>Specific ICMP types: [x] Router Advertisement<ul>
<li>ICMP Type: 0</li>
<li>ICMP Code: Any</li>
</ul>
</li>
<li>This program: System</li>
</ul>
</li>
<li>
<p>(Outbound) Core Networking - Dynamic Host Configuration Protocol for IPv6 (DHCPV6-Out)</p>
<ul>
<li>Name: Block - (DHCPV6-Out)</li>
<li>Protocol type: UDP</li>
<li>Protocol number: 17</li>
<li>Local Port: Specific Ports, 546</li>
<li>Remote Port: Specific Ports, 547</li>
<li>This program: %SystemRoot%\system32\svchost.exe</li>
</ul>
</li>
<li>
<p><code>Right-Click</code> the policy name under <code>&lt;DOMAIN&gt;.local</code> and choose <code>Enforced</code></p>
</li>
</ul>
<p><em>You'll need to restart the endpoints or refresh the group policy on each endpoint manually to ensure these changes take effect immediately</em></p>
<p>Update Group Policy via PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ADComputer</span> <span class="n">-filter</span> <span class="p">*</span> <span class="p">|</span> <span class="k">foreach</span><span class="p">{</span> <span class="nb">Invoke-GPUpdate</span> <span class="n">-computer</span> <span class="nv">$_</span><span class="p">.</span><span class="n">name</span> <span class="n">-RandomDelayInMinutes</span> <span class="n">0</span> <span class="n">-force</span><span class="p">}</span>
</code></pre></div>
<p>Update Group Policy via cmd.exe:</p>
<div class="highlight"><pre><span></span><code>gpupdate
</code></pre></div>
<h3 id="enable-smb-signing">Enable SMB Signing</h3>
<p><a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing">https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing</a></p>
<p>Default for Workstations = 0
Default for Server = 1</p>
<p>Enable SMB Signing via PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Services\LanManWorkstation\Parameters&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;RequireSecuritySignature&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="n">1</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;RequireSecuritySignature&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="n">1</span>
</code></pre></div>
<p>Enable SMB Signing on a Domain Controller via a GPO:</p>
<ul>
<li>Group Policy Management</li>
<li>Forest: <code>&lt;DOMAIN&gt;.local</code> &gt; Domains &gt; <code>&lt;DOMAIN&gt;.local</code> &gt; <code>Right-Click</code></li>
<li>Create a GPO in this domain, and Link it here...</li>
<li>Name it "SMB Signing" or something meaningful, click OK</li>
<li>Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Local Policies &gt; Security Options</li>
<li>Microsoft network server: Digitally sign communications (always) &gt; Enable</li>
<li>Microsoft network client:  Digitally sign communications (always) &gt; Enable</li>
<li><code>Right-Click</code> the policy name under <code>&lt;DOMAIN&gt;.local</code> and choose <code>Enforced</code></li>
</ul>
<p><em>You'll need to restart the endpoints or refresh the group policy on each endpoint manually to ensure these changes take effect immediately</em></p>
<p>Update Group Policy via PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ADComputer</span> <span class="n">-filter</span> <span class="p">*</span> <span class="p">|</span> <span class="k">foreach</span><span class="p">{</span> <span class="nb">Invoke-GPUpdate</span> <span class="n">-computer</span> <span class="nv">$_</span><span class="p">.</span><span class="n">name</span> <span class="n">-RandomDelayInMinutes</span> <span class="n">0</span> <span class="n">-force</span><span class="p">}</span>
</code></pre></div>
<p>Update Group Policy via cmd.exe:</p>
<div class="highlight"><pre><span></span><code>gpupdate
</code></pre></div>
<h2 id="filesystem">Filesystem</h2>
<p>How to do the equivalent of <code>chmod</code> operations in Windows.</p>
<h3 id="takeownexe">takeown.exe</h3>
<p>Change ownership recursively of a file(s) or folder(s) to the current user:</p>
<div class="highlight"><pre><span></span><code><span class="n">takeown</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">F</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="nb">R</span>
</code></pre></div>
<p>Change ownership recursively of a file(s) or folder(s) to the <strong>Administrators group</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">takeown</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">F</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">A</span> <span class="p">/</span><span class="nb">R</span>
</code></pre></div>
<p>Change ownership back to a standard user (where $HOSTNAME is either local pc name or domain name, and user is a local or domain user):</p>
<div class="highlight"><pre><span></span><code><span class="n">takeown</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">S</span> <span class="nv">$HOSTNAME</span> <span class="p">/</span><span class="n">U</span> <span class="nv">$USER</span> <span class="p">/</span><span class="n">F</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span>
</code></pre></div>
<h3 id="icaclsexe">icacls.exe</h3>
<p>Remove all permissions on a file or folder:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
</code></pre></div>
<p>Reset to default permissions:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">reset</span>
</code></pre></div>
<p><strong>Folder Permissions</strong></p>
<p>Grant read-only access to a <strong>folder</strong> for user alice:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">grant</span> <span class="n">alice</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)RX&quot;</span>
</code></pre></div>
<p>Remove <em>granted</em> (note the <code>:g</code>) access to a *<em>folder</em> for user alice:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">remove</span><span class="p">:</span><span class="n">g</span> <span class="n">alice</span>
</code></pre></div>
<p>Permit read-only access to a <strong>folder</strong> for the builtin group "everyone" (removes any inherit or current write or modify permissions with <code>/inheritance:r</code>):</p>
<ul>
<li>SID <code>*S-1-1-0</code> means <code>everyone</code></li>
<li>Similar to <code>chmod a=rX -R ./ExampleFolder</code> in Linux</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleDir</span><span class="p">\</span> <span class="p">/</span><span class="n">grant</span> <span class="p">*</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">0</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)RX&quot;</span>
</code></pre></div>
<p>The purpose of <code>CI</code> and <code>OI</code> is to allow the "synchronize" permission, which allows directory traversal and if missing, denies it even if RX permission is granted</p>
<p>Configure a folder to be only modifiable by administrators, read and execute by eveyrone:</p>
<ul>
<li>Similar to <code>chmod a=rX -R ./ExampleFolder; chmod o=rwX -R ./ExampleFolder; chown root:root ./ExmapleFolder</code> on Linux</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="p">*</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">0</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)RX&quot;</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="n">SYSTEM</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)(F)&quot;</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)(F)&quot;</span>
</code></pre></div>
<p>Example output:</p>
<div class="highlight"><pre><span></span><code><span class="n">PS</span><span class="p">&gt;</span> <span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\*</span>
<span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="n">Everyone</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">RX</span><span class="p">)</span>
         <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>
         <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>
</code></pre></div>
<p><strong>File Permissions</strong></p>
<p>Grant read-only access to a <strong>file</strong> for user alice. This does not require <code>(CI)(OI)</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleFile</span> <span class="p">/</span><span class="n">grant</span> <span class="n">alice</span><span class="p">:</span><span class="s2">&quot;RX&quot;</span>
</code></pre></div>
<p>Remove <em>granted</em> (note the <code>:g</code>) access to a <strong>file</strong> for user alice:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">ExampleFile</span> <span class="p">/</span><span class="n">remove</span><span class="p">:</span><span class="n">g</span> <span class="n">alice</span>
</code></pre></div>
<p>Permit read-only + execute for the <code>everyone</code> builtin group, to a single file. This does not require <code>(CI)(OI)</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacle</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">example</span><span class="p">.</span><span class="nb">md </span><span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r </span><span class="p">/</span><span class="n">grant</span> <span class="p">*</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">0</span><span class="p">:</span><span class="s2">&quot;RX&quot;</span>
</code></pre></div>
<p>Limit full access to only SYSTEM and BUILTIN\Administrators:</p>
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">grant</span> <span class="n">SYSTEM</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
</code></pre></div>
<p>Example output:</p>
<div class="highlight"><pre><span></span><code><span class="n">PS</span><span class="p">&gt;</span> <span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span>
<span class="n">administrators_authorized_keys</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">:(</span><span class="n">F</span><span class="p">)</span>
                               <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:(</span><span class="n">F</span><span class="p">)</span>
</code></pre></div>
<h3 id="net-access-control-methods">.NET Access Control Methods</h3>
<p>This section breaks down using the PowerShell <code>Set/Get-Acl</code> cmdlets and the .NET methods underpinning them. The idea is to mirror what <code>takeown.exe</code> and <code>icacls.exe</code> or <code>chmod</code> plus <code>chown</code> can do, in an easy to understand way.</p>
<p>Take the ACL data of one filesystem object and apply it to another with the following:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$SourceObject</span> <span class="p">=</span> <span class="s2">&quot;C:\Users\Administrator\Documents&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$SourceObject</span>
<span class="nv">$DestObject</span> <span class="p">=</span> <span class="s2">&quot;C:\Tools&quot;</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$DestObject</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
</code></pre></div>
<p>To use this like <code>icacls.exe</code> or <code>chmod</code> we'll need to reference some examples:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl?view=powershell-7.3"><code>Set-Acl</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemaccessrule.-ctor?view=net-7.0#system-security-accesscontrol-filesystemaccessrule-ctor(system-security-principal-identityreference-system-security-accesscontrol-filesystemrights-system-security-accesscontrol-accesscontroltype)"><code>FileSystemAccessRule($identity, $fileSystemRights, $type)</code></a></li>
</ul>
<p>First, to learn the namespace / class path to access .NET classes, see the top <strong>Definition</strong> section of each class in the documentation:</p>
<blockquote>
<p>FileSecurity Class</p>
<p>Namespace: System.Security.AccessControl</p>
</blockquote>
<p>Access it with: <code>New-Object -TypeName System.Security.AccessControl.FileSecurity -ArgumentList ...&lt;SNIP&gt;</code></p>
<p><em>Remember: Methods apply actions, where classes define the objects or "things" to work with through actions, roughly speaking.</em></p>
<p>Looking at the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemaccessrule.-ctor?view=net-8.0#system-security-accesscontrol-filesystemaccessrule-ctor(system-security-principal-identityreference-system-security-accesscontrol-filesystemrights-system-security-accesscontrol-inheritanceflags-system-security-accesscontrol-propagationflags-system-security-accesscontrol-accesscontroltype)">five parameters</a> to <code>FileSystemAccessRule($identity, $fileSystemRights, $inheritanceFlags, $propagationFlags, $type)</code>, shows how we can start to write the code block.</p>
<p><strong>$identity</strong></p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.principal.identityreference?view=net-7.0"><code>$identity</code></a> is a reference to a user account through the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.principal.ntaccount?view=net-7.0">NTAccount class</a>, built with either a <code>$userAccount</code> string, or both a <code>$domainName</code> and <code>$userAccount</code> string.</p>
<p><strong>$fileSystemRights</strong></p>
<p>For the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemrights?view=net-8.0#definition">fields available to <code>$fileSystemRights</code></a>, these include but aren't limited to:</p>
<ul>
<li>FullControl</li>
<li>Read</li>
<li>Write</li>
<li>Modify</li>
<li>Synchronize</li>
<li>Traverse</li>
</ul>
<p>You can specify more than one <code>$fileSystemRights</code> with a comma separated list. So we can create a FileSystemAccessRule construct like this:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$AccessRule</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;ReadAndExecute,Modify&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
</code></pre></div>
<p><em>For the sake of readability, many examples below use one per line.</em></p>
<p><strong>$inheritanceFlags, $propagationFlags</strong></p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.inheritanceflags?view=net-8.0"><code>$inheritanceFlags</code></a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.propagationflags?view=net-8.0"><code>$propagationFlags</code></a> define how existing child objects are modified based on the parent ACL.</p>
<ul>
<li><code>$inheritanceFlags</code> of <code>"ContainerInherit,ObjectInherit"</code> is the same as <code>"(CI)(OI)"</code> from icacls.exe, meaning the changes are recursive and persistent</li>
<li><code>$propagationFlags</code> should be set to <code>"None"</code> if the "root" object removed existing inheritance from its parent object and has its own ACL's protected</li>
</ul>
<p><strong>$type</strong></p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.accesscontroltype?view=net-7.0"><code>$type</code></a> is either <code>Allow</code> (0) or <code>Deny</code> (1).</p>
<p><strong>Inheritance</strong></p>
<p>Of all the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity?view=net-8.0#methods">methods under the object security class</a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.setaccessruleprotection?view=net-8.0#system-security-accesscontrol-objectsecurity-setaccessruleprotection(system-boolean-system-boolean)"><code>SetAccessRuleProtection</code></a> appears to deal directly with inheritance. Inheritance complicates locking down ACL's in some cases. This is a way to work with that.</p>
<p><strong>Essential Methods</strong></p>
<p>Now for reference, lets list all the relevant methods under the <code>FileSystemSecurity</code> and <code>ObjectSecurity</code> class in a way that's more readable and understandable.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemsecurity.setaccessrule?view=net-7.0"><code>SetAccessRule($rule)</code></a> Where <code>$rule</code> is an ACL object built from <code>FileSystemAccessRule()</code> to apply</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemsecurity.removeaccessrule?view=net-7.0"><code>RemoveAccessRule($rule)</code></a> Where <code>$rule</code> is an ACL object built from <code>FileSystemAccessRule()</code> to remove</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.purgeaccessrules?view=net-7.0"><code>PurgeAccessRules($identity)</code></a> Which purges all of <code>$identity</code>'s access to an object</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.setowner?view=net-7.0"><code>SetOwner($identity)</code></a> Sets the owner to <code>$identity</code></li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.setgroup?view=net-7.0"><code>SetGroup($identity)</code></a> Sets the group to <code>$identity</code></li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.setaccessruleprotection?view=net-8.0"><code>SetAccessRuleProtection($true, $false)</code></a> Protects our defined rules from inheritance, and removes existing inheritance</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.principal.ntaccount.-ctor?view=net-8.0"><code>NTAccount($domainName, $accountName)</code></a> Is how you construct an <code>$identity</code> object, <code>$domainName</code> is optional</li>
</ul>
<p>Finally, when do you use Set/Add/Remove/Purge?</p>
<ul>
<li>Use <code>SetAccessRule()</code> to overwrite, and replace a specifc <code>$identity</code>'s ACL for an object</li>
<li>Use <code>AddAccessRule()</code> to build on an <code>$identity</code>'s existing ACL for an object, like "set" the first rule, then "add" additional rules</li>
<li>Use <code>RemoveAccessRule()</code> to remove a <code>$rule</code> from an <code>$identity</code>'s ACL, like take away FullControl, but leave all other existing rules</li>
<li>Use <code>PurgeAccessRules()</code> to completely remove any <strong>defined</strong> <code>$rule</code>s for an <code>$identity</code>, <strong>this does not prevent access via inheritance</strong></li>
</ul>
<p>Next, some practical examples of how to use these. Each of them is copy / paste ready to use, just change the top variables.</p>
<p><strong>Reset ACL to Default Inheritance</strong></p>
<ul>
<li>This effectively wipes any modifications</li>
<li>Meaning the filesystem object will default to the ACL's it's going to inherit based on where it exists in the filesystem</li>
<li>This uses the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesecurity.-ctor?view=net-8.0#system-security-accesscontrol-filesecurity-ctor">first constructor example</a> in the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesecurity?view=net-8.0#constructors">FileSecurity class</a> to create an empty FileSecurity object, and apply it to the <code>$FilePath</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;test.txt&quot;</span>
<span class="nv">$EmptyAcl</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSecurity</span> <span class="n">-ArgumentList</span> <span class="nv">$null</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Change Ownership</strong></p>
<ul>
<li>Gives "User2" ownership of <code>$FilePath</code></li>
<li>Just change the value of <code>$UserAccount</code> to any user to change ownership</li>
<li>Builds a <code>System.Security.Principal.NTAccount</code> object for <code>$identity</code></li>
<li>Uses <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.setowner?view=net-7.0"><code>SetOwner($identity)</code></a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;test.txt&quot;</span>
<span class="nv">$UserAccount</span> <span class="p">=</span> <span class="s2">&quot;User2&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$NewOwner</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="nv">$UserAccount</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetOwner</span><span class="p">(</span><span class="nv">$NewOwner</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Set Access</strong></p>
<ul>
<li>This <em>adds</em> User2 to the ACL, with the FullControl right over <code>$FilePath</code></li>
<li>In this case User2 had no <em>previous</em> ACL rules defined or access to <code>$FilePath</code></li>
<li>Uses <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemsecurity.setaccessrule?view=net-7.0"><code>SetAccessRule($rule)</code></a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;test.txt&quot;</span>
<span class="nv">$UserName</span> <span class="p">=</span> <span class="s2">&quot;User2&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Add Access</strong></p>
<ul>
<li>If an <code>$identity</code> alread has a defined ACL for the object, add another <code>$fileSystemRights</code> rule definition to it</li>
<li>Similar to <code>SetAccessRule()</code>, but appends the rule to existing access</li>
<li>Uses <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemsecurity.addaccessrule?view=net-8.0"><code>AddAccessRule($rule)</code></a></li>
</ul>
<p>You could also use this in addition to <code>SetAccessRule()</code> when building specific rules for an <code>$identity</code> even when creating new rules. Otherwise each invocation of <code>SetAccessRule()</code> overwrites the previous list for the same <code>$identity</code>. The example below demonstrates this.</p>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Tools&quot;</span>
<span class="nv">$UserName</span> <span class="p">=</span> <span class="s2">&quot;User2&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;ReadAndExecute&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;CreateFiles&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule3</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;CreateDirectories&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule4</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;Synchronize&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">AddAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">AddAccessRule</span><span class="p">(</span><span class="nv">$AccessRule3</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">AddAccessRule</span><span class="p">(</span><span class="nv">$AccessRule4</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Remove Access</strong></p>
<ul>
<li>Same as <code>AddAccessRule($rule)</code>, only it removes an existing <code>$fileSystemRights</code> rule definition</li>
<li>This can be one rule, or any number of rules defined for any <code>$identity</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Tools&quot;</span>
<span class="nv">$UserName</span> <span class="p">=</span> <span class="s2">&quot;User2&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;AppendData&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;CreateFiles&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">RemoveAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">RemoveAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Purge Access / Remove All</strong></p>
<ul>
<li>This revokes User2's defined ACL's to the file. <strong>User2 may still access the file through inheritance, however</strong>.</li>
<li>Uses <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.objectsecurity.purgeaccessrules?view=net-7.0"><code>PurgeAccessRules($identity)</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemsecurity.removeaccessruleall?view=net-8.0"><code>RemoveAccessRuleAll($rule)</code></a> appears to do the same thing, just specify one existing rule and all will be wiped for that <code>$identity</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;test.txt&quot;</span>
<span class="nv">$UserAccount</span> <span class="p">=</span> <span class="s2">&quot;User2&quot;</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$RemoveAccount</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="nv">$UserAccount</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">PurgeAccessRules</span><span class="p">(</span><span class="nv">$RemoveAccount</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Admin RWX, Users RX</strong></p>
<p>This is effectively the <code>/usr/bin</code> permissions of 755 where only elevated accounts can modify content, but everyone can read and execute it.</p>
<ul>
<li>Resets the ACL for the path <strong>recursively</strong>, and applies the 0755 style permissions to it</li>
<li>The new ACL must be applied to all existing files recursively</li>
<li>Just because an Administrator makes a directory does NOT mean standard users cannot modify it</li>
<li>You must disable inheritance, and set explicit permissions for such folders</li>
<li>Owner  : BUILTIN\Administrators</li>
<li>Access : BUILTIN\Administrators Allow  FullControl</li>
<li>Access : NT AUTHORITY\SYSTEM Allow  FullControl</li>
<li>Access : Everyone Allow  ReadAndExecute, Synchronize</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Tools&quot;</span>
<span class="nv">$UserName</span> <span class="p">=</span> <span class="s2">&quot;BUILTIN\Administrators&quot;</span>
<span class="c"># Reset the ACL</span>
<span class="nv">$EmptyAcl</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSecurity</span> <span class="n">-ArgumentList</span> <span class="nv">$null</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="p">(</span><span class="nb">gci </span><span class="n">-Recurse</span> <span class="n">-Force</span> <span class="nv">$FilePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="p">}</span>
<span class="c"># Construct the new ACL</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;ContainerInherit,ObjectInherit&quot;</span><span class="p">,</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;NT AUTHORITY\SYSTEM&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;ContainerInherit,ObjectInherit&quot;</span><span class="p">,</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule3</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;Everyone&quot;</span><span class="p">,</span><span class="s2">&quot;ReadAndExecute,Synchronize&quot;</span><span class="p">,</span><span class="s2">&quot;ContainerInherit,ObjectInherit&quot;</span><span class="p">,</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewOwner</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;$UserName&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule3</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRuleProtection</span><span class="p">(</span><span class="nv">$true</span><span class="p">,</span> <span class="nv">$false</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetOwner</span><span class="p">(</span><span class="nv">$NewOwner</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="p">(</span><span class="nb">gci </span><span class="n">-Recurse</span> <span class="n">-Force</span> <span class="nv">$FilePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="p">}</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Admin Only</strong></p>
<p>Creates a file / folder permission structure where only Admins can traverse and modify the content.</p>
<ul>
<li>Like before, you must apply the constructed ACL object to all existing files recursively</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Tools&quot;</span>
<span class="nv">$UserName</span> <span class="p">=</span> <span class="s2">&quot;BUILTIN\Administrators&quot;</span>
<span class="c"># Reset the ACL recursively</span>
<span class="nv">$EmptyAcl</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSecurity</span> <span class="n">-ArgumentList</span> <span class="nv">$null</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="p">(</span><span class="nb">gci </span><span class="n">-Recurse</span> <span class="n">-Force</span> <span class="nv">$FilePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="p">}</span>
<span class="c"># Construct the new ACL, apply it recursively</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;ContainerInherit,ObjectInherit&quot;</span><span class="p">,</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;NT AUTHORITY\SYSTEM&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;ContainerInherit,ObjectInherit&quot;</span><span class="p">,</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewOwner</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;$UserName&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRuleProtection</span><span class="p">(</span><span class="nv">$true</span><span class="p">,</span> <span class="nv">$false</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetOwner</span><span class="p">(</span><span class="nv">$NewOwner</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="p">(</span><span class="nb">gci </span><span class="n">-Recurse</span> <span class="n">-Force</span> <span class="nv">$FilePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="p">}</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Set User's authorized_keys Permissions</strong></p>
<p>Three PowerShell utilities exist in the PowerShell/openssh-portable repo addressing this issue:</p>
<ul>
<li><a href="https://github.com/PowerShell/openssh-portable/blob/latestw_all/contrib/win32/openssh/OpenSSHUtils.psm1">OpenSSHUtils.psm1</a></li>
<li><a href="https://github.com/PowerShell/openssh-portable/blob/latestw_all/contrib/win32/openssh/FixHostFilePermissions.ps1">FixHostFilePermissions.ps1</a></li>
<li><a href="https://github.com/PowerShell/openssh-portable/blob/latestw_all/contrib/win32/openssh/FixUserFilePermissions.ps1">FixUserFilePermissions.ps1</a></li>
</ul>
<p>This is a simplified version of what those achieve, to help you understand how to do this yourself.</p>
<ul>
<li>Wipes out all existing ACLs and removes inheritance</li>
<li>Allows <code>$env:USERNAME</code> (and NT AUTHORITY\SYSTEM + BUILTIN\Administrators) FullControl over <code>authorized_keys</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$UserName</span> <span class="p">=</span> <span class="nv">$env:USERNAME</span> <span class="c"># Replace this with a defined user</span>
<span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Users\$UserName\.ssh\authorized_keys&quot;</span>
<span class="c"># Reset the ACL</span>
<span class="nv">$EmptyAcl</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSecurity</span> <span class="n">-ArgumentList</span> <span class="nv">$null</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="c"># Construct the new ACL</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$UserName</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;NT AUTHORITY\SYSTEM&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule3</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;BUILTIN\Administrators&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewOwner</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;$UserName&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule3</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRuleProtection</span><span class="p">(</span><span class="nv">$true</span><span class="p">,</span> <span class="nv">$false</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetOwner</span><span class="p">(</span><span class="nv">$NewOwner</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p><strong>Set administrators_authorized_keys Permissions</strong></p>
<p>Same as the authorized_keys file permissions for a standard user, except NT AUTHORITY\SYSTEM and BUILTIN\Administrators are the only <code>$identity</code>s that can access the file.</p>
<div class="highlight"><pre><span></span><code><span class="nv">$FilePath</span> <span class="p">=</span> <span class="s2">&quot;C:\ProgramData\ssh\administrators_authorized_keys&quot;</span>
<span class="c"># Reset the ACL</span>
<span class="nv">$EmptyAcl</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSecurity</span> <span class="n">-ArgumentList</span> <span class="nv">$null</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$EmptyAcl</span>
<span class="c"># Construct the new ACL</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span>
<span class="nv">$AccessRule1</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;NT AUTHORITY\SYSTEM&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$AccessRule2</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;BUILTIN\Administrators&quot;</span><span class="p">,</span><span class="s2">&quot;FullControl&quot;</span><span class="p">,</span><span class="s2">&quot;Allow&quot;</span>
<span class="nv">$NewOwner</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;BUILTIN\Administrators&quot;</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule1</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$AccessRule2</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRuleProtection</span><span class="p">(</span><span class="nv">$true</span><span class="p">,</span> <span class="nv">$false</span><span class="p">)</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetOwner</span><span class="p">(</span><span class="nv">$NewOwner</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>
<span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$FilePath</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<h3 id="net-access-audit-methods">.NET Access Audit Methods</h3>
<p>Much like ACL's, we can build and apply audit rules via PowerShell in a similar way.</p>
<p>See the <code>SetAuditRule($rule)</code> method.</p>
<div class="highlight"><pre><span></span><code><span class="c"># TO DO</span>
</code></pre></div>
<h3 id="smb">SMB</h3>
<p>This section references the following sources:</p>
<ul>
<li><a href="https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527#windows">nemo-wq/PrintNightmare</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl?view=powershell-7.3#example-5-grant-administrators-full-control-of-the-file">Set-Acl</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbshare?view=windowsserver2022-ps">New-SmbShare</a></li>
</ul>
<p>Create a new folder, an SMB share for that folder, and give <code>flare-user</code> full access to it:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Setup a user to access the folder</span>
<span class="nv">$Password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s2">&quot;flare-pass&quot;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<span class="nb">New-LocalUser</span> <span class="s2">&quot;flare-user&quot;</span> <span class="n">-Password</span> <span class="nv">$Password</span>
<span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="s2">&quot;Users&quot;</span> <span class="n">-Member</span> <span class="s2">&quot;flare-user&quot;</span>

<span class="c"># Create the folder</span>
<span class="nb">New-Item</span> <span class="n">-Type</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Share</span>

<span class="c"># Give flare-user FullControl</span>
<span class="nv">$NewAcl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="s2">&quot;C:\Share&quot;</span>
<span class="nv">$identity</span> <span class="p">=</span> <span class="s2">&quot;[DOMAIN\]flare-user&quot;</span>
<span class="nv">$fileSystemRights</span> <span class="p">=</span> <span class="s2">&quot;FullControl&quot;</span>
<span class="nv">$type</span> <span class="p">=</span> <span class="s2">&quot;Allow&quot;</span>
<span class="nv">$argumentlist</span> <span class="p">=</span> <span class="nv">$identity</span><span class="p">,</span> <span class="nv">$fileSystemRights</span><span class="p">,</span> <span class="nv">$type</span>
<span class="nv">$NewRule</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span> <span class="n">-ArgumentList</span> <span class="nv">$argumentlist</span>
<span class="nv">$NewAcl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$NewRule</span><span class="p">)</span>
<span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="s2">&quot;C:\Share&quot;</span> <span class="n">-AclObject</span> <span class="nv">$NewAcl</span>

<span class="c"># Create the share</span>
<span class="nb">New-SmbShare</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Share</span> <span class="n">-Name</span> <span class="s2">&quot;Share&quot;</span> <span class="n">-FullAccess</span> <span class="s2">&quot;flare-user&quot;</span>

<span class="c"># Check available shares</span>
<span class="nb">Get-SmbShare</span> <span class="n">-Name</span> <span class="p">*</span>
</code></pre></div>
<p><em>NOTE 1: You can tab complete difficult to remember arguments like <code>System.Security.AccessControl.FileSystemAccessRule</code>.</em></p>
<p><em>NOTE 2: <a href="https://help.openai.com/en/articles/6825453-chatgpt-release-notes">ChatGPT May 24 Version</a> demonstrates a shorter way of writing the <code>$NewRule</code> line:</em></p>
<div class="highlight"><pre><span></span><code><span class="nv">$NewRule</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span><span class="p">(</span><span class="s2">&quot;flare-user&quot;</span><span class="p">,</span> <span class="s2">&quot;FullControl&quot;</span><span class="p">,</span> <span class="s2">&quot;Allow&quot;</span><span class="p">)</span>
</code></pre></div>
<p>From here you can easily <code>impacket-smbclient flare-user:flare-pass@hostname</code> to connect.</p>
<p>Modifying access to a share is done with the following cmdlets:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/smbshare/grant-smbshareaccess?view=windowsserver2022-ps"><code>Grant-SmbShareAccess</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/smbshare/revoke-smbshareaccess?view=windowsserver2022-ps"><code>Revoke-SmbShareAccess</code></a></li>
</ul>
<p>Remove an SMB share:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Remove-SmbShare</span> <span class="n">-Name</span> <span class="s2">&quot;Share&quot;</span>
</code></pre></div>
<h2 id="sysinternals">SysInternals</h2>
<p>Overview:</p>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/">https://docs.microsoft.com/en-us/sysinternals/</a></p>
<p>Download individual tools directly:</p>
<p><a href="https://live.sysinternals.com/">https://live.sysinternals.com/</a></p>
<p>Download the entire suite as a zip archive:</p>
<p><a href="https://download.sysinternals.com/files/SysinternalsSuite.zip">https://download.sysinternals.com/files/SysinternalsSuite.zip</a></p>
<h3 id="accesschk">AccessChk</h3>
<ul>
<li><a href="https://live.sysinternals.com/accesschk64.exe">https://live.sysinternals.com/accesschk64.exe</a></li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></li>
</ul>
<p>See the following blog for additional uses of AccessChk:
- <a href="https://sirensecurity.io/blog/windows-privilege-escalation-resources/">https://sirensecurity.io/blog/windows-privilege-escalation-resources/</a></p>
<p>Evaluate what access to C:\$PATH is available to $USER:</p>
<div class="highlight"><pre><span></span><code><span class="n">accesschk64</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;$USER&quot;</span> <span class="n">c</span><span class="p">:\</span><span class="nv">$PATH</span>
</code></pre></div>
<h3 id="sysmon">Sysmon</h3>
<ul>
<li><a href="https://live.sysinternals.com/Sysmon64.exe">https://live.sysinternals.com/Sysmon64.exe</a></li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon</a></li>
</ul>
<h4 id="installing-sysmon">Installing Sysmon</h4>
<p>Open an administrative PowerShell session.</p>
<p>Create the tools directory with the correct permissions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">New-Item</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="s2">&quot;C:\Tools&quot;</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="nb">New-Item</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="s2">&quot;C:\Tools\Scripts&quot;</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">reset</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r </span><span class="p">|</span> <span class="nb">Out-Null</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="n">SYSTEM</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)(F)&quot;</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)(F)&quot;</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span> <span class="p">/</span><span class="n">grant</span> <span class="p">*</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">0</span><span class="p">:</span><span class="s2">&quot;(CI)(OI)RX&quot;</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</code></pre></div>
<p>Download and install Sysmon and a starter configuration file (if you did not write your own).</p>
<ul>
<li><a href="https://live.sysinternals.com/Sysmon64.exe">Sysmon</a></li>
<li><a href="https://github.com/olafhartong/sysmon-modular">Sysmon Modular - Olaf Hartong</a></li>
<li><a href="https://github.com/SwiftOnSecurity/sysmon-config">Sysmon Config - SwiftOnSecurity</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Change to the tools path</span>
<span class="nb">cd </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span>

<span class="c"># If you want to use SwiftOnSecurity&#39;s config:</span>
<span class="nb">iwr </span><span class="s2">&quot;https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml&quot;</span> <span class="n">-OutFile</span> <span class="s2">&quot;C:\Tools\sysmon-config.xml&quot;</span>
<span class="c"># If you want to use Olaf Hartong&#39;s config:</span>
<span class="nb">iwr </span><span class="s2">&quot;https://raw.githubusercontent.com/olafhartong/sysmon-modular/master/sysmonconfig.xml&quot;</span> <span class="n">-OutFile</span> <span class="s2">&quot;C:\Tools\sysmon-config.xml&quot;</span>

<span class="c"># Download Sysmon</span>
<span class="nb">iwr </span><span class="s2">&quot;https://live.sysinternals.com/Sysmon64.exe&quot;</span> <span class="n">-OutFile</span> <span class="s2">&quot;C:\Tools\Sysmon64.exe&quot;</span>

<span class="c"># Uninstall the currently running Sysmon components with the newest binary if you already have an older version running (does not require reboot)</span>
<span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">Sysmon64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-accepteula</span> <span class="n">-u</span>

<span class="c"># Install the newest Sysmon (does not require reboot)</span>
<span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">Sysmon64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-accepteula</span> <span class="n">-i</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sysmon-config</span><span class="p">.</span><span class="n">xml</span>
</code></pre></div>
<p><strong>NOTE</strong>: This does not erase or remove current log files, and they can all still be read again after installing the new binary.</p>
<h4 id="cleanup">Cleanup</h4>
<ul>
<li>Option 1: Make the config file readable only by SYSTEM and BUILTIN\Administrator
    <div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sysmon-config</span><span class="p">.</span><span class="n">xml</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sysmon-config</span><span class="p">.</span><span class="n">xml</span> <span class="p">/</span><span class="n">grant</span> <span class="n">SYSTEM</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sysmon-config</span><span class="p">.</span><span class="n">xml</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
</code></pre></div></li>
<li>Option 2: Delete the config file from the local machine</li>
<li>Both: Monitor and log for execution of <code>Sysmon64.exe -c</code> which dumps the entire configuration whether it's still on disk or not. If you find this in your logs and did not run this, you may have been broken into.</li>
</ul>
<h4 id="custom-config">Custom Config</h4>
<p>Using Sysmon-Modular it's easy to create custom configuration files.</p>
<ul>
<li><a href="https://github.com/olafhartong/sysmon-modular/tree/master#generating-a-config">Sysmon Modular: Generating a Config</a></li>
</ul>
<p>Install the configuration with <code>C:\Tools\Sysmon64.exe -c .\sysmonconfig.xml</code> and observe it with your SIEM, the Event Viewer, or <a href="https://github.com/straysheep-dev/windows-configs/blob/main/Tail-EventLogs.ps1">Tail-EventLogs.ps1</a>.</p>
<p>Adjust rules accordingly. For example, if there's a DLL Side-Loading rule that's overwhelming your logs, you can find which rule files include this rule using the following:
<div class="highlight"><pre><span></span><code><span class="p">.</span> <span class="p">.\</span><span class="nb">Merge-AllSysmonXml</span>

<span class="nb">Find-RulesInBasePath</span> <span class="n">-BasePath</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sysmon-modular</span><span class="p">\</span> <span class="p">|</span> <span class="nb">sls </span><span class="s2">&quot;DLL Side-Loading&quot;</span>
</code></pre></div></p>
<ul>
<li>Read the rule criteria based on what you're seeing in your logs.</li>
<li>Find the exact line in sysmon-modular's rules to tune it manually.</li>
<li>Regenerate the config using <code>Merge-AllSysmonXml -Path ( Get-ChildItem '[0-9]*\*.xml') -AsString | Out-File sysmonconfig.xml</code>.</li>
</ul>
<h4 id="tune-a-config-with-powershell">Tune a Config (with PowerShell)</h4>
<p><em>This will depend on your configuration file. The sysmon-modular config mentioned above is a great starting place to help you maintain includes and excludes.</em></p>
<p>When first applying a configuration, do it in a test environment mirroring the systems it will be deployed on. Then review what's being logged that's either too much, or not enough. This will likely be accomplished with a SIEM, but if you need to do this with PowerShell you can investigate logs by working big to small in scope.</p>
<ul>
<li>This will help identify what's being logged <em>too much</em></li>
<li>This is not the most effective way to find what <em>isn't being logged</em></li>
<li>To find what's <em>not being logged</em> you'll need to conduct (offensive) testing on your environment<ul>
<li><a href="https://github.com/redcanaryco/atomic-red-team">Atomic-Red-Team</a> can help with this</li>
</ul>
</li>
</ul>
<p>Find the frequency of all Sysmon Events:
<div class="highlight"><pre><span></span><code><span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">Logname</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">-Property</span> <span class="n">Id</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Count</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span>
</code></pre></div></p>
<p>Find the frequency of a known property in each event (in this case, the RuleName from sysmon-modular):
<div class="highlight"><pre><span></span><code><span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">Logname</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;10&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">0</span><span class="p">].</span><span class="n">value</span> <span class="p">}|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Descending</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Count</span><span class="p">,</span> <span class="n">Name</span>
</code></pre></div></p>
<h2 id="windows-logging">Windows Logging</h2>
<p>To see all available logs on a (Windows) system:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-ListLog</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Property</span> <span class="n">LogName</span>
</code></pre></div>
<p>To see the available properties for a log, use:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-MaxEvents</span> <span class="n">1</span> <span class="n">-LogName</span> <span class="s1">&#39;&lt;log&gt;&#39;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-Property</span> <span class="p">*</span>
</code></pre></div>
<h3 id="event-logs">Event Logs</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor">Microsoft Docs: Event IDs to Monitor</a></li>
<li><a href="https://github.com/strandjs/IntroLabs/blob/master/IntroClassFiles/Tools/IntroClass/DomainLogReview/DomainLogReview.md">Intro to SOC: Domain Log Review</a></li>
</ul>
<h3 id="log-size">Log Size</h3>
<ul>
<li><a href="https://www.tenable.com/audits/items/CIS_Microsoft_Windows_Server_2019_STIG_v1.0.1_L1_DC.audit:9c098551b8a388b5b1e037989c9ef0ee">Tenable: STIG SERVER2019 Security Event Log 196608 KB</a></li>
<li><a href="https://www.tenable.com/audits/items/DISA_STIG_Windows_10_v2r3.audit:00966725cee3c68f591dc1e58fc3e6db">Tenable: STIG WIN10 Security Event Log 1024000 KB</a></li>
<li><a href="https://help.deepsecurity.trendmicro.com/10_2/aws/Events-Alerts/Log-Event-Data-Storage.html#:~:text=Event%20log%20entries%20usually%20average,number%20of%20rules%20in%20place.">TrendMicro: Event Log File Sizes</a></li>
<li><a href="https://docs.splunk.com/Documentation/AddOns/released/MSSysmon/ConfigureSysmon#:~:text=The%20best%20practice%20is%20to,without%20a%20custom%20configuration%20file.">Splunk: Configuring Sysmon Logging</a></li>
</ul>
<p>Independant of how long your SIEM or central logging server is retaining all logs shipped to it, each endpoint should maintain between 200MB to 1GB (or more if the machine can tolerate it) of Sysmon and or Security event logs to ensure all events are properly captured and forwarded (not lost).</p>
<h3 id="windows-defender-logs">Windows Defender Logs</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide">Defender Event Log and Error Codes</a></li>
</ul>
<p>Get the latest instance of Id 1116, <code>MALWAREPROTECTION_STATE_MALWARE_DETECTED</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Windows Defender/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;1116&#39;</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p>Get all "Warning" events that aren't Id 1002, <code>MALWAREPROTECTION_SCAN_CANCELLED</code> (which can be a noisy event):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Windows Defender/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">LevelDisplayName</span> <span class="o">-eq</span> <span class="s1">&#39;Warning&#39;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-ne</span> <span class="n">1002</span> <span class="p">}</span>
</code></pre></div>
<p>Find any instances of Defender's configuration being changed:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Windows Defender/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5004</span> <span class="o">-or</span>  <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5007</span>  <span class="p">}</span>
</code></pre></div>
<p>Find any instances of Defender components being disabled or off:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Windows Defender/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5001</span> <span class="o">-or</span>  <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5008</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5010</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">5012</span> <span class="p">}</span>
</code></pre></div>
<h3 id="asr-events">ASR Events</h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/defender-endpoint/overview-attack-surface-reduction#list-of-attack-surface-reduction-events">List of ASR Events</a></li>
</ul>
<p>The link above includes raw XML you can import into the event viewer to filter for only ASR related log entries. The XML also contains the paths needed to query the event logs from PowerShell. This is a copy of that table for reference:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Provider/source</th>
<th style="text-align: center;">Event ID</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">1</td>
<td>ACG audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">2</td>
<td>ACG enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">3</td>
<td>Don't allow child processes audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">4</td>
<td>Don't allow child processes block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">5</td>
<td>Block low integrity images audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">6</td>
<td>Block low integrity images block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">7</td>
<td>Block remote images audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">8</td>
<td>Block remote images block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">9</td>
<td>Disable win32k system calls audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">10</td>
<td>Disable win32k system calls block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">11</td>
<td>Code integrity guard audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">12</td>
<td>Code integrity guard block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">13</td>
<td>EAF audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">14</td>
<td>EAF enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">15</td>
<td>EAF+ audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">16</td>
<td>EAF+ enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">17</td>
<td>IAF audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">18</td>
<td>IAF enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">19</td>
<td>ROP StackPivot audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">20</td>
<td>ROP StackPivot enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">21</td>
<td>ROP CallerCheck audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">22</td>
<td>ROP CallerCheck enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">23</td>
<td>ROP SimExec audit</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Security-Mitigations (Kernel Mode/User Mode)</td>
<td style="text-align: center;">24</td>
<td>ROP SimExec enforce</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>WER-Diagnostics</td>
<td style="text-align: center;">5</td>
<td>CFG Block</td>
</tr>
<tr>
<td>Exploit protection</td>
<td>Win32K (Operational)</td>
<td style="text-align: center;">260</td>
<td>Untrusted Font</td>
</tr>
<tr>
<td>Network protection</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">5007</td>
<td>Event when settings are changed</td>
</tr>
<tr>
<td>Network protection</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1125</td>
<td>Event when Network protection fires in Audit-mode</td>
</tr>
<tr>
<td>Network protection</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1126</td>
<td>Event when Network protection fires in Block-mode</td>
</tr>
<tr>
<td>Controlled folder access</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">5007</td>
<td>Event when settings are changed</td>
</tr>
<tr>
<td>Controlled folder access</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1124</td>
<td>Audited Controlled folder access event</td>
</tr>
<tr>
<td>Controlled folder access</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1123</td>
<td>Blocked Controlled folder access event</td>
</tr>
<tr>
<td>Controlled folder access</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1127</td>
<td>Blocked Controlled folder access sector write block event</td>
</tr>
<tr>
<td>Controlled folder access</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1128</td>
<td>Audited Controlled folder access sector write block event</td>
</tr>
<tr>
<td>Attack surface reduction</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">5007</td>
<td>Event when settings are changed</td>
</tr>
<tr>
<td>Attack surface reduction</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1122</td>
<td>Event when rule fires in Audit-mode</td>
</tr>
<tr>
<td>Attack surface reduction</td>
<td>Windows Defender (Operational)</td>
<td style="text-align: center;">1121</td>
<td>Event when rule fires in Block-mode</td>
</tr>
</tbody>
</table>
<p>Notable paths for PowerShell parsing include the following (keeping in mind only the event ID's above apply):</p>
<ul>
<li><code>LogName='Microsoft-Windows-Security-Mitigations/UserMode'</code></li>
<li><code>LogName='Microsoft-Windows-Security-Mitigations/KernelMode'</code></li>
<li><code>LogName='Microsoft-Windows-Win32k/Operational'</code></li>
<li><code>LogName='Microsoft-Windows-WER-Diag/Operational'</code></li>
<li><code>LogName='Microsoft-Windows-Windows Defender/Operational'</code></li>
</ul>
<p>Example queries, based on <code>LogName</code> and <code>$_.Id</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Security-Mitigations/UserMode&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Security-Mitigations/KernelMode&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="n">-neq</span> <span class="n">11</span> <span class="o">-and</span>  <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="n">-neq</span> <span class="n">12</span>  <span class="p">}</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Windows Defender/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">1121</span> <span class="o">-or</span>  <span class="nv">$_</span><span class="p">.</span><span class="n">Id</span> <span class="o">-eq</span> <span class="n">1122</span>  <span class="p">}</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
</code></pre></div>
<p><em>It's important to note that when a user is notified via a toast notificaiton, the alert details are not always available within the Windows Defender GUI to review. Using PowerShell will allow you to extract any matching logs and all details.</em></p>
<h3 id="logon-events">Logon Events</h3>
<p>This can be difficult to understand at first, as the normal Logon (ID 4624) and Logoff (ID 4634) events will produce numerous entries even if you simply sign out and back in to an account locally. Using these events alone can be difficult if you're trying to trace behavior. If you're looking for something similar to Linux's <code>last | head</code> then you need to query the Explicit Logon Attempt event (ID 4648).</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span><span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Security&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="n">TimeCreated</span> <span class="o">-gt</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span> <span class="p">|</span> <span class="nb">where </span><span class="n">Id</span> <span class="o">-eq</span> <span class="s1">&#39;4648&#39;</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span><span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Security&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="n">TimeCreated</span> <span class="o">-gt</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span> <span class="p">|</span> <span class="nb">where </span><span class="n">Id</span> <span class="o">-eq</span> <span class="s1">&#39;4648&#39;</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p>You can also use offensive tools to do this, such as <a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a>, which returns easily readable results:</p>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">Seatbelt</span><span class="p">.</span><span class="n">exe</span> <span class="n">ExplicitLogonEvents</span>
</code></pre></div>
<p>I wanted to mimic Seathbelt's output in PowerShell, so I wrote this script to accomplish that. This includes references to the <a href="#sysmon-logs">Sysmon Logs</a> section here, and also to the <a href="https://github.com/GhostPack/Seatbelt/blob/master/Seatbelt/Commands/Windows/EventLogs/ExplicitLogonEvents/ExplicitLogonEventsCommand.cs">C# source code for the ExplicitLogonEvents module in Seatbelt</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c"># MIT License</span>
<span class="c">#</span>
<span class="c"># Print unique logon information for a Windows system using built in event logs, in a clear way.</span>
<span class="c"># This returns every user login by default, but you can swap around variables below to suit your needs</span>
<span class="c"># As is, this will also catch shells like &quot;runas /user:username cmd.exe&quot;</span>
<span class="c">#</span>
<span class="c"># This script is meant to return data in a similar format as &quot;.\Seatbelt.exe ExplicitLogonEvents&quot; would:</span>
<span class="c"># [GhostPack/Seatbelt - ExplicitLogonEvents](https://github.com/GhostPack/Seatbelt/blob/master/Seatbelt/Commands/Windows/EventLogs/ExplicitLogonEvents/ExplicitLogonEventsCommand.cs)</span>
<span class="c">#</span>
<span class="c"># Parsing logs like this was learned from:</span>
<span class="c"># [Security Weekly Webcast - Sysmon: Gaining Visibility Into Your Enterprise](https://securityweekly.com/webcasts/sysmon-gaining-visibility-into-your-enterprise/)</span>
<span class="c"># [Slide Deck](https://securityweekly.com/wp-content/uploads/2022/04/alan-stacilauskas-unlock-sysmon-slide-demov4.pdf)</span>
<span class="c">#</span>
<span class="c"># Huge thanks to the presentors:</span>
<span class="c">#</span>
<span class="c"># [Alan Stacilauskas](https://www.alstacilauskas.com/)</span>
<span class="c"># [Amanda Berlin](https://twitter.com/@infosystir)</span>
<span class="c"># [Tyler Robinson](https://twitter.com/tyler_robinson)</span>

<span class="c"># Set a range of time to search in the logs</span>
<span class="c"># AddMinutes / AddHours / AddDays / AddMonths</span>
<span class="nv">$startTime</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span>

<span class="c"># This line will get you the relevant event log data to begin parsing</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span><span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Security&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="n">TimeCreated</span> <span class="o">-gt</span> <span class="nv">$startTime</span> <span class="p">|</span> <span class="nb">where </span><span class="n">Id</span> <span class="o">-eq</span> <span class="s1">&#39;4648&#39;</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span>
    <span class="c"># Variable names were kept the same as they are in Seatbelt&#39;s ExplicitLogonEventsCommand.cs</span>
    <span class="c"># Variable properties can be extracted from the Windows Event ID 4648 $_.Message object:</span>
    <span class="nv">$creationTime</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">TimeCreated</span>
    <span class="nv">$subjectUserSid</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">0</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$subjectUserName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$subjectDomainName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">2</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$subjectLogonId</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">3</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$logonGuid</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$targetUserName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">5</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$targetDomainName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">6</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$targetLogonGuid</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">7</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$targetServerName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">8</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$targetServerInfo</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">9</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$processId</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">10</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$processName</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">11</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$ipAddress</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">12</span><span class="p">].</span><span class="n">value</span>
    <span class="nv">$ipPort</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">13</span><span class="p">].</span><span class="n">value</span>

    <span class="c"># You can change this pattern variable and the if statement itself below if you&#39;d like to search for different data</span>
    <span class="c"># Basically the &quot;user logging in&quot; part of the login sequence captured by event logs is made by svchost.exe and not winlogon.exe</span>
    <span class="nv">$patternToMatch</span> <span class="p">=</span> <span class="s1">&#39;winlogon.exe&#39;</span>

    <span class="c"># Another approach is filtering for a blank username:</span>
    <span class="c"># if ($targetUserName -ne $nul) { ...</span>
    <span class="c">#</span>
    <span class="c"># Alternatively you could filter for:</span>
    <span class="c"># if ($targetUserName -inotmatch &quot;(UMFD-\d|DWM-\d)&quot;) { ...</span>
    <span class="c"># DWM-\d matches patterns of the Desktop Window Manager user</span>
    <span class="c"># UMFD-\d matches patterns of the Font Driver Host user</span>

    <span class="c"># Lastly, you could filter based on the source IP Address:</span>
    <span class="c"># if ($ipAddress -match $patternToMatch) {</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$processName</span> <span class="o">-inotmatch</span> <span class="nv">$patternToMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;$creationTime, $targetUserName, $targetDomainName, $targetServerName, $processName, $ipAddress&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="powershell-logs">PowerShell Logs</h3>
<ul>
<li>At minimum, enable Script Block logging (without Invocation Logging)</li>
<li>If possible, enable Transcription to a protected directory that's sent to a central logging server</li>
</ul>
<h4 id="module-logging">Module Logging</h4>
<p>Enable logging for selected PowerShell modules.</p>
<p><em>This may not be necessary if you enable script block logging.</em></p>
<h4 id="script-block-logging">Script Block Logging</h4>
<p>Logs PowerShell input (commands, functions, decodes and tracks script content)</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#enabling-script-block-logging">Enable Script Block Logging</a></li>
<li><code>Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"</code></li>
<li><code>Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on PowerShell Script Block Logging</code></li>
<li>Log Name: <code>Microsoft-Windows-PowerShell/Operational</code></li>
<li>Log Path: <code>C:\Windows\System32\winevt\Logs\Microsoft-Windows-PowerShell%4Operational.evtx</code></li>
</ul>
<p><em>Invocation Logging is an entirely optional checkbox under this Group Policy setting. It logs the start and stop of executions. This will flood your logs.</em></p>
<p>Enable Script Block Logging (without the start / stop Invocation Logging option):</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#using-the-registry</span>
<span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell\ScriptBlockLogging&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$null</span> <span class="p">=</span> <span class="nb">New-Item</span> <span class="nv">$basePath</span> <span class="n">-Force</span>
<span class="p">}</span>

<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScriptBlockLogging</span> <span class="n">-Value</span> <span class="s2">&quot;1&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScriptBlockInvocationLogging</span> <span class="n">-Value</span> <span class="s2">&quot;0&quot;</span>
</code></pre></div>
<p>Remove Script Block Logging:</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#using-the-registry</span>
<span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell\ScriptBlockLogging&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScriptBlockLogging</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableScriptBlockInvocationLogging</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://learn.microsoft.com/en-us/powershell/scripting/windows-powershell/wmf/whats-new/script-logging?view=powershell-7.3">Script Block logging has the benefit of being able to unwrap obfuscated functions and record their raw text.</a></p>
<p>This code sample from the Microsoft Docs link above reassembles large script blocks logged across multiple entries:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$created</span> <span class="p">=</span> <span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">ProviderName</span><span class="p">=</span><span class="s2">&quot;Microsoft-Windows-PowerShell&quot;</span><span class="p">;</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">4104</span> <span class="p">}</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.&lt;...&gt;</span> <span class="p">}</span>
<span class="nv">$sortedScripts</span> <span class="p">=</span> <span class="nv">$created</span> <span class="p">|</span> <span class="nb">sort </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">0</span><span class="p">].</span><span class="n">Value</span> <span class="p">}</span>
<span class="nv">$mergedScript</span> <span class="p">=</span> <span class="n">-join</span> <span class="p">(</span><span class="nv">$sortedScripts</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">2</span><span class="p">].</span><span class="n">Value</span> <span class="p">})</span>
</code></pre></div>
<h4 id="transcription-logging">Transcription Logging</h4>
<p>Logs PowerShell output (everything that appears in the powershell terminal session)</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_config?view=powershell-7.3#transcription">PowerShell Transcription</a></li>
<li><code>HKLM:\Software\Policies\Microsoft\Windows\PowerShell\Transcription</code></li>
<li><code>Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on PowerShell Script Block Logging</code></li>
<li>Log path is up to the user, written as a text file</li>
</ul>
<p>Enable PowerShell transcription, write output to C:\PSTranscripts:</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#using-the-registry</span>
<span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_config?view=powershell-7.3#transcription</span>
<span class="c"># https://github.com/clr2of8/PowerShellForInfoSec/blob/main/Tools/Set-PSLogging.ps1</span>
<span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell\Transcription&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$null</span> <span class="p">=</span> <span class="nb">New-Item</span> <span class="nv">$basePath</span> <span class="n">-Force</span>
<span class="p">}</span>

<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableTranscripting</span> <span class="n">-Value</span> <span class="s2">&quot;1&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableInvocationHeader</span> <span class="n">-Value</span> <span class="s2">&quot;1&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">OutputDirectory</span> <span class="n">-Value</span> <span class="s2">&quot;C:\PSTranscripts&quot;</span>
</code></pre></div>
<p>Remove PowerShell Transcription:</p>
<div class="highlight"><pre><span></span><code><span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging?view=powershell-5.1#using-the-registry</span>
<span class="c"># https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_config?view=powershell-7.3#transcription</span>
<span class="c"># https://github.com/clr2of8/PowerShellForInfoSec/blob/main/Tools/Set-PSLogging.ps1</span>
<span class="nv">$basePath</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s1">&#39;HKLM:\Software\Policies\Microsoft\Windows&#39;</span>
    <span class="s1">&#39;PowerShell\Transcription&#39;</span>
<span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;\&#39;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$basePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableTranscripting</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">EnableInvocationHeader</span>
    <span class="nb">Remove-ItemProperty</span> <span class="nv">$basePath</span> <span class="n">-Name</span> <span class="n">OutputDirectory</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="sysmon-logs">Sysmon Logs</h3>
<p>This is a quick start on how to read your Sysmon logs.
- <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.2">Get-WinEvent</a></p>
<p>These will help in building statements to parse logs conditionally with more granularity:
- <a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/deep-dives/everything-about-if?view=powershell-7.2">PowerShell if Statements</a>
- <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/out-string?view=powershell-7.2">Out-String</a></p>
<p>Note that if you do not use <code>Sort-Object -Unique</code> or similar, logs will be displayed from oldest (top) to newest (bottom). It is also not necessary to use <code>Out-String</code> if you prefer working with PowerShell objects over strings.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/group-object?view=powershell-7.3">Group-Object</a></li>
</ul>
<p><strong>Another tip is using <code>&lt;cmds&gt;... | Group-Object | Select-Object Count, Name | Sort-Object Count -Descending</code>. This is the PowerShell equivalent to Unix's <code>... | sort | uniq -c | sort -nr</code>, grouping unique results into order based on occurrance.</strong></p>
<p>This webcast is an excellent resource, not just for rule creation but various ways to script and parse logs, and essentially a quick start to Sysmon threat hunting via the CLI and GUI:</p>
<ul>
<li><a href="https://securityweekly.com/webcasts/sysmon-gaining-visibility-into-your-enterprise/">Security Weekly Webcast - Sysmon: Gaining Visibility Into Your Enterprise</a></li>
<li><a href="https://securityweekly.com/wp-content/uploads/2022/04/alan-stacilauskas-unlock-sysmon-slide-demov4.pdf">Slide Deck</a></li>
</ul>
<p>Huge thanks to the presentors:</p>
<ul>
<li><a href="https://www.alstacilauskas.com/">Alan Stacilauskas</a></li>
<li><a href="https://twitter.com/@infosystir">Amanda Berlin</a></li>
<li><a href="https://twitter.com/tyler_robinson">Tyler Robinson</a></li>
</ul>
<p>Additional resources from the presentation, discord, and other trainings:</p>
<ul>
<li><a href="https://www.blumira.com/integration/poshim-automate-windows-log-collection/">Poshim - Automated Windows Log Collection</a></li>
<li><a href="https://github.com/countercept/chainsaw">Chainsaw</a></li>
<li><a href="https://github.com/sans-blue-team/DeepBlueCLI">DeepBlueCLI</a></li>
<li><a href="https://github.com/Yamato-Security/hayabusa">Hayabusa</a></li>
<li><a href="https://github.com/olafhartong/sysmon-modular">Sysmon Modular - Olaf Hartong</a></li>
<li><a href="https://github.com/SwiftOnSecurity/sysmon-config">Sysmon Config - SwiftOnSecurity</a></li>
</ul>
<p>There are two easy ways of parsing log output:</p>
<table>
<thead>
<tr>
<th>Technique</th>
<th>TypeName</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\| select { $_.properties[4].value }</code></td>
<td>Selected.System.Diagnostics.Eventing.Reader.EventLogRecord</td>
</tr>
<tr>
<td><code>\| ForEach-Object { Out-String -InputObject $_.properties[4].value }</code></td>
<td>System.String</td>
</tr>
</tbody>
</table>
<p>The technique of using <code>ForEach-Object { Out-String -InputObject $_.properties[x,y,z].value }</code> was highlighted during the webcast.</p>
<hr />
<p>To parse <em>any</em> event logs quickly and effectively:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/scripting/samples/creating-get-winevent-queries-with-filterhashtable?view=powershell-7.3">Use a hash table</a></li>
<li>Set a start time</li>
<li>Obtain object property values</li>
</ul>
<p>You can get any log's property values by piping it to <code>| select -First 1 | fl</code>. Each line in the Message block relates to a value.</p>
<p>Specify multiple values like this: <code>$_.properties[0,1,5,6].value</code></p>
<p>You can also specifiy a series of values with two <code>..</code> dots between them like: <code>$_.properties[0..20].value</code></p>
<p>Set the start time as a variable:
<div class="highlight"><pre><span></span><code><span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddMinutes</span><span class="p">(-</span><span class="n">30</span><span class="p">)</span>
<span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddHours</span><span class="p">(-</span><span class="n">1</span><span class="p">)</span>
<span class="nv">$StartDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">2</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="sysmon-event-ids">Sysmon Event IDs</h4>
<p>These references can help you sort through event properties visually.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#events">Sysmon: Events</a></li>
<li><a href="https://www.blackhillsinfosec.com/a-sysmon-event-id-breakdown/">BHIS: Sysmon Event ID Breakdown</a></li>
<li><a href="https://github.com/olafhartong/sysmon-cheatsheet/blob/master/Sysmon-Cheatsheet-dark.pdf">olafhartong/sysmon-cheatsheet (PDF)</a></li>
</ul>
<h4 id="id-22-dns-queries">ID 22: DNS Queries</h4>
<p>DNS query property values:</p>
<ul>
<li>[0]RuleName</li>
<li>[1]UtcTime</li>
<li>[2]ProcessGuid</li>
<li>[3]ProcessId</li>
<li>[4]QueryName</li>
<li>[5]QueryStatus</li>
<li>[6]QueryResults</li>
<li>[7]Image</li>
<li>[8]User</li>
</ul>
<p>Show all unique DNS queries (ID 22) and sort them by frequency:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;22&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Count</span><span class="p">,</span><span class="n">Name</span>
</code></pre></div></p>
<p>Show all DNS queries (ID 22) that contain "google":
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;22&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="o">-imatch</span> <span class="s2">&quot;google&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Count</span><span class="p">,</span><span class="n">Name</span>
</code></pre></div></p>
<p>Show all DNS queries (ID 22) and when they were made:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">Logname</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;22&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Out-String</span> <span class="n">-InputObject</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span>
</code></pre></div></p>
<h4 id="id-3-network-connection">ID 3: Network Connection</h4>
<p>Network connection property values:</p>
<ul>
<li>[0]RuleName</li>
<li>[1]UtcTime</li>
<li>[2]ProcessGuid</li>
<li>[3]ProcessId</li>
<li>[4]Image</li>
<li>[5]User</li>
<li>[6]Protocol</li>
<li>[7]Initiated</li>
<li>[8]SourceIsIpv6</li>
<li>[9]SourceIp</li>
<li>[10]SourceHostname</li>
<li>[11]SourcePort</li>
<li>[12]SourcePortName</li>
<li>[13]DestinationIsIpv6</li>
<li>[14]DestinationIp</li>
<li>[15]DestinationHostname</li>
<li>[16]DestinationPort</li>
<li>[17]DestinationPortName</li>
</ul>
<p>Show all unique executables that made a network connection, filter out <code>msedge.exe</code> and <code>svchost.exe</code>, sort by frequency:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;3&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="o">-inotmatch</span> <span class="s2">&quot;(msedge.exe|svchost.exe)&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Count</span><span class="p">,</span> <span class="n">Name</span>
</code></pre></div></p>
<p>Using the query above, get all unique destination IPs, sort by frequency:</p>
<ul>
<li>Use this to filter network activity</li>
<li>Feed the returned list of IPs to a threat intel platform</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;3&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="o">-inotmatch</span> <span class="s2">&quot;(msedge.exe|svchost.exe)&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">14</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Count</span><span class="p">,</span> <span class="n">Name</span>
</code></pre></div>
<p>Show all network connections (ID 3), what executable made them, when, and destination IP / hostname:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;3&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Out-String</span> <span class="n">-InputObject</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">14</span><span class="p">,</span><span class="n">15</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span>
</code></pre></div></p>
<h4 id="id-1-process-creation">ID 1: Process Creation</h4>
<p>Process creation property values:
- [0]RuleName
- [1]UtcTime
- [2]ProcessGuid
- [3]ProcessId
- [4]Image
- [5]FileVersion
- [6]Description
- [7]Product
- [8]Company
- [9]OriginalFileName
- [10]CommandLine
- [11]CurrentDirectory
- [12]User
- [13]LogonGuid
- [14]LogonId
- [15]TerminalSessionId
- [16]IntegrityLevel
- [17]Hashes
- [18]ParentProcessGuid
- [19]ParentProcessId
- [20]ParentImage
- [21]ParentCommandLine
- [22]ParentUser</p>
<p>List all processes created (ID 1) by timestamp, PID, executable, commandline, executable hashes, and PPID:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Out-String</span> <span class="n">-InputObject</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">3</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">10</span><span class="p">,</span><span class="n">17</span><span class="p">,</span><span class="n">19</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span>
</code></pre></div></p>
<p>List all details of all processes created (ID 1):
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div></p>
<p>List all details of (ID 1) log entries where the RuleName field contains "Discovery":
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">0</span><span class="p">].</span><span class="n">value</span> <span class="o">-imatch</span> <span class="s2">&quot;Discovery&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div></p>
<p>List how many times each executable created a process (ID 1), sorted by frequency:
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">4</span><span class="p">].</span><span class="n">value</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Count</span><span class="p">,</span><span class="n">Name</span>
</code></pre></div></p>
<h4 id="id-10-process-accessed">ID 10: Process Accessed</h4>
<p>Process accessed property values:
- [0]RuleName
- [1]UtcTime
- [2]SourceProcessGUID
- [3]SourceProcessId
- [4]SourceThreadId
- [5]SourceImage
- [6]TargetProcessGUID
- [7]TargetProcessId
- [8]TargetImage
- [9]GrantedAccess
- [10]CallTrace
- [11]SourceUser
- [12]TargetUser</p>
<p>Detect LSASS access (currently this just matches the first entry that has the string "lsass" anywhere in the log, needs revised to be more precise):
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span> <span class="n">LogName</span><span class="p">=</span><span class="s1">&#39;Microsoft-Windows-Sysmon/Operational&#39;</span><span class="p">;</span> <span class="n">StartTime</span><span class="p">=</span><span class="nv">$StartDate</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="s1">&#39;10&#39;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">0</span><span class="p">..</span><span class="n">30</span><span class="p">].</span><span class="n">value</span> <span class="o">-imatch</span> <span class="s2">&quot;lsass&quot;</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
</code></pre></div></p>
<h2 id="services">Services</h2>
<h3 id="openssh">OpenSSH</h3>
<table>
<thead>
<tr>
<th>Directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C:\ProgramData\ssh\</code></td>
<td>Main configuration folder, <code>/etc/ssh/</code> equivalent</td>
</tr>
<tr>
<td><code>C:\Users\$USER\.ssh\</code></td>
<td>User folder, <code>~/.ssh</code> equivalent</td>
</tr>
</tbody>
</table>
<p>Steps to setup OpenSSH Server (The OpenSSH Client is typically installed by default).</p>
<ol>
<li>
<p>Update Windows</p>
</li>
<li>
<p>Install OpenSSH Server Optional Feature</p>
</li>
</ol>
<p>See the following Microsoft documentation of OpenSSH for additional context:</p>
<p><a href="https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse">https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse</a></p>
<blockquote>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WindowsCapability</span> <span class="n">-Online</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">Name</span> <span class="o">-like</span> <span class="s1">&#39;OpenSSH*&#39;</span>

<span class="c"># Install the OpenSSH Client</span>
<span class="nb">Add-WindowsCapability</span> <span class="n">-Online</span> <span class="n">-Name</span> <span class="n">OpenSSH</span><span class="p">.</span><span class="n">Client</span><span class="p">~~~~</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>

<span class="c"># Install the OpenSSH Server</span>
<span class="nb">Add-WindowsCapability</span> <span class="n">-Online</span> <span class="n">-Name</span> <span class="n">OpenSSH</span><span class="p">.</span><span class="n">Server</span><span class="p">~~~~</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>

<span class="c"># Start the sshd service</span>
<span class="nb">Start-Service</span> <span class="n">sshd</span>
</code></pre></div>
</blockquote>
<ol>
<li>Configure:</li>
</ol>
<blockquote>
<div class="highlight"><pre><span></span><code><span class="c"># OPTIONAL but recommended:</span>
<span class="nb">Set-Service</span> <span class="n">-Name</span> <span class="n">sshd</span> <span class="n">-StartupType</span> <span class="s1">&#39;Automatic&#39;</span>

<span class="c"># Confirm the Firewall rule is configured. It should be created automatically by setup. Run the following to verify</span>
<span class="k">if</span> <span class="p">(!(</span><span class="nb">Get-NetFirewallRule</span> <span class="n">-Name</span> <span class="s2">&quot;OpenSSH-Server-In-TCP&quot;</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Enabled</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">Write-Output</span> <span class="s2">&quot;Firewall Rule &#39;OpenSSH-Server-In-TCP&#39; does not exist, creating it...&quot;</span>
    <span class="nb">New-NetFirewallRule</span> <span class="n">-Name</span> <span class="s1">&#39;OpenSSH-Server-In-TCP&#39;</span> <span class="n">-DisplayName</span> <span class="s1">&#39;OpenSSH Server (sshd)&#39;</span> <span class="n">-Enabled</span> <span class="n">True</span> <span class="n">-Direction</span> <span class="n">Inbound</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-Action</span> <span class="n">Allow</span> <span class="n">-LocalPort</span> <span class="n">22</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">Write-Output</span> <span class="s2">&quot;Firewall rule &#39;OpenSSH-Server-In-TCP&#39; has been created and exists.&quot;</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>
<p>Change the following in <code>C:\ProgramData\ssh\sshd_config</code>:
<div class="highlight"><pre><span></span><code>#PasswordAuthentication Yes
</code></pre></div>
To:
<div class="highlight"><pre><span></span><code>PasswordAuthentication no
</code></pre></div></p>
<p>Place public key data into:
<div class="highlight"><pre><span></span><code>C:\Users\$USER\.ssh\authorized_keys
C:\ProgramData\ssh\administrators_authorized_keys
</code></pre></div></p>
<p>Like on Unix systems, the permissions must be correct on the authorized_key files. See the following page on the Win32-OpenSSH Wiki for detailed descriptions:</p>
<p><a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Security-protection-of-various-files-in-Win32-OpenSSH">https://github.com/PowerShell/Win32-OpenSSH/wiki/Security-protection-of-various-files-in-Win32-OpenSSH</a></p>
<p>Then, if the user you'll be logging in as IS NOT an administrator:
<div class="highlight"><pre><span></span><code><span class="n">takeown</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">F</span> <span class="p">.\</span><span class="n">authorized_keys</span> <span class="p">/</span><span class="n">S</span> <span class="nv">$HOSTNAME</span> <span class="p">/</span><span class="n">U</span> <span class="nv">$USER</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">authorized_keys</span> <span class="p">/</span><span class="n">reset</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">authorized_keys</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">authorized_keys</span> <span class="p">/</span><span class="n">grant</span> <span class="nv">$USER</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
</code></pre></div></p>
<p>or if the user you'll be logging in as IS an administrator:
<div class="highlight"><pre><span></span><code><span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">authorized_keys</span> <span class="p">/</span><span class="n">reset</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="nb">r</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">grant</span> <span class="n">SYSTEM</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
<span class="n">icacls</span><span class="p">.</span><span class="n">exe</span> <span class="p">.\</span><span class="n">administrators_authorized_keys</span> <span class="p">/</span><span class="n">grant</span> <span class="n">BUILTIN</span><span class="p">\</span><span class="n">Administrators</span><span class="p">:</span><span class="s2">&quot;(F)&quot;</span>
</code></pre></div></p>
<ol>
<li>Applying Configuration Changes</li>
</ol>
<p>Anytime you update or modify <code>C:\ProgramData\ssh\sshd_config</code>, be sure to restart the <code>sshd</code> service so that it reads and loads the latest changes:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Restart-Service</span> <span class="n">sshd</span>
</code></pre></div>
<hr />
<h2 id="scheduled-tasks">Scheduled Tasks</h2>
<p>List all scheduled tasks by creation date:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ScheduledTask</span> <span class="n">-TaskName</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Property</span> <span class="n">Date</span><span class="p">,</span><span class="n">Author</span><span class="p">,</span><span class="n">Taskname</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Date</span>
</code></pre></div>
<p>View scheduled tasks' creation date in the GUI:</p>
<p>Task Scheduler &gt; Task Scheduler (Local) &gt; Task Scheduler Library &gt; [TaskName] &gt; Created</p>
<p>Autoruns will also quickly identify any scheduled tasks in the <code>Scheduled Tasks</code> tab.</p>
<ul>
<li>Hide: Windows Entries</li>
<li>Hide: Microsoft Entries</li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns">https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns</a></p>
<h3 id="log-audit-task-creation">Log &amp; Audit Task Creation</h3>
<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698#security-monitoring-recommendations">https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698#security-monitoring-recommendations</a></p>
<p>Using the GUI:</p>
<p>Run <code>gpedit.msc</code></p>
<p><code>Local Computer Policy &gt; Windows Settings &gt; Security Settings &gt; Advanced Audit Policy Configuration &gt; Object Access &gt; Audit Other Object Access Events</code></p>
<p>Choose <code>Configure the following audit events</code></p>
<p>Choose <code>Success</code>, then <code>Apply</code> and <code>OK</code></p>
<p>Now you can query the event logs for occurances of scheduled task creation:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s2">&quot;Security&quot;</span> <span class="p">|</span> <span class="nb">Where </span><span class="n">Id</span> <span class="o">-eq</span> <span class="s2">&quot;4698&quot;</span>
<span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s2">&quot;Security&quot;</span> <span class="p">|</span> <span class="nb">Where </span><span class="n">Id</span> <span class="o">-eq</span> <span class="s2">&quot;4698&quot;</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Property</span> <span class="p">*</span>
</code></pre></div>
<p><strong>TO DO</strong>: Configure scheduled task creation auditing using only PowerShell</p>
<p>You can locate registry items just like searching the filesystem.</p>
<p>We know the policy for scheduled task logging is related to "Object Access":</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\*object*access*&quot;</span> <span class="n">-Recurse</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</code></pre></div>
<p>After a possible delay while it searches, you should find it at this path, and be able to check it's values:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\PolicyManager\default\Audit\ObjectAccess_AuditOtherObjectAccessEvents&quot;</span>
</code></pre></div>
<hr />
<h2 id="wmi">WMI</h2>
<ul>
<li><a href="https://github.com/strandjs/IntroLabs/blob/master/IntroClassFiles/Tools/IntroClass/WindowsCLI/WindowsCLI.md">Intro to SOC: Windows CLI</a></li>
<li><a href="https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/basic-cmd-for-pentesters.md">Hacktricks: CMD</a></li>
<li><a href="https://github.com/carlospolop/hacktricks/tree/master/windows-hardening/basic-powershell-for-pentesters">Hacktricks: PowerShell</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Powershell%20-%20Cheatsheet.md">PayloadsAllTheThings: PowerShell</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Persistence.md#windows-management-instrumentation-event-subscription">PayloadsAllTheThings: WMI Event Subscription</a></li>
</ul>
<hr />
<h2 id="disk-management">Disk Management</h2>
<p>This SuperUser answer by user VainMan is an excellent walkthrough of managing disks with just built in Windows tools:</p>
<ul>
<li><a href="https://web.archive.org/web/20220612105334/https://superuser.com/questions/1453790/how-to-move-the-recovery-partition-on-windows-10">SuperUser: How to Move the Recovery Partition on Windows 10</a><ul>
<li><a href="https://stackoverflow.com/legal/terms-of-service#licensing">https://stackoverflow.com/legal/terms-of-service#licensing</a></li>
<li>This section is released under the same <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA-4.0</a> license as the original post.</li>
</ul>
</li>
</ul>
<p>PowerShell Cmdlets:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/storage/get-disk?view=windowsserver2022-ps#description">Get-Disk</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/storage/set-disk?view=windowsserver2022-ps#description">Set-Disk</a></li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/storage/?view=windowsserver2022-ps">List of All Storage Cmdlets</a></li>
</ul>
<p>Additional documentation for this section:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/capture-and-apply-windows-system-and-recovery-partitions?view=windows-11">Microsoft Docs: Capture and Apply the System and Recovery Partitions</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/diskpart"><code>diskpart.exe</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/what-is-dism?view=windows-11"><code>dism.exe</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/reagentc-command-line-options?view=windows-11"><code>reagentc.exe</code></a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/mountvol"><code>mountvol.exe</code></a></li>
<li><code>diskmgmt.mmc</code></li>
</ul>
<h3 id="mount-and-unmount-volumes-and-drives-gui">Mount and Unmount Volumes and Drives (GUI)</h3>
<p>The <a href="https://learn.microsoft.com/en-us/windows/client-management/client-tools/change-default-removal-policy-external-storage-media">default external storage removal policy</a> in recent versions of Windows (since Windows 10 1809) is <strong>Quick removal</strong>.</p>
<p>See: <code>diskmgmt.msc</code> &gt; Right-Click the Disk number, select <code>Properties</code> &gt; Policies Tab</p>
<ul>
<li><strong>Quick removal</strong>: You can remove the device without using the "Safely Remove Hardware" process</li>
<li><strong>Better performance</strong>: Improved system resource usage, data is cached but you will need to use "Safely Remove Hardware" to avoid data loss</li>
</ul>
<p>Set a Drive to Offline:</p>
<ul>
<li>Also in the <code>diskmgmt.msc</code> window, Right-Click the Disk number</li>
<li>Select <code>Offline</code> to take the drive offline</li>
<li>This unmounts the drive, and prevents accidental writes or access</li>
<li>You can also use <a href="https://learn.microsoft.com/en-us/powershell/module/storage/set-disk?view=windowsserver2022-ps#example-2"><code>Set-Drive</code></a> to take a disk offline or make it read-only</li>
</ul>
<h3 id="mount-and-unmount-volumes-and-drives-cli">Mount and Unmount Volumes and Drives (CLI)</h3>
<p>This is functionally the equivalent of using <code>diskmgmt.mmc</code> in any of the following ways:</p>
<ul>
<li>Create a new simple volume from unallocated space, or format an external drive and assigning it a drive letter</li>
<li>Unmounting the drive (removing the drive letter)</li>
<li>Deleting the volume altogether</li>
</ul>
<p>Get the <code>VolumeName</code> of the <code>G:</code> drive:
<div class="highlight"><pre><span></span><code>mountvol.exe G: /L
     \\?\Volume{12345678-abcd-efab-cdef-01234567890a}\
</code></pre></div></p>
<p>Unmount the <code>G:</code> drive
<div class="highlight"><pre><span></span><code>mountvol.exe G: /P
</code></pre></div></p>
<ul>
<li>The volume will still exist</li>
<li>The mount point will no longer be traversable since there's no longer an assigned drive letter</li>
<li><code>Get-ItemProperty -Path "HKLM:\SYSTEM\MountedDevices"</code> will show a <code>#{GUID}</code> instead of <code>\DosDevices\G:</code></li>
<li>Even if you assign the volume a new drive letter, it will know it's tied to the same <code>#{GUID}</code> and replace it with <code>\DosDevices\&lt;letter&gt;:</code></li>
</ul>
<p>Mount the volume to a new drive letter (quote the VolumeName string):
<div class="highlight"><pre><span></span><code>mountvol.exe X: &#39;\\?\Volume{12345678-abcd-efab-cdef-01234567890a}\&#39;
</code></pre></div></p>
<p>Remove the volume, delete the volume (meaning all data on the volume), then clean up any leftover artifiacts in the registry</p>
<ul>
<li><code>Get-ItemProperty -Path "HKLM:\SYSTEM\MountedDevices"</code> will still show a <code>#{GUID}</code> after deleting a volume with any disk tool</li>
<li>The deleted volume should still be visible in <code>diskmgmt.mmc</code> until you delete its registry entry, then close and open <code>diskmgmt.mmc</code> again</li>
<li><code>mountvol.exe /R</code> will remove this registry entry once the volume no longer exists</li>
<li>If the volume still exists, <code>mountvol.exe /R</code> will not remove the entry</li>
<li>If you format the same volume again and mount it, you'll note it retains the same <code>#{GUID}</code> when unmounted</li>
</ul>
<div class="highlight"><pre><span></span><code>mountvol.exe G: /P
diskpart.exe
&gt; list volume
&gt; select Volume 1
&gt; delete
&gt; exit
mountvol.exe /R
</code></pre></div>
<h3 id="extend-the-c-drive">Extend the C Drive</h3>
<p>Extending the C drive isn't intuitive because the partition the OS is installed on is sandwiched between the boot and recovery partitions. Even if you have free space (say on a newly extended VM or on a dual boot machine where you're removing the other OS) you cannot extend the installed partition without moving the recovery partition.</p>
<p>This entire example essentially mirrors the SuperUser answer linked above, with only small additions or changes to focus on backing up the recovery partition, deleting it so that the <code>C:</code> partition can be extended, then appending the backup recovery partition image to the new end of the <code>C:</code> partition.</p>
<p>Mount the recovery partition
<div class="highlight"><pre><span></span><code>diskpart
list disk
select disk &lt;disk&gt;
list partition
select partition &lt;partition&gt;
assign letter=R
exit
</code></pre></div>
Create an image file with the <code>dd</code>-like <code>dism.exe</code> utility:
<div class="highlight"><pre><span></span><code>dism /Capture-Image /ImageFile:C\recovery-partition.wim /CaptureDir:R:\ /Name:&quot;Recovery&quot;
</code></pre></div></p>
<p>Delete the current recovery partition:
<div class="highlight"><pre><span></span><code>diskpart
select volume R
delete partition override
exit
</code></pre></div></p>
<ul>
<li>Extend the <code>C:\</code> drive in Disk Management</li>
<li>Create a new volume (+ new drive letter)</li>
<li>Apply the recovery image to the new volume using the new drive letter</li>
</ul>
<div class="highlight"><pre><span></span><code>dism /Apply-Image /ImageFile:C:\recovery-partition.wim /Index:1 /ApplyDir:R:\
</code></pre></div>
<p>Register the new recovery location
<div class="highlight"><pre><span></span><code>reagentc /disable
reagentc /setreimage /path R:\Recovery\WindowsRE
reagentc /enable
</code></pre></div></p>
<p>Unmount that drive letter to return the recovery partition to a 'hidden' state
<div class="highlight"><pre><span></span><code>diskpart
select volume R
remove
exit
</code></pre></div></p>
<ul>
<li>You'll be able to see in Disk Management the Recovery (or whatever you named it) partition loses it's new drive letter</li>
</ul>
<p>Optionally:
- Confirm the recovery partition is working with <code>reagentc /info</code>
- Boot into recovery <code>reagentc /boottore /logfile C:\Temp\Reagent.log</code>
- Delete the recovery image file <code>del C:\recovery-image.wim</code></p>
<h3 id="prevent-automatic-mounting-of-new-volumes">Prevent Automatic Mounting of New Volumes</h3>
<p><em>NOTE: this still needs tested, and does not appear to work as expected.</em></p>
<p>This is useful in forensics where you want to connect an external drive but do not want to mount or open the filesystem.</p>
<p>On Windows Server, this is a built in utility: <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/automount"><code>automount</code></a>.</p>
<p>On a Windows workstation, you must use <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/mountvol"><code>mountvol.exe</code></a>.</p>
<p>Disables automatic mounting of new basic volumes. New volumes are not mounted automatically when added to the system.
<div class="highlight"><pre><span></span><code>mountvol.exe /N
</code></pre></div></p>
<ul>
<li>Now <code>mountvol.exe /?</code> will print a message at the bottom of the usage information noting if automatic mounting is disabled</li>
</ul>
<p>Re-enables automatic mounting of new basic volumes.
<div class="highlight"><pre><span></span><code>mountvol.exe /E
</code></pre></div></p>
<h3 id="efi-partition">EFI Partition</h3>
<p>This mounts the <code>\EFI</code> partiton under <code>E:\</code> if it's available (you can use any available drive letter).
<div class="highlight"><pre><span></span><code>mountvol.exe E: /S
</code></pre></div></p>
<p>If you want to review the 10 most recently modified files in the EFI partition mounted at <code>E:\</code>:
<div class="highlight"><pre><span></span><code><span class="nb">gci </span><span class="n">E</span><span class="p">:\</span><span class="n">EFI</span> <span class="n">-Recurse</span> <span class="n">-Force</span> <span class="o">-File</span> <span class="p">|</span> <span class="nb">sort </span><span class="n">LastWriteTime</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="n">10</span> <span class="n">FullName</span><span class="p">,</span><span class="n">LastWriteTime</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$nul</span>
</code></pre></div></p>
<p>Get a list of all filetypes found in <code>E:\EFI</code>:
<div class="highlight"><pre><span></span><code><span class="nb">gci </span><span class="n">E</span><span class="p">:\</span><span class="n">EFI</span> <span class="n">-Recurse</span> <span class="n">-Force</span> <span class="o">-File</span> <span class="p">|</span> <span class="nb">sort </span><span class="n">LastWriteTime</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Extension</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$nul</span>
</code></pre></div></p>
<p>Check the signature of every file in <code>E:\EFI</code>, using <code>C:\Tools\sigcheck64.exe</code>:
<div class="highlight"><pre><span></span><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$efi_file</span> <span class="k">in</span> <span class="p">(</span><span class="nb">gci </span><span class="n">E</span><span class="p">:\</span> <span class="n">-Recurse</span> <span class="n">-Force</span> <span class="o">-File</span><span class="p">).</span><span class="n">FullName</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">sigcheck64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-accepteula</span> <span class="nv">$efi_file</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;^\s+Verified:\s+Signed$&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">GREEN</span> <span class="s2">&quot;[OK]$efi_file&quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">RED</span> <span class="s2">&quot;[WARNING]$efi_file&quot;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></p>
<hr />
<h2 id="device-management">Device Management</h2>
<p>Restricting device and driver installation.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy">Manage Device Installation with Group Policy</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors">System Defined Device Setup Classes Available to Vendors</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-reserved-for-system-use">System Defined Device Setup Classes Reserved for System Use</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/usbcon/usb-device-descriptors">USB Device Descriptors</a></li>
</ul>
<h3 id="device-id-strings">Device ID Strings</h3>
<p><a href="https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy#determine-device-identification-strings">https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy#determine-device-identification-strings</a></p>
<p>The <code>Class GUID</code> is the type of device, for example a printer or a tablet.</p>
<p>The <code>Instance ID</code>, <code>Hardware IDs</code>, and <code>Compatible IDs</code> are identifiers for the device. The most specific is the <code>Instance ID</code>. This relates to that one device, and individual devices may have multiple <code>Instance ID</code>s. You'll need these ID's to 'allow' or 'deny' devices.</p>
<h3 id="enum-device-id-strings-cmdexe">Enum Device ID Strings (cmd.exe)</h3>
<p>You can start like this from a command prompt with <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/pnputil"><code>pnputil</code></a>:</p>
<div class="highlight"><pre><span></span><code>pnputil /enum-devices /connected
</code></pre></div>
<p>If you were trying to find a single device, scroll through the list to determine the possible <code>Class GUID</code> of the device you're looking for.</p>
<p>Next you'd query connected devices of that class. This should narrow down the results enough for you to identify the exact device.</p>
<div class="highlight"><pre><span></span><code>pnputil /enum-devices /connected /class &#39;{&lt;guid&gt;}&#39;
</code></pre></div>
<p>In this case, the <code>Device Description</code> fields most closely matching and describing your device are usually the right ones.</p>
<p>Finally, query the device directly using the <code>Instance ID</code> (there may be multiple <code>Instand ID</code>s for the same device, query each one you find) and this time also print the <code>Hardware IDs</code> and <code>Compatible IDs</code> for each instance:</p>
<div class="highlight"><pre><span></span><code>pnputil /enum-devices /instanceid &#39;&lt;instance-id&gt;&#39; /ids
</code></pre></div>
<h3 id="enum-device-id-strings-powershell">Enum Device ID Strings (PowerShell)</h3>
<p>All the credit for this one goes to the <a href="https://devblogs.microsoft.com/powershell/">PowerShell Team</a> over on the Microsoft DevBlogs:</p>
<ul>
<li><a href="https://web.archive.org/web/20220903134605/https://devblogs.microsoft.com/powershell/displaying-usb-devices-using-wmi/">Displaying USB Devices Using WMI</a></li>
</ul>
<p>This will gather all of your connected USB devices in a single line:</p>
<blockquote>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">Win32_USBControllerDevice</span> <span class="p">|</span> <span class="p">%{</span><span class="no">[wmi]</span><span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Dependent</span><span class="p">)}</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Description</span><span class="p">,</span><span class="n">DeviceID</span> <span class="p">|</span> <span class="nb">ft </span><span class="n">Description</span><span class="p">,</span><span class="n">DeviceID</span> <span class="n">-auto</span>
</code></pre></div>
</blockquote>
<p>We can append <code>ClassGuid</code>, <code>HardwareID</code>, and or <code>CompatibleID</code> onto an <code>fl</code> instead of an <code>ft</code> command to obtain the other IDs as well:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">Win32_USBControllerDevice</span> <span class="p">|</span> <span class="p">%{</span><span class="no">[wmi]</span><span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Dependent</span><span class="p">)}</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Description</span><span class="p">,</span><span class="n">DeviceID</span> <span class="p">|</span> <span class="nb">fl </span><span class="n">Description</span><span class="p">,</span><span class="n">DeviceID</span><span class="p">,</span><span class="n">ClassGuid</span><span class="p">,</span><span class="n">HardwareID</span><span class="p">,</span><span class="n">CompatibleID</span>
</code></pre></div>
<p>In any case, you'll want to note the <code>Instance ID</code>, <code>Hardware IDs</code>, and <code>Compatible IDs</code> for use with policy configuration.</p>
<p>As mentioned in #3 of <a href="https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy#scenario-steps--preventing-installation-of-prohibited-devices">Scenario steps - preventing installation of prohibited devices</a>, be sure you know exactly what will be blocked by the policy before deploying it. It's recommended to test all of this in a VM, as you can quickly recover from a policy that's too broad (which could block all external devices preventing you from using or recovering the machine).</p>
<p>Devices are evaluated by the <code>Apply layered order of evaluation for Allow and Prevent device installation policies across all device match criteria</code> policy in the following order:</p>
<ul>
<li>Device Instance IDs</li>
<li>Device IDs (hardware / compatible)</li>
<li>Device Setup Class</li>
<li>Removeable Devices</li>
</ul>
<p><code>Device Instance IDs</code> are the most specific and always take precedence.</p>
<p>To allow only trusted devices while defaulting to blocking all others:</p>
<ul>
<li>Enter the ID's of devices you wish to allow under <code>Allow installation of devices that match any of these device instance IDs</code> and enable this policy</li>
<li>Set <code>Apply layered order of evaluation for Allow and Prevent device installation policies across all device match criteria</code> policy to enable</li>
<li>Enabled the <code>Prevent installation of removable devices</code> policy</li>
</ul>
<p>Alternatively, and as a test, if you wish to block specific devices while allowing all by default:</p>
<ul>
<li>Enable the <code>Prevent installation of devices that match any of these device instance IDs</code> policy to block specific Instance IDs (precise)</li>
<li>Enable the <code>Prevent installation of devices that match any of these device IDs</code> policy to block based on Hardware or Compatible IDs (broad)</li>
<li>Click <code>Show</code> and add the IDs to this list</li>
<li>Check <code>Also apply to matching devices that are already installed</code></li>
</ul>
<p>What the last point will do is disconnect any currently connected device(s) matching the policy and remove their drivers. In Windows 11 this will happen immediately after applying the policy.</p>
<p><em>Remember you may need to specify multiple <code>Instance IDs</code> even for one device.</em></p>
<p>You can confirm the devices are no longer visible with:</p>
<div class="highlight"><pre><span></span><code>pnputil.exe /enum-devices /connected /class &#39;{&lt;guid&gt;}&#39;
</code></pre></div>
<p>Disabling or setting that policy to Not Configured will reconnect the devices.</p>
<h3 id="deny-execute-access-disable-autorun">Deny Execute Access, Disable Autorun</h3>
<p>By default, Windows will automatically mount any external drives connected. However, these settings will prevent them from executing any content. AutoPlay typically loads media or external files automatically based on a user setting. Autoruns (since Vista) execute content from an <code>autorun.inf</code> file. These files should require user interaction.</p>
<p>In the following GPO path:</p>
<div class="highlight"><pre><span></span><code>Local Computer Policy &gt; Administrative Templates &gt; System &gt; Removable Storage Access
</code></pre></div>
<p>The following policies control whether content can execute <em>at all</em> from removable media.</p>
<ul>
<li>CD and DVD: Deny execute access</li>
<li>Floppy Drives: Deny execute access</li>
<li>Removable Disks: Deny execute access</li>
<li>All Available Storage Classes: Deny execute access</li>
<li>Tape Drives: Deny execute access</li>
</ul>
<p>Next, in this GPO path:</p>
<div class="highlight"><pre><span></span><code>Local Computer Policy &gt; Administrative Templates &gt; Windows Components &gt; AutoPlay Policies
</code></pre></div>
<p>These settings control Autorun and AutoPlay features.</p>
<ul>
<li><code>Turn off Autoplay</code>: Enabled, CD-ROM and removable media drives</li>
<li><code>Set the default behaivor for Autorun</code>: Enabled, Do not execute any autorun commands</li>
<li><code>Disallow Autoplay for non-volume devices</code>: Enabled</li>
</ul>
<p>To set these items from PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Per user, AutoPlay setting</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\AutoplayHandlers&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DisableAutoplay&quot;</span> <span class="n">-Type</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="n">1</span>
</code></pre></div>
<h3 id="enable-or-disable-pnp-devices">Enable or Disable PnP Devices</h3>
<p><a href="https://stackoverflow.com/questions/61057551/how-to-enable-disable-webcam-by-script-win-10">stackoverflow: Enable / Disable Webcam with PowerShell</a></p>
<p>Sometimes you won't be able to re-enable a previously disabled webcam through the settings menu. Instead enumerate cameras, then enable or disable them using their <code>InstanceId</code>.</p>
<p>Enumerate known cameras.</p>
<ul>
<li>Disabled cameras have a status of <code>error</code></li>
<li>Enabled cameras have a status of <code>OK</code></li>
<li>Disconnected cameras have a status of <code>unknown</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Get-PnpDevice</span> <span class="n">-FriendlyName</span> <span class="s2">&quot;*cam*&quot;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Status</span><span class="p">,</span><span class="n">FriendlyName</span><span class="p">,</span><span class="n">InstanceId</span> <span class="p">|</span> <span class="nb">fl</span>
<span class="nb">Get-PnpDevice</span> <span class="n">-Class</span> <span class="n">camera</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Status</span><span class="p">,</span><span class="n">FriendlyName</span><span class="p">,</span><span class="n">InstanceId</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>
<p>Enable / Disable camera as administrator, you'll be prompted to confirm:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Enable-PnpDevice</span> <span class="n">-InstanceId</span> <span class="s2">&quot;&lt;instanceid&gt;&quot;</span>
</code></pre></div>
<h3 id="blocking-iso-mounting">Blocking ISO Mounting</h3>
<p>Taken directly from <a href="https://twitter.com/mubix">Mubix</a>'s blog post:</p>
<ul>
<li><a href="https://malicious.link/post/2022/blocking-iso-mounting/">https://malicious.link/post/2022/blocking-iso-mounting/</a></li>
</ul>
<p>What this does:</p>
<ul>
<li>Block ISO mounting from double clicking</li>
<li>Block ISO mounting via the context menu</li>
<li>Block programmatic ISO mounting via PowerShell</li>
</ul>
<p>In the following GPO path:</p>
<div class="highlight"><pre><span></span><code>Local Computer Policy &gt; Administrative Templates &gt; System &gt; Device Installation &gt; Device Installation Restrictions
</code></pre></div>
<p>Enable this policy:</p>
<div class="highlight"><pre><span></span><code>Prevent installation of devices that match any of these device IDs
</code></pre></div>
<p>Check the "Also apply to matching devices that are already installed" option.</p>
<p>And set this as a value:</p>
<div class="highlight"><pre><span></span><code>SCSI\CdRomMsft____Virtual_DVD-ROM_
</code></pre></div>
<p>Try to mount an ISO to validate this is working. All ISO files should fail to mount to the filesystem once this policy is in place.</p>
<h4 id="creating-an-iso-for-testing">Creating an ISO for Testing</h4>
<p>On Ubuntu the <code>genisoimage</code> command can quickly create an ISO of any folder or file:</p>
<div class="highlight"><pre><span></span><code>genisoimage<span class="w"> </span>-o<span class="w"> </span>&lt;outfile&gt;.iso<span class="w"> </span>&lt;input-folder&gt;
genisoimage<span class="w"> </span>-o<span class="w"> </span>my-docs.iso<span class="w"> </span>./Documents
</code></pre></div>
<p>You can verify the ISO and contents with:</p>
<div class="highlight"><pre><span></span><code>file<span class="w"> </span>./my-docs.iso

sudo<span class="w"> </span>mkdir<span class="w"> </span>/mnt/my-iso
sudo<span class="w"> </span>mount<span class="w"> </span>my-docs.iso<span class="w"> </span>/mnt/my-iso

ls<span class="w"> </span>-l<span class="w"> </span>/mnt/my-iso

sudo<span class="w"> </span>umount<span class="w"> </span>/mnt/my-iso
sudo<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/mnt/my-iso
</code></pre></div>
<p>Now move the <code>.iso</code> file over to your Windows machine (or if you did this in WSL it's already there) to confirm your policy configurations are working.</p>
<p><strong>Additional Use Cases</strong></p>
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy#scenario-steps--preventing-installation-of-all-usb-devices-while-allowing-only-an-authorized-usb-thumb-drive">Allow only authorized USB device(s), block all other USB devices</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows/client-management/manage-device-installation-with-group-policy#scenario-2-prevent-installation-of-a-specific-printer-1">Block a specific device from being installed</a></p>
</li>
</ul>
<p><strong>TO DO</strong>: how to configure these policies with just PowerShell</p>
<hr />







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2024 straysheep-dev
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/straysheep-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.path", "navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.path", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.tooltips"], "search": "../../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>