
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://straysheep-dev.github.io/blog/2024/05/02/simple-pfsense-pfsense-administration/">
      
      
        <link rel="prev" href="../../../../2023/08/20/simple-ansible-ansible/">
      
      
        <link rel="next" href="../simple-bitwarden-bitwarden/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>pfSense administration - straysheep.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="pfSense administration - straysheep.dev" />
<meta property="og:image" content="https://straysheep-dev.github.io/assets/images/social/blog/2024/05/02/simple-pfsense-pfsense-administration.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://straysheep-dev.github.io/blog/2024/05/02/simple-pfsense-pfsense-administration/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="pfSense administration - straysheep.dev" />
<meta property="twitter:image" content="https://straysheep-dev.github.io/assets/images/social/blog/2024/05/02/simple-pfsense-pfsense-administration.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pfsense-administration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="straysheep.dev" class="md-header__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            straysheep.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              pfSense administration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  Main

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../license/" class="md-tabs__link">
        
  
  
    
  
  License

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="straysheep.dev" class="md-nav__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    straysheep.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2019/07/15/-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚≠ê Resources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../15/octicons-alert-16-aide-advanced-intrusion-detection-environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AIDE (Advanced Intrusion Detection Environment)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2023/08/20/simple-ansible-ansible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/07/25/simple-ansible-ansible-molecule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible Molecule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/12/octicons-beaker-16-atomic-red-team-x-unix-artifacts-collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Atomic Red Team x Unix Artifacts Collector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-dns-bind9-dns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BIND9 DNS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple-bitwarden-bitwarden/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    bitwarden
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../15/material-file-tree-triage-auditd-logs-with-check-auditd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triage auditd logs with check-auditd
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/01/20/fontawesome-solid-gears-cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CI/CD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/04/material-clipboard-flow-clipboard-snooping-x11-and-wayland/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clipboard Snooping (X11 and Wayland)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/15/fontawesome-solid-square-binary-compile-static-binaries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Static Binaries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../29/octicons-terminal-16-custom-shell-profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Shell Profiles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-flatpak-flatpak/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    flatpak
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/08/simple-qemu-kvm-kernel-based-virtual-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    KVM (Kernel-based Virtual Machine)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/28/material-code-tags-check-linting-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linting Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2022/08/29/material-magnify-scan-nessus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nessus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/04/18/material-console-network-network-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/01/material-wifi-alert-nzyme-x-simple-raspberrypi-raspberry-pi--simple-proxmox-proxmox--simple-tailscale-tailscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    nzyme x [ Raspberry Pi + Proxmox + Tailscale]
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../29/material-file-document-arrow-right-openscap-practical-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenSCAP Practical Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-openwrt-openwrt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenWrt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    pfSense administration
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    pfSense administration
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#additional-references" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional References
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Downloading
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#physical-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Physical Hardware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powering-on-for-install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Powering On for Install.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#virtual-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Virtual Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backup-restore" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup &amp; Restore
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup-post-install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initial Setup (Post Install)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial Setup (Post Install)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-setup-via-the-console-via-vm-external-display-or-serial-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initial Setup via the Console (via VM, external display, or serial console):
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-initial-setup-via-the-webgui" class="md-nav__link">
    <span class="md-ellipsis">
      
        The initial setup via the WebGUI:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DNS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-servers" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS: Servers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-filtering-wesbites" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS: Filtering Wesbites
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Interfaces
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    <span class="md-ellipsis">
      
        Users
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Users">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-low-privileged-user-for-management-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a low privileged user for management (GUI):
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-low-privileged-user-for-management-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a low privileged user for management (Console)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SSH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-advanced" class="md-nav__link">
    <span class="md-ellipsis">
      
        System &gt; Advanced
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Firewall Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-j-ssh-jump-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        -J SSH Jump Proxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Serial Console
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-the-management-port" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protect the Management Port
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protect the Management Port">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommended-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optional Settings
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backup-restore-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup / Restore Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrading
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Upgrading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upgrading-to-a-new-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrading to a new release
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update Troubleshooting
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ui-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        UI Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updating-network-address-ranges" class="md-nav__link">
    <span class="md-ellipsis">
      
        Updating Network Address Ranges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aliases" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aliases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aliases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alias-ports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alias Ports
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Firewall
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Firewall">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-interfaces-wan-lan-floating" class="md-nav__link">
    <span class="md-ellipsis">
      
        Essential Interfaces (WAN, LAN, FLOATING)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-firewall-rulesets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Firewall Rulesets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example Firewall Rulesets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optx-subnet-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPTx (Subnet egress)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternate-optx-strict-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternate OPTx (Strict egress)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-network-reject-all-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis Network (Reject all traffic)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pfsense-as-a-lab-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense as a Lab VM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pfSense as a Lab VM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pfsense-lab-vm-for-osint" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Lab VM for OSINT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pfsense-lab-vm-for-networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Lab VM for Networking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malware-analysis-network-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malware Analysis Network Isolation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        NAT
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NAT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpn" class="md-nav__link">
    <span class="md-ellipsis">
      
        VPN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vlans" class="md-nav__link">
    <span class="md-ellipsis">
      
        VLANs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-vlan-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a VLAN Checklist:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-vlan-detailed-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a VLAN - Detailed Steps:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bridging-multiple-interfaces-for-port-mirroring-span-port-for-traffic-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bridging Multiple Interfaces for Port Mirroring (SPAN Port for Traffic Monitoring)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bridging Multiple Interfaces for Port Mirroring (SPAN Port for Traffic Monitoring)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-managed-switch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a managed switch
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging-network-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging Network Traffic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collecting-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Collecting Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrade Log
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cli-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI: Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-system-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI: System Services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Packages
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Packages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pkg-binaries-and-pfsense-webgui-availability" class="md-nav__link">
    <span class="md-ellipsis">
      
        pkg Binaries and pfSense WebGUI Availability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-zeek-network-security-monitor-nsm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package: Zeek Network Security Monitor (NSM)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeek-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zeek Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Storage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="External Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zfs" class="md-nav__link">
    <span class="md-ellipsis">
      
        ZFS
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting:
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unable-to-obtain-ip-address-or-access-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unable to Obtain IP Address or Access GUI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-stack-fails-to-load-after-reboot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Management Stack Fails to Load After Reboot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pfsense-fails-reconnecting-to-tailnet" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Fails Reconnecting to Tailnet
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-powershell-get-started-with-powerstig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Started with PowerSTIG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../08/13/simple-proxmox-proxmox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Proxmox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/02/22/material-sync-circle-rsync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    rsync
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07/simple-snapcraft-snap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    snap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../08/13/material-server-security-wazuh-all-your-things-with-tailscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wazuh all your things with Tailscale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/10/16/material-wifi-cog-wifichallenge-exam--course-review/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    WiFiChallenge Exam &amp; Course Review
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../08/material-microsoft-windows-windows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_30" >
        
          
          <label class="md-nav__link" for="__nav_3_30" id="__nav_3_30_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_30_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_30">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-05-02 00:00:00+00:00" class="md-ellipsis">May 2, 2024</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              57 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#additional-references" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional References
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Downloading
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#physical-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Physical Hardware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powering-on-for-install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Powering On for Install.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#virtual-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Virtual Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backup-restore" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup &amp; Restore
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup-post-install" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initial Setup (Post Install)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial Setup (Post Install)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-setup-via-the-console-via-vm-external-display-or-serial-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initial Setup via the Console (via VM, external display, or serial console):
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-initial-setup-via-the-webgui" class="md-nav__link">
    <span class="md-ellipsis">
      
        The initial setup via the WebGUI:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DNS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-servers" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS: Servers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-filtering-wesbites" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS: Filtering Wesbites
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Interfaces
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    <span class="md-ellipsis">
      
        Users
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Users">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-low-privileged-user-for-management-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a low privileged user for management (GUI):
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-low-privileged-user-for-management-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a low privileged user for management (Console)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SSH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-advanced" class="md-nav__link">
    <span class="md-ellipsis">
      
        System &gt; Advanced
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Firewall Rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-j-ssh-jump-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        -J SSH Jump Proxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        Serial Console
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-the-management-port" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protect the Management Port
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protect the Management Port">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommended-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optional Settings
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backup-restore-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backup / Restore Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrading
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Upgrading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upgrading-to-a-new-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrading to a new release
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update Troubleshooting
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ui-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        UI Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updating-network-address-ranges" class="md-nav__link">
    <span class="md-ellipsis">
      
        Updating Network Address Ranges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aliases" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aliases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aliases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alias-ports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alias Ports
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Firewall
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Firewall">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-interfaces-wan-lan-floating" class="md-nav__link">
    <span class="md-ellipsis">
      
        Essential Interfaces (WAN, LAN, FLOATING)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-firewall-rulesets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Firewall Rulesets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example Firewall Rulesets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optx-subnet-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPTx (Subnet egress)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternate-optx-strict-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternate OPTx (Strict egress)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-network-reject-all-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis Network (Reject all traffic)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pfsense-as-a-lab-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense as a Lab VM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pfSense as a Lab VM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pfsense-lab-vm-for-osint" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Lab VM for OSINT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pfsense-lab-vm-for-networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Lab VM for Networking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malware-analysis-network-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malware Analysis Network Isolation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        NAT
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NAT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpn" class="md-nav__link">
    <span class="md-ellipsis">
      
        VPN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vlans" class="md-nav__link">
    <span class="md-ellipsis">
      
        VLANs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-vlan-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a VLAN Checklist:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-vlan-detailed-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a VLAN - Detailed Steps:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bridging-multiple-interfaces-for-port-mirroring-span-port-for-traffic-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bridging Multiple Interfaces for Port Mirroring (SPAN Port for Traffic Monitoring)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bridging Multiple Interfaces for Port Mirroring (SPAN Port for Traffic Monitoring)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-managed-switch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a managed switch
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging-network-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging Network Traffic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collecting-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Collecting Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        Upgrade Log
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cli-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI: Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-system-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI: System Services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Packages
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Packages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pkg-binaries-and-pfsense-webgui-availability" class="md-nav__link">
    <span class="md-ellipsis">
      
        pkg Binaries and pfSense WebGUI Availability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-zeek-network-security-monitor-nsm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package: Zeek Network Security Monitor (NSM)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeek-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zeek Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Storage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="External Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zfs" class="md-nav__link">
    <span class="md-ellipsis">
      
        ZFS
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting:
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unable-to-obtain-ip-address-or-access-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unable to Obtain IP Address or Access GUI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-stack-fails-to-load-after-reboot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Management Stack Fails to Load After Reboot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pfsense-fails-reconnecting-to-tailnet" class="md-nav__link">
    <span class="md-ellipsis">
      
        pfSense Fails Reconnecting to Tailnet
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="pfsense-administration"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.013 0C.898 0 0 .929 0 2.044v17.775L3.252 8.27h3.282L6.1 9.785h.063c.186-.217.433-.403.742-.62.31-.216.62-.402.96-.588.342-.186.713-.31 1.116-.433.402-.124.805-.155 1.208-.155.867 0 1.579.154 2.198.433.62.279 1.084.712 1.455 1.239.31.464.5 1.019.593 1.669.006.06.027.135.027.189.062.712-.031 1.518-.28 2.385a8.6 8.6 0 0 1-1.02 2.322 10 10 0 0 1-1.58 1.95 8.1 8.1 0 0 1-2.044 1.364 5.5 5.5 0 0 1-2.354.495 5.7 5.7 0 0 1-1.982-.34c-.588-.217-.99-.62-1.238-1.177h-.062L2.353 24h19.603A2.04 2.04 0 0 0 24 21.956V4.706c-.093-.03-.186-.06-.248-.092a2.8 2.8 0 0 0-.557-.062q-.836 0-1.394.372c-.34.248-.65.743-.867 1.518l-.526 1.826h2.013l.495 1.58-1.3 1.27h-2.014l-2.446 8.67h-3.53l2.446-8.67h-1.455l.805-2.85h1.425l.557-2.044c.185-.619.403-1.238.681-1.795a5 5 0 0 1 1.053-1.487c.433-.434.99-.775 1.641-1.022.65-.248 1.487-.372 2.447-.372.248 0 .464 0 .712.031A2.08 2.08 0 0 0 21.988 0zm6.565 11.118c-.898 0-1.672.278-2.323.805-.65.526-1.083 1.239-1.331 2.106s-.217 1.579.155 2.105c.31.557.929.805 1.858.805.898 0 1.672-.278 2.322-.805.65-.526 1.115-1.238 1.363-2.105.247-.867.185-1.58-.155-2.106-.34-.527-.991-.805-1.89-.805Z"/></svg></span> pfSense administration</h1>
<p>A quick reference for pfSense administration.</p>
<!-- more -->

<ul>
<li>pfSense Documentation<ul>
<li><a href="https://docs.netgate.com/pfsense/en/latest/index.html">https://docs.netgate.com/pfsense/en/latest/index.html</a></li>
</ul>
</li>
</ul>
<p><em>In all cases where the pfSense documentation is either referenced directly or closely adapted, a link back to the source page or section is provided.</em></p>
<p>Many of the initial steps are the same as the pfSense documents, but with less or different detail, and organized in a way that I've found I repeat when setting up a pfSense system. This cheatsheet most closely resembles the creation of a home lab, and ways of gaining visibility into a small set of networks. Be sure to review the pfSense documentation for complete details.</p>
<h2 id="additional-references">Additional References</h2>
<ul>
<li>
<p>FreeBSD Handbook - Get started with the CLI using this as a reference.</p>
<ul>
<li><a href="https://docs.freebsd.org/en/books/handbook/basics/">https://docs.freebsd.org/en/books/handbook/basics/</a></li>
<li><a href="https://www.freebsd.org/copyright/freebsd-doc-license/">https://www.freebsd.org/copyright/freebsd-doc-license/</a></li>
</ul>
</li>
<li>
<p>Lawrence Systems - Channel covering all things networking. Many pfSense examples were adapted directly from there.</p>
<ul>
<li><a href="https://www.youtube.com/user/TheTecknowledge/videos">https://www.youtube.com/user/TheTecknowledge/videos</a></li>
<li><a href="https://creativecommons.org/licenses/by/3.0/">https://creativecommons.org/licenses/by/3.0/</a></li>
</ul>
</li>
<li>
<p>The Cyber Plumber's Handbook - Free pdf with in depth but very clear and easy to understand exercises of traversing networks.</p>
<ul>
<li><a href="https://github.com/opsdisk/the_cyber_plumbers_handbook">https://github.com/opsdisk/the_cyber_plumbers_handbook</a></li>
<li><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">https://creativecommons.org/licenses/by-nc-nd/4.0/</a></li>
</ul>
</li>
</ul>
<h2 id="downloading">Downloading</h2>
<p>Install image documentation:</p>
<ul>
<li><a href="https://docs.netgate.com/pfsense/en/latest/install/download-installer-image.html">https://docs.netgate.com/pfsense/en/latest/install/download-installer-image.html</a></li>
<li><a href="https://docs.netgate.com/pfsense/en/latest/install/download-installer-image.html#verifying-the-integrity-of-the-download">https://docs.netgate.com/pfsense/en/latest/install/download-installer-image.html#verifying-the-integrity-of-the-download</a></li>
</ul>
<p>pfSense installer images:
- <a href="https://www.pfsense.org/download/">https://www.pfsense.org/download/</a></p>
<p><strong>Be sure to verify the sha256sum of the installer file</strong></p>
<div class="highlight"><pre><span></span><code>user@device:/home/user/Downloads$<span class="w"> </span>sha256sum<span class="w"> </span>-c<span class="w"> </span>./pfSense-CE-2.6.0-RELEASE-amd64.iso.gz.sha256
pfSense-CE-2.6.0-RELEASE-amd64.iso.gz:<span class="w"> </span>OK
</code></pre></div>
<h2 id="installation">Installation</h2>
<h3 id="physical-hardware">Physical Hardware</h3>
<p>This section is closely adapted from here: <a href="https://docs.netgate.com/reference/create-flash-media.html">https://docs.netgate.com/reference/create-flash-media.html</a></p>
<ol>
<li>
<p>Creating bootable media</p>
</li>
<li>
<p>Insert your external device (typically usb).</p>
</li>
<li>
<p>Identify the device path under <code>/dev/X</code> by running <code>dmesg | tail</code>.</p>
</li>
<li>
<p>Another easy way to identify device mount point is with the Gnome <code>disks</code> utility, or <code>gparted</code>.</p>
</li>
<li>
<p>Erase the target media partition table:</p>
</li>
</ol>
<p><a href="https://docs.netgate.com/reference/create-flash-media.html#cleaning-the-target-disk">https://docs.netgate.com/reference/create-flash-media.html#cleaning-the-target-disk</a></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>&lt;usb_device_name&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span>
sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sdx<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>
<p>Here <code>/dev/sdx</code> is used as an example. If you have two internal SSD's, you'll likely have <code>/dev/sda</code> and <code>/dev/sdb</code></p>
<p>Connecting a third removable USB drive, will then show up under <code>/dev</code> as <code>/dev/sdc</code></p>
<p>NVME drives will show up as <code>/dev/nvme0n1</code>, <code>/dev/nvme1n1</code> and so on.</p>
<ul>
<li>Write pfSense image to media:</li>
</ul>
<p><a href="https://docs.netgate.com/reference/create-flash-media.html#write-the-image">https://docs.netgate.com/reference/create-flash-media.html#write-the-image</a></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>&lt;image_file_name&gt;<span class="w"> </span><span class="nv">of</span><span class="o">=</span>&lt;usb_device_name&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>4M<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress
sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/opt/iso/pfSense-CE-2.6.0-RELEASE-amd64.iso<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sdx<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>4M<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress

<span class="c1"># you should see output similar to the following, this operation does not take long:</span>
<span class="m">182</span>+1<span class="w"> </span>records<span class="w"> </span><span class="k">in</span>
<span class="m">182</span>+1<span class="w"> </span>records<span class="w"> </span>out
<span class="m">767463424</span><span class="w"> </span>bytes<span class="w"> </span><span class="o">(</span><span class="m">767</span><span class="w"> </span>MB,<span class="w"> </span><span class="m">732</span><span class="w"> </span>MiB<span class="o">)</span><span class="w"> </span>copied,<span class="w"> </span><span class="m">10</span>.8692<span class="w"> </span>s,<span class="w"> </span><span class="m">70</span>.6<span class="w"> </span>MB/s
</code></pre></div>
<p>See this table of examples for all OS's:</p>
<ul>
<li><a href="https://docs.netgate.com/reference/create-flash-media.html#cleaning-the-target-disk">https://docs.netgate.com/reference/create-flash-media.html#cleaning-the-target-disk</a></li>
</ul>
<p>Alternatively on Windows you can use:</p>
<ul>
<li><a href="https://github.com/balena-io/etcher/releases">https://github.com/balena-io/etcher/releases</a></li>
</ul>
<p>or</p>
<ul>
<li><a href="https://github.com/pbatard/rufus/releases">https://github.com/pbatard/rufus/releases</a></li>
</ul>
<hr />
<h3 id="powering-on-for-install">Powering On for Install.</h3>
<p>Read every step before starting.</p>
<p>Serial console commands and information taken directly from here: <a href="https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#minicom">https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#minicom</a></p>
<ul>
<li>Disconnect all ethernet cables<ul>
<li>From pfSense device</li>
<li>From management PC</li>
</ul>
</li>
<li>Serial cable is unplugged</li>
<li>
<p>pfSense device is powered off</p>
</li>
<li>
<p><strong>Connect the serial cable to both devices</strong></p>
</li>
<li><strong>Start the serial console output on your managing PC:</strong><ul>
<li>Identify the device name: <code>find /dev -name "*ttyUSB*" -ls 2&gt;/dev/null</code></li>
<li>Replace <code>/dev/ttyUSBX</code> with your device name: <code>sudo screen /dev/ttyUSBX 115200</code></li>
<li>This will simply be a blank <code>screen</code> session until the pfSense machine powers on</li>
</ul>
</li>
<li><strong>Plug in the installation media USB to the pfSense device</strong></li>
<li><strong>Power on pfSense device</strong><ul>
<li>Be ready to be back at your keyboard here</li>
</ul>
</li>
<li><strong>Press any key to interrupt boot when prompted</strong><ul>
<li>This happens relatively quickly after powering on the device, and gives you ~2 seconds to stop the boot sequence</li>
</ul>
</li>
</ul>
<p>From here your steps depend on the hardware's UEFI BIOS / shell settings to mount and run media.</p>
<ul>
<li>Netgate devices for example have a built-in shell which takes commands documented in each of their appliance's specific manuals</li>
<li>Choose filesystem type (UFS / ZFS) and target installation media (the internal disk to install pfSense on)<ul>
<li>Some 32-bit OS images do not support the ZFS (SG-3100 for example)</li>
</ul>
</li>
</ul>
<p>When installation is finished, the console menu will indicate this clearly stating it has <code>halted</code> and be technically powered 'off' at this point</p>
<ul>
<li>Remove the insallation media</li>
<li>Powercycle the device<ul>
<li>Unplug the power cable</li>
<li>Wait 60 seconds</li>
<li>Reconnect the power cable</li>
</ul>
</li>
</ul>
<p>To quit the serial console <code>screen</code> terminal: <code>CTRL+SHIFT+A</code>; then press <code>\</code></p>
<hr />
<h3 id="virtual-machine">Virtual Machine</h3>
<p>Recommended machine settings:</p>
<ul>
<li>1 Processor</li>
<li>2 vCPU Per Processor (minimum 1 vCPU)</li>
<li>2048 GB RAM (minimum 1024 GB RAM)</li>
<li>NAT or Bridged Networking (The first public interface will be assigned as the WAN)</li>
<li>20+ GB Disk Size</li>
<li>1+ LAN Segements (VMware) or Internal Network Segments (VirtualBox)</li>
<li>UEFI Firmware</li>
</ul>
<p>Incompatible machine settings:</p>
<ul>
<li>DO NOT add a TPU (VMware)</li>
<li>DO NOT enable Secure Boot (VMware)</li>
</ul>
<p><strong>TO DO</strong>: add screenshots showing VMware / VirtualBox configurations prior to the first boot.</p>
<p>The installation process:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/install/install-walkthrough.html">https://docs.netgate.com/pfsense/en/latest/install/install-walkthrough.html</a></p>
<p>All defaults during the install steps are fine. It's recommended to use the ZFS filesystem from pfSense version 2.6.0 and onward.</p>
<ul>
<li>Auto (ZFS) Guided Root-on-ZFS<ul>
<li>Here on <code>Configure Options:</code> where <code>&gt;&gt;&gt; Install</code> is highlighted, press [Enter]</li>
<li>Press [Enter] on <code>stripe</code> here unless you want <code>RAID</code></li>
<li>Press [Space] to 'select' the checkbox next to your virtual disk &gt; <code>[*]</code> then press [Enter]<ul>
<li>If you don't select an available disk, it will let you know</li>
</ul>
</li>
<li>Select <code>&lt; YES &gt;</code> then press [Enter]</li>
<li>Skip spawning a shell unless you need to</li>
<li>Press [Enter] here with <code>&lt; Reboot &gt;</code> selected</li>
</ul>
</li>
</ul>
<p>At this point you will be at the welcome menu for the console.</p>
<p>Optionally Press 8 to drop into a shell and make changes immediately.</p>
<p>For example, immediately change the root password:</p>
<div class="highlight"><pre><span></span><code>passwd<span class="w"> </span>root
</code></pre></div>
<h2 id="backup-restore">Backup &amp; Restore</h2>
<p>Test your backup configurations.</p>
<p>It's a good idea when finalizing the configuration of your machine, or resinstalling / upgrading the OS to always:</p>
<ol>
<li>Download an encrypted full configuration backup xml file.</li>
<li>Immediately test restoring that configuration file to the target machine<ul>
<li><code>Preserve Switch Configruation</code> <strong>keeps</strong> the switch configuration <strong>currently running</strong> on the machine, and <strong>IGNORES</strong> the switch configuration that would be restored from the backup xml file</li>
</ul>
</li>
<li>If the configuration restores successfully, you're ready to proceed with reinstalling / upgrading pfSense</li>
</ol>
<h2 id="initial-setup-post-install">Initial Setup (Post Install)</h2>
<p>The fist steps in most cases.</p>
<h3 id="initial-setup-via-the-console-via-vm-external-display-or-serial-console">Initial Setup via the Console (via VM, external display, or serial console):</h3>
<p>Some basics can be easily accomplished from the console. Starting with the network interfaces.</p>
<hr />
<p><a href="https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#gnu-screen">https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#gnu-screen</a></p>
<p>To find the serial USB device and connect via the serial console:</p>
<ul>
<li><code>find /dev -name "*ttyUSB*" -ls 2&gt;/dev/null</code></li>
<li><code>sudo screen /dev/ttyUSB0 115200</code></li>
</ul>
<p>To quit the serial console <code>screen</code> terminal:</p>
<ul>
<li><code>CTRL+SHIFT+A</code>; then press <code>\</code></li>
</ul>
<hr />
<p>Get which interface is your NAT / Bridged (publicly facing) interface from the shell menu <code>8) Shell</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Use less -S to be able to scroll up and right to read terminal</span>
ifconfig<span class="w"> </span><span class="p">|</span><span class="w"> </span>less<span class="w"> </span>-S
</code></pre></div>
<p>If you assigned the default network interface in the hypervisor as the Bridged or NAT interface, it's almost always going to be <code>em0</code>.</p>
<p>Proceed to setup the interfaces with the guided prompts at <code>1) Assign Interfaces</code>.</p>
<p>Followed by the <code>2) Set interface(s) IP address</code> for each interface.</p>
<p>You can also install packages here if you choose to.</p>
<p>Be sure to install the accompanying <code>pfSense-pkg-&lt;package-name&gt;</code> for each package that has a way of interfacing with the WebGUI. For example:</p>
<div class="highlight"><pre><span></span><code>pkg update -f
pkg install -y sudo pfSense-pkg-sudo
</code></pre></div>
<p>If you forget to install <code>pfSense-pkg-sudo</code>, you will not be able to configure is from the WebGUI (and in the case of sudo the configuraiton file is actually different).</p>
<p>From here, it's recommended to switch over to the WebGUI to finish the remaining setup.</p>
<hr />
<h3 id="the-initial-setup-via-the-webgui">The initial setup via the WebGUI:</h3>
<p><a href="https://docs.netgate.com/pfsense/en/latest/config/setup-wizard.html">https://docs.netgate.com/pfsense/en/latest/config/setup-wizard.html</a></p>
<p><code>Block private networks</code> is OK on WAN connected to the public internet (ie; the ip address is publicly routable) though if you plan to <code>-J</code> with ssh into internal subnets, you would not enable this.</p>
<p><code>Block Bogons</code> is OK on all interfaces</p>
<p>Choose a non-publicly routable tld as the localdomain name, any of these four from RFC 2606 will work:</p>
<div class="highlight"><pre><span></span><code>.test
.example
.invalid
.localhost
</code></pre></div>
<p>However the default here is fine.</p>
<p>After you complete the installation and initial setup process you'll be at the dashboard. From there, you can proceed with the following:</p>
<hr />
<h2 id="dns">DNS</h2>
<p>The first thing to configure could be DNS. Using DNS over TLS will ensure you're receiving legitimate replies to queries.</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/services/dns/resolver-config.html">https://docs.netgate.com/pfsense/en/latest/services/dns/resolver-config.html</a></p>
<p>Under <code>System &gt; General Setup &gt; DNS Server Settings</code></p>
<h4 id="dns-servers">DNS: Servers</h4>
<p>The following lists three popular publicly available DNS resolvers that support DNS over TLS forwarded queries:</p>
<table>
<thead>
<tr>
<th>IP Address</th>
<th>Hostname for TLS validation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.1.1.1</code></td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td><code>1.0.0.1</code></td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td><code>2606:4700:4700::1111</code></td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td><code>2606:4700:4700::1001</code></td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td><code>9.9.9.9</code></td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td><code>149.112.112.112</code></td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td><code>2620:fe::fe</code></td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td><code>2620:fe::9</code></td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td><code>8.8.8.8</code></td>
<td>dns.google</td>
</tr>
<tr>
<td><code>8.8.4.4</code></td>
<td>dns.google</td>
</tr>
<tr>
<td><code>2001:4860:4860::8888</code></td>
<td>dns.google</td>
</tr>
<tr>
<td><code>2001:4860:4860::8844</code></td>
<td>dns.google</td>
</tr>
</tbody>
</table>
<p><img alt="pfsense-dns-config-001" src="../../../../media/pfsense/pfsense-dns-config-001.png" /></p>
<p>This is what <code>/var/unbound/unbound.conf</code> may look like with DNS over TLS forwarding enabled:</p>
<div class="highlight"><pre><span></span><code>...8&lt;...

<span class="c1"># Forwarding</span>
forward-zone:
<span class="w">        </span>name:<span class="w"> </span><span class="s2">&quot;.&quot;</span>
<span class="w">        </span>forward-tls-upstream:<span class="w"> </span>yes
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">1</span>.1.1.1@853#cloudflare-dns.com
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">1</span>.0.0.1@853#cloudflare-dns.com
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">2606</span>:4700:4700::1111@853#cloudflare-dns.com
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">2606</span>:4700:4700::1001@853#cloudflare-dns.com
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">9</span>.9.9.9@853#dns.quad9.net
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">149</span>.112.112.112@853#dns.quad9.net
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">2620</span>:fe::fe@853#dns.quad9.net
<span class="w">        </span>forward-addr:<span class="w"> </span><span class="m">2620</span>:fe::9@853#dns.quad9.net

...&gt;8...
</code></pre></div>
<p><strong>UNCHECK</strong> the following if it's checked:</p>
<p><code>System &gt; General Setup &gt; DNS Server Override (Allow outside DNS to override server list)</code></p>
<p>Set the following option:</p>
<p><code>System &gt; General Setup &gt; DNS Resolution Behavior &gt; select "Use local, ignore remote"</code></p>
<p>This ensures queries are sent to unbound, which then forwards them to upstream DNS over TLS servers.</p>
<p>Under <code>Services &gt; DNS Resolver</code>:</p>
<ul>
<li>[x] Enable DNS Resolver</li>
<li>[x] Enable DNSSEC Support* (Check logs if you have issues, and disable. Ideally keep it enabled)</li>
<li>[x] Enable Forwarding Mode</li>
<li>[x] Use SSL/TLS for outgoing DNS</li>
<li>[x] [Optional] DHCP Registration / Static DHCP (Allows Dns resoultion of local <code>&lt;hostname&gt;.&lt;localdomain&gt;</code>)</li>
</ul>
<p><strong>IMPORTANT</strong>: Be sure your <code>/var/unbound/unbound.conf</code> contains the DNS over TLS entries once you configure and apply them in the GUI.</p>
<p>For logging, the following three configuration options can be applied. Only <code>log-queries</code> is uncommented here to avoid overwhealming the logs.</p>
<p>Add any of the following to the DNS resolver's custom options under 'server':</p>
<div class="highlight"><pre><span></span><code>server:
    log-queries: yes
    #log-replies: yes
    #log-tag-queryreply: yes
</code></pre></div>
<p>This file can be edited manually at <code>/var/unbound/unbound.conf</code></p>
<p>See unbound's example configuration file for more:</p>
<p><a href="https://github.com/NLnetLabs/unbound/blob/master/doc/example.conf.in">https://github.com/NLnetLabs/unbound/blob/master/doc/example.conf.in</a></p>
<h3 id="dns-filtering-wesbites">DNS: Filtering Wesbites</h3>
<p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/block-websites.html">https://docs.netgate.com/pfsense/en/latest/recipes/block-websites.html</a></p>
<p>The same configuraiton syntax would apply here that you'd use for unbound.</p>
<p>One solution is to create a separate file just for this, for example <code>/var/unbound/conf.d/blocklist.conf</code>.</p>
<p>You will need to tell unbound to 'include' the <code>/var/unbound/conf.d/</code> directory if you decide to use it by adding the following to <code>/var/unbound/unbound.conf</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Include conf.d files</span>
include:<span class="w"> </span>/var/unbound/conf.d/*
</code></pre></div>
<p><strong>METHOD 1 (OLD)</strong></p>
<p>This will route all traffic for a given domain to the 'null' address <code>0.0.0.0</code> or <code>::</code> and has been replaced by method 2.</p>
<div class="highlight"><pre><span></span><code>local-zone: &quot;domain.toblock&quot; redirect
local-data: &quot;domain.toblock A 0.0.0.0&quot;
local-data&quot; &quot;domain.toblock AAAA ::&quot;
</code></pre></div>
<p><strong>METHOD 2 (BEST)</strong></p>
<p>The same as method 1, but requiring only a single line. This makes the file easier to generate from other lists, and manage.</p>
<div class="highlight"><pre><span></span><code>local-zone: &quot;domain.toblock&quot; always_null
</code></pre></div>
<p><strong>METHOD 3 (SECOND BEST)</strong></p>
<p>If you have an older version of unbound that does not support <code>always_null</code> this is your best choice.</p>
<div class="highlight"><pre><span></span><code>local-zone: &quot;domain.toblock&quot; always_nxdomain
</code></pre></div>
<p><strong>Block AS Numbers by Alias</strong>:</p>
<p>Also see this example in the Netgate docs:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/block-websites.html">https://docs.netgate.com/pfsense/en/latest/recipes/block-websites.html</a></p>
<hr />
<h2 id="network-interfaces">Network Interfaces</h2>
<p><a href="https://docs.netgate.com/pfsense/en/latest/config/interface-configuration.html">https://docs.netgate.com/pfsense/en/latest/config/interface-configuration.html</a></p>
<ul>
<li>Enable Interfaces under <code>Interfaces &gt; Assignments</code></li>
<li>Configure RFC1918 address range subnets<ul>
<li><code>Interfaces &gt; OPTx &gt; Static IPv4 Configuration</code><ul>
<li>Assign the interface an address and define the CIDR range available here.</li>
<li>EXAMPLE: 192.168.20.1/24</li>
</ul>
</li>
<li>Here is where you configure IPv6 or not</li>
</ul>
</li>
<li>For each interface, <code>Services &gt; DHCP Server &gt;[interface]</code> select <code>Enable DHCP Server</code><ul>
<li>[If Static DHCP = no] Set range of +10/-10 hosts, example:<ul>
<li>Available range: 192.168.1.1 - 192.168.1.254</li>
<li>Set range to: 192.168.1.100 - 192.168.1.200 for 100 available IP addresses</li>
</ul>
</li>
<li>[Optional] Set static DHCP mappings of 127/127<ul>
<li>127/127 means 127 IP Addresses available in the dynamic pool, and 127 available in the static pool (127 is half of a /24 network)</li>
<li>MAC Address</li>
<li>Hostname</li>
<li>Choose an IP address from outside of the default range's pool:<ul>
<li>Available range: 192.168.1.1 - 192.168.1.254</li>
<li>Set range to: 192.168.1.127 - 192.168.1.254 (dynamic range)</li>
<li>Available IP's left for static mappings: 192.168.1.1 - 192.168.1.126</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>NOTE</strong>: setting range at a +10/-10 minimum is a best practice especially for static mappings, in case interfaces or gateways require changes at a later point in time. This advice has been echoed in various <a href="https://www.youtube.com/user/TheTecknowledge/videos">Lawrence Systems</a> videos for setting up networks.</p>
<p><strong>TO DO</strong>: provide a direct link + timestamp from one of the videos covering this concept.</p>
<p><strong>EXAMPLE</strong>:</p>
<p>The 100-200 pool (Easy for small, home, or lab networks)</p>
<ul>
<li>Network = 172.16.1.0/24</li>
<li>Available Range = 172.16.1.100 to 172.16.1.200</li>
</ul>
<p>This would make addresses 100 to 200 available for dynamic clients.</p>
<p>Any static addresses you would assign then fall under 1-99,201-254.</p>
<p>You can set static mappings within dynamic ranges, but if that IP address is taken by a dynamic client it cannot be assigned to the static client requesting it until the dynamic client disconnects and that lease expires.</p>
<p><strong>RECOMMENDED</strong>: set static mappings to your own devices that will connect to the management port for administration purposes. The prevents any machine from connecting to that port and attempting to reach the management interface via (slow) brute force or a future bypass technique if one is discovered.</p>
<hr />
<h2 id="users">Users</h2>
<ul>
<li>
<p><code>System &gt; General Setup</code></p>
</li>
<li>
<p><code>webConfigurator</code> you can change the system <code>Theme</code> as well as add more dashboard columns (3 tends to work well).</p>
</li>
<li>
<p><code>Save</code></p>
</li>
</ul>
<hr />
<ul>
<li>
<p><code>System &gt; Advanced</code></p>
</li>
<li>
<p>Console Options</p>
</li>
<li>
<p><code>[x]</code> Password protect the console menu</p>
</li>
</ul>
<p>SSH access
- Jump to <a href="#ssh">ssh</a> below to make those changes now.</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/ssh-access.html">https://docs.netgate.com/pfsense/en/latest/recipes/ssh-access.html</a></p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/config/advanced-admin.html#best-practices-for-ssh">https://docs.netgate.com/pfsense/en/latest/config/advanced-admin.html#best-practices-for-ssh</a></p>
<p>Lawrence Systems, on pfSense remote management <a href="https://www.youtube.com/watch?v=MVoe3mX_UZQ">full video</a></p>
<p><strong>NOTE</strong>: Be sure to conduct all of the following from a physical or virtual location with <strong>anti-lockout</strong> or <strong>serial console access</strong> just in case!</p>
<p>Ideally all management is done over SSH, with BOTH public key and password required for access.</p>
<p>However, requiring a public key alone is still fine! And in some cases, is the only way to do remote automation securely.</p>
<p>Add your public key to the desired user's page via <code>System &gt; User Manager &gt; User &gt; Authorized SSH Keys</code></p>
<p>Alternatively you can add it to the <code>authorized_keys</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># The empty line of &quot;&quot; is recommened to keep each entry on a separate line. Empty lines aren&#39;t interpreted.</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.ssh/authorized_keys
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJR19JyOxGYHSxsybdm3OsdFGW+fRITxVxmiB/S//S+60h6nddXZsCl/XhmvmLSXW6Z9EXivXm7428YC/PP3khM= kali@kali&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.ssh/authorized_keys
</code></pre></div>
<p>In the next step, we'll create a lower privilege user for remote access instead of using the built-in admin account (which is root).</p>
<p><strong>NOTE</strong>: If you're wondering why Kali is used throughout this tutorial, the <a href="https://www.kali.org/get-kali/#kali-live">live disk image</a> now has virtual machine tools installed by default since 2021.3. It's never been so easy to spin up a working and fully capable OS without running any post configuration scripts. There's also a vast array of useful tools available by default (ie; <code>screen</code>, <code>wireshark</code>, <code>burpsuite</code>, etc) which can be invaluable in troubleshooting and exploring your own devices. While it hasn't always been the best option for beginnners, if you're familiar with Ubuntu and Linux in general you'll do fine.</p>
<hr />
<h4 id="creating-a-low-privileged-user-for-management-gui">Creating a low privileged user for management (GUI):</h4>
<p>Lawrence Systems, on pfSense remote management, timestamped at <a href="https://youtu.be/MVoe3mX_UZQ?t=287">User Management</a></p>
<p>The following points try to summarize what the video covers:</p>
<blockquote>
<ul>
<li><code>System &gt; User Manager &gt; Add</code></li>
<li>Create a username and password (saved to your password manager)</li>
<li><code>Group Membership</code> you'll want to highlight <code>admins</code> and select <code>&gt;&gt; Move to "Member of" list</code> so this user can access the Web UI and login remotely.</li>
<li>Add the SSH public key for this user: <code>System &gt; User Manager &gt; Edit user (admin) &gt; User1 &gt; Authorized SSH Keys</code></li>
<li>Save</li>
<li>Return to the page for the new user again.</li>
<li>Under <code>Effective Privileges</code> choose <code>+Add</code> and <code>Ctrl+click</code> to highlight BOTH <code>WebCfg - All pages</code> and <code>User - System: Shell account access</code> then choose <code>Save</code> at the bottom of the page.</li>
<li>Save</li>
<li>Next, disable the built-in admin account: <code>System &gt; User Manager &gt; Edit user (admin) &gt; Disabled</code>, check <code>This user cannot login</code></li>
<li>Save</li>
</ul>
</blockquote>
<p><strong>NOTE</strong>: This will prevent the built-in admin account from both, SSH, and logging in to the WebGUI.</p>
<p><strong>Optional, but recommended</strong>:</p>
<ul>
<li><code>System &gt; Package Manager &gt; Available Packages</code> install <code>sudo</code></li>
</ul>
<p>Sudo can be managed under <code>System &gt; sudo</code>, though the default settings work exactly as you'd expect.</p>
<p>After install, the sudoers file under <code>/usr/local/etc/sudoers</code> will look like:</p>
<div class="highlight"><pre><span></span><code>root ALL=(root) ALL
admin ALL=(root) ALL
%admins ALL=(root) ALL
</code></pre></div>
<p>Meaning the <code>admins</code> group is funcitonally similar to being in group <code>sudo</code> in Debian-based systems.</p>
<p><strong>NOTE</strong>: you do not need <code>sudo</code> installed to access the GUI over an SSH tunnel - the <code>Diagnostics &gt; Command Prompt</code> shell still runs as root, and you can still install <code>sudo</code> later should you choose.</p>
<p><strong>WHY?</strong></p>
<p>Creating a dedicated management user mitigates the damage a local attacker can do, as the account password + sudo will be required to elevate privileges without a local exploit.</p>
<hr />
<h4 id="creating-a-low-privileged-user-for-management-console">Creating a low privileged user for management (Console)</h4>
<p>This next section directly references and is adapted from here:</p>
<p><a href="https://docs.freebsd.org/en/books/handbook/basics/#users-synopsis">https://docs.freebsd.org/en/books/handbook/basics/#users-synopsis</a></p>
<p>This will create an equivalent user account with groups similar to the steps you'd follow in the GUI.</p>
<p>The only difference is the $HOME directory is not world readable, we use <code>750</code> instead of the default of <code>755</code>.</p>
<p>Run the <code>adduser</code> utility with root privileges to be walked through the following prompt:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="m">2</span>.6.0-RELEASE<span class="o">][</span>user2@pfSense.home.arpa<span class="o">]</span>/home/user2:<span class="w"> </span>sudo<span class="w"> </span>adduser
Username:<span class="w"> </span>user4
Full<span class="w"> </span>name:<span class="w"> </span>Fourth<span class="w"> </span>User
Uid<span class="w"> </span><span class="o">(</span>Leave<span class="w"> </span>empty<span class="w"> </span><span class="k">for</span><span class="w"> </span>default<span class="o">)</span>:
Login<span class="w"> </span>group<span class="w"> </span><span class="o">[</span>user4<span class="o">]</span>:<span class="w"> </span>nobody
Login<span class="w"> </span>group<span class="w"> </span>is<span class="w"> </span>nobody.<span class="w"> </span>Invite<span class="w"> </span>user4<span class="w"> </span>into<span class="w"> </span>other<span class="w"> </span>groups?<span class="w"> </span><span class="o">[]</span>:<span class="w"> </span>admins
Login<span class="w"> </span>class<span class="w"> </span><span class="o">[</span>default<span class="o">]</span>:
Shell<span class="w"> </span><span class="o">(</span>sh<span class="w"> </span>csh<span class="w"> </span>tcsh<span class="w"> </span>ssh_tunnel_shell<span class="w"> </span>scponly<span class="w"> </span>scponlyc<span class="w"> </span>git-shell<span class="w"> </span>bash<span class="w"> </span>rbash<span class="w"> </span>nologin<span class="o">)</span><span class="w"> </span><span class="o">[</span>sh<span class="o">]</span>:<span class="w"> </span>tcsh
Home<span class="w"> </span>directory<span class="w"> </span><span class="o">[</span>/home/user4<span class="o">]</span>:
Home<span class="w"> </span>directory<span class="w"> </span>permissions<span class="w"> </span><span class="o">(</span>Leave<span class="w"> </span>empty<span class="w"> </span><span class="k">for</span><span class="w"> </span>default<span class="o">)</span>:<span class="w"> </span><span class="m">750</span>
Use<span class="w"> </span>password-based<span class="w"> </span>authentication?<span class="w"> </span><span class="o">[</span>yes<span class="o">]</span>:
Use<span class="w"> </span>an<span class="w"> </span>empty<span class="w"> </span>password?<span class="w"> </span><span class="o">(</span>yes/no<span class="o">)</span><span class="w"> </span><span class="o">[</span>no<span class="o">]</span>:
Use<span class="w"> </span>a<span class="w"> </span>random<span class="w"> </span>password?<span class="w"> </span><span class="o">(</span>yes/no<span class="o">)</span><span class="w"> </span><span class="o">[</span>no<span class="o">]</span>:
Enter<span class="w"> </span>password:
Enter<span class="w"> </span>password<span class="w"> </span>again:
Lock<span class="w"> </span>out<span class="w"> </span>the<span class="w"> </span>account<span class="w"> </span>after<span class="w"> </span>creation?<span class="w"> </span><span class="o">[</span>no<span class="o">]</span>:
Username<span class="w">   </span>:<span class="w"> </span>user4
Password<span class="w">   </span>:<span class="w"> </span>*****
Full<span class="w"> </span>Name<span class="w">  </span>:<span class="w"> </span>Fourth<span class="w"> </span>User
Uid<span class="w">        </span>:<span class="w"> </span><span class="m">2004</span>
Class<span class="w">      </span>:
Groups<span class="w">     </span>:<span class="w"> </span>nobody<span class="w"> </span>admins
Home<span class="w">       </span>:<span class="w"> </span>/home/user4
Home<span class="w"> </span>Mode<span class="w">  </span>:<span class="w"> </span><span class="m">750</span>
Shell<span class="w">      </span>:<span class="w"> </span>/bin/tcsh
Locked<span class="w">     </span>:<span class="w"> </span>no
OK?<span class="w"> </span><span class="o">(</span>yes/no<span class="o">)</span>:<span class="w"> </span>yes
adduser:<span class="w"> </span>INFO:<span class="w"> </span>Successfully<span class="w"> </span>added<span class="w"> </span><span class="o">(</span>user4<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>user<span class="w"> </span>database.
Add<span class="w"> </span>another<span class="w"> </span>user?<span class="w"> </span><span class="o">(</span>yes/no<span class="o">)</span>:<span class="w"> </span>no
Goodbye!
</code></pre></div>
<p>Next you should have the following output:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="m">2</span>.6.0-RELEASE<span class="o">][</span>user2@pfSense.home.arpa<span class="o">]</span>/home/user2:<span class="w"> </span>su<span class="w"> </span>user4
Password:
user4@pfSense:/home/user2<span class="w"> </span>%<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">2004</span><span class="o">(</span>user4<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">65534</span><span class="o">(</span>nobody<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">65534</span><span class="o">(</span>nobody<span class="o">)</span>,1999<span class="o">(</span>admins<span class="o">)</span>
</code></pre></div>
<p>To add a user to a group:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pw<span class="w"> </span>groupmod<span class="w"> </span>somegroup<span class="w"> </span>-m<span class="w"> </span>user
sudo<span class="w"> </span>pw<span class="w"> </span>groupmod<span class="w"> </span>admins<span class="w"> </span>-m<span class="w"> </span>user5
</code></pre></div>
<p>To remove a user from a group:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pw<span class="w"> </span>groupmod<span class="w"> </span>somegroup<span class="w"> </span>-d<span class="w"> </span>user
sudo<span class="w"> </span>pw<span class="w"> </span>groupmod<span class="w"> </span>zeek<span class="w"> </span>-d<span class="w"> </span>analyst1
</code></pre></div>
<p>To create, review, and delete a group:</p>
<p><a href="https://docs.freebsd.org/en/books/handbook/basics/#users-groups">https://docs.freebsd.org/en/books/handbook/basics/#users-groups</a></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pw<span class="w"> </span>groupadd<span class="w"> </span>logsync
sudo<span class="w"> </span>pw<span class="w"> </span>groupshow<span class="w"> </span>logsync
sudo<span class="w"> </span>pw<span class="w"> </span>groupdel<span class="w"> </span>logsync
</code></pre></div>
<p>To remove a user:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="m">2</span>.6.0-RELEASE<span class="o">][</span>user2@pfSense.home.arpa<span class="o">]</span>/home/user2:<span class="w"> </span>sudo<span class="w"> </span>rmuser<span class="w"> </span>user1
Matching<span class="w"> </span>password<span class="w"> </span>entry:

user1:.../home/user1:/bin/tcsh

Is<span class="w"> </span>this<span class="w"> </span>the<span class="w"> </span>entry<span class="w"> </span>you<span class="w"> </span>wish<span class="w"> </span>to<span class="w"> </span>remove?<span class="w"> </span>y
Remove<span class="w"> </span>user<span class="err">&#39;</span>s<span class="w"> </span>home<span class="w"> </span>directory<span class="w"> </span><span class="o">(</span>/home/user1<span class="o">)</span>?<span class="w"> </span>y
Removing<span class="w"> </span>user<span class="w"> </span><span class="o">(</span>user1<span class="o">)</span>:<span class="w"> </span>mailspool<span class="w"> </span>home<span class="w"> </span>passwd.
</code></pre></div>
<p>Install sudo</p>
<div class="highlight"><pre><span></span><code>pkg install -y sudo pfSense-pkg-sudo
</code></pre></div>
<hr />
<h2 id="ssh">SSH</h2>
<h3 id="system-advanced"><code>System &gt; Advanced</code></h3>
<ul>
<li>Secure Shell<ul>
<li>Check <code>Enable Secure Shell</code></li>
<li>Change <code>SSHd Key Only</code> to either <code>Public Key Only</code> or <code>Require Both Password and Public Key</code></li>
<li>Optionally change the <code>SSH port</code></li>
</ul>
</li>
</ul>
<p>Click <code>Save</code> at the bottom here when finished.
Optionally change the port to prevent the logs from being flooded with bruteforce attempts.</p>
<p>By default every 3 failed attempts will result in a timed lockout, making bruteforce next to impossible.</p>
<p>This allows accessing the http GUI over a portforward via ssh:</p>
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>-p<span class="w"> </span>&lt;port&gt;<span class="w"> </span>-L<span class="w"> </span><span class="m">127</span>.0.0.1:8443:127.0.0.1:443<span class="w"> </span>root@pfsense.ip
</code></pre></div>
<p>Browsing to <a href="https://127.0.0.1:8443">https://127.0.0.1:8443</a> on the local machine will allow you to access the web GUI</p>
<h3 id="ssh-firewall-rules">SSH Firewall Rules</h3>
<p>Remote Management With SSH:</p>
<p><a href="https://youtu.be/MVoe3mX_UZQ?t=142">Lawence Systems</a> again on SSH remote management.</p>
<p><code>Firewall &gt; Rules &gt; WAN &gt; Add Rule</code></p>
<div class="highlight"><pre><span></span><code># Same video as just above, timestamped at SSH firewall rules: https://youtu.be/MVoe3mX_UZQ?t=347
Protocol: TCP
Source: Any | &lt;static-ip-range&gt;           # ingress filter source addresses if you can, however it&#39;s still OK if you must allow any for remote management (ssh is a secure protocol to expose publicly if properly configured)
Destination: This firewall (self)
Destination Port: ssh | (other) &lt;port&gt;    # change the port to the random port you made ssh listen to in the management menu above, otherwise leave as &#39;ssh&#39;
Description: SSH Remote Access
Save
Apply
</code></pre></div>
<p><strong>TIP</strong>: Firefox containers or separate Chrome profiles are great to have on hand if you're managing multiple instances with SSH local port-forwarding. All of the session tabs in your browser share the same (localhost) hostname / ip in this case. Using containers and profiles (don't forget isolate origins and site per process on chrome) will further isolate those web interfaces in case one of them is compromised.</p>
<h3 id="-j-ssh-jump-proxy">-J SSH Jump Proxy</h3>
<p>If you manage multiple machines behind a remote pfSense box, use the <code>-J</code> jump proxy switch instead of the (less secure) agent-forwarding on the pfSense ssh daemon.</p>
<p>It accomplishes this by tunneling tcp over ssh instead of forwarding the session (which caches your key's identity material) at each host along the way.</p>
<p>Attackers with access to the jump boxes with forwarding enabled can impersonate (not steal) the key identity on that jump box should they be able to access the cache.</p>
<p>To use <code>-J</code>, each ssh server in the chain needs your public key.</p>
<p>Separate each internal host along the path with commas <code>,</code> and specify ports as <code>user@host:&lt;port&gt;</code>:
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>-J<span class="w"> </span>user@public-ip:port,user@internaljump1:port,user@internaljump2:port<span class="w"> </span>-p<span class="w"> </span>&lt;port&gt;<span class="w"> </span>-L<span class="w"> </span><span class="m">127</span>.0.0.1:8080:127.0.0.1:80<span class="w"> </span>user@interalhost.ip
<span class="c1">#    ^___________________________________________________________________^  ^_____________________________________^</span>
<span class="c1">#                       The -J argument is one string                         All additional ssh arguments follow as normal</span>
</code></pre></div></p>
<p>Reference: <strong>The Cyber Plumber's Handbook (SSH Tunneling)</strong> for many more examples</p>
<p><a href="https://github.com/opsdisk/the_cyber_plumbers_handbook">https://github.com/opsdisk/the_cyber_plumbers_handbook</a></p>
<hr />
<h3 id="serial-console">Serial Console</h3>
<p>Closely adapted from: <a href="https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#gnu-screen">https://docs.netgate.com/pfsense/en/latest/hardware/connect-to-console.html#gnu-screen</a></p>
<p>Under <code>System &gt; Advanced &gt; Console Menu</code> check <code>Password protect the console menu</code></p>
<p>Connecting a serial cable using usb adapted to serial connection will be listed under <code>/dev</code> as <code>/dev/ttyUSB0</code></p>
<p>The default speed (in pfSense and other cases) is <code>115200</code></p>
<p>Gnu screen (Kali, Ubuntu)</p>
<p><code>screen</code> is available by default in Kali / Kali Live.</p>
<p>On Ubuntu:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>screen
</code></pre></div></p>
<p>After connecting the USB-end to your local PC and the serial-end to the firewall device, check that the device is visible from your PC:
<div class="highlight"><pre><span></span><code>find<span class="w"> </span>/dev<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*ttyUSB*&quot;</span><span class="w"> </span>-ls<span class="w"> </span><span class="m">2</span>&gt;/dev/null
</code></pre></div></p>
<p>You're looking for a device name similar to <code>ttyUSB0</code>, but note that the <strong>number</strong> or <strong>name</strong> may be slightly different.</p>
<p>Once you've identified the device, connect with:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>screen<span class="w"> </span>/dev/ttyUSB0<span class="w"> </span><span class="m">115200</span>
</code></pre></div></p>
<p>If the device is powered off here, the screen will be blank until you power the device back on. You'll see the boot cycle then.</p>
<p>If there‚Äôs an encoding mismatch, try UTF-8 mode:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>screen<span class="w"> </span>-U<span class="w"> </span>/dev/cu.SLAB_USBtoUART<span class="w"> </span><span class="m">115200</span>
</code></pre></div></p>
<p>To quit:</p>
<p><code>CTRL+SHIFT+A</code>; then press <code>\</code></p>
<p><strong>NOTE</strong>: connecting the workstation to the target device over serial cable before powering the target device on, will allow you to identify the serial cable‚Äôs USB id‚Äôs to enter into VirtualBox. This prevents an external device from potentially interfacing directly with the host.</p>
<p>Similarly, VMware (on Windows) allows USB arbitration at plug-in, so you can choose whether it connects to the host or a VM.</p>
<hr />
<h3 id="protect-the-management-port">Protect the Management Port</h3>
<p>Generally management via a web interface should only be accessible from a management subnet / dedicate management interface. The workaround if you require remote access, or if the network is completely flat, is to configure the web interface to only listen on localhost (<code>127.0.0.1</code> and <code>::1</code>), and open <strong>public key based</strong> SSH for access.</p>
<p>This above guidance is fairly generic and applies to any networking appliance.</p>
<p>The steps below detail how to secure a pfSense device if it's also <em>physically</em> in an untrusted environment. Ultimately physical access means game over, but ideally you'd want to at minimum detect tampering. Everything under the <em>recommended</em> section attempts to require an adversary to either completely reset the device to factory defaults or open the case to gain access.</p>
<p>Two areas this guide does not yet cover:</p>
<ul>
<li>Attacks leveraging USB ports</li>
<li>Attacks against the network card itself</li>
</ul>
<h4 id="recommended-settings">Recommended Settings</h4>
<ul>
<li>Require portforwarding over SSH to reach the WebGUI</li>
<li>Delete the default <code>Anti-Lockout Rule</code><ul>
<li>Create a firewall rule to allow inbound ssh access:<ul>
<li>Protocol: TCP</li>
<li>Source IP: *</li>
<li>Source Port: *</li>
<li>Destination IP: This Firewall</li>
<li>Destination Port: <code>&lt;ssh-port&gt;</code></li>
</ul>
</li>
<li>Be sure this rule is active on the LAN / management port so you do not lock yourself out when removing the default Anti-Lockout Rule</li>
<li><code>System &gt; Advanced &gt; [x] Disable webConfigurator anti-lockout rule</code></li>
<li>
<blockquote>
<p>Hint: the "Set interface(s) IP address" option in the console menu resets this setting as well.</p>
</blockquote>
</li>
</ul>
</li>
<li>Limit private traffic on the LAN / management port to only SSH on the firewall itself<ul>
<li>If a WAN cable is accidentally (or malicously) plugged in to the management interface, it's essentially the same attack surface as the WAN interface</li>
<li>A management device connected to the LAN / management interface can still reach the public internet with a block rule for private addresses followed by a pass rule to any</li>
<li>If you need to reach other internal hosts, use an SSH session on the firewall itself, or use the firewall as a <code>-J</code> jump proxy</li>
</ul>
</li>
<li>Create a low-privileged user</li>
<li>Password protect the serial console</li>
<li>Fill the screws on the bottom of the device with paint / nail polish to detect tampering</li>
<li>Review <code>system.log</code> for connection attempts to the physical ports while the device is unattended<ul>
<li><code>Status &gt; System Logs &gt; System &gt; General</code></li>
<li>Filter for '<code>rc.linkup</code>' in <code>message</code>, this will show when interfaces had ethernet connections made</li>
<li>Other filters for this: <code>DEVD</code> and <code>Hotplug</code></li>
<li>This is useful for determining attempted intrusion or tampering while traveling, if for example you decide to bring a pfSense device as a mobile router (the size of the SG-1100 makes this feasible)</li>
</ul>
</li>
</ul>
<h4 id="optional-settings">Optional Settings</h4>
<ul>
<li>Set static ARP mappings to MAC addresses of only devices you trust / will use for management</li>
<li>Only expose the SSH service on the management interface (lower priority, SSH is generally OK to be publicly facing)</li>
<li>Firewall access to the SSH service by source IP (lower priority, especially if you don't always have a static source IP)</li>
</ul>
<p>Always confirm your settings with <code>nmap</code>:</p>
<div class="highlight"><pre><span></span><code>nmap<span class="w"> </span>-n<span class="w"> </span>-Pn<span class="w"> </span>-sT<span class="w"> </span>-p-<span class="w"> </span>-e<span class="w"> </span>&lt;iface&gt;<span class="w"> </span>--open<span class="w"> </span>-T4<span class="w"> </span>&lt;firewall-ip&gt;
Starting<span class="w"> </span>Nmap<span class="w"> </span><span class="m">7</span>.80<span class="w"> </span><span class="o">(</span><span class="w"> </span>https://nmap.org<span class="w"> </span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span><span class="m">2022</span>-01-23<span class="w"> </span><span class="m">12</span>:00<span class="w"> </span>EDT
Nmap<span class="w"> </span>scan<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>&lt;firewall-ip&gt;
Host<span class="w"> </span>is<span class="w"> </span>up<span class="w"> </span><span class="o">(</span><span class="m">0</span>.0013s<span class="w"> </span>latency<span class="o">)</span>.
Not<span class="w"> </span>shown:<span class="w"> </span><span class="m">65534</span><span class="w"> </span>filtered<span class="w"> </span>ports
Some<span class="w"> </span>closed<span class="w"> </span>ports<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>reported<span class="w"> </span>as<span class="w"> </span>filtered<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>--defeat-rst-ratelimit
PORT<span class="w">   </span>STATE<span class="w"> </span>SERVICE
<span class="m">22</span>/tcp<span class="w"> </span>open<span class="w">  </span>ssh

Nmap<span class="w"> </span><span class="k">done</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>IP<span class="w"> </span>address<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>host<span class="w"> </span>up<span class="o">)</span><span class="w"> </span>scanned<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">87</span>.72<span class="w"> </span>seconds
</code></pre></div>
<p>This will use a TCP connect scan with normal user privileges to check all 65535 ports on the firewall. You want ssh to be the only service exposed.</p>
<p>You should also try to reach other internal subnets from the managemnt interface with either <code>ping</code> or <code>nmap</code>.</p>
<p>The <code>&lt;iface&gt;</code> in this case is the network interface on the device you're running the scan <em>from</em>, for example it could be <code>eth0</code> or <code>wlp1s0</code>.</p>
<p>If a WAN cable connects to another internal LAN or OPT port, at minimum, most likely DNS and SSH are what will be reachable.</p>
<hr />
<h2 id="backup-restore-configuration">Backup / Restore Configuration</h2>
<p>You will want to walk through a backup / restore process once you configure pfSense, to ensure your backup restores successfully and can be relied on. Do this <em>before</em> putting the device / VM into production.</p>
<ol>
<li>
<p><code>Diagnostics &gt; Backup/Restore</code></p>
</li>
<li>
<p>Set the Backup Area to All in the Backup Configuration section of the page.</p>
</li>
<li>
<p>Set a password to encrypt the configuration xml file which may contain keys or secrets.</p>
</li>
<li>
<p>Click <code>[Download]</code>.</p>
</li>
<li>
<p>Save this file to external media and cloud storage, or to your password manager for example.</p>
</li>
</ol>
<p>Later with the xml file present, restore the configuration from this page. <strong>Test this out before you rely on it</strong>.</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/backup/restore.html?highlight=restore#restoring-with-the-gui">https://docs.netgate.com/pfsense/en/latest/backup/restore.html?highlight=restore#restoring-with-the-gui</a></p>
<ol>
<li>
<p>After backing up the configuration, Navigate to <code>Diagnostics &gt; Factory Defaults</code></p>
</li>
<li>
<p>Click <code>[Factory Reset]</code> then <code>[OK]</code></p>
</li>
<li>
<p>After the reset which may take several minutes, walkthrough <code>Initial Setup</code> (see below)</p>
</li>
<li>
<p><code>Diagnostics &gt; Backup/Restore</code>, select the areas to restore, the restore file on your local machine, and input the encryption password</p>
</li>
</ol>
<p>Ensure everything is restored correctly.</p>
<p>You can also restore from internal backups the firewall makes after any changes as well:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/backup/restore.html?highlight=restore#restoring-from-the-config-history">https://docs.netgate.com/pfsense/en/latest/backup/restore.html?highlight=restore#restoring-from-the-config-history</a></p>
<h2 id="upgrading">Upgrading</h2>
<p>Upgrade Guide:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/install/upgrade-guide-update.html">https://docs.netgate.com/pfsense/en/latest/install/upgrade-guide-update.html</a></p>
<p>Upgrade Release Notes (for v2.4.5, but applies generally):</p>
<p><a href="https://www.netgate.com/blog/pfsense-2-4-5-release-now-available">https://www.netgate.com/blog/pfsense-2-4-5-release-now-available</a></p>
<p>Important guidance included with every Release Note:</p>
<blockquote>
<p><strong>Take a backup of the firewall configuration before applying any update.</strong></p>
<p><strong>Do not update packages before upgrading! Either remove all packages or do not update packages before running the upgrade.</strong></p>
</blockquote>
<h3 id="upgrading-to-a-new-release">Upgrading to a new release</h3>
<p>Via the GUI:</p>
<ul>
<li>
<p>Set <code>System &gt; Updates &gt; Branch</code> to the <code>Latest stable version</code></p>
</li>
<li>
<p><code>Confirm</code></p>
</li>
</ul>
<p>Via the console menu:</p>
<ul>
<li>Select option 13 (or select option 8 and run <code>pfSense-upgrade</code>)</li>
</ul>
<p>Via SSH with <code>sudo</code> / root:</p>
<ul>
<li>run <code>pfSense-upgrade</code></li>
</ul>
<h3 id="update-troubleshooting">Update Troubleshooting</h3>
<p>This page contains everything you'd need for troubleshooting various issues with updates and upgrades:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html</a></p>
<p>Generally if obtaining the latest update fails, try the following:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#upgrade-not-offered-library-errors">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#upgrade-not-offered-library-errors</a></p>
<blockquote>
<p>Refresh the repository configuration and upgrade script by running the following commands from the console or shell:</p>
<div class="highlight"><pre><span></span><code>pkg-static<span class="w"> </span>clean<span class="w"> </span>-ay<span class="p">;</span><span class="w"> </span>pkg-static<span class="w"> </span>install<span class="w"> </span>-fy<span class="w"> </span>pkg<span class="w"> </span>pfSense-repo<span class="w"> </span>pfSense-upgrade
</code></pre></div>
</blockquote>
<p>If pfSense is unable to obtain an update status (the GUI update text under <code>Dashboard &gt; System Information &gt; Version</code> will be in red, or from the console you may see TLS verification fail when trying to reach netgate's servers)</p>
<p>Closely adapted from: <a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#rewrite-repository-information">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#rewrite-repository-information</a></p>
<p>See the link above for additional guidance if these steps do not solve the issue.</p>
<ul>
<li>
<p>Login via the GUI</p>
</li>
<li>
<p>Set <code>System &gt; Updates &gt; Branch</code> to a <code>Previous stable version</code> (or <code>Latest developer snapshots</code>)</p>
</li>
<li>
<p>Set <code>Branch</code> back to desired update target</p>
</li>
<li>
<p>You should now see the update as available.</p>
</li>
</ul>
<h2 id="ui-configuration">UI Configuration</h2>
<p>How to manage widgets: <a href="https://docs.netgate.com/pfsense/en/latest/monitoring/dashboard-manage.html">https://docs.netgate.com/pfsense/en/latest/monitoring/dashboard-manage.html</a></p>
<p>Good widgets to have visible:</p>
<ul>
<li>System Information</li>
<li>Interfaces</li>
<li>Service Status</li>
<li>Firewall Logs</li>
<li>Gateways</li>
</ul>
<h2 id="networking">Networking</h2>
<p>Echoing what was referenced during the initial setup, to configure network interfaces:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/config/interface-configuration.html">https://docs.netgate.com/pfsense/en/latest/config/interface-configuration.html</a></p>
<p><strong>TIP</strong>: When choosing a network address / range, choose something somwhat obscure that isn't likely to be a default configuration of an internal subnet. This is particularly important when bringing a small router / wireless device as a pfSense box on the go for travel.</p>
<p><strong>EXAMPLE</strong>: If you have an internal subnet of 192.168.20.0/24 on your pfSense device, and are connecting this device to a hotel LAN network that also has the same subnet, you will run into routing issues.</p>
<p>Choosing something less typical, but still memorable can be done: <code>10.15.15.0/24</code>, <code>172.21.21.0/24</code>, <code>192.168.222.0/24</code>, etc...</p>
<hr />
<h3 id="updating-network-address-ranges">Updating Network Address Ranges</h3>
<p><strong>TIP</strong>: To change the subnet of the management interface, avoid lockout and misconfiguration by temporarily permitting management access from another subnet or ensuring you have console access to use <code>2) Set interface(s) IP address</code></p>
<p><strong>TIP</strong>: update these values on an upstream bridged AP as well, either before or after, so long as it's not the same interface required for remotely managing the bridged AP device</p>
<ul>
<li>[x] <code>Services &gt; DHCP Server &gt; &lt;iface&gt;</code> Uncheck 'Enable DHCP server on <iface>'</li>
<li>[x] <code>Interfaces &gt; &lt;iface&gt;</code> Change the IP address and range values</li>
<li>[x] <code>Save</code> and <code>Apply</code></li>
<li>[x] <code>Services &gt; DHCP Server &gt; &lt;iface&gt;</code> Update the <code>Range</code> values to reflect the new IP range, and re-check 'Enable DHCP server on <iface>'</li>
<li>[x] <code>Save</code> and <code>Apply</code></li>
</ul>
<hr />
<h3 id="aliases">Aliases</h3>
<h4 id="networks">Networks</h4>
<p>Create an alias list for private RFC1918 or RFC3330 networks to use in rules for subnet isolation.
Otherwise vlans can still reach other vlans if they aren't firewalled.</p>
<p>https://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.xhtml</p>
<p>https://www.iana.org/assignments/ipv6-address-space/ipv6-address-space.xhtml</p>
<table>
<thead>
<tr>
<th>Address Block</th>
<th>Present Use</th>
<th>Reference</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.0.0.0/8</td>
<td>"This" Network</td>
<td>[RFC1700, page 4]</td>
</tr>
<tr>
<td>10.0.0.0/8</td>
<td>Private-Use Networks</td>
<td>[RFC1918]</td>
</tr>
<tr>
<td>14.0.0.0/8</td>
<td>Public-Data Networks</td>
<td>[RFC1700, page 181]</td>
</tr>
<tr>
<td>24.0.0.0/8</td>
<td>Cable Television Networks</td>
<td>--</td>
</tr>
<tr>
<td>39.0.0.0/8</td>
<td>Reserved but subject to allocation</td>
<td>[RFC1797]</td>
</tr>
<tr>
<td>127.0.0.0/8</td>
<td>Loopback</td>
<td>[RFC1700, page 5]</td>
</tr>
<tr>
<td>128.0.0.0/16</td>
<td>Reserved but subject to allocation</td>
<td>--</td>
</tr>
<tr>
<td>169.254.0.0/16</td>
<td>Link Local</td>
<td>--</td>
</tr>
<tr>
<td>172.16.0.0/12</td>
<td>Private-Use Networks</td>
<td>[RFC1918]</td>
</tr>
<tr>
<td>191.255.0.0/16</td>
<td>Reserved but subject to allocation</td>
<td>--</td>
</tr>
<tr>
<td>192.0.0.0/24</td>
<td>Reserved but subject to allocation</td>
<td>--</td>
</tr>
<tr>
<td>192.0.2.0/24</td>
<td>Test-Net</td>
<td></td>
</tr>
<tr>
<td>192.88.99.0/24</td>
<td>6to4 Relay Anycast</td>
<td>[RFC3068]</td>
</tr>
<tr>
<td>192.168.0.0/16</td>
<td>Private-Use Networks</td>
<td>[RFC1918]</td>
</tr>
<tr>
<td>198.18.0.0/15</td>
<td>Network Interconnect Device Benchmark Testing</td>
<td>[RFC2544]</td>
</tr>
<tr>
<td>223.255.255.0/24</td>
<td>Reserved but subject to allocation</td>
<td>--</td>
</tr>
<tr>
<td>224.0.0.0/4</td>
<td>Multicast</td>
<td>[RFC3171]</td>
</tr>
<tr>
<td>240.0.0.0/4</td>
<td>Reserved for Future Use</td>
<td>[RFC1700, page 4]</td>
</tr>
<tr>
<td>::1</td>
<td>Loopback</td>
<td>[RFC4291, page 6]</td>
</tr>
<tr>
<td>fc00::/7</td>
<td>Unique Local Address (Global scope)</td>
<td>[RFC4193, page 3]</td>
</tr>
<tr>
<td>fe80::/10</td>
<td>Link-Scoped Unicast</td>
<td>[RFC4291, page 6]</td>
</tr>
<tr>
<td>ff00::/8</td>
<td>Multicast</td>
<td>[RFC4291, page 6]</td>
</tr>
</tbody>
</table>
<p>https://datatracker.ietf.org/doc/html/rfc3330#section-3</p>
<p>Example of RFC 3330 as an alias:</p>
<p><img alt="pfsense-rfc3330-aliases" src="../../../../media/pfsense/pfsense-rfc3330-aliases.png" /></p>
<p>Correctly configured routing devices should <strong>NOT</strong> forward fe80:: / link-scoped unicast traffic by default, meaning that local traffic should only happen locally. It allows your edge device to talk to the ISP's gateway device, but the ISP's gateway device will not be able to to talk to your internal machines on fe80::, however if you have a globally routable IPv6 address, the address and that interface it's bound to <strong>are</strong> <em>globally routable</em>.</p>
<h4 id="alias-ports">Alias Ports</h4>
<p>It can be helpful to create an alias for all of the ports management interfaces use.</p>
<ul>
<li>22/tcp  | SSH</li>
<li>80/tcp  | HTTP WebGUI</li>
<li>443/tcp | HTTPS WebGUI</li>
</ul>
<p>Of course if you changed any these from their defaults, maintaining them here makes it easy to maintain egress rules.</p>
<h2 id="firewall">Firewall</h2>
<p>Firewall rules and examples.</p>
<h3 id="essential-interfaces-wan-lan-floating">Essential Interfaces (WAN, LAN, FLOATING)</h3>
<div class="highlight"><pre><span></span><code>FLOATING
    * [Optional] Reject outbound RFC1918/3330 traffic over the WAN
    * &lt;https://docs.netgate.com/pfsense/en/latest/recipes/rfc1918-egress.html#steps-to-block-rfc-1918-traffic-from-leaving-the-wan-interface&gt;
    NOTE: This covers the use case of routing over a VPN, if the VPN goes down private network taffic
          will not leave the WAN interface.
</code></pre></div>
<p><img alt="pfsense-fw-rules-floating" src="../../../../media/pfsense/pfsense-fw-rules-floating.png" /></p>
<hr />
<div class="highlight"><pre><span></span><code>WAN
    * Block private networks
    * Block bogon networks
    * [Optional] Allow ssh/tcp -&gt; WAN interface (whichever port is ssh, this allows ssh tunneling to the
      web interface without exposing it)
    * [Optional] Allow vpn traffic -&gt; X interface (permit remote access to networks, as well as secure
      routing capability back out through the WAN using the vpn&#39;s dns server + firewall)
</code></pre></div>
<p><img alt="pfsense-fw-rules-wan-001" src="../../../../media/pfsense/pfsense-fw-rules-wan-001.png" /></p>
<hr />
<div class="highlight"><pre><span></span><code>LAN / Management Interface
    * Anti-Lockout Rule | Allow to specific management ports on this interface (ie; 22, 443 only, etc)
    * [Optional] Allow to other internal interfaces for management from this one subnet
    * Disable the &#39;default allow outbound&#39; rules here to keep this management interface
      entirely offline, which is ultimately optional but recommended.
</code></pre></div>
<p><img alt="pfsense-fw-rules-lan-mgmt" src="../../../../media/pfsense/pfsense-fw-rules-lan-mgmt.png" /></p>
<hr />
<p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/rfc1918-egress.html">https://docs.netgate.com/pfsense/en/latest/recipes/rfc1918-egress.html</a></p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/firewall/rule-methodology.html#block-private-networks">https://docs.netgate.com/pfsense/en/latest/firewall/rule-methodology.html#block-private-networks</a></p>
<p><strong>NOTE</strong>: This suggests that the 'Block private address ranges' rule will break functionality when pfsense is behind another router</p>
<p>(ie; a pfSense vm at 192.168.20.18 bridged to a real network, 192.168.20.0/24)</p>
<p>This has not happened so far, however if it breaks DHCP, DNS, or other local routing, disable it and review.</p>
<p>So far it only effects inbound traffic, which is fine if ssh access from the WAN interface is not required.</p>
<p><strong>TIP</strong>: You'll note <code>Block</code> and <code>Reject</code> are mentioned explicitly in the rules below. From an internal perspective, this makes the firewall rules less obvious.</p>
<ul>
<li><strong>EXAMPLE 1</strong><ul>
<li>pfSense typically rejects on closed ports.</li>
<li>If you only Block your management ports, Scanning all 65535 ports on the firewall will reveal exactly which are your management ports</li>
</ul>
</li>
<li><strong>EXAMPLE 2</strong><ul>
<li>Say you decide to scan ports on a specific IP chosen at random (172.20.111.72) within your current network (172.20.111.0/24)</li>
<li>If no host exists, this will return as 'filtered'.</li>
<li>Note that it can return filtered if the host exists and is dropping packets, but for the sake of this example, we know there is no host there.</li>
<li>When Reject rules are in place to isolate neighboring RFC1918/3330 subnet ranges, any IP address in all neighboring private subnets will immediately return 'closed' for any ports scanned.</li>
<li>When they do not return 'filtered' as the they would if there was no host at that IP, it becomes obvious you're firewalling neighboring subnets.</li>
</ul>
</li>
</ul>
<h3 id="example-firewall-rulesets">Example Firewall Rulesets</h3>
<h4 id="optx-subnet-egress">OPTx (Subnet egress)</h4>
<div class="highlight"><pre><span></span><code>    * Block bogon networks
    * Reject -&gt; management access
    * [Optional] Deny IPv6
    * Allow ICMP req -&gt; OPTx
    * Allow tcp/udp-&gt; OPTx interface (Dns, DHCP, etc)
    * [Optional] Block -&gt; RFC1918/3330 traffic (isolate subnets, else reachable)
    * OPTx Net -&gt; Any ICMP req (allow all outbound ICMP ping request)
    * OPTx Net -&gt; Any tcp/udp (allow all outbound routing of tpc/udp traffic)
</code></pre></div>
<p><img alt="pfsense-fw-rules-egress-001" src="../../../../media/pfsense/pfsense-fw-rules-egress-001.png" /></p>
<h4 id="alternate-optx-strict-egress">Alternate OPTx (Strict egress)</h4>
<div class="highlight"><pre><span></span><code>    * Block bogon networks
    * Reject -&gt; management access
    * [Optional] Deny IPv6
    * Allow ICMP req -&gt; OPTx
    * Allow udp/53 -&gt; OPTx interface (Dns, DHCP, ping, etc)
    * Block -&gt; RFC1918/3330 traffic (isolate subnets, else reachable)
    * OPTx Net -&gt; Any ICMP req (allow all outbound ICMP ping request)
    * OPTx Net -&gt; Any tcp/80 (Standard outbound http)
    * OPTx Net -&gt; Any tcp/443 (Standard outbound https)
    * OPTx Net -&gt; Any udp/123 (Standard outbound ntp)
</code></pre></div>
<h4 id="analysis-network-reject-all-traffic">Analysis Network (Reject all traffic)</h4>
<div class="highlight"><pre><span></span><code>    * Block bogon networks
    * [Optional] Reject ANY -&gt; ANY
</code></pre></div>
<p><strong>NOTE</strong>: Rejecting <code>ANY -&gt; ANY</code> will still allow Zeek to capture this traffic on the defined <code>SPAN</code> port if the analysis network interface is a member of the <code>BRIDGEx</code> interface. It will also still permit hosts to receive a DHCP lease from the pfSense firewall, be reachable with ping from the pfSense firewall, and for hosts to commnuicate with eachother internally, but no traffic can enter or leave this network. Rejecting <code>ANY -&gt; ANY</code> is not truly necessary, for example simply not having any rules will achieve a similar outcome. The difference is this rule is defined, and any outbound connections will be closed immediately instead of left to time out.</p>
<p><img alt="pfsense-fw-rules-analysis-subnet" src="../../../../media/pfsense/pfsense-fw-rules-analysis-subnet.png" /></p>
<h2 id="pfsense-as-a-lab-vm">pfSense as a Lab VM</h2>
<p>You'll want to review the documents for VMware and VirtualBox on how they describe <strong>lan segments</strong>:</p>
<ul>
<li>
<p>VMware</p>
<ul>
<li><a href="https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/com.vmware.ws.using.doc/GUID-CC791418-B30C-487D-8F57-E7E855B61549.html">https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/com.vmware.ws.using.doc/GUID-CC791418-B30C-487D-8F57-E7E855B61549.html</a></li>
</ul>
</li>
<li>
<p>VirtualBox</p>
<ul>
<li><a href="https://www.virtualbox.org/manual/UserManual.html#network_internal">https://www.virtualbox.org/manual/UserManual.html#network_internal</a></li>
</ul>
</li>
</ul>
<p>The key is <strong>this type of networking is entirely separate from the host's phyiscal network card</strong>.</p>
<p>pfSense is leveraged here to be both the local subnet management system, and a way to control traffic flow, keeping your LAN segments entirely virtual and providing the subnets with outbound network access that require it.</p>
<p>There's a lot of flexibility with this setup, the next steps cover the main details.</p>
<p>This example will you give you a general purpose lab VM with the following isolated subnets (you can use the example rulesets above in these subnets):</p>
<ul>
<li>LAN / management network</li>
<li>OPT1 / trusted network (work machines, local networking)</li>
<li>OPT2 / untrusted network (lab machines, potentially untrusted local traffic)</li>
<li>OPT3 / analysis network (no routing, no inbound, no outbound)</li>
<li>[Optional] SPAN0 / port mirroring network interface</li>
</ul>
<p><img alt="pfsense-interfaces-001" src="../../../../media/pfsense/pfsense-interfaces-001.png" /></p>
<p>On VMWare Workstation, under <code>VM &gt; Settings &gt; Hardware</code> you'll want to have 6 network adaptors:</p>
<table>
<thead>
<tr>
<th>Device</th>
<th>Summary</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Network Adapater</td>
<td>Bridged (Automatic)</td>
<td>Bridged, connected directly to the physical network (This will act as your WAN)</td>
</tr>
<tr>
<td>Network Adapater 2</td>
<td>LAN Segment</td>
<td>LAN Segment 1, effectively your LAN or management interface</td>
</tr>
<tr>
<td>Network Adapater 3</td>
<td>LAN Segment</td>
<td>LAN Segment 2, this will appear as OPT1 under interfaces, your trusted network</td>
</tr>
<tr>
<td>Network Adapater 4</td>
<td>LAN Segment</td>
<td>LAN Segment 3, this will appear as OPT2 under interfaces, your untrusted network</td>
</tr>
<tr>
<td>Network Adapater 5</td>
<td>LAN Segment</td>
<td>LAN Segment 4, this will appear as OPT3 under interfaces, your analysis (offline) network</td>
</tr>
<tr>
<td>Network Adapater 6</td>
<td>LAN Segment</td>
<td>LAN Segment 5, this will appear as OPT4 under interfaces, you'll want to assign this as your SPAN port</td>
</tr>
</tbody>
</table>
<p><img alt="vmware-pfsense-network-devices-001" src="../../../../media/pfsense/vmware-pfsense-network-devices-001.png" /></p>
<p><img alt="vmware-pfsense-network-devices-002" src="../../../../media/pfsense/vmware-pfsense-network-devices-002.png" /></p>
<p>On VirtualBox, we are limited to 4 total network interfaces per VM.</p>
<p>However we can still achieve similar usage with the following setup, under <code>VM &gt; Settings &gt; Network</code>:</p>
<table>
<thead>
<tr>
<th>Adapter</th>
<th>Summary</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Adapter 1</td>
<td>Bridged Adapter</td>
<td>Bridged, connected directly to the physical network (This will act as your WAN)</td>
</tr>
<tr>
<td>Adapter 2</td>
<td>Internal Network</td>
<td>You can name these anything, we'll use <code>pf-intnet-1</code> here, effectively your LAN or management interface</td>
</tr>
<tr>
<td>Adapter 3</td>
<td>Internal Network</td>
<td>You can name these anything, we'll use <code>pf-intnet-2</code> here, this will appear as OPT1 under interfaces, your trusted network</td>
</tr>
<tr>
<td>Adapter 4</td>
<td>Internal Network</td>
<td>You can name these anything, we'll use <code>pf-intnet-3</code> here, this will appear as OPT2 under interfaces, your untrusted network</td>
</tr>
</tbody>
</table>
<p>While we're limited, we have flexibility in what to do next. I've found the following solutions work, choose whichever one you think is best:</p>
<ul>
<li><strong>SOLUTION 1</strong>: Configure Zeek to listen on the 'trusted' and 'untrusted' networks</li>
<li>Zeek can be configured to listen to two network interfaces.</li>
<li>Instead of using a SPAN port, set it to your two networks that allow outbound traffic.</li>
<li>
<p>If you need an analysis subnet, simply switch over to the LAN / management interface, and turn off the firewall rules to pass outbound traffic in your untrusted network.</p>
</li>
<li>
<p><strong>SOLUTION 2</strong>: Merge your <code>LAN</code> management interface with the <code>OPT1</code> trusted subnet, essentially allow admin access via the trusted subnet</p>
</li>
<li>Trusted + management network</li>
<li>Untrusted network</li>
<li>Analysis network</li>
</ul>
<p>Don't forget you can also clone these VM's, and run pfSense behind pfSense. Despite the limitation in network adapters, the possibilities are somewhat limitless.</p>
<hr />
<h4 id="pfsense-lab-vm-for-osint">pfSense Lab VM for OSINT</h4>
<p>Taking the above examples, you could dedicate a network interface to OSINT, following the setup recommended in <a href="https://inteltechniques.com/book1.html">Open Source Intelligence Techniques</a>. This will replicate everything done on phyiscal hardware, such as the VPN + kill switch, only here you can manage and experiment with all of this virtually.</p>
<p>They key points to remember no matter what kind of VPN client you setup:</p>
<ul>
<li>If you're dedicating a subnet to run behind the VPN, be sure you've added a network interface as a LAN segment to the pfSense VM ahead of time</li>
<li>Add the VPN CA to your cert manager</li>
<li>Add the VPN client profile<ul>
<li>Don't pull routes</li>
<li>Don't pull DNS if you want to use pfSense for DNS over TLS / HTTPS</li>
<li>Refuse any non-stub compression</li>
<li>If your VPN service profiles share a common CA and TLS key, you can configure a single profile to connect to random endpoints<ul>
<li>Add one IP / port pair to the Endpoint Configuration section as normal</li>
<li>Add the other IP / port pairs to Advanced Configuration &gt; Custom Options, one per line, starting with "remote", ending with a semicolon, like: <code>remote &lt;ip-address&gt; &lt;port&gt;;</code></li>
<li>Add <code>remote-random;</code> to the Advanced Configuration &gt; Custom Options</li>
<li>Each time you restart the OpenVPN service, it will connect to a new endpoint</li>
</ul>
</li>
</ul>
</li>
<li>Interfaces &gt; Assignments &gt; Add the new OVPN interface <em>you just created and named</em></li>
<li>Here you'd also add the interface and DHCP server details for the dedicated subnet, just as described in <a href="#network-interfaces">network interfaces</a></li>
<li>Configure manual outbound NAT, set the default gateway to the OVPN interface <em>you just created and named</em> for both outbound mappings<ul>
<li>You want to add the one you named, and not the default virtual interface of 'OpenVPN' which is listed if OpenVPN is connected and running</li>
</ul>
</li>
<li>Firewall &gt; Rules &gt; Set any rules you require, be sure the default outbound rule has the OVPN interface <em>you just created and named</em> set as it's default gateway (do this under Advanced)</li>
<li>Once done, be sure to refresh the connection under Status &gt; OpenVPN &gt; Restart openvpn Service</li>
<li>Use a VM in that subnet (Kali live works well here) to check your public IP with <code>curl https://ipinfo.io/ip</code></li>
<li>SSH into the pfSense VM, setup a listener to review DNS traffic for leaks with <code>sudo tcpdump -i em0 -n -vv -Q out port 53 -Z nobody</code></li>
<li>Make requests from that subnet to review the packet capture</li>
</ul>
<p>To review your configuration:</p>
<ul>
<li>Status &gt; OpenVPN &gt; Client Instance Statistics shows "Connected (Success)"</li>
<li>On the same page, ‚Üª restarting the client will cycle through IP addresses</li>
<li><code>curl https://ipinfo.io/ip</code></li>
<li>Visit <code>https://bgp.he.net/</code> from any browser within the subnet</li>
<li>Start with Status &gt; System Logs &gt; OpenVPN if you're encountering any issues</li>
</ul>
<p>The easiest and safest way to manage this connection from the host is by bridging the "WAN" side of the pfSense VM so that you can SSH port forward to hit the web interface like this: <code>ssh -p &lt;port&gt; -L 127.0.0.1:8443:127.0.0.1:443 &lt;user&gt;@&lt;pfsense-ip&gt;</code>. Browsing to <code>https://127.0.0.1:8443</code> on your host will take you to the pfSense web interface. Here you can monitor the connection as well as cycle and change endpoints by restarting the OpenVPN client. This is ideal over making the VPN connection from your host whether it's through the built in <code>openvpn</code> package on Linux, or a VPN service's client application. In both cases you avoid putting your host into the same subnet as the VPN, and in the latter you avoid installing additional software.</p>
<h3 id="pfsense-lab-vm-for-networking">pfSense Lab VM for Networking</h3>
<p>Similarly, to do network testing you could network two or more additional pfSense systems behind a single 'main' pfSense VM, to communicate with each other. This will allow you to quickly spin up networking configurations and utilities, that generally work best across mutliple subnets and routes.</p>
<h3 id="malware-analysis-network-isolation">Malware Analysis Network Isolation</h3>
<p>This is critical for an internal and isolated malware analysis subnet, where you do not want anything reaching the world outside of that virtual network.</p>
<p>This set of checks was learned from <a href="https://academy.tcm-sec.com/p/practical-malware-analysis-triage">Practical Malware Analysis &amp; Triage</a> which provides more detailed video walkthroughs of what to do and what to check. The accompanying Discord server also has more information on this topic. This section was heavily shaped from these two sources.</p>
<p>The key to network isolation is ensuring the VM's doing the analysis are only connected to this one network interface and <strong>no others</strong>.</p>
<p>First, be sure you've seen and configured the analysis subnet like the <a href="#analysis-network-reject-all-traffic">example above</a></p>
<p>Then you can test internal and outbound connectivity from your analysis workstation:</p>
<ul>
<li>
<p>Obtain local network information on Windows: <code>ipconfig</code></p>
</li>
<li>
<p>Obtain local network information on Linux: <code>ip a</code></p>
</li>
<li>
<p>Ping the local gateway</p>
</li>
<li>
<p>Ping a publicly reachable address (we'll use Quad9's public DNS server): <code>ping 9.9.9.9</code></p>
</li>
</ul>
<p>You should receive a <strong>Request timed out.</strong> response and see <strong>(100% loss)</strong> in your command output like below:</p>
<p><img alt="pfsense-analysis-subnet-isolation-001" src="../../../../media/pfsense/pfsense-analysis-subnet-isolation-001.png" /></p>
<p>To be exhaustive, ensure DNS cannot be resolved:</p>
<p>On Windows:</p>
<div class="highlight"><pre><span></span><code>nslookup.exe microsoft.com &lt;dns-server&gt;
</code></pre></div>
<p>On Linux:</p>
<div class="highlight"><pre><span></span><code>dig<span class="w"> </span>@&lt;dns-server&gt;<span class="w"> </span>microsoft.com
</code></pre></div>
<p>All of these should fail / timeout, like the example above.</p>
<p>Next, you can check to see if the firewall itself can in fact reach internal hosts - it should never need to do this but it's one direction you can check to ensure for example DHCP leases can be sent out.</p>
<p><img alt="pfsense-analysis-subnet-isolation-002" src="../../../../media/pfsense/pfsense-analysis-subnet-isolation-002.png" /></p>
<p>Last and most important, you'll want to check from another internal host that internal machines can talk to eachother, but again not anything else:</p>
<ul>
<li>This example pings the Windows 11 workstation from the previous example, at <code>172.20.133.100</code></li>
<li>The gateway is ping'd again at <code>172.20.133.1</code> to ensure it doesn't respond</li>
<li>The gateway is also checked with <code>nmap</code> to ensure the web interface is unreachable.</li>
</ul>
<p><img alt="pfsense-analysis-subnet-isolation-003" src="../../../../media/pfsense/pfsense-analysis-subnet-isolation-003.png" /></p>
<p>From here you're ready to test or analyze malware as far as the network configuration goes. Remember to also disable Drag &amp; Drop + Copy &amp; Paste and take a snapshot before detonation.</p>
<p>Anytime you need to retreive new samples, or update an analysis workstation, simply roll back to the known-good snapshot, connect to a subnet that permits outbound traffic, run the updates and/or download the latest samples, then switch the network connection back to the analysis subnet before taking a new snapshot.</p>
<hr />
<h2 id="nat">NAT</h2>
<p>Outbound NAT Mode:
<code>Automatic</code> is fine in most cases
<code>Manual</code> can be used to enforce subnets to use specific routes (ie; vpn killswitch, traffic shaping)</p>
<p><strong>TO DO</strong></p>
<hr />
<h3 id="vpn">VPN</h3>
<p><strong>Server Configuration</strong>:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-s2s-route-internet-traffic.html">https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-s2s-route-internet-traffic.html</a></p>
<p>This guide routes all traffic through, and out of, a single site.</p>
<ul>
<li>
<p>Good for traffic inspection</p>
</li>
<li>
<p>Good for personal vpn usage (connect back to a trusted network)</p>
</li>
</ul>
<p><strong>Client Configruation</strong>:</p>
<p>Be sure to check <code>Don't pull routes</code> (prevents the server from manipulating the local routing table)</p>
<p>Also choose <code>[Refuse] Allow Compression</code> (don't allow any tunnel compression)</p>
<p><code>IPv4 Tunnel Network</code>: Set this network range to a private range not in use by any live interfaces on the router, or allow the server to handle this and do not set any interfaces to ip ranges the server uses.</p>
<hr />
<h3 id="vlans">VLANs</h3>
<p>A logical splitting of a physical port into other virtual ports</p>
<p>Represented as:</p>
<p><code>eth0</code> -&gt; <code>eth0.10</code>, <code>eth0.20</code>, <code>eth0.30</code>...</p>
<h3 id="creating-a-vlan-checklist">Creating a VLAN Checklist:</h3>
<ul>
<li><code>VLAN ID</code> created under <code>Interfaces &gt; Assignments &gt; VLANs</code></li>
<li>If applicable, <code>VLAN ID</code> also created under <code>Interfaces &gt; Switches &gt; VLANs</code><ul>
<li>This is necessary on devices such as the SG-1100, or devices leveraging a single network interface with multiple ports already separated logically by VLANs</li>
<li>For example, the SG-1100 will end up with double tagged VLANs if you're applying your own tags for an upstream switch / AP<ul>
<li>This device is already separating traffic logically on a single interface with VLANs to create a LAN / WAN / OPT</li>
<li>In other words, they're already tagged</li>
<li>You're applying your own VLAN tags on top of these to isolate subnets on an upstream wireless access point, or managed switch.</li>
</ul>
</li>
</ul>
</li>
<li>VLAN interfaces are enabled and defined within <code>Interfaces &gt; Assignments &gt; [vlan-interface]</code></li>
<li><code>Interfaces &gt; [vlan-interface]</code>, <code>[x] Enable Interface</code><ul>
<li>Optionally rename it from <code>OPTx</code></li>
<li>Configure IPv4|6 + other settings</li>
<li>Set interface's IPv4 static address + netmask</li>
<li>Block bogon networks (always)</li>
<li>Set a switch port this interface should map to<ul>
<li>In the case of the SG-1100, this can be left alone.</li>
<li>For the SG-3100, you can use this to logically separate the 4 LAN ports into isolated VLAN subnets</li>
</ul>
</li>
<li><code>Save</code> + <code>Apply</code> when done.</li>
</ul>
</li>
<li>DHCP enabled for desired VLANs under <code>Services &gt; DHCP Server &gt; [vlan-interface]</code><ul>
<li>Here you can configure <code>Deny unkown clients</code> and <code>Static ARP</code> entries. This is useful for correlating traffic logs to IP addresses + MAC addresses</li>
<li><code>Save</code> when done</li>
</ul>
</li>
<li>All VLAN interface(s) configured so far should be visible on the <strong>Dashboard</strong> like any other interface</li>
<li>Assign <strong>firewall rules</strong> to VLANs like any other interface</li>
<li>Provision networking, and tag, upstream switches / Bridged AP's with the desired VLAN tags<ul>
<li>Bridged AP's <strong>must</strong> support, and be in, <em>bridged mode</em> to allow the pfSense firewall to manage clients, dhcp, etc</li>
</ul>
</li>
</ul>
<hr />
<h3 id="creating-a-vlan-detailed-steps">Creating a VLAN - Detailed Steps:</h3>
<p><code>Interfaces &gt; Assignments</code></p>
<p>pfSense Interfaces and VLAN Assignments.</p>
<p>Enable any VLANs you created in <code>Interfaces &gt; Assignments &gt; VLANs</code> here.</p>
<p><strong>EXAMPLE</strong>:</p>
<ul>
<li>WAN  = net2</li>
<li>LAN  = net1</li>
<li>OPT1 = net0</li>
<li>OPT2 = VLAN 20  on net0 / OPT1 <description></li>
<li>OPT3 = VLAN 30  on net0 / OPT1 <description></li>
<li>LAN2 = VLAN 200 on net1 / LAN <description></li>
</ul>
<p><strong>TO DO</strong>: add screenshots showing what this looks like in the WebGUI</p>
<hr />
<p><code>Interfaces &gt; Assignments &gt; VLANs</code></p>
<p>This is where both upstream and local VLAN tags are described.</p>
<p>You won't need to define upstream VLANs under <code>Interfaces &gt; Switches &gt; VLANs</code>, only VLANs on the local physical switch are defined there <strong>(Exception being the SG-1100 style chipsets, see below)</strong></p>
<p>Remember to enable these under <code>Interfaces &gt; Assignments</code>.</p>
<p><strong>EXAMPLE</strong>:</p>
<p>Assign 3 VLANs to the <code>net0</code> interface, that an upstream Bridged AP will be aware of and using:</p>
<div class="highlight"><pre><span></span><code>Parent Interface: net0
VLAN Tag: 110
Description: VLAN1

Parent Interface: net0
VLAN Tag: 120
Description: VLAN2

Parent Interface: net0
VLAN Tag: 130
Description: VLAN3
</code></pre></div>
<ul>
<li>
<p><code>Interfaces &gt; Assignments &gt; [interface]</code></p>
</li>
<li>
<p>Here again <code>Switch Port</code> is only relevant for ports on the local physical switch built into the device.</p>
</li>
<li>
<p>Upstream VLANs won't be assigned a <code>Switch Port</code></p>
</li>
<li>
<p>Enable the inerface like any other.</p>
</li>
<li>
<p><code>Interfaces &gt; Switches &gt; VLANS</code></p>
</li>
</ul>
<p>The only VLAN's tagged and grouped here are those built directly into the pfSense device's switch</p>
<p>Upstream VLAN's (for example from an access point) are not shown here.</p>
<p>VLAN's <strong>group ID</strong> number are related to the physical port on the box.</p>
<p>The <strong>TAG number</strong> assigned by the user is part of the 802.1q standard to identify VLAN's and apply rules.</p>
<hr />
<p><strong>EXAMPLE</strong>:</p>
<p>If there are 5 ports on your switch, port 5 itself being the physical uplink to WAN, and 1-4 being individual ethernate ports;</p>
<p>To keep them all separate, you would tag <code>5</code> on each VLAN, and leave the 1,2,3, or 4 untagged.</p>
<div class="highlight"><pre><span></span><code>VLAN group  VLAN tag    Members      Description
0           1           1,5          Default System VLAN
1           120         2,5t         LAN2 VLAN
2           130         3,5t         LAN3 VLAN
3           140         4,5t         LAN4 VLAN
</code></pre></div>
<p>5 remains untagged on the default system VLAN group.</p>
<p>Contrast the above to what the default VLAN mappings look like on the same device if you did not configure any VLANs:</p>
<div class="highlight"><pre><span></span><code>VLAN group  VLAN tag    Members      Description
0           1           1,2,3,4,5    Default System VLAN
</code></pre></div>
<p><strong>SG-1100 VLAN Differences</strong></p>
<p>This device is configured as a 'router on a stick' where the chip is a single 'port' that's broken down logically into three separate ports, the difference being the three logical ports are phyiscal ports on the device.
Because of this you will need to double tag based on the port you plan to use the VLANs with.</p>
<div class="highlight"><pre><span></span><code>VLAN group  VLAN tag    Members      Description
0           1           0            Default System VLAN
1           4090        0t,3         WAN
2           4091        0t,2         LAN
3           4092        0t,1         OPT
4           110         0t,1t        VLAN1                     # this line shows the double tagged VLAN
                                                               # tagging the default `0` for the uplink,
                                                               # as well as `1` since it&#39;s using the OPT port.
</code></pre></div>
<hr />
<h3 id="bridging-multiple-interfaces-for-port-mirroring-span-port-for-traffic-monitoring">Bridging Multiple Interfaces for Port Mirroring (SPAN Port for Traffic Monitoring)</h3>
<p><a href="https://docs.netgate.com/pfsense/en/latest/bridges/create.html">https://docs.netgate.com/pfsense/en/latest/bridges/create.html</a></p>
<p>Define a set of interfaces to bridge, which become a single bridge interface, and a span port to view their traffic on, for IDS / monitoring.</p>
<p>What you'll need:</p>
<ul>
<li>A free interface on the pfSense device to dedicate as a SPAN port, for mirroring traffic from all other ports connected to the bridge</li>
</ul>
<p><strong>Step 1: Create the SPAN port interface</strong></p>
<ul>
<li><code>Interfaces &gt; Assignments</code> Select the next free interface you have available, or bring down and repurpose an existing interface to be used as a SPAN port</li>
<li>Enable interface</li>
<li>Description: we'll use <code>SPAN0</code>, however you can name this whatever you like, as with any other interface.</li>
<li>IPv4 Configuration Type: Static IPv4</li>
<li>IPv6 Configuration Type: None</li>
<li><code>Static IPv4 Configuration &gt; IPv4 Address</code>: Any <a href="">RFC1918</a> address will work, for this example we'll use <code>10.8.4.1</code>, set the cidr range to <code>/32</code></li>
<li>Block Bogon Networks</li>
<li>Save</li>
</ul>
<p><img alt="pfsense-span-interface" src="../../../../media/pfsense/pfsense-span-interface.png" /></p>
<p><strong>NOTE</strong>: this is best handled on a switch, not the router (pfSense in this case) itself. However for a small office / home office / lab use case, this is fine, and also what this guide will follow.</p>
<p><strong>Step 2: Create the BRIDGE interface</strong></p>
<p>You do not need a free interface before doing this, the BRIDGEx interface is a purely virtual interface meant to logically tie together any interfaces you specify as members of this bridge.</p>
<ul>
<li><code>Interfaces &gt; Assignments &gt; Bridges &gt; +Add</code></li>
<li><code>Member Interfaces</code>: Ctrl+click to select all interfaces to monitor, their traffic is to be mirrored on the SPAN port via this BRIDGEx adapter.</li>
</ul>
<p>Selecting the interfaces:</p>
<p><img alt="pfsense-bridge0-interface-002" src="../../../../media/pfsense/pfsense-bridge0-interface-002.png" /></p>
<p><strong>NOTE</strong>: on VMware Workstation for Linux, this operation may stall here, or for example if you run tcpdump, or bring up a bridged or promiscuous interface. Switch over to your pfSense VM tab and see if there is a prompt regarding enabling promiscuous mode on the virtual network interfaces you selected. Select OK to acknowledge the prompt - this is normal and will not prevent pfSense from monitoring these virtual interfaces.</p>
<ul>
<li>Select <code>Advanced Options</code></li>
<li><code>Span Port</code>: select the <code>SPAN0</code> interface we created above.</li>
<li><code>Save</code></li>
</ul>
<p>Here's what BRDIGE0 should look like under <code>Interfaces &gt; Bridges</code>:</p>
<p><img alt="pfsense-bridge0-interface-001" src="../../../../media/pfsense/pfsense-bridge0-interface-001.png" /></p>
<p>Next:</p>
<ul>
<li><code>Interfaces &gt; Assignments</code> choose to <code>+Add</code> the newest <code>BRIDGEx</code> interface, likely BRIDGE0</li>
<li>Save</li>
<li>Click the <code>OPTx</code> interface link for the newly created BRIDGEx</li>
<li>Enable interface</li>
<li>IPv4 Configuration Type: Static IPv4</li>
<li>IPv6 Configuration Type: None</li>
<li><code>Static IPv4 Configuration &gt; IPv4 Address</code>: Any <a href="">RFC1918</a> address will work, for this example we'll use <code>10.9.9.1</code>, set the cidr range to <code>/32</code></li>
<li>Block Bogon Networks</li>
<li>Save</li>
</ul>
<p><strong>Step 3: Confirm the interfaces are up &amp;&amp; monitoring</strong></p>
<ul>
<li>
<p>You do not need to configure DHCP server settings, each interface is a single host (/32) static IPv4 address.</p>
</li>
<li>
<p>You do not need to configure any real firewall rules for the BRIDGEx or SPANx interfaces to monitor traffic. They both can have the single rule of "Block bogon networks" (which is also optional).</p>
</li>
</ul>
<p>If you're curious how you can manage firewall / traffic filtering when using a bridge interface, see the pfSense documentation page here:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/bridges/firewall.html">https://docs.netgate.com/pfsense/en/latest/bridges/firewall.html</a></p>
<p>Essentially the default setting in pfSense is to honor the rules already configured for the individual interfaces being monitored, and ignore rules on the bridge interface. In other words, the bridge is simply passive by default in that it is only monitoring traffic and not doing additional filtering.</p>
<p>Under <code>System &gt; Advanced &gt; System Tunables</code> review the following values (<code>1=enabled</code>, <code>0=disabled</code>) this example shows the defaults described above:</p>
<div class="highlight"><pre><span></span><code>net.link.bridge.pfil_member     Packet filter on the member interface   1
net.link.bridge.pfil_bridge     Packet filter on the bridge interface   0
</code></pre></div>
<p>Bridge interface firewall rules:</p>
<p><img alt="pfsense-fw-rules-bridge0" src="../../../../media/pfsense/pfsense-fw-rules-bridge0.png" /></p>
<p>SPAN interface firewall rules:</p>
<p><img alt="pfsense-fw-rules-span0" src="../../../../media/pfsense/pfsense-fw-rules-span0.png" /></p>
<p>The next steps will be easier to 'see' if you spin up a Live OS to connect to one of the LAN segments and generate some traffic. A Live OS is suggested due to the low resource and configuration requirements while you're testing and configuring Zeek.</p>
<p>When you're ready, back on pfSense follow either the SSH or GUI instructions:</p>
<ul>
<li>[GUI]: Go to <code>Diagnostics &gt; Command Prompt</code></li>
<li>[SSH]: SSH into the firewall, and ensure the management user can run commands with sudo</li>
<li>Run <code>ifconfig</code> to identify the <code>emX</code> device with the description of <code>SPAN0</code> (or what you named it).</li>
</ul>
<p><img alt="pfsense-span-port-001" src="../../../../media/pfsense/pfsense-span-port-001.png" /></p>
<ul>
<li>[GUI]: Go to <code>Diagnostics &gt; Packet Capture</code>, select <code>SPANx</code> for the <code>Interface</code>, <code>Port</code> of <code>53</code> and then click <code>Start</code></li>
<li>[GUI]: After a minute or two passes, or you've manually generated some traffic (<code>dig @1.1.1.1 ubuntu.com</code> or <code>nslookup microsoft.com 9.9.9.9</code>) <code>Stop</code> the packet capture.</li>
<li>[SSH]: Alternatively Run <code>sudo tcpdump -i emX -n -vv port 53</code> where emX is your SPAN port interface (ie; em5, yours could be different) and port 53 is easy to visually parse since it's only looking at DNS request.</li>
</ul>
<p><strong>TO DO</strong>: See what changes are required to run <code>tcpdump</code> with -Z <user> to drop privileges.</p>
<p><img alt="pfsense-span-port-001" src="../../../../media/pfsense/pfsense-span-port-002.png" /></p>
<ul>
<li>If you have devices on the network you should see traffic, and it should be under their assinged IP address on the network, which is exactly what we want.</li>
<li><strong>NOTE</strong>: This will capture traffic that does not pass (is dropped / rejected), for example if you have a subnet dedicated to malware analysis. This will capture or 'see' all of the DNS requests being made by all of the hosts on that subnet, even though no traffic is routed out of that network - if the packet hits the firewall, it can see it.</li>
<li>You can verify this by watching the requests being monitored by the <code>SPAN0</code> port using the <code>tcpdump</code> command above</li>
<li>In another SSH session window on the pfSense box, running <code>sudo tail -f /var/log/resolver.log</code> to see what DNS queries the firewall is actually resolving (this assumes you have set pfSense's DNS resolver to ignore external DNS servers, and only use it's own internal configuration to resolve queries as detailed above in this guide - as a reminder that forwards the queries over TLS upstream to cloudflare and quad9).</li>
</ul>
<p><strong>Step 4: Configure Zeek to monitor the SPAN port</strong></p>
<ul>
<li><code>System &gt; Package Manager &gt; Available Packages</code> install <code>zeek</code></li>
<li>Go to <code>Services &gt; Zeek NSM &gt; General</code></li>
<li>Enable Zeek NSM</li>
<li>Hostname: <code>10.7.8.1</code>this is the IP address of the SPAN interface we assigned in the example above this section, yours may be different if you chose a different IP address and range.</li>
<li>Zeek Interface(s): <code>SPAN0</code></li>
<li>Local Network Configuration: The following private address ranges will be fine in most cases:
<div class="highlight"><pre><span></span><code>10.0.0.0/8
172.16.0.0/12
192.168.0.0/16
fc00::/7
fe80::/64
</code></pre></div></li>
</ul>
<p><strong>Step 5: [Optional] Configure Zeek as a cluster</strong></p>
<ul>
<li>Go to <code>Services &gt; Zeek NSM &gt; Zeek Cluster</code></li>
<li>Check <code>Enabled Zeek Cluster</code></li>
<li>Manager, Proxy, Worker 1, and Worker 2 Hosts should be set to <code>127.0.0.1</code></li>
<li>Set Worker 1 and Worker 2 Interfaces to <code>loopback</code></li>
</ul>
<p>If you run <code>zeekctl status</code> from the CLI or Command Prompt (GUI) and it still returns that Zeek is running as type <code>standalone</code> you may need to either reboot pfSense, or manually edit <code>/usr/local/etc/node.cfg</code></p>
<p>Further configuration file examples for Zeek can be found here:</p>
<p><a href="https://github.com/activecm/docker-zeek/tree/master/etc">https://github.com/activecm/docker-zeek/tree/master/etc</a></p>
<p>Next, you'll want to install the <a href="https://github.com/activecm/zeek-open-connections/">zeek-open-connections</a> zkg package if you plan to analyze this data with <a href="https://github.com/activecm/rita#obtaining-data-generating-zeek-logs">RITA</a></p>
<p>All of the typical Zeek commands work from the SSH / Console CLI (The prompts will not work from the WebGUI), for example:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zeekctl<span class="w"> </span>status
sudo<span class="w"> </span>zkg<span class="w"> </span>refresh
sudo<span class="w"> </span>zkg<span class="w"> </span>install<span class="w"> </span>zeek/activecm/zeek-open-connections
sudo<span class="w"> </span>zkg<span class="w"> </span>list
</code></pre></div>
<p>Running those will install the zkg package successfully.</p>
<p><strong>IMPORTANT</strong>: It's recommened to reboot pfSense here for Zeek to fully restart with the latest configuration changes.</p>
<p>One great feature of Zeek on pfSense is the real time inspection of all your bridged interfaces via the WebGUI.</p>
<p>Go to <code>Services &gt; Zeek NSM &gt; Real Time Inspection</code> and select a Log file to view, and the Max lines to show at one time. With this you can view all data being captured live, for a quick visual inspection.</p>
<p><img alt="pfsense-zeek-real-time-inspection" src="../../../../media/pfsense/pfsense-zeek-real-time-inspection.png" /></p>
<p>See <a href="#package-zeek-network-security-monitor-nsm">Zeek Network Security Monitor (NSM)</a> below for more details.</p>
<hr />
<h4 id="using-a-managed-switch">Using a managed switch</h4>
<p>Cisco's explaination of unmanaged, smart, and managed switches is a good starting reference:</p>
<p><a href="https://www.cisco.com/c/en/us/solutions/small-business/resource-center/networking/understanding-the-different-types-of-network-switches.html#~feature-options">https://www.cisco.com/c/en/us/solutions/small-business/resource-center/networking/understanding-the-different-types-of-network-switches.html#~feature-options</a></p>
<p><strong>Types</strong>:</p>
<ul>
<li>Unmanaged: plug and play, no configuration possible</li>
<li>Smart: some advanced features, meant for edge of network (conference rooms, printing, labs)</li>
<li>Managed: fully configurable, deployed at the core of the network for traffic shaping, QOS, IDS, etc.</li>
</ul>
<p><strong>Options</strong>:</p>
<ul>
<li>Speeds 10|100|1000 mbps</li>
<li>Ports 4|8|16|32|etc</li>
<li>PoE: powers devices from the switch if they use PoE</li>
<li>Stackable vs Standalone: standalone are static devices, stackable switches allow stacking multiple of the same unit, seemlessly with current configuration - supports failover if one unit fails, and routes traffic around it.</li>
</ul>
<h2 id="logs">Logs</h2>
<p><code>Status &gt; System Logs &gt; Settings</code></p>
<p><strong>Log Message Format</strong>: <code>syslog</code></p>
<ul>
<li>[x] Forward / Reverse Display</li>
</ul>
<p>Log Rotation Size (bytes):</p>
<div class="highlight"><pre><span></span><code>    Default: 512000 (500 KiB)
</code></pre></div>
<p>Recommended: 4000000 (4MB) This value may change depending on <code>Log Retention Count</code> and log storage policy</p>
<p><strong>Number of Logs</strong>:</p>
<div class="highlight"><pre><span></span><code>    Default: 7
</code></pre></div>
<p>Recommended: Whatever works for your system. Keeping more logs that are all a small size is reasonable to still view in the Web GUI if you have space. Forwarding logs means you won't take up space on the pfSense machine.</p>
<p>Useful log files:</p>
<table>
<thead>
<tr>
<th>Log File</th>
<th>Path</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logins</td>
<td><code>/var/log/auth.log</code></td>
</tr>
<tr>
<td>Dns Logs</td>
<td><code>/var/log/resolver.log</code></td>
</tr>
<tr>
<td>Firewall Logs</td>
<td><code>/var/log/filter.log</code></td>
</tr>
</tbody>
</table>
<h3 id="logging-network-traffic">Logging Network Traffic</h3>
<p>How to log and maintain network data using pfSense.</p>
<p>This section would not exist without these resources:</p>
<ul>
<li>https://github.com/0ptsec/optsecdemo</li>
<li>https://www.activecountermeasures.com/raspberry-pi-network-sensor-webinar-qa/</li>
<li>https://github.com/william-stearns (wstearns-ACM) in the Threat Hunter Community Discord</li>
<li>https://unix.stackexchange.com/questions/194863/delete-files-older-than-x-days (user basic6's answer)</li>
</ul>
<p>This is meant to run on any box with <code>tcpdump</code> available, and pairs well with the <a href="#external-storage">external storage</a> section below:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pw<span class="w"> </span>groupadd<span class="w"> </span>logsync
sudo<span class="w"> </span>mkdir<span class="w"> </span>/mnt/external/pcaps
sudo<span class="w"> </span>chown<span class="w"> </span>nobody:logsync<span class="w"> </span>/mnt/external/pcaps
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">750</span><span class="w"> </span>/mnt/external/pcaps
sudo<span class="w"> </span>pw<span class="w"> </span>groupmod<span class="w"> </span>logsync<span class="w"> </span>-m<span class="w"> </span><span class="nv">$YOUR_USER</span>
</code></pre></div>
<p>Where <code>$YOUR_USER</code> is the account on pfSense you'll be connecting to over ssh to bring logs back to a central logging system.</p>
<p>What this does is sets <code>pcaps/</code> to be owned by the user <code>nobody</code> and the group <code>logsync</code>, so when <code>tcpdump</code> drops privileges, the nobody user can write to that folder. The 5 in 750 allows any user that's part of the group <code>logsync</code> to view but not write to the folder. This is an easy way to limit permissions while scripting the collection of logs safely over ssh. The 0 in 750 prevents any other user context on the system from examining or modifying the pcaps.</p>
<p>If you don't have an external storage device, be aware of your firewall's disk space and be sure to limit the pcap file rotation frequency via cron (below).</p>
<p><code>tcsh</code> does not understand command substitution, just use <code>pfSense.%Y%m%d%H%M%S</code>...
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/usr/sbin/tcpdump<span class="w"> </span>-i<span class="w"> </span>ethX<span class="w"> </span>-Z<span class="w"> </span>nobody<span class="w"> </span>-G<span class="w"> </span><span class="m">3600</span><span class="w"> </span>-w<span class="w"> </span>/mnt/external/pcaps/pfSense.%Y%m%d%H%M%S.pcap
</code></pre></div></p>
<p>In all cases, replace <code>ethX</code> with the name of the interface you want to capture on. Ideally you would have a <a href="#bridging-multiple-interfaces-for-port-mirroring-span-port-for-traffic-monitoring">SPAN port that's mirroring traffic from all interfaces</a>, and capture on that.</p>
<p>pfSense running tcpdump unprivileged:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/usr/sbin/tcpdump<span class="w"> </span>-i<span class="w"> </span>ethX<span class="w"> </span>-Z<span class="w"> </span>nobody<span class="w"> </span>-G<span class="w"> </span><span class="m">3600</span><span class="w"> </span>-w<span class="w"> </span>/tmp/pfSense.%Y%m%d%H%M%S.pcap<span class="w"> </span><span class="s1">&#39;((tcp[13] &amp; 0x17 != 0x10) or not tcp)&#39;</span><span class="w"> </span><span class="p">&amp;</span>
</code></pre></div></p>
<p>pfSense running tcpdump as root:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/usr/sbin/tcpdump<span class="w"> </span>-i<span class="w"> </span>ethX<span class="w"> </span>-G<span class="w"> </span><span class="m">3600</span><span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>sudo<span class="w"> </span>mktemp<span class="w"> </span>-d<span class="k">)</span><span class="s2">/pfSense.%Y%m%d%H%M%S.pcap &#39;((tcp[13] &amp; 0x17 != 0x10) or not tcp)&#39; &amp;</span>
</code></pre></div></p>
<p>The easiest way to run these commands is by appending an <code>&amp;</code> to send them into the background. From here you can easily monitor them with <code>ps aux</code>.</p>
<p>If you want to stop the capture running this way, obtain the pid of the root owned process running tcpdump you find with <code>ps aux</code>, then run <code>kill &lt;pid&gt;</code>.</p>
<p>To rotate your pcap files based on a range of days, create the following task under <code>/etc/cron.d/pcap-rotation-service</code>:
<div class="highlight"><pre><span></span><code># Cron task to rotate pcaps
# Rotates pcap files under $PCAP_PATH based on the range of time in $DAYS
# For example, +60 means the last 60 days of pcaps are maintained

* 0  * * * root /usr/bin/find $PCAP_PATH -type f -mtime +$DAYS -delete
</code></pre></div></p>
<p>Replacing <code>$PCAP_PATH</code> with where you're storing your pcap files, and <code>$DAYS</code> with how many days of network traffic you want to maintain. This means you will always have pcaps available of the most recent 60 days.</p>
<h3 id="collecting-logs">Collecting Logs</h3>
<ul>
<li><a href="https://github.com/activecm/zeek-log-transport/blob/master/zeek_log_transport.sh">https://github.com/activecm/zeek-log-transport/blob/master/zeek_log_transport.sh</a></li>
<li><a href="https://github.com/opsdisk/the_cyber_plumbers_handbook">https://github.com/opsdisk/the_cyber_plumbers_handbook</a></li>
</ul>
<p>To collect logs over ssh, you could use <code>cron</code> + <code>rsync</code> to automatically pull them into a central logging system.</p>
<p>Modifying the ssh example from the rsync manual, here's what collecting logs from a pfSense system could look like:
<div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>-arv<span class="w"> </span>--safe-links<span class="w"> </span>--delete<span class="w"> </span>-e<span class="w"> </span>ssh<span class="w"> </span>pfsense@172.31.199.101:<span class="s2">&quot;/mnt/external/pcaps/&quot;</span><span class="w"> </span>/home/ubuntu/Logs/pcaps/
</code></pre></div></p>
<p>This "archives" (preserves unix file characteristics) recursively and verbosely (<code>-arv</code>), the remote files, ignoring dangerous symlinks if files happen to have been tampered with (<code>--safe-links</code>), deleting any extraneous files locally that aren't present remotely (<code>--delete</code>), over ssh (<code>-e ssh</code>), from the remote path of <code>/mnt/external/pcaps</code> to the local path of <code>/home/ubuntu/Logs/pcaps</code>.</p>
<p>If you need to use something like a jump proxy, the same command from above would look like this:
<div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>-arv<span class="w"> </span>--safe-links<span class="w"> </span>--delete<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;ssh -J &lt;user&gt;@&lt;jump-hostname&gt;:&lt;port&gt;&quot;</span><span class="w"> </span>pfsense@172.31.199.101:<span class="s2">&quot;/mnt/external/pcaps/&quot;</span><span class="w"> </span>/home/ubuntu/Logs/pcaps/
</code></pre></div></p>
<p>You'll want to review the rsync manual's <code>--rsh=COMMAND, -e</code> section for correctly encasing quotes and character escaping.</p>
<h3 id="upgrade-log">Upgrade Log</h3>
<p><a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#upgrade-log">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html#upgrade-log</a></p>
<p>A log of all latest upgrade attempts is kept at: <code>/conf/upgrade_log.latest.txt</code></p>
<h2 id="cli">CLI</h2>
<p>The FreeBSD Handbook will answer many of your questions in getting started here.</p>
<p><a href="https://docs.freebsd.org/en/books/handbook/basics/">https://docs.freebsd.org/en/books/handbook/basics/</a></p>
<p>See the Netgate docs on troubleshooting &gt; lockout for various CLI examples</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/config/console-menu.html">https://docs.netgate.com/pfsense/en/latest/config/console-menu.html</a></p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html</a></p>
<p>By default pfSense has no <code>man</code> command to view manuals like Linux or macOS typically has.</p>
<p>Running a command either with <code>--help</code>, <code>-h</code>, or without arguments will likely print basic usage details</p>
<h3 id="cli-firewall">CLI: Firewall</h3>
<p><a href="https://docs.netgate.com/pfsense/en/latest/firewall/pf-ruleset.html">https://docs.netgate.com/pfsense/en/latest/firewall/pf-ruleset.html</a></p>
<p><a href="https://docs.freebsd.org/en/books/handbook/firewalls/#firewalls-pf">https://docs.freebsd.org/en/books/handbook/firewalls/#firewalls-pf</a></p>
<h3 id="cli-system-services">CLI: System Services</h3>
<p><a href="https://docs.freebsd.org/en/books/handbook/config/">https://docs.freebsd.org/en/books/handbook/config/</a></p>
<p>Service scripts are handled by rc.d:</p>
<p><code>/etc/rc.d/*</code>
<code>/usr/local/etc/rc.d/*</code></p>
<p>Check if a service is running:</p>
<div class="highlight"><pre><span></span><code>service<span class="w"> </span>&lt;service&gt;<span class="w"> </span>status<span class="p">|</span>onestatus
service<span class="w"> </span>sshd<span class="w"> </span>onestatus
</code></pre></div>
<p>Restart a service:
<div class="highlight"><pre><span></span><code>service sshd restart
</code></pre></div></p>
<p>Some services cannot be managed this way. You will need to either manage these from the WebGUI or by using common BSD commands.</p>
<p>Unbound is an example of this. Sometimes the daemon is running but isn't resolving domains, or writing to the log file correctly.</p>
<p>To restart unbound:</p>
<div class="highlight"><pre><span></span><code># You can see the commandline invocation that the system uses to start unbound with:
ps aux | grep &quot;^unbound&quot;

# Obtain the pid:
ps aux | grep &quot;^unbound&quot; | cut -d &#39; &#39; -f 2

# Stop unbound
sudo kill &lt;pid&gt;

# Start unbound
sudo /usr/local/sbin/unbound -c /var/unbound/unbound.conf
</code></pre></div>
<h2 id="packages">Packages</h2>
<p><a href="https://docs.freebsd.org/en/books/handbook/ports/">https://docs.freebsd.org/en/books/handbook/ports/</a></p>
<p>Fix a broken pkg db:</p>
<p><a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/pkg-broken-database.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/pkg-broken-database.html</a></p>
<p><strong>TIP</strong>: pfSense has <code>git</code> available as a package. <code>sudo pkg install -y git-\*</code></p>
<h3 id="pkg-binaries-and-pfsense-webgui-availability">pkg Binaries and pfSense WebGUI Availability</h3>
<p>pfSense has two binaries for package management, <code>pkg</code> and <code>pkg-static</code>.</p>
<div class="highlight"><pre><span></span><code>/usr/sbin/pkg
/usr/local/sbin/pkg-static
</code></pre></div>
<p>The official documentation recommends using <code>pkg-static</code> to [re]install packages.</p>
<p>It's not clear what the difference is between the two, both appear to work similarly for basic package management functions.</p>
<p><strong>In any case you will need to install the corresponding pfSense package if one exists for a package you want to install</strong>, for example:</p>
<div class="highlight"><pre><span></span><code>user@pfSense: pkg search nmap
nmap-7.91_3         Port scanning utility for large networks
pfSense-pkg-nmap-1.4.4_5    pfSense package nmap
</code></pre></div>
<p>If you install <code>nmap-7.91_3</code> by itself, you can still use <code>nmap</code> from the commandline, however <code>Diagnostics &gt; Nmap</code> will not be available in the WebGUI without also installing <code>pfSense-pkg-nmap-1.4.4_5</code></p>
<p>As version numbers can change, you may simply use <code>&lt;package-name&gt;</code> and <code>pfSense-pkg-&lt;package-name&gt;</code> to install both at once, like this:</p>
<div class="highlight"><pre><span></span><code>sudo pkg install -y nmap pfSense-pkg-nmap
</code></pre></div>
<p>Print a list of all currently installed packages:</p>
<div class="highlight"><pre><span></span><code>pkg<span class="w"> </span>info
</code></pre></div>
<p>Update the package repository metadata:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>update<span class="w"> </span>-f
</code></pre></div>
<p>Upgrade currently installed packages with available updates:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>upgrade
</code></pre></div>
<p>Remove packages installed as dependencies that are no longer needed (leaf packages):</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>autoremove
</code></pre></div>
<p>Clean the pkg cache:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>clean
<span class="c1"># or all:</span>
sudo<span class="w"> </span>pkg<span class="w"> </span>clean<span class="w"> </span>-a
</code></pre></div>
<p>Get detailed information on a particular package:</p>
<div class="highlight"><pre><span></span><code>pkg<span class="w"> </span>info<span class="w"> </span>openvpn
</code></pre></div>
<p>Search the binary package repository for an application</p>
<div class="highlight"><pre><span></span><code>pkg<span class="w"> </span>search<span class="w"> </span>openvpn
</code></pre></div>
<p>Install package(s):</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>sudo<span class="w"> </span>zeek<span class="w"> </span>pfSense-pkg-sudo<span class="w"> </span>pfSense-pkg-zeek
</code></pre></div>
<p>Uninstall an installed package:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>delete<span class="w"> </span>curl
<span class="c1"># or</span>
sudo<span class="w"> </span>pkg<span class="w"> </span>remove<span class="w"> </span>curl

<span class="c1"># escape wildcards with &#39;*&#39;</span>
sudo<span class="w"> </span>pkg<span class="w"> </span>delete<span class="w"> </span>pstree-<span class="se">\*</span>
</code></pre></div>
<p>Audit currently installed packages for known vulnerabilities:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>audit<span class="w"> </span>-F
Fetching<span class="w"> </span>vuln.xml.xz:<span class="w"> </span><span class="m">100</span>%<span class="w">  </span><span class="m">941</span><span class="w"> </span>KiB<span class="w"> </span><span class="m">963</span>.5kB/s<span class="w">    </span><span class="m">00</span>:01
openvpn-2.5.4_1<span class="w"> </span>is<span class="w"> </span>vulnerable:
<span class="w">  </span>openvpn<span class="w"> </span>--<span class="w"> </span>Potential<span class="w"> </span>authentication<span class="w"> </span>by-pass<span class="w"> </span>with<span class="w"> </span>multiple<span class="w"> </span>deferred<span class="w"> </span>authentication<span class="w"> </span>plug-ins
<span class="w">  </span>CVE:<span class="w"> </span>CVE-2022-0547
<span class="w">  </span>WWW:<span class="w"> </span>https://vuxml.FreeBSD.org/freebsd/45a72180-a640-11ec-a08b-85298243e224.html

dnsmasq-2.86,1<span class="w"> </span>is<span class="w"> </span>vulnerable:
<span class="w">  </span>dnsmasq<span class="w"> </span>--<span class="w"> </span>heap<span class="w"> </span>use-after-free<span class="w"> </span><span class="k">in</span><span class="w"> </span>dhcp6_no_relay
<span class="w">  </span>CVE:<span class="w"> </span>CVE-2022-0934
<span class="w">  </span>WWW:<span class="w"> </span>https://vuxml.FreeBSD.org/freebsd/3f321a5a-b33b-11ec-80c2-1bb2c6a00592.html

strongswan-5.9.4<span class="w"> </span>is<span class="w"> </span>vulnerable:
<span class="w">  </span>strongswan<span class="w"> </span>-<span class="w"> </span>Incorrect<span class="w"> </span>Handling<span class="w"> </span>of<span class="w"> </span>Early<span class="w"> </span>EAP-Success<span class="w"> </span>Messages
<span class="w">  </span>CVE:<span class="w"> </span>CVE-2021-45079
<span class="w">  </span>WWW:<span class="w"> </span>https://vuxml.FreeBSD.org/freebsd/ccaea96b-7dcd-11ec-93df-00224d821998.html

cyrus-sasl-2.1.27_2<span class="w"> </span>is<span class="w"> </span>vulnerable:
<span class="w">  </span>cyrus-sasl<span class="w"> </span>--<span class="w"> </span>Fix<span class="w"> </span>off<span class="w"> </span>by<span class="w"> </span>one<span class="w"> </span>error
<span class="w">  </span>CVE:<span class="w"> </span>CVE-2019-19906
<span class="w">  </span>WWW:<span class="w"> </span>https://vuxml.FreeBSD.org/freebsd/a80c6273-988c-11ec-83ac-080027415d17.html

<span class="m">4</span><span class="w"> </span>problem<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>installed<span class="w"> </span>package<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>found.
</code></pre></div>
<h3 id="package-zeek-network-security-monitor-nsm">Package: Zeek Network Security Monitor (NSM)</h3>
<p>Install Zeek from the packages list <code>System &gt; Package Manager &gt; Available Packages</code>, search for <code>zeek</code></p>
<p>Or with pkg:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>zeek<span class="w"> </span>pfSense-pkg-zeek
</code></pre></div>
<p>Zeek filesystem locations:</p>
<div class="highlight"><pre><span></span><code>/usr/local/etc/node.cfg
/usr/local/etc/networks.cfg
/usr/local/etc/zeekctl.cfg
/usr/local/bin/zeek*
/usr/local/share/zeek/*
/usr/local/share/zeek/site/local.zeek
/usr/local/share/zeek/site/local.zeek.sample
/usr/local/logs/*
/usr/local/logs/yyyy-mm-dd/
/usr/local/logs/current -&gt; /usr/local/spool/zeek
/usr/local/logs/stats
</code></pre></div>
<p>Zeek should have an entry automatically added under <code>/etc/crontab</code> to restart it if it is not running:</p>
<div class="highlight"><pre><span></span><code>*/5<span class="w"> </span>*<span class="w">   </span>*<span class="w">   </span>*<span class="w">   </span>*<span class="w">   </span>root<span class="w">    </span>/usr/local/bin/zeekctl<span class="w"> </span>cron
</code></pre></div>
<p>Review the local zeek log files from SSH:</p>
<div class="highlight"><pre><span></span><code>zgrep<span class="w"> </span><span class="s1">&#39;gitlab.com&#39;</span><span class="w"> </span>/usr/local/logs/yyyy-mm-dd/dns.*.log.gz
</code></pre></div>
<p><strong>TO DO</strong>: provide an example cron task that tar archive's zeek logs and prepares them to be retreived + deleted from the pfSense system over SSH for external storage + analysis with RITA.</p>
<h3 id="zeek-configuration">Zeek Configuration</h3>
<p>Zeek has a few easy to navigate configuration pages under <code>Services &gt; Zeek NSM</code></p>
<ul>
<li>
<p><strong>Standalone configuration</strong> is an option, however only one interface can be monitored at a time. <strong>NOTE</strong>: This works great for monitoring a SPAN / Mirror port directly on the local pfSense device.</p>
</li>
<li>
<p>Hostname: <code>127.0.0.1</code>, this can alternatively be the IP address of the <code>SPAN0</code> interface if you've configured one for port mirroring.</p>
</li>
<li>
<p>Zeek Interfaces: <code>interface</code>, this can be the <code>SPAN0</code> interface.</p>
</li>
<li>
<p>Local Network Configuration: local subnets to monitor, usually private address ranges such as these:
<div class="highlight"><pre><span></span><code>10.0.0.0/8
172.16.0.0/12
192.168.0.0/16
fe80::/64
fc00::/7
</code></pre></div></p>
</li>
</ul>
<p>Alternatively, configuring Zeek as a <code>Cluster</code> is recommened even on a single box.</p>
<p>This is essentially the same as standalone in this instance, except it allows Zeek to listen on up to two interfaces, and potentially connect with with other nodes should you expand later on.</p>
<p>Below is an example listening on two internal interfaces:</p>
<div class="highlight"><pre><span></span><code>Manager: `127.0.0.1`
Proxy: `127.0.0.1`
Worker 1 Host: `127.0.0.1`    # workers use localhost when manager does, else you&#39;ll see errors in the system log trying to use the interface address
Worker 1 Interface: `OPT1`
Worker 2 Host: `127.0.0.1`    # workers use localhost when manager does, else you&#39;ll see errors in the system log trying to use the interface address
Worker 2 Interface: `OPT2`
</code></pre></div>
<p>Confirm your configurations over SSH or with <code>Diagnositcs &gt; Command Prompt</code>:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/usr/local/etc/node.cfg
</code></pre></div>
<p>Seeing this configuration file's comments will likely help you visualize the configuration of standalone vs cluster better.</p>
<p><strong>NOTE</strong>: In a cluster configuration, Zeek can only monitor up to 2 network interfaces. It's recommended you create a BRIDGE and SPAN interface for port mirroring if you need to monitor more than 1 interface.</p>
<p>Use <code>Services &gt; Zeek NSM &gt; Realtime Inspection</code> to monitor data live</p>
<p>As of pfSense 2.5.2, check to ensure <code>/usr/local/share/zeek/site/local.zeek</code> exists.</p>
<p>If not, create it from the default example file in the same directory:</p>
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>/usr/local/share/zeek/site/local.zeek.sample<span class="w"> </span>/usr/local/share/zeek/site/local.zeek
</code></pre></div>
<p><strong>Running Zeek Unprivileged</strong></p>
<p><strong>TO DO</strong>: Provide an example of how to do this.</p>
<p>Excerpt from the installer:</p>
<blockquote>
<div class="highlight"><pre><span></span><code>The rc.d script now honors the zeek_user rc.d variable.  To run as
a user other than root (the default) you need to make a few changes.
For example to run as the user zeek, add this to /etc/rc.conf:

    zeek_enable=&quot;YES&quot;
    zeek_user=&quot;zeek&quot;

Add this to /etc/devfs.conf:

    own     bpf     root:bpf
    perm    bpf     0660

And add zeek to the bpf group:

    bpf:*:81:zeek

and restart the devfs service:

    service devfs restart

or reboot.

If the interface defined in node.cfg is configured for NIC checksum
offloading (the default when this feature is supported by the
hardware) you will want to set ignore_checksums in site/local.zeek:

    redef ignore_checksums = T;
</code></pre></div>
</blockquote>
<h2 id="external-storage">External Storage</h2>
<p>While pfSense should mainly be used as a firewall, and is not meant for long term storage or as a central logging server, it's ability to do a number of network forensics and debugging means at some point you may need to temporarily add external storage to the device. This is a good idea instead of letting a packet capture run overnight, only to later discover the partition (or worse the entire filesystem) has been flooded and no new data can be written, effectively halting the operation of your firewall.</p>
<p>The easiest way to walk through and familiarize yourself with these steps is in a VM. Pass through an external USB device to get started.</p>
<p>The FreeBSD documentation on both <a href="https://docs.freebsd.org/en/books/handbook/disks/#usb-disks">USB disks</a> and <a href="https://docs.freebsd.org/en/books/handbook/disks/#disks-adding">Adding Disks</a> will help guide you through this process.</p>
<p>The first thing you'll see from a terminal when connecting the external device, in this example we'll use a 64GB USB drive, is the device's entry in <code>dmesg</code>. Use <code>dmesg | grep '&lt;device&gt;'</code> to review this information later (where <code>&lt;device&gt;</code> for example could be <code>da1</code>).</p>
<p>We'll also use <code>da1</code> as the device name for the rest of these examples.</p>
<p>Confirm the device's name under <code>/dev/</code> with <code>ls -l /dev/da1*</code></p>
<p>From here follow the steps in the FreeBSD manual to create a new UFS (this will work fine even if pfSense is running on a ZFS):</p>
<ul>
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html#EXAMPLES">https://www.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html#EXAMPLES</a></li>
<li><a href="https://docs.freebsd.org/en/books/handbook/disks/#usb-disks">https://docs.freebsd.org/en/books/handbook/disks/#usb-disks</a></li>
</ul>
<p>The following commands are mostly mirrored directly from those pages linked above:</p>
<div class="highlight"><pre><span></span><code>sudo gpart destroy -F da1
sudo gpart create -s GPT da1
sudo gpart add -t freebsd-ufs -a 1M da1
gpart show da1

sudo newfs -U /dev/da1p1

sudo vi /etc/fstab
</code></pre></div>
<p>Add the following to <code>/etc/fstab</code>, replacing "external" with whatever you'd like to name your device's mount point:
<div class="highlight"><pre><span></span><code>/dev/da1p1      /mnt/external   ufs rw  2   2
</code></pre></div></p>
<p>Finally, create the mount point and mount the device:
<div class="highlight"><pre><span></span><code>sudo mkdir /mnt/external
sudo mount /mnt/external
</code></pre></div></p>
<p>Your external storage is ready for use. Be sure to create a folder within this filesystem that is writable by the correct users (if you don't want to be running as root to write to it).</p>
<p>To undo all of these steps, erasing the external device to an empty state and removing the external filesystem from pfSense:</p>
<div class="highlight"><pre><span></span><code>sudo umount /mnt/external
sudo gpart destroy -F da1
sudo rm -rf /mnt/external

sudo vi /etc/fstab
<span class="c"># remove the entry with the external filesystem&#39;s mount point</span>
</code></pre></div>
<h3 id="zfs">ZFS</h3>
<p>The same can be done with <code>zfs</code>. First, be sure the device is completely empty and not mounted to the filesystem.</p>
<p>If it's currently mounted, <code>zpool</code> will raise an error. If it's not empty, this operation will make the data (likely) unrecoverable.</p>
<div class="highlight"><pre><span></span><code>sudo umount /mnt/external
sudo gpart destroy -F da1
</code></pre></div>
<p>The <a href="https://docs.freebsd.org/en/books/handbook/zfs/">zfs chapter in the FreeBSD handbook</a> goes into detail on how you can configure this type of filesystem.</p>
<p>This <a href="https://ubuntu.com/tutorials/setup-zfs-storage-pool#3-creating-a-zfs-pool">Ubuntu tutorial on setting up zfs storage</a> is also a good point of reference.</p>
<p>For our purposes, to quickly attach an external device (taken and adapted from the examples linked above):</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /mnt/external
sudo zpool create -m /mnt/external external /dev/da1
</code></pre></div>
<p>This will mount the device at <code>/external</code> and show it under <code>df -h</code> as well as <code>mount</code>.</p>
<p>When you're done, to erase the device and it's contents from the filesystem:</p>
<div class="highlight"><pre><span></span><code>sudo zpool destroy external
</code></pre></div>
<p>You may also notice even after erasing this device with <code>dd</code>, <code>gpart</code>, or <code>zpool</code>, the device still contains the <code>zfs_member</code> label.</p>
<p>There are two ways to do this. Using <code>zpool</code>, this stackexchange post demonstrates the command:</p>
<ul>
<li><a href="https://unix.stackexchange.com/questions/335377/zero-out-deprecated-zfs-label-from-disk-with-dd">https://unix.stackexchange.com/questions/335377/zero-out-deprecated-zfs-label-from-disk-with-dd</a></li>
</ul>
<div class="highlight"><pre><span></span><code>sudo zpool labelclear /dev/da1
</code></pre></div>
<p>Another way is to erase both the beginning and the end of the device with <code>dd</code>. This can be done using the <code>seek</code> option.</p>
<ul>
<li><a href="https://www.gnu.org/software/coreutils/manual/html_node/dd-invocation.html#dd-invocation">https://www.gnu.org/software/coreutils/manual/html_node/dd-invocation.html#dd-invocation</a></li>
</ul>
<p>A way to calculate the offset is by obtaining the device size in MB with <code>dmesg</code>:</p>
<div class="highlight"><pre><span></span><code>dmesg | grep <span class="s1">&#39;byte sectors&#39;</span>
</code></pre></div>
<p>You're looking for the line in dmesg starting with our device name, in this example it's <code>da1</code>.</p>
<p>Using the same example of a 64GB disk, we see <code>58656MB</code> as the total size. We want to aim for the last few MB, so we'll use <code>58650</code> in our command.</p>
<p>These two <code>dd</code> commands will successfully remove the zfs label:</p>
<div class="highlight"><pre><span></span><code>sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/dev/da1 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">status</span><span class="o">=</span>progress <span class="nv">count</span><span class="o">=</span>10
sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/dev/da1 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">status</span><span class="o">=</span>progress <span class="nv">seek</span><span class="o">=</span>58650
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting:</h2>
<p><strong>TO DO</strong></p>
<p>Install Issues: <a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/installation.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/installation.html</a></p>
<p>Upgrade Issues: <a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/upgrades.html</a></p>
<p>Broken PKG DB: <a href="https://docs.netgate.com/pfsense/en/latest/troubleshooting/pkg-broken-database.html">https://docs.netgate.com/pfsense/en/latest/troubleshooting/pkg-broken-database.html</a></p>
<h3 id="unable-to-obtain-ip-address-or-access-gui">Unable to Obtain IP Address or Access GUI</h3>
<p>I've only been able to replicate this when adding BRIDGE and SPAN interfaces for port mirroring, then making changes to the dashboard GUI layout.</p>
<p>Something causes the management interface DHCP server to stop leasing IP addresses.</p>
<p>Luckily IPv6 Link-Local scope is a direct connection without the need for IPv4 style DHCP.</p>
<ol>
<li>Obtain your connected interface's inet6 local address (fe80::x) with <code>ip a</code> or <code>ifconfig</code>.</li>
<li>Capture packets on your connected interface with <code>sudo tcpdump -i &lt;iface&gt; -n -vv</code> and look for both fe80::x addresses, the one opposite of yours is pfSense's address.</li>
</ol>
<p><strong>NOTE</strong>: I have not been able to get a browser to connect to an IPv6 address. You may have better luck; <code>http://[fe80::1111:2222:3333:4444]:443/</code></p>
<ol>
<li>Port forward with SSH into the interface so you can browse to the GUI: <code>ssh -L 8443:127.0.0.1:443 &lt;pfsense-user&gt;@fe80::aaaa:bbbb:cccc:1234%&lt;your-iface&gt;</code></li>
<li>Point your browser to <code>https://127.0.0.1:8443</code></li>
<li>Re-enable DHCP for the interface that lost it; <code>Services &gt; DHCP Server &gt; &lt;iface&gt;</code> check <code>Enable</code></li>
</ol>
<h3 id="management-stack-fails-to-load-after-reboot">Management Stack Fails to Load After Reboot</h3>
<div class="admonition note">
<p class="admonition-title">Observed Conditions</p>
<p>This has only been replicated on an SG-1100 under heavier network strain.</p>
</div>
<p>On occassion this has happened, if for example you're streaming Netflix or running high volume network scans (<code>nmap</code>) while needing to reboot pfSense. In cases like this, everything comes back online in 2-3 minutes, but you'll find you cannot reach the management interfaces over SSH or HTTPS, no matter how you're trying to reach them.</p>
<p>When this happens the simplest solution is to connect via the serial console, and reboot the machine one more time. Over time logs may be added here that could point to why this happens, but so far no consistent issue has been found.</p>
<div class="admonition tip">
<p class="admonition-title">Serial Connection</p>
<p>If you have your pfSense box installed in some sort of rack and have the space, leaving the serial cable connected and wrapped up behind the device while not in use may save you time if you ever need to reconnect again.</p>
</div>
<h3 id="pfsense-fails-reconnecting-to-tailnet">pfSense Fails Reconnecting to Tailnet</h3>
<p>Sometimes after a reboot Tailscale may not connect back to your tailnet. Simply restart the Tailscale service to fix this.</p>
<p>If you use Tailscale to manage pfSense remotely this can be an issue. Having an alternate remote access method such as SSH (even externally with limited ingress rules) or another jump box connected to your Tailnet on pfSense's management subnet, can save you.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2024 straysheep-dev
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/straysheep-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.path", "navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.path", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.tooltips"], "search": "../../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>