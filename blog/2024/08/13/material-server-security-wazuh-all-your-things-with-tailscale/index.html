
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://straysheep-dev.github.io/blog/2024/08/13/material-server-security-wazuh-all-your-things-with-tailscale/">
      
      
        <link rel="prev" href="../../../07/19/material-dns-bind9-dns/">
      
      
        <link rel="next" href="../simple-proxmox-proxmox/">
      
      
      <link rel="icon" href="../../../../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Wazuh all your things with Tailscale - straysheep.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Wazuh all your things with Tailscale - straysheep.dev" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://straysheep-dev.github.io/assets/images/social/blog/posts/wazuh-tailscale.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://straysheep-dev.github.io/blog/2024/08/13/material-server-security-wazuh-all-your-things-with-tailscale/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Wazuh all your things with Tailscale - straysheep.dev" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://straysheep-dev.github.io/assets/images/social/blog/posts/wazuh-tailscale.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#wazuh-all-your-things-with-tailscale" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="straysheep.dev" class="md-header__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            straysheep.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Wazuh all your things with Tailscale
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  Main

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../license/" class="md-tabs__link">
        
  
  
    
  
  License

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="straysheep.dev" class="md-nav__button md-logo" aria-label="straysheep.dev" data-md-component="logo">
      
  <img src="../../../../../assets/logo.svg" alt="logo">

    </a>
    straysheep.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/straysheep-dev/straysheep-dev.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    straysheep-dev.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Main
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    License
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2019/07/15/-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⭐ Resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/15/octicons-alert-16-aide-advanced-intrusion-detection-environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AIDE (Advanced Intrusion Detection Environment)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2023/08/20/simple-ansible-ansible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ansible
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/07/25/simple-ansible-ansible-molecule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ansible Molecule
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/12/octicons-beaker-16-atomic-red-team-x-unix-artifacts-collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Atomic Red Team x Unix Artifacts Collector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-dns-bind9-dns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BIND9 DNS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/02/simple-bitwarden-bitwarden/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    bitwarden
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/15/material-file-tree-triage-auditd-logs-with-check-auditd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Triage auditd logs with check-auditd
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/01/20/fontawesome-solid-gears-cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CI/CD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/04/material-clipboard-flow-clipboard-snooping-x11-and-wayland/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clipboard Snooping (X11 and Wayland)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/06/15/fontawesome-solid-square-binary-compile-static-binaries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compile Static Binaries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/29/octicons-terminal-16-custom-shell-profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Shell Profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/07/simple-flatpak-flatpak/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    flatpak
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/08/simple-qemu-kvm-kernel-based-virtual-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KVM (Kernel-based Virtual Machine)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/28/material-code-tags-check-linting-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linting Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2022/08/29/material-magnify-scan-nessus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nessus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/04/18/material-console-network-network-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Network Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../12/01/material-wifi-alert-nzyme-x-simple-raspberrypi-raspberry-pi--simple-proxmox-proxmox--simple-tailscale-tailscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    nzyme x [ Raspberry Pi + Proxmox + Tailscale]
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/29/material-file-document-arrow-right-openscap-practical-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenSCAP Practical Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/07/simple-openwrt-openwrt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenWrt
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/02/simple-pfsense-pfsense-administration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pfSense administration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../07/19/material-powershell-get-started-with-powerstig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Get Started with PowerSTIG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple-proxmox-proxmox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proxmox
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2025/02/22/material-sync-circle-rsync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    rsync
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/07/simple-snapcraft-snap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Wazuh all your things with Tailscale
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Wazuh all your things with Tailscale
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tailnet-access" class="md-nav__link">
    <span class="md-ellipsis">
      Tailnet Access
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tailnet Access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-acls-and-tags" class="md-nav__link">
    <span class="md-ellipsis">
      🏷️ Defining ACLs and Tags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tagging-devices" class="md-nav__link">
    <span class="md-ellipsis">
      🏷️ Tagging Devices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manager-vm-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Manager VM Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manager VM Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-an-iso" class="md-nav__link">
    <span class="md-ellipsis">
      Get an ISO
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-os-hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      Install the OS (Hyper-V)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-state-cis-l2" class="md-nav__link">
    <span class="md-ellipsis">
      Configure State (CIS L2)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-wazuh" class="md-nav__link">
    <span class="md-ellipsis">
      Install Wazuh
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Wazuh">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agent-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#password-auth" class="md-nav__link">
    <span class="md-ellipsis">
      🔑 Password Auth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-verification" class="md-nav__link">
    <span class="md-ellipsis">
      🎫 Agent Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manager-verification" class="md-nav__link">
    <span class="md-ellipsis">
      🎫 Manager Verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tailnet-enrollment" class="md-nav__link">
    <span class="md-ellipsis">
      Tailnet Enrollment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-scripting" class="md-nav__link">
    <span class="md-ellipsis">
      Shell Scripting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shell Scripting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-single-node" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy a Single Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-agents" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible" class="md-nav__link">
    <span class="md-ellipsis">
      Ansible
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-single-node_1" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy a Single Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-agents_1" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      Docker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disk-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Disk Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#central-management" class="md-nav__link">
    <span class="md-ellipsis">
      Central Management
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingesting-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting Logs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ingesting Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      Sysmon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmonforlinux" class="md-nav__link">
    <span class="md-ellipsis">
      SysmonForLinux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditd" class="md-nav__link">
    <span class="md-ellipsis">
      auditd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeek" class="md-nav__link">
    <span class="md-ellipsis">
      Zeek
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reviewing-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Reviewing Logs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reviewing Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon_1" class="md-nav__link">
    <span class="md-ellipsis">
      Sysmon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditd_1" class="md-nav__link">
    <span class="md-ellipsis">
      auditd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      Data Visualization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      External Alerting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="External Alerting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-script" class="md-nav__link">
    <span class="md-ellipsis">
      Python Script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-block" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Block
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Maintenance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wazuh-dashboard-server-is-not-ready-yet" class="md-nav__link">
    <span class="md-ellipsis">
      Wazuh dashboard server is not ready yet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-to-proxmox" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate to Proxmox
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../05/08/material-microsoft-windows-windows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_29" >
        
          
          <label class="md-nav__link" for="__nav_3_29" id="__nav_3_29_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_29_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_29">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-08-13 00:00:00+00:00" class="md-ellipsis">August 13, 2024</time>
                      </div>
                    </li>
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 13h1.5v2.82l2.44 1.41-.75 1.3L15 16.69zm4-5H5v11h4.67c-.43-.91-.67-1.93-.67-3a7 7 0 0 1 7-7c1.07 0 2.09.24 3 .67zM5 21a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v6.1c1.24 1.26 2 2.99 2 4.9a7 7 0 0 1-7 7c-1.91 0-3.64-.76-4.9-2zm11-9.85A4.85 4.85 0 0 0 11.15 16c0 2.68 2.17 4.85 4.85 4.85A4.85 4.85 0 0 0 20.85 16c0-2.68-2.17-4.85-4.85-4.85"/></svg>
                          <time datetime="2025-06-15 00:00:00+00:00" class="md-ellipsis">June 15, 2025</time>
                        </div>
                      </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              44 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tailnet-access" class="md-nav__link">
    <span class="md-ellipsis">
      Tailnet Access
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tailnet Access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-acls-and-tags" class="md-nav__link">
    <span class="md-ellipsis">
      🏷️ Defining ACLs and Tags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tagging-devices" class="md-nav__link">
    <span class="md-ellipsis">
      🏷️ Tagging Devices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manager-vm-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Manager VM Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manager VM Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-an-iso" class="md-nav__link">
    <span class="md-ellipsis">
      Get an ISO
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-os-hyper-v" class="md-nav__link">
    <span class="md-ellipsis">
      Install the OS (Hyper-V)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-state-cis-l2" class="md-nav__link">
    <span class="md-ellipsis">
      Configure State (CIS L2)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-wazuh" class="md-nav__link">
    <span class="md-ellipsis">
      Install Wazuh
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Wazuh">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agent-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#password-auth" class="md-nav__link">
    <span class="md-ellipsis">
      🔑 Password Auth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-verification" class="md-nav__link">
    <span class="md-ellipsis">
      🎫 Agent Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manager-verification" class="md-nav__link">
    <span class="md-ellipsis">
      🎫 Manager Verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tailnet-enrollment" class="md-nav__link">
    <span class="md-ellipsis">
      Tailnet Enrollment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-scripting" class="md-nav__link">
    <span class="md-ellipsis">
      Shell Scripting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shell Scripting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-single-node" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy a Single Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-agents" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible" class="md-nav__link">
    <span class="md-ellipsis">
      Ansible
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-single-node_1" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy a Single Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-agents_1" class="md-nav__link">
    <span class="md-ellipsis">
      📦 Deploy Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      Docker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disk-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Disk Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#central-management" class="md-nav__link">
    <span class="md-ellipsis">
      Central Management
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingesting-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting Logs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ingesting Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysmon" class="md-nav__link">
    <span class="md-ellipsis">
      Sysmon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmonforlinux" class="md-nav__link">
    <span class="md-ellipsis">
      SysmonForLinux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditd" class="md-nav__link">
    <span class="md-ellipsis">
      auditd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeek" class="md-nav__link">
    <span class="md-ellipsis">
      Zeek
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reviewing-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Reviewing Logs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reviewing Logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysmon_1" class="md-nav__link">
    <span class="md-ellipsis">
      Sysmon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditd_1" class="md-nav__link">
    <span class="md-ellipsis">
      auditd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      Data Visualization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      External Alerting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="External Alerting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-script" class="md-nav__link">
    <span class="md-ellipsis">
      Python Script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-block" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Block
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Maintenance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wazuh-dashboard-server-is-not-ready-yet" class="md-nav__link">
    <span class="md-ellipsis">
      Wazuh dashboard server is not ready yet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-to-proxmox" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate to Proxmox
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="wazuh-all-your-things-with-tailscale"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v.67l-2.5-1.11-6.5 2.88V15H3a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h8c.06 2.25 1 4.4 2.46 6H3a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M8 5h1V3H8zm0 8h1v-2H8zm0 8h1v-2H8zM4 3v2h2V3zm0 8v2h2v-2zm0 8v2h2v-2zm13.5-7 4.5 2v3c0 2.78-1.92 5.37-4.5 6-2.58-.63-4.5-3.22-4.5-6v-3zm0 1.94L15 15.06v2.66c0 1.54 1.07 2.98 2.5 3.34z"/></svg></span> Wazuh all your things with Tailscale</h1>
<p>This guide shows you how to get a Wazuh instance running over Tailscale on both Windows and Linux, using Sysmon(+forLinux), auditd, and all the tweaks you'll want to get started. This is ideal for a low resource, low budget, or lab scenario. You could eventually migrate this Wazuh data to a distributed cluster (proxmox), or real hardware if you grow with it.</p>
<!-- more -->

<hr />
<div class="admonition abstract">
<p class="admonition-title">Overview</p>
<ul>
<li>🌐 <a href="https://login.tailscale.com/start">Creating a tailnet</a>, <a href="https://tailscale.com/kb/1192/acl-samples#restrict-based-on-purpose-tags">defining an ACL policy, connecting machines using tags</a></li>
<li>Installing Ubuntu Server + Wazuh on a Hyper-V VM<ul>
<li>🌐 <a href="https://documentation.wazuh.com/current/quickstart.html#installing-wazuh">Shell script installer</a></li>
<li>🌐 <a href="https://github.com/wazuh/wazuh-ansible/tags">wazuh-ansible</a> <a href="https://documentation.wazuh.com/current/deployment-options/deploying-with-ansible/index.html">installation method</a> (based on tag of latest stable version)</li>
<li>🌐 <a href="https://documentation.wazuh.com/current/deployment-options/docker/wazuh-container.html">Docker</a></li>
</ul>
</li>
<li>Applying and maintaining the <a href="https://static.open-scap.org/ssg-guides/ssg-ubuntu2204-guide-cis_level2_server.html">CIS L2 benchmark</a> using <a href="https://github.com/straysheep-dev/ansible-configs/tree/main/inventory_openscap_utils">ansible tags</a></li>
<li>Ingesting logs: 3 components</li>
<li>Reading and understanding logs</li>
<li>How to write a custom integration, <a href="https://github.com/straysheep-dev/alert-service/tree/main/wazuh-integrations">including a ready-to-use Discord integration for shipping alerts</a></li>
</ul>
</div>
<hr />
<h2 id="tailnet-access">Tailnet Access</h2>
<p><a href="https://login.tailscale.com/start">Create a Tailscale account</a> if you already don't have one (<a href="https://tailscale.com/pricing">it's free for up to 3 users and 100 devices</a>).</p>
<h3 id="defining-acls-and-tags">🏷️ Defining ACLs and Tags</h3>
<p>This allows agents to communicate with ports on the manager node(s), but nothing else in your tailnet, not even other endpoints.</p>
<div class="admonition tip">
<p class="admonition-title">Tailnet ACLs</p>
<p>Tailscale's ACL rules work on a default-deny-all policy. You must define what can talk to what.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">// Define the tags which can be applied to devices and by which users.</span>
<span class="w">    </span><span class="nt">&quot;tagOwners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">&lt;SNIP&gt;</span>
<span class="w">        </span><span class="nt">&quot;tag:wazuh-agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;autogroup:admin&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;tag:wazuh-node&quot;</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="s2">&quot;autogroup:admin&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;acls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="err">&lt;SNIP&gt;</span>
<span class="w">        </span><span class="c1">// Allow Wazuh agents to communicate with Wazuh nodes</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;accept&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;src&quot;</span><span class="p">:</span><span class="w">    </span><span class="p">[</span><span class="s2">&quot;tag:wazuh-agent&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;dst&quot;</span><span class="p">:</span><span class="w">    </span><span class="p">[</span><span class="s2">&quot;tag:wazuh-node:1514,1515,55000&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="err">&lt;SNIP&gt;</span>
</code></pre></div>
<p><em>Be sure your Wazuh nodes ingesting data also have their firewalls open on tcp/1515 tcp/1514 tcp/55000 </em><em>for their tailnet interface only</em><em>.</em></p>
<h3 id="tagging-devices">🏷️ Tagging Devices</h3>
<p>This can be done when generating an authkey, or once a device is already in your tailnet.</p>
<p>If you've already enrolled some endpoints, and have an existing tailnet, you can add a tag to them from the Tailnet dasboard.</p>
<ul>
<li>Click the <code>...</code> three dots</li>
<li>Choose <code>Edit ACL Tags...</code></li>
<li>Choose <code>Add tags</code>, or go to <code>Manage tags in Access Controls</code> if you haven't created tags yet</li>
<li>Create a tag called something like <code>wazuh-agent</code> (it can be anything, but has to match what's in your ACLs)</li>
<li>Create another tag called <code>wazuh-node</code> for the server components (this tag could be used on each server component if they're distributed)</li>
</ul>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_tailnet_dashboard.png" /></p>
<p>If you're still enrolling more endpoints, tag your auth keys as either <code>wazuh-node</code> or <code>wazuh-agent</code>.</p>
<ul>
<li><code>Settings</code> &gt; <code>Keys</code> &gt; <code>Generate auth key ...</code></li>
<li>Tag:<code>wazuh-node</code> for server components or Tag:<code>wazuh-agent</code> for endpoints</li>
</ul>
<hr />
<h2 id="manager-vm-requirements">Manager VM Requirements</h2>
<p>Check the <a href="https://documentation.wazuh.com/current/quickstart.html">Quick Start</a> first.</p>
<p>A headless server is the ideal environment for Wazuh to live for performance sake, even in a lab scenario. To avoid any exposed web interfaces, use SSH local portforwarding to access the Wazuh manager dashboard after installing it. So your localhost:8443 can reach the Wazuh node's localhost:443 to login.</p>
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">127</span>.0.0.1:8443:127.0.0.1:443<span class="w"> </span>user@wazuh-ip
</code></pre></div>
<ul>
<li>Ubuntu 22.04 Server</li>
<li>80 GB Disk Space (50GB for logs, 30GB for OS)</li>
<li>4 vCPU</li>
<li>8 GiB RAM (will exceed 8 if you run this with a GUI)</li>
</ul>
<h3 id="get-an-iso">Get an ISO</h3>
<p><a href="https://releases.ubuntu.com">Grab the latest server image and signatures</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nv">url_list</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">https://releases.ubuntu.com/jammy/SHA256SUMS</span>
<span class="s1">https://releases.ubuntu.com/jammy/SHA256SUMS.gpg</span>
<span class="s1">https://releases.ubuntu.com/jammy/ubuntu-22.04.4-live-server-amd64.iso</span>
<span class="s1">&#39;</span>

<span class="k">for</span><span class="w"> </span>remote_file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$url_list</span>
<span class="k">do</span>
<span class="w">    </span>curl<span class="w"> </span>-LfO<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$remote_file</span><span class="s2">&quot;</span>
<span class="k">done</span>

gpg<span class="w"> </span>--verify<span class="w"> </span>SHA256SUMS.gpg<span class="w"> </span>SHA256SUMS<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
sha256sum<span class="w"> </span>-c<span class="w"> </span>SHA256SUMS<span class="w"> </span>--ignore-missing<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</code></pre></div>
<h3 id="install-the-os-hyper-v">Install the OS (Hyper-V)</h3>
<div class="admonition info">
<p class="admonition-title">Hyper-V</p>
<p>This guide uses Hyper-V, since it's less often covered than VMware and VirtualBox, which are heavily documented and more beginner friendly.</p>
</div>
<p>If Hyper-V isn't already enabled on your system, <a href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v">enable it</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Run as administrator</span>
<span class="nb">Enable-WindowsOptionalFeature</span> <span class="n">-Online</span> <span class="n">-FeatureName</span> <span class="n">Microsoft-Hyper-V</span> <span class="n">-All</span>
<span class="n">shutdown</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">t</span> <span class="n">0</span> <span class="p">/</span><span class="nb">r</span>
</code></pre></div>
<p>Once rebooted, you're ready to continue:</p>
<ul>
<li>Run Hyper-V Manager as admin (search for Hyper-V manager in the Start Menu)</li>
<li>Right-Click your hostname in the Hyper-V Manger window, New &gt; Virtual Machine...</li>
<li>Name: Wazuh</li>
<li>Check "Store in a different location"</li>
<li><code>PS&gt; mkdir "C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\Wazuh"</code></li>
<li>Select this folder</li>
<li>Choose "Next"</li>
<li>Select "Generation 2"</li>
<li>Startup memory: 8192, leave "Use Dynamic Memory" checked</li>
<li>Choose "Next"</li>
<li>Connection: "CustomNATSwitch" (<a href="https://github.com/straysheep-dev/windows-configs#hyper-v-default-switch-has-no-dhcp">which you should create if you're doing a lot with Hyper-V and home labs</a>)</li>
<li>Choose "Next"</li>
<li>Create a virtual hard disk, set the Location: <code>C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\Wazuh\</code></li>
<li>Choose "Next"</li>
<li>Choose Install an operating system later</li>
<li>Choose "Next", then "Finish"</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Custom NAT Switch</p>
<p>A custom NAT switch solves a lot of problems in Hyper-V networking.</p>
<ul>
<li>The default Hyper-V network "regenerates" every time you reboot, so it's considered a new interface</li>
<li>This is an issue <a href="https://learn.microsoft.com/en-us/windows/security/operating-system-security/network-security/windows-firewall/tools#shields-up-mode-for-active-attacks">if you have strict firewall rules on the host (AllowInboundRules: False)</a></li>
<li>If you do set AllowInboundRules: False (which is generally a good idea) this will also break DHCP</li>
</ul>
<p>With a custom switch, <strong>while you can only have one custom NAT switch per host</strong>, it's persistent, you define the IP range, and firewall rules persist. If you configure WSL to talk to this internal IP range, it will continue to work</p>
</div>
<p>Make the custom NAT switch:</p>
<div class="highlight"><pre><span></span><code><span class="nb">New-VMSwitch</span> <span class="n">-SwitchName</span> <span class="s2">&quot;CustomNATSwitch&quot;</span> <span class="n">-SwitchType</span> <span class="n">Internal</span>
<span class="nv">$ifindex</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-NetAdapter</span> <span class="n">-IncludeHidden</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s2">&quot;vEthernet (CustomNATSwitch)&quot;</span> <span class="p">}).</span><span class="n">ifIndex</span>
<span class="nb">New-NetIPAddress</span> <span class="n">-IPAddress</span> <span class="n">10</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">1</span> <span class="n">-PrefixLength</span> <span class="n">24</span> <span class="n">-InterfaceIndex</span> <span class="nv">$ifindex</span>
<span class="nb">New-NetNat</span> <span class="n">-Name</span> <span class="n">CustomNATNetwork</span> <span class="n">-InternalIPInterfaceAddressPrefix</span> <span class="n">10</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">55</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
</code></pre></div>
<p>If you want WSL to be able to reach this switch, <a href="https://github.com/straysheep-dev/windows-configs?tab=readme-ov-file#communicating-with-hyper-v">allow both interfaces to forward packets</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Apply</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (CustomNATSwitch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Enabled</span>

<span class="c"># Remove</span>
<span class="nb">Get-NetIPInterface</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (WSL (Hyper-V firewall))&#39;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">InterfaceAlias</span> <span class="o">-eq</span> <span class="s1">&#39;vEthernet (CustomNATSwitch)&#39;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Set-NetIPInterface</span> <span class="n">-Forwarding</span> <span class="n">Disabled</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">If WSL and Hyper-V can't talk after a reboot...</p>
<p>You may have to re-enable this after every reboot.</p>
</div>
<p>Next, modifying the settings before we start:</p>
<ul>
<li>Right-Click the "Wazuh" VM name from the list, choose Settings</li>
<li>Security &gt; Secure Boot &gt; Template: <code>Microsoft UEFI Certificate Authority</code></li>
<li>Memory &gt; Minimum RAM: <code>4096</code></li>
<li>Memory &gt; Maximum RAM: <code>8192</code></li>
<li>Processor &gt; Number of virtual processors: 4 (6 if you can)</li>
<li>Click "SCSI Controller", select "DVD Drive", click "Add"</li>
<li>You'll be on the DVD drive tab automatically, select "Image file:" and choose your ubuntu server ISO</li>
<li>Integration Services &gt; You can safely disable everything, for isolation</li>
<li>Checkpoints &gt; uncheck "Use automatic checkpoints"</li>
<li>Checkpoints &gt; Checkpoint File Location: <code>C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\Wazuh</code></li>
<li>Smart Paging File Location &gt; <code>C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines\Wazuh</code></li>
<li>Apply, then OK</li>
<li>Take a checkpoint (snapshot) here so you don't have to do this again if anything goes wrong</li>
</ul>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_hyper-v_conf.png" /></p>
<p>Now install Ubuntu as you would normally. You'll need to manually configure <code>eth0</code>.</p>
<ul>
<li>Subnet: 10.55.55.0/24</li>
<li>IPv4: 10.55.55.X</li>
<li>Gateway: 10.55.55.1</li>
<li>Name Servers: <a href="https://www.cloudflare.com/learning/dns/dns-over-tls/">1.1.1.1</a>,<a href="https://docs.quad9.net/">9.9.9.9</a></li>
</ul>
<p>Use the entire disk as LVM (default), you do not necessarily <em>need</em> encryption if your host has full disk encryption. Set the server's name to something like <code>wazuh-node</code> or <code>wazuh-standalone</code>. When you get to SSH access, check "Install OpenSSH server" and then "Import SSH Key" to provide your GItHub username. It will pull your public key (if you have one) from the GitHub API (you can do this with <code>curl</code> by the way) into the <code>~/.ssh/authorized_keys</code> file. Let the install complete.</p>
<p>When it's done, follow the prompts as usual to "eject" the ISO and reboot. SSH in and ensure the packages are up to date with a <code>sudo apt update; sudo apt upgrade -y; sudo snap refresh</code>. Then <code>sudo systemctl poweroff</code> and take another checkpoint.</p>
<hr />
<h3 id="configure-state-cis-l2">Configure State (CIS L2)</h3>
<div class="admonition abstract">
<p class="admonition-title">CIS L2 Benchmark for Ubuntu Server</p>
<p>Here's where you can configure the system into a state, such as the <a href="https://static.open-scap.org/ssg-guides/ssg-ubuntu2204-guide-cis_level2_server.html">CIS L2 benchmark for Ubuntu server</a>.</p>
<p>Apply any additional changes you normally would to secure or configure a server here. These changes need to avoid getting in the way of Wazuh functioning. You may need to test and debug any other hardening policies you apply outside of those mentioned here.</p>
<p>The tags and tasks applied in the steps below will still allow Wazuh to function.</p>
</div>
<p>Install Ansible.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3-pip
python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>ansible
<span class="c1"># logout, then back in to update your PATH</span>
</code></pre></div>
<p>Clone my <a href="https://github.com/straysheep-dev/ansible-configs">ansible-configs</a> repo.</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>~/src
<span class="nb">cd</span><span class="w"> </span>~/src
git<span class="w"> </span>clone<span class="w"> </span>git@github.com:straysheep-dev/ansible-configs.git
<span class="nb">cd</span><span class="w"> </span>ansible-configs/
gpg<span class="w"> </span>--keyserver<span class="w"> </span>hkps://keyserver.ubuntu.com:443<span class="w"> </span>--recv-keys<span class="w"> </span><span class="s1">&#39;9906 9EB1 2D40 9EA9 3BD1 E52E B09D 00AE C481 71E0&#39;</span>
git<span class="w"> </span>verify-commit<span class="w"> </span><span class="k">$(</span><span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

<span class="c1"># You could loop through every commit and verify it, if you can&#39;t download over SSH</span>
<span class="k">for</span><span class="w"> </span>signature<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;^commit&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">(</span>git<span class="w"> </span>verify-commit<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$signature</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;Good signature&#39;</span><span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARNING]: </span><span class="nv">$signature</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</code></pre></div>
<p>Uncomment the following roles in <code>playbook.yml</code> to gather some essential packages and tools:</p>
<div class="highlight"><pre><span></span><code>    - role: &quot;install_unbound&quot;
#    - role: &quot;install_ykman&quot;
#    - role: &quot;install_chrome&quot;
#    - role: &quot;build_wireguard_server&quot;
    - role: &quot;build_tailscale_node&quot;
#    - role: &quot;build_ubuntu_desktop&quot;
#    - role: &quot;install_auditd&quot;
#    - role: &quot;hyperv_guest_tools&quot;
    - role: &quot;configure_gnupg&quot;
    - role: &quot;configure_microsoft_repos&quot;
#    - role: &quot;install_vscode&quot;
    - role: &quot;install_powershell&quot;
    - role: &quot;install_sysmon&quot;
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Unbound DNS</p>
<p>My unbound DNS role is usually always added so the machine can leverage DNS over TLS. <a href="https://github.com/straysheep-dev/linux-configs/tree/main/dns">You can do this with stubby instead</a>, or if you prefer another method altogether that's fine too. <code>systemd-resolved</code> has not had full support for DNS over TLS or HTTPS, and is just starting to support it as of 2023/2024.</p>
</div>
<p><a href="https://tailscale.com/kb/1085/auth-keys">Generate an authkey</a>. From your Tailnet dashboard go to <code>Settings</code> &gt; <code>Keys</code> &gt; <code>Genereate auth key...</code></p>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_tailnet_authkey.png" /></p>
<p>Add the authkey to an ansible-vault.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/src/ansible-configs
rm<span class="w"> </span>auth.yml
ansible-vault<span class="w"> </span>create<span class="w"> </span>auth.yml
</code></pre></div>
<p>Contents of <code>auth.yml</code>, <em>with</em> the double quotes around each value:</p>
<div class="highlight"><pre><span></span><code>ansible_become_password: &quot;&lt;your_sudo_password&gt;&quot;
tailscale_authkey: &quot;&lt;tskey-auth-abcdef0123456789abcdef0123456789&gt;&quot;
</code></pre></div>
<p>Run the playbook.</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Enter Vault Password&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-s<span class="w"> </span>vault_pass<span class="p">;</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ANSIBLE_VAULT_PASSWORD</span><span class="o">=</span><span class="nv">$vault_pass</span>
<span class="c1"># paste your vault password, hit enter</span>

ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/inventory.ini<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;@auth.yml&quot;</span><span class="w"> </span>--vault-pass-file<span class="w"> </span>&lt;<span class="o">(</span>cat<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="nv">$ANSIBLE_VAULT_PASSWORD</span><span class="o">)</span><span class="w"> </span>-v<span class="w"> </span>./playbook.yml
</code></pre></div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_ansible_tailnet_enrollment.png" /></p>
<p>If everything succeeded, poweroff the machine and take a checkpoint. Otherwise read the Ansible output and revise any potential issues. It's possible some tasks may hang, especially if your network drops the connection. Easiest thing here is to <code>ctrl+c</code> and just run the playbook again. It's configuring a state and the roles were written to safely run more than once.</p>
<hr />
<p><strong>⚙️ Applying the SCAP Content</strong></p>
<p>SSH back in, this time <code>cd ~/src/ansible-configs/inventory_openscap_utils</code>.</p>
<div class="admonition tip">
<p class="admonition-title">Ansible OpenSCAP Utils</p>
<p><em>This section is from <a href="http://127.0.0.1:8000/blog/2024/05/29/openscap-practical-usage/">OpenSCAP Practical Usage</a>.</em></p>
<p>If you haven't already, clone the latest <a href="https://github.com/straysheep-dev/ansible-configs">ansible-configs</a>:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>curl<span class="w"> </span>unzip

mkdir<span class="w"> </span>~/src
<span class="nb">cd</span><span class="w"> </span>~/src
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/straysheep-dev/ansible-configs
<span class="nb">cd</span><span class="w"> </span>ansible-configs/inventory_openscap_utils
</code></pre></div>
<p>and follow the steps below.</p>
</div>
<p>Run <code>./download-content.sh</code> to pull the latest OpenSCAP policy release from GitHub.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_1.png" /></p>
<p>It will automatically <code>unzip</code> policy files matching the current OS. To specify another OS, use <code>-u &lt;os-name&gt;</code>.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_2.png" /></p>
<p>You can list all available policy files with <code>-l</code>.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_3.png" /></p>
<p>The wrapper script is written to interpret posix-extended regex. Combine rules from multiple policies like this.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_4.png" /></p>
<p>Comment out any rules in the tags-*.txt files you don't want to apply, or find break the deployment.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_5.png" /></p>
<div class="admonition example">
<p class="admonition-title">Why Ansible?</p>
<p>Running <code>./apply-tags.sh</code> with the <code>-d|--diff</code> options will run Ansible with <code>--check --diff</code>, showing you the changes without making them, and failing if a change cannot be made correctly. This is the strength of this approach. With states maintained as tags you can more easily isolate and debug what could have broken a system, especially if you're testing tags in groups.</p>
</div>
<hr />
<p><strong>📚 Script Usage</strong></p>
<p>The wrapper script has built in <code>-h|--help</code> information. You can pass it all the arguments you will usually need to either test a policy on the localhost, or use an inventory + vault.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_6.png" /></p>
<p>When the script executes a playbook, the raw command with all of the tags listed will be printed to your screen. This is copy / paste-able to repeat manually if necessary.</p>
<p><img alt="" src="../../../../media/openscap-ansible/openscap_ansible_7.png" /></p>
<p><strong>🏷️ Premade Tags</strong></p>
<p>There are also folders in the same directory of premade tag sets that will apply as many rules as possible without breaking a system, exceptions being <code>aide</code> and <code>auditd</code> rules. The reason being these rules often endlessly loop, need tuned to your environment, or break the deployment. Use the <a href="https://github.com/straysheep-dev/ansible-configs/tree/main/aide"><code>aide</code></a> and <a href="https://github.com/straysheep-dev/ansible-configs/tree/main/install_auditd"><code>install_auditd</code></a> roles instead.</p>
<p>Once all the loops finish, <code>sudo systemctl reboot</code> and SSH back in. Check the system with <code>systemctl status</code> to ensure <code>State:  running</code>. Check <code>journalctl -xe</code> for any errors or issues. If all looks good, poweroff and once again take a checkpoint.</p>
<p>Now you're ready to install Wazuh.</p>
<div class="admonition tip">
<p class="admonition-title"><code>tmux</code></p>
<p>When you SSH into the Wazuh server, start a <code>tmux</code> session to easily return to your console if you're disconnected. You can also monitor the install with a second pane using <code>prefix+"</code> then in the new pane run <code>htop</code>.</p>
</div>
<hr />
<h2 id="install-wazuh">Install Wazuh</h2>
<p>Installation can take 20-30 minutes, or even more depending on your setup and connection speed. Kick off the installer script or playbook and take a break.</p>
<p>No matter which method you choose, you can start by ensuring ports tcp/1515, tcp/1514, tcp/55000 allow inbound connections from the Tailnet IP ranges:</p>
<div class="highlight"><pre><span></span><code><span class="nv">tailnet_ip</span><span class="o">=</span><span class="k">$(</span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>tailscale0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s2">&quot;\b100(\.(\d){1,3}){3}\b&quot;</span><span class="k">)</span>
sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span><span class="k">in</span><span class="w"> </span>on<span class="w"> </span>tailscale0<span class="w"> </span>to<span class="w"> </span><span class="nv">$tailnet_ip</span><span class="w"> </span>proto<span class="w"> </span>tcp<span class="w"> </span>port<span class="w"> </span><span class="m">1515</span>,1514,55000<span class="w"> </span>comment<span class="w"> </span>wazuh
</code></pre></div>
<div class="admonition quote">
<p class="admonition-title"><a href="https://documentation.wazuh.com/current/installation-guide/wazuh-agent/index.html">Wazuh Docs: Large Scale Deployment</a></p>
<p>If you are deploying Wazuh in a large environment, with a high number of servers or endpoints, keep in mind that this deployment might be easier using automation tools such as <a href="https://documentation.wazuh.com/current/deployment-options/deploying-with-puppet/index.html">Puppet</a>, <a href="https://github.com/wazuh/wazuh-chef">Chef</a>, SCCM, or <a href="https://documentation.wazuh.com/current/deployment-options/deploying-with-ansible/installation-guide.html">Ansible</a>.</p>
</div>
<hr />
<h3 id="agent-authentication">Agent Authentication</h3>
<div class="admonition abstract">
<p class="admonition-title">Verifying Wazuh Connections</p>
<p>This section details steps you can use to lock down connections to and from your Wazuh instance. You may want to do this for a few reasons.</p>
<ol>
<li>Prevent a rogue Wazuh server from intercepting data from endpoints</li>
<li>Prevent rogue endpoints from sending data into your Wazuh instance.</li>
</ol>
<p>An adversary-controlled Wazuh server having full visibility into an endpoint is less than ideal for a number of reasons, and of these two points is likely the easier to achieve in a real world scenario where there's no authentication.</p>
<p>Rogue endpoints enrolling would ideally have little effect on your Wazuh instance, unless a known exploit is available for one of the backend server components, and this exploit can be leveraged by an agent sending crafted data to the data ingestors. You're already using Wazuh to detect and respond to emerging threats, so a malicious endpoint is baked-in to the potential threat model. Practically this would only be used in a more targeted scenario.</p>
</div>
<p>There are effectively three options. The <a href="https://documentation.wazuh.com/current/user-manual/agent/agent-enrollment/security-options/index.html">Wazuh User Manual: Agent Enrollment Security Options</a> page details all of these.</p>
<h4 id="password-auth">🔑 Password Auth</h4>
<p><em>This method requires using a password during the enrollment process to ensure that Wazuh agents enrolled in the Wazuh manager are authenticated.</em></p>
<ul>
<li><a href="https://documentation.wazuh.com/current/user-manual/agent/agent-enrollment/security-options/using-password-authentication.html">Instructions</a></li>
<li>It's recommended to use the same password across all nodes in a multi-node deployment</li>
<li>Agents and managers will no longer communicate without the password set on both ends</li>
<li>This will break exisitng connections to your manager</li>
<li>Configure the manager to expect password auth</li>
<li>Configure each agent to use the password during deployment or by adding the <code>authd.pass</code> file later</li>
</ul>
<p>Generally, if you want to get your Wazuh instance protected with minimal work, this is the way to go. Not only does it prevent unauthorized agents from enrolling, but a rogue server would need to know the password the agent requests when during enrollment. In other words, both the server and agents are protected.</p>
<p>This output is from the agent's side when providing an enrollment password on the agent, for a Wazuh server that does not require a password to authenticate.</p>
<div class="highlight"><pre><span></span><code>root@bind9-node:~#<span class="w"> </span>tail<span class="w"> </span>-F<span class="w"> </span>/var/ossec/logs/ossec.log
<span class="m">2025</span>/01/01<span class="w"> </span><span class="m">11</span>:22:33<span class="w"> </span>wazuh-agentd:<span class="w"> </span>INFO:<span class="w"> </span>Requesting<span class="w"> </span>a<span class="w"> </span>key<span class="w"> </span>from<span class="w"> </span>server:<span class="w"> </span><span class="m">10</span>.0.0.20
<span class="m">2025</span>/01/01<span class="w"> </span><span class="m">11</span>:22:33<span class="w"> </span>wazuh-agentd:<span class="w"> </span>INFO:<span class="w"> </span>Using<span class="w"> </span>agent<span class="w"> </span>name<span class="w"> </span>as:<span class="w"> </span>bind9-node
<span class="m">2025</span>/01/01<span class="w"> </span><span class="m">11</span>:22:33<span class="w"> </span>wazuh-agentd:<span class="w"> </span>INFO:<span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>server<span class="w"> </span>reply
<span class="m">2025</span>/01/01<span class="w"> </span><span class="m">11</span>:22:33<span class="w"> </span>wazuh-agentd:<span class="w"> </span>ERROR:<span class="w"> </span>Invalid<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>new<span class="w"> </span>agent<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>manager<span class="o">)</span>
<span class="m">2025</span>/01/01<span class="w"> </span><span class="m">11</span>:22:33<span class="w"> </span>wazuh-agentd:<span class="w"> </span>ERROR:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>add<span class="w"> </span>agent<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>manager<span class="o">)</span>
</code></pre></div>
<p>These steps enforce password auth on the server:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>su<span class="w"> </span>-
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Enter an enrollment password:&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-s<span class="w"> </span>wazuh_auth_pass
sed<span class="w"> </span>-E<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/&lt;use_password&gt;.*&lt;\/use_password&gt;/&lt;use_password&gt;yes&lt;\/use_password&gt;/&#39;</span><span class="w"> </span>/var/ossec/etc/ossec.conf
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$wazuh_auth_pass</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/var/ossec/etc/authd.pass
chmod<span class="w"> </span><span class="m">640</span><span class="w"> </span>/var/ossec/etc/authd.pass
chown<span class="w"> </span>root:wazuh<span class="w"> </span>/var/ossec/etc/authd.pass
systemctl<span class="w"> </span>restart<span class="w"> </span>wazuh-manager
</code></pre></div>
<p>These steps configure an agent to use password auth:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Linux/Unix</label><label for="__tabbed_1_2">Windows</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>su<span class="w"> </span>-
<span class="nv">WAZUH_MANAGER</span><span class="o">=</span><span class="s2">&quot;&lt;server-ip-or-fqdn&gt;&quot;</span><span class="w"> </span><span class="nv">WAZUH_REGISTRATION_PASSWORD</span><span class="o">=</span><span class="s2">&quot;&lt;password&gt;&quot;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>wazuh-agent
<span class="c1"># Installing the agent with these env variables will make the necessary configurations</span>
<span class="c1"># for password auth to occur.</span>

<span class="c1"># If you have existing agents, you will need to deploy the password</span>
<span class="c1"># to each of them:</span>
sudo<span class="w"> </span>su<span class="w"> </span>-
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&lt;password&gt;&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/var/ossec/etc/authd.pass
chmod<span class="w"> </span><span class="m">640</span><span class="w"> </span>/var/ossec/etc/authd.pass
chown<span class="w"> </span>root:wazuh<span class="w"> </span>/var/ossec/etc/authd.pass
systemctl<span class="w"> </span>restart<span class="w"> </span>wazuh-agent.service
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">wazuh-agent</span><span class="p">-</span><span class="n">4</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">msi</span> <span class="p">/</span><span class="n">q</span> <span class="n">WAZUH_MANAGER</span><span class="p">=</span><span class="s2">&quot;&lt;server-ip-or-fqdn&gt;&quot;</span> <span class="n">WAZUH_REGISTRATION_PASSWORD</span><span class="p">=</span><span class="s2">&quot;&lt;password&gt;&quot;</span>
<span class="nb">Restart-Service</span> <span class="n">-Name</span> <span class="n">wazuh</span>
<span class="c"># Installing the agent with these env variables will make the necessary configuraitons</span>
<span class="c"># for password auth to occur.</span>

<span class="c"># If you have existing agents, you will need to deploy the password</span>
<span class="c"># to each of them:</span>
<span class="c"># 32-bit</span>
<span class="nb">echo </span><span class="s2">&quot;&lt;password&gt;&quot;</span> <span class="p">&gt;</span> <span class="s2">&quot;C:\Program Files\ossec-agent\authd.pass&quot;</span>
<span class="c"># 64-bit</span>
<span class="nb">echo </span><span class="s2">&quot;&lt;password&gt;&quot;</span> <span class="p">&gt;</span> <span class="s2">&quot;C:\Program Files (x86)\ossec-agent\authd.pass&quot;</span>
<span class="c"># Restart the agent</span>
<span class="nb">Restart-Service</span> <span class="n">-Name</span> <span class="n">wazuh</span>
</code></pre></div>
</div>
</div>
</div>
<h4 id="agent-verification">🎫 Agent Verification</h4>
<div class="admonition quote">
<p><em>This method uses SSL certificates to verify that a Wazuh agent is authorized to enroll in the Wazuh manager.</em></p>
</div>
<h4 id="manager-verification">🎫 Manager Verification</h4>
<div class="admonition quote">
<p><em>This method uses SSL certificates to verify the identity of the Wazuh manager before a Wazuh agent sends the enrollment request.</em></p>
</div>
<hr />
<h3 id="tailnet-enrollment">Tailnet Enrollment</h3>
<p><em>How to enroll multiple endpoints each with their own tailnet_authkey</em></p>
<p>This was covered above in <a href="#configure-state-cis-l2">Configure State (CIS L2)</a> with screenshots enrolling just the Wazuh manager machine into a tailnet. Enrolling multiple devices at once is as simple as giving each endpoint a unique variable with a pregenerated authkey.</p>
<p>Here's what your vault could contain:</p>
<div class="highlight"><pre><span></span><code>client01_tsauthkey: &quot;tskey-abcdef0123456789abcdef0123456789&quot;
server01_tsauthkey: &quot;tskey-abcdef0123456789abcdef0123456789&quot;
&lt;SNIP&gt;
</code></pre></div>
<p>...and the corresponding inventory file:</p>
<div class="highlight"><pre><span></span><code>managed_group:
  hosts:
    172.16.20.20:
      ansible_port: 22
      ansible_user: user
      tailscale_authkey: &quot;{{ client01_tsauthkey }}&quot;
    172.16.20.21:
      ansible_port: 22
      ansible_user: server
      tailscale_authkey: &quot;{{ server01_tsauthkey }}&quot;
      is_exit_node: &quot;true&quot;
      &lt;SNIP&gt;
</code></pre></div>
<hr />
<h3 id="shell-scripting">Shell Scripting</h3>
<h4 id="deploy-a-single-node">📦 Deploy a Single Node</h4>
<p><a href="https://documentation.wazuh.com/current/quickstart.html">There's a shell script that will deploy the SIEM on a single node</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/src
curl<span class="w"> </span>-sO<span class="w"> </span>https://packages.wazuh.com/4.8/wazuh-install.sh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span>./wazuh-install.sh<span class="w"> </span>-a
</code></pre></div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_wazuh_installer_script.png" /></p>
<h4 id="deploy-agents">📦 Deploy Agents</h4>
<p><a href="https://documentation.wazuh.com/current/quickstart.html#next-steps">Deploy agents with a few lines</a>.</p>
<div class="admonition note">
<p class="admonition-title">Wazuh's Public Key</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gpg<span class="w"> </span>--with-fingerprint<span class="w"> </span>/usr/share/keyrings/wazuh.gpg
<span class="w">    </span>gpg:<span class="w"> </span>WARNING:<span class="w"> </span>no<span class="w"> </span><span class="nb">command</span><span class="w"> </span>supplied.<span class="w">  </span>Trying<span class="w"> </span>to<span class="w"> </span>guess<span class="w"> </span>what<span class="w"> </span>you<span class="w"> </span>mean<span class="w"> </span>...
<span class="w">    </span>pub<span class="w">   </span>rsa4096/0x96B3EE5F29111145<span class="w"> </span><span class="m">2016</span>-08-01<span class="w"> </span><span class="o">[</span>SC<span class="o">]</span><span class="w"> </span><span class="o">[</span>expires:<span class="w"> </span><span class="m">2027</span>-05-15<span class="o">]</span>
<span class="w">        </span>Key<span class="w"> </span><span class="nv">fingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0DCF<span class="w"> </span>CA55<span class="w"> </span>47B1<span class="w"> </span>9D2A<span class="w"> </span><span class="m">6099</span><span class="w">  </span><span class="m">5060</span><span class="w"> </span>96B3<span class="w"> </span>EE5F<span class="w"> </span><span class="m">2911</span><span class="w"> </span><span class="m">1145</span>
<span class="w">    </span>uid<span class="w">                             </span>Wazuh.com<span class="w"> </span><span class="o">(</span>Wazuh<span class="w"> </span>Signing<span class="w"> </span>Key<span class="o">)</span><span class="w"> </span>&lt;support@wazuh.com&gt;
<span class="w">    </span>sub<span class="w">   </span>rsa4096/0x417F3D5A664FAB32<span class="w"> </span><span class="m">2016</span>-08-01<span class="w"> </span><span class="o">[</span>E<span class="o">]</span><span class="w"> </span><span class="o">[</span>expires:<span class="w"> </span><span class="m">2027</span>-05-15<span class="o">]</span>
<span class="w">        </span>Key<span class="w"> </span><span class="nv">fingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>7C74<span class="w"> </span><span class="m">8627</span><span class="w"> </span>7A6A<span class="w"> </span><span class="m">9681</span><span class="w"> </span>DF3F<span class="w">  </span>3D8A<span class="w"> </span>417F<span class="w"> </span>3D5A<span class="w"> </span>664F<span class="w"> </span>AB32
</code></pre></div>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Linux</label><label for="__tabbed_2_2">Windows</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://packages.wazuh.com/key/GPG-KEY-WAZUH<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--no-default-keyring<span class="w"> </span>--keyring<span class="w"> </span>gnupg-ring:/usr/share/keyrings/wazuh.gpg<span class="w"> </span>--import<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/usr/share/keyrings/wazuh.gpg
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/apt/sources.list.d/wazuh.list
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
<span class="c1"># Change to root</span>
sudo<span class="w"> </span>su<span class="w"> </span>-
<span class="nv">WAZUH_MANAGER</span><span class="o">=</span><span class="s2">&quot;&lt;server-ip-or-fqdn&gt;&quot;</span><span class="w"> </span><span class="nv">WAZUH_REGISTRATION_PASSWORD</span><span class="o">=</span><span class="s2">&quot;&lt;password&gt;&quot;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>wazuh-agent
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nb">cd </span><span class="nv">$env:TEMP</span>
<span class="nb">iwr </span><span class="n">-Uri</span> <span class="n">https</span><span class="p">://</span><span class="n">packages</span><span class="p">.</span><span class="n">wazuh</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">4</span><span class="p">.</span><span class="n">x</span><span class="p">/</span><span class="n">windows</span><span class="p">/</span><span class="n">wazuh-agent</span><span class="p">-</span><span class="n">4</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">msi</span> <span class="n">-OutFile</span> <span class="n">wazuh-agent</span><span class="p">.</span><span class="n">msi</span>
<span class="nb">Start-Process</span> <span class="n">msiexec</span> <span class="s1">&#39;/quiet /i wazuh-agent.msi WAZUH_MANAGER=&quot;&lt;server-ip-or-fqdn&gt;&quot; WAZUH_REGISTRATION_PASSWORD=&quot;&lt;password&gt;&quot;&#39;</span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Deploy agents as root / admin</p>
<p><code>sudo su -</code> or run from an administrator powershell session when using the <code>WAZUH_MANAGER="&lt;ip&gt;" apt-get install wazuh-agent</code> otherwise the environment variable isn't read correctly.</p>
<p>If this happens, manually add your manager's tailnet IP in <code>/var/ossec/etc/ossec.conf</code> or <code>C:\Program Files (x86)\ossec-agent\ossec.conf</code> <strong>on the endpoint</strong>:</p>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_wazuh-agent.png" /></p>
</div>
<hr />
<h3 id="ansible">Ansible</h3>
<p>The Ansible repo allows for a distributed cluster or a single node / agent deployment. <strong>This guide recommends using Ansible to help you automate your infrastructure and endpoint enrollment. Create your own roles or plays for custom configurations.</strong></p>
<ul>
<li>🌐 <a href="https://github.com/wazuh/wazuh-ansible">wazuh-ansible</a></li>
<li>🌐 <a href="https://github.com/wazuh/wazuh-ansible/releases/latest">You'll want to use the latest release's tag</a></li>
</ul>
<p>Obtain the latest release version:</p>
<div class="highlight"><pre><span></span><code><span class="nv">RESPONSE</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span>https://api.github.com/repos/wazuh/wazuh-ansible/releases/latest<span class="k">)</span>
<span class="nv">URL</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESPONSE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="s1">&#39;/zipball_url/{print $4}&#39;</span><span class="k">)</span>
<span class="nv">TAG</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESPONSE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="s1">&#39;/tag_name/{print $4}&#39;</span><span class="k">)</span>

curl<span class="w"> </span>--silent<span class="w"> </span>-L<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span><span class="w"> </span>--output<span class="w"> </span>wazuh-ansible-<span class="s2">&quot;</span><span class="nv">$TAG</span><span class="s2">&quot;</span>.zip
</code></pre></div>
<p>Alernatively you could clone the entire repo and checkout the latest tag:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/wazuh/wazuh-ansible
<span class="nb">cd</span><span class="w"> </span>wazuh-ansible
git<span class="w"> </span>tag
git<span class="w"> </span>checkout<span class="w"> </span>tags/v4.8.0
</code></pre></div>
<p>If you want to verify the latest tag signature, look for the <code>Good signature from "GitHub &lt;noreply@github.com&gt;" [unknown]</code> line.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Obtain GitHub&#39;s signing key</span>
<span class="c1"># https://github.com/web-flow.gpg</span>
<span class="c1"># 5DE3E0509C47EA3CF04A42D34AEE18F83AFDEB23</span>
gpg<span class="w"> </span>--keyserver<span class="w"> </span>hkps://keyserver.ubuntu.com:443<span class="w"> </span>--recv-keys<span class="w"> </span><span class="s1">&#39;5DE3E0509C47EA3CF04A42D34AEE18F83AFDEB23&#39;</span>
git<span class="w"> </span>verify-commit<span class="w"> </span>v4.8.0
gpg:<span class="w"> </span>Signature<span class="w"> </span>made<span class="w"> </span>Thu<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">07</span>:09:59<span class="w"> </span><span class="m">2024</span><span class="w"> </span>UTC
gpg:<span class="w">                </span>using<span class="w"> </span>RSA<span class="w"> </span>key<span class="w"> </span>B5690EEEBB952194
gpg:<span class="w"> </span>Good<span class="w"> </span>signature<span class="w"> </span>from<span class="w"> </span><span class="s2">&quot;GitHub &lt;noreply@github.com&gt;&quot;</span><span class="w"> </span><span class="o">[</span>unknown<span class="o">]</span>
gpg:<span class="w"> </span>WARNING:<span class="w"> </span>This<span class="w"> </span>key<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>certified<span class="w"> </span>with<span class="w"> </span>a<span class="w"> </span>trusted<span class="w"> </span>signature!
gpg:<span class="w">          </span>There<span class="w"> </span>is<span class="w"> </span>no<span class="w"> </span>indication<span class="w"> </span>that<span class="w"> </span>the<span class="w"> </span>signature<span class="w"> </span>belongs<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>owner.
Primary<span class="w"> </span>key<span class="w"> </span>fingerprint:<span class="w"> </span><span class="m">9684</span><span class="w"> </span>79A1<span class="w"> </span>AFF9<span class="w"> </span>27E3<span class="w"> </span>7D1A<span class="w">  </span>566B<span class="w"> </span>B569<span class="w"> </span>0EEE<span class="w"> </span>BB95<span class="w"> </span><span class="m">2194</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Verifying Git Signatures: Tags vs Releases vs Commits</p>
<p>If commit signing is enforced for a project, and it's on GitHub, commits will either be signed by the committer's key, or GitHub's signing key.</p>
<p>Tags are sometimes a more "complete" snapshot of a repo's contents, where commits only validate the changes they relate to. It's better to check the tag or even a release signature when possible, else you'll need to loop through every commit if they've all been signed. A release signature is often it's own .asc file released along side the other release files, so you can check the integrity of each file with the .asc signature using the related public key.</p>
<p>In the case of wazuh-ansible the tags are actually commits. Basically you have a few options:</p>
<ul>
<li>Clone the repo over SSH (trusting GitHub's keys)</li>
<li>Ensure your DNS is trustworthy (use 1.1.1.1 or 9.9.9.9 or 8.8.8.8 over TLS / HTTPS)</li>
<li>Loop through the commit signatures</li>
</ul>
<p>In all cases you'll need to place trust primarily into the project (which your're already doing by using it) and GitHub's infrastructure. This is an overly paranoid take on verifying integrity, but something to consider when an EDR / SIEM has complete access to your infrastructure. If you'd rather use Wazuh's apt / dnf installation options, they rely on the Wazuh signing key which has a known fingerprint of <code>0DCF CA55 47B1 9D2A 6099  5060 96B3 EE5F 2911 1145</code>. Use this fingerprint to cross reference it against <a href="https://packages.wazuh.com/key/GPG-KEY-WAZUH">the GPG key from Wazuh.com</a> and <a href="https://keyserver.ubuntu.com/pks/lookup?search=0DCF+CA55+47B1+9D2A+6099++5060+96B3+EE5F+2911+1145&amp;fingerprint=on&amp;op=index">keyserver.ubuntu.com</a></p>
</div>
<h4 id="deploy-a-single-node_1">📦 Deploy a Single Node</h4>
<p><code>cd</code> into the project folder and create a new inventory file.</p>
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>inventory.yaml
</code></pre></div>
<p>In this example, we're creating the "aio" or all-in-one inventory group, which points to remote machine(s) that already have our SSH public key on them for us to connect to, and we have the ansible user's <code>sudo</code> password for privilege escalation.</p>
<div class="highlight"><pre><span></span><code><span class="nt">aio</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">192.168.123.198</span><span class="p">:</span>
<span class="w">      </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user1</span>
<span class="w">      </span><span class="nt">ansible_become_password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;packer&#39;</span><span class="w">  </span><span class="c1"># Replace this with a vault variable</span>
<span class="w">      </span><span class="nt">ansible_become_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sudo</span>
</code></pre></div>
<p>You won't need to modify anything in the playbook (even the 127.0.0.1 addresses) other than using sudo instead of root:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Comment out all instances of &quot;root&quot; and replace with</span>
<span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div>
<p>If you are in fact doing this "locally" it will still try to ssh into 127.0.0.1. You'll need a public key your own localhost will accept ssh connections over.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>su<span class="w"> </span>-
ssh-keygen<span class="w">  </span><span class="c1"># Enter all defaults, no password</span>
<span class="nb">eval</span><span class="w"> </span><span class="k">$(</span>ssh-agent<span class="w"> </span>-s<span class="k">)</span>
ssh-add<span class="w"> </span>~/.ssh/id_rsa
ssh-add<span class="w"> </span>-L<span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.ssh/authorized_keys
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Temporary SSH key for deployment</p>
<p>You should delete this public / private key pair once you're done installing Wazuh. It's only available on the server, so it's not a huge risk, but should not be left behind.</p>
</div>
<p>Execute with</p>
<div class="highlight"><pre><span></span><code>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.yaml<span class="w"> </span>-v<span class="w"> </span>./wazuh-single.yml
</code></pre></div>
<hr />
<h4 id="deploy-agents_1">📦 Deploy Agents</h4>
<div class="admonition info">
<p class="admonition-title">Tailnet connections</p>
<p>Your endpoints should already be enrolled, or get unrolled, before the wazuh-agent is installed so it can reach the wazuh-manager.</p>
</div>
<p><code>cd</code> into the project folder and edit the <code>wazuh-agent.yml</code> playbook.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>playbooks
nano<span class="w"> </span>wazuh-agent.yml
</code></pre></div>
<p>Replace <code>hosts:</code> with either the keyword <code>localhost</code> to run locally or create a group name to reference in an inventory file. Replace <code>address:</code> with your Wazuh manager's Tailnet IP.</p>
<div class="highlight"><pre><span></span><code>---
- hosts: tailnet_group
  become: yes
  become_user: root
  roles:
    - ../roles/wazuh/ansible-wazuh-agent
  vars:
    wazuh_managers:
      - address: &lt;your Wazuh manager&#39;s Tailnet IP&gt;
        port: 1514
        protocol: tcp
        api_port: 55000
        api_proto: &#39;https&#39;
        api_user: wazuh
        max_retries: 5
        retry_interval: 5
</code></pre></div>
<p>We'll use an inventory file, assuming you may want to deploy the agent on a number of endpoints.</p>
<ul>
<li><code>tailnet_group</code> is the group name we came up with for these hosts</li>
<li>All you need is the tailnet IP of the endpoint</li>
<li>We'll be authenticating and running as root to avoid having to create a vault with sudo passwords for each endpoint</li>
<li><code>/root/.ssh/authorized_keys</code> must have a public key to access your connection</li>
</ul>
<div class="highlight"><pre><span></span><code>tailnet_group:
  hosts:
    172.16.20.20:
      ansible_port: 22
      ansible_user: user
    172.16.20.21:
      ansible_port: 22
      ansible_user: server
&lt;SNIP&gt;
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Windows Endpoints</p>
<p>You effectively have two options for opening Windows endpoints to Ansible provisioning:</p>
<ul>
<li>WinRM (Domain-Joined, ideally with Kerberos auth)</li>
<li>🌐 <a href="https://github.com/straysheep-dev/windows-configs/blob/main/Manage-OpenSSHServer.ps1">SSH (Best for non-domain-joined endpoints)</a></li>
</ul>
<p>First, change the playbook to support the become method <code>runas</code>, and specify an admin user.</p>
<div class="highlight"><pre><span></span><code>- hosts: tailnet_group
  become: yes
  become_user: admin
  become_method: runas
  &lt;SNIP&gt;
</code></pre></div>
<p>Next, update your <code>inventory.yml</code> file by appending the following options to your Windows endpoints:</p>
<ul>
<li><code>cmd</code> is the default shell for SSH on Windows</li>
<li>Change this to <code>powershell</code> if you've defined PowerShell as the default login shell</li>
<li>Ensure <code>C:\Temp</code> exists, or specify a different temp directory</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="na">&lt;SNIP&gt;</span>
<span class="w">  </span><span class="na">vars</span><span class="o">:</span>
<span class="w">    </span><span class="na">ansible_port</span><span class="o">:</span><span class="w"> </span><span class="s">22</span>
<span class="w">    </span><span class="na">ansible_user</span><span class="o">:</span><span class="w"> </span><span class="s">admin</span>
<span class="w">    </span><span class="na">ansible_connection</span><span class="o">:</span><span class="w"> </span><span class="s">ssh</span>
<span class="w">    </span><span class="na">ansible_shell_type</span><span class="o">:</span><span class="w"> </span><span class="s">cmd</span>
<span class="w">    </span><span class="na">become_method</span><span class="o">:</span><span class="w"> </span><span class="s">runas</span>
<span class="w">    </span><span class="na">shell_type</span><span class="o">:</span><span class="w"> </span><span class="s">cmd</span>
<span class="w">    </span><span class="na">remote_tmp</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;C:\Temp\ansible&quot;</span>
<span class="na">&lt;SNIP&gt;</span>
</code></pre></div>
<p>See the following references:</p>
<ul>
<li>🌐 <a href="https://devops.stackexchange.com/questions/16532/ansible-playbook-fails-on-windows-server">Ansible Playbook Fails on Windows</a></li>
<li>🌐 <a href="https://stackoverflow.com/questions/66671945/ansible-playbook-error-the-powershell-shell-family-is-incompatible-with-the-sud">Ansible Playbook Become Error</a></li>
</ul>
</div>
<p>Execute with:</p>
<div class="highlight"><pre><span></span><code>~/.local/bin/ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.ini<span class="w"> </span>-b<span class="w"> </span>-v<span class="w"> </span>./wazuh-agent.yml
</code></pre></div>
<hr />
<h3 id="docker">Docker</h3>
<p><em>⚠️ TO DO: This section is still under construction, check back later! ⚠️</em></p>
<hr />
<h2 id="disk-usage">Disk Usage</h2>
<p><em>⚠️ TO DO: This section is still under construction, check back later! ⚠️</em></p>
<p>Paths that will contain a large amount of data:</p>
<ul>
<li><code>/var/ossec/queue/vd/feed</code> Vulnerability data, set a retention policy in <code>vulnerability-detection</code> of <code>ossec.conf</code> on the manager</li>
<li><code>/var/ossec/logs</code> Logs from your endpoints</li>
</ul>
<hr />
<h2 id="central-management">Central Management</h2>
<p><em>⚠️ TO DO: This section is still under construction, check back later! ⚠️</em></p>
<p><a href="https://documentation.wazuh.com/current/user-manual/reference/centralized-configuration.html">Wazuh User Manual: Central Configuration</a></p>
<ul>
<li>Config per OS?</li>
<li>Multiple config templates?</li>
</ul>
<hr />
<h2 id="ingesting-logs">Ingesting Logs</h2>
<p><em>For reference, the post from Wazuh's blog below is a great starting point for auditd, sysmon, sysmonforlinux, and a repo to use for custom decoders and rules.</em></p>
<ul>
<li>🌐 <a href="https://wazuh.com/blog/detecting-sysjoker-backdoor-malware-with-wazuh/">Detecting the SysJoker malware with Wazuh</a></li>
<li>🌐 <a href="https://github.com/socfortress/Wazuh-Rules">github/socfortress/Wazuh-Rules</a></li>
</ul>
<div class="admonition info">
<p class="admonition-title">The 3 Components</p>
<p>What can be confusing at first, is "what exactly do I need to start ingesting and seeing log data into my Wazuh instance?".</p>
<p>This requires 3 essential pieces:</p>
<ul>
<li>Logging configuration: This includs config.xml (sysmon) or audit.rules (auditd)</li>
<li>Wazuh decoder file: Wazuh uses this file to interpret the log data, (e.g. sysmon and auditd data are very different) basically, you need a custom decoder</li>
<li>Wazuh rule file: This tells Wazuh what to do with the data, how to classify it's severity and whether to show it at all</li>
</ul>
<p>If this seems overwhelming don't worry, this blog exists to overcome this jump by detailing exactly what you can "leave as a default" and what you can maintain.</p>
<p><strong>The goal is to get the data generated by your existing logging configurations to appear in Wazuh and be actionable while still maintainable.</strong></p>
<p>At first glance in the Wazuh docs, configuring auditd rules to fire is daunting, and basically requires you to now maintain new keys in your config, or potentially even rewrite it to work with Wazuh rules in this way. Fortunately, and <strong>largely thanks to the SOCFortress files</strong>, it's not like that anymore using these "general" decoder and rule files, and Wazuh does a lot of heavy lifting using these components out of the box now.</p>
</div>
<h3 id="sysmon">Sysmon</h3>
<p>Get started with one of the following configuration options:</p>
<ul>
<li>🌐 <a href="https://github.com/SwiftOnSecurity/sysmon-config">github.com/SwiftOnSecurity/sysmon-config</a></li>
<li>🌐 <a href="https://github.com/Neo23x0/sysmon-config">github.com/Neo23x0/sysmon-config</a>, a more up to date fork</li>
<li>🌐 <a href="https://github.com/olafhartong/sysmon-modular">github.com/olafhartong/sysmon-modular</a>, more advanced and requires tuning</li>
</ul>
<p><em><strong>NOTE</strong>: Neo23x0's version is recommended.</em></p>
<p>On the endpoint:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$url_list</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s2">&quot;https://github.com/Neo23x0/sysmon-config/raw/master/sysmonconfig-export.xml&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://live.sysinternals.com/Sysmon64.exe&quot;</span>
    <span class="p">)</span>

<span class="c"># Only check the config file, Sysmon is signed by Microsoft, can be reviewed with sigcheck64.exe</span>
<span class="nv">$sha256_list</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="s2">&quot;6625BDD777DDC230730EBA628607F4B99123A011ED5B4AE91C20A264AC2DA3B9&quot;</span>
    <span class="p">)</span>

<span class="nb">cd </span><span class="nv">$env:TEMP</span>
<span class="nv">$progressPreference</span> <span class="p">=</span> <span class="s1">&#39;silentlyContinue&#39;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$url</span> <span class="k">in</span> <span class="nv">$url_list</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$basename</span> <span class="p">=</span> <span class="nb">Split-Path</span> <span class="n">-Path</span> <span class="nv">$url</span> <span class="n">-Leaf</span>
    <span class="nb">iwr </span><span class="n">-Uri</span> <span class="s2">&quot;$url&quot;</span> <span class="n">-OutFile</span> <span class="nv">$basename</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(!(</span><span class="nb">get-filehash</span> <span class="n">sysmonconfig-export</span><span class="p">.</span><span class="n">xml</span> <span class="p">|</span> <span class="nb">sls </span><span class="nv">$sha256_list</span><span class="p">))</span>
<span class="p">{</span>
    <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">RED</span> <span class="s2">&quot;[WARNING]SHA256 mismatch $basename&quot;</span>
<span class="p">}</span> <span class="k">else</span>
<span class="p">{</span>
    <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span> <span class="s2">&quot;[OK]SHA256SUM $basename&quot;</span>
<span class="p">}</span>

<span class="c"># Install Sysmon with config file</span>
<span class="p">.\</span><span class="n">Sysmon64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-accepteula</span> <span class="n">-i</span> <span class="n">sysmonconfig-export</span><span class="p">.</span><span class="n">xml</span>

<span class="c"># Configure wazuh-agent to ship Sysmon events to the manager</span>
<span class="nv">$configuration_text</span> <span class="p">=</span> <span class="s2">&quot;</span>
<span class="s2">&lt;ossec_config&gt;</span>
<span class="s2">  &lt;localfile&gt;</span>
<span class="s2">    &lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;</span>
<span class="s2">    &lt;log_format&gt;eventchannel&lt;/log_format&gt;</span>
<span class="s2">  &lt;/localfile&gt;</span>
<span class="s2">&lt;/ossec_config&gt;</span>
<span class="s2">&quot;</span>

<span class="nb">echo </span><span class="nv">$configuration_text</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="s2">&quot;C:\Program Files (x86)\ossec-agent\ossec.conf&quot;</span> <span class="n">-Encoding</span> <span class="n">ASCII</span> <span class="n">-Append</span>
<span class="nb">Restart-Service</span> <span class="n">WazuhSvc</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Manage-Sysinternals.ps1</p>
<p>There's also <a href="https://github.com/straysheep-dev/windows-configs/blob/main/Manage-Sysinternals.ps1">my PowerShell script</a> that will automatically download a pinned version of SwiftOnSecurity's sysmon-config.xml, Sysmon itself (as well as any other Sysinternals tools you select) and install it all for you under <code>C:\Tools</code>.</p>
</div>
<hr />
<h3 id="sysmonforlinux">SysmonForLinux</h3>
<p><em>The blog post uses config files from the <a href="https://github.com/socfortress/Wazuh-Rules">https://github.com/socfortress/Wazuh-Rules</a> repo, so you should fork it and use them in your own infrastructure.</em></p>
<p>These steps use hard-coded hashes. If the hash changes, go to the source (ideally your fork) and check what changed.</p>
<p><strong>Get the Sysmon config, Wazuh rules, and Wazuh decoder file.</strong></p>
<p>On the endpoint:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/tmp
curl<span class="w"> </span>-LfO<span class="w"> </span><span class="s1">&#39;https://wazuh.com/resources/blog/detecting-sysjoker-backdoor-malware-with-wazuh/sysmonforlinux-config.xml&#39;</span>
sha256sum<span class="w"> </span>./sysmonforlinux-config.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;\bca8a78c13ade0acc6778c9ed100e4ca5e073403ba6ad208d44f69b5bdbcfe222\b&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARNING]checksum error.&quot;</span>
sudo<span class="w"> </span>sysmon<span class="w"> </span>-c<span class="w"> </span>./sysmonforlinux-config.xml
</code></pre></div>
<p>One the server:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/src
<span class="nv">url_list</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">https://wazuh.com/resources/blog/detecting-sysjoker-backdoor-malware-with-wazuh/sysmonforlinux-config.xml</span>
<span class="s1">https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Sysmon%20Linux/decoder-linux-sysmon.xml</span>
<span class="s1">https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Sysmon%20Linux/200150-sysmon_for_linux_rules.xml</span>
<span class="s1">&#39;</span>
<span class="k">for</span><span class="w"> </span>url<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$url_list</span>
<span class="k">do</span>
<span class="w">    </span>curl<span class="w"> </span>-LfO<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$url</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="nv">sha256sums</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">ca8a78c13ade0acc6778c9ed100e4ca5e073403ba6ad208d44f69b5bdbcfe222</span>
<span class="s1">0ed99f58c051fe5d042bb934988ca1914e89d66fd91653ff607eb50987f1f2e8</span>
<span class="s1">34b07aa25e37c65d968f90b667ca38514f27a7c7fac93a277ef5a332877aa4ce</span>
<span class="s1">&#39;</span>

<span class="k">for</span><span class="w"> </span>hash_value<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$sha256sums</span>
<span class="k">do</span>
<span class="w">    </span>sha256sum<span class="w"> </span>./*.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;\b</span><span class="nv">$hash_value</span><span class="s2">\b&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARNING]checksum error.&quot;</span>
<span class="k">done</span>

<span class="c1"># Necessary decoder and rule files</span>
cat<span class="w"> </span>decoder-linux-sysmon.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/var/ossec/etc/decoders/local_decoder.xml<span class="w"> </span>&gt;/dev/null
cat<span class="w"> </span><span class="m">200150</span>-sysmon_for_linux_rules.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/var/ossec/etc/rules/local_rules.xml<span class="w"> </span>&gt;/dev/null

<span class="c1"># If you want the same sysmon config running on the Wazuh server</span>
sudo<span class="w"> </span>sysmon<span class="w"> </span>-c<span class="w"> </span>./sysmonforlinux-config.xml

systemctl<span class="w"> </span>restart<span class="w"> </span>wazuh-manager
</code></pre></div></p>
<p><strong>📝 Explanation</strong></p>
<div class="admonition info">
<p class="admonition-title">1. ENDPOINT: <a href="https://github.com/straysheep-dev/ansible-configs/tree/main/install_sysmon">Install <code>sysmonforlinx</code></a> + this <a href="https://wazuh.com/resources/blog/detecting-sysjoker-backdoor-malware-with-wazuh/sysmonforlinux-config.xml">config.xml</a>)</p>
<ul>
<li>This config.xml works well with Wazuh, as it uses exclude rules to "see" everything, allowing Wazuh full visibility, while preventing Wazuh agent operations from flooding the logs</li>
<li>You will likely need at least the ProcessCreate filters from this file if you plan to use your own config, to prevent your logs from being overrun</li>
<li><code>ca8a78c13ade0acc6778c9ed100e4ca5e073403ba6ad208d44f69b5bdbcfe222  sysmonforlinux-config.xml</code></li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">2. WAZUH NODE: Install the <a href="https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Sysmon%20Linux/decoder-linux-sysmon.xml">decoder file</a> so Wazuh can \"read\" Sysmon logs</p>
<ul>
<li>The Wazuh blog and socfortress GitHub contain the exact same decoder file, the blog's copy just has CRLF line endings.</li>
<li><code>0ed99f58c051fe5d042bb934988ca1914e89d66fd91653ff607eb50987f1f2e8  decoder-linux-sysmon.xml</code></li>
<li><code>cat decoder-linux-sysmon.xml | sudo tee -a /var/ossec/etc/decoders/local_decoder.xml &gt;/dev/null</code></li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">3. WAZUH NODE: Next you need the <a href="https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Sysmon%20Linux/200150-sysmon_for_linux_rules.xml">rule file</a>, so Wazuh understands Sysmon event IDs in a general sense.</p>
<ul>
<li>Similar to the decoder file, the blog vs socfortress source file for Wazuh rules are virtuall the same (explore the diff in VSCode) just some lines swapped, and one bottom section added</li>
<li><code>34b07aa25e37c65d968f90b667ca38514f27a7c7fac93a277ef5a332877aa4ce  200150-sysmon_for_linux_rules.xml</code></li>
<li><code>cat 200150-sysmon_for_linux_rules.xml | sudo tee -a /var/ossec/etc/rules/local_rules.xml &gt;/dev/null</code></li>
</ul>
</div>
<p>This can seem confusing with three separate files for one monitoring scenario, so to reiterate:</p>
<ul>
<li>Each endpoint has it's own logging config, whether this is auditd rules, or Sysmon config.xml, maintain those how you have been (the Sysmon config from the blog is recommneded if you're just starting)</li>
<li>Wazuh needs a decoder written to interpret any logs, it includes some by default but I've found in many cases you need a custom decoder to work with existing audit.rules and sysmon config.xml files</li>
<li>The Wazuh rules file, tells Wazuh what and how to alert<ul>
<li>The SOCFortress Wazuh rules file above can "see" every event your agent ships to Wazuh, and sets each event ID to <code>level=3</code> by default, so they will ALL appear in your Wazuh dashboard logs</li>
<li>This is how you start from scratch, tune from here</li>
<li>Build more specific changes over time as necessary, this can be to your sysmon config.xml, the Wazuh rules, or even just learning how to write good DQL queries for your environment</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">On Rule Writing</p>
<p>The blog post writes / appends unique detections for the sysjoker malware to the <code>/var/ossec/etc/rules/local_rules.xml</code> on the Wazuh manager's end. This is a fairly advanced and complex route to take. You do not <em>need</em> to write rules this way as mentioned above just to get started. Trying to start this way is overwhelming, remember, the goal instead is to use the SOCFortress rules / decoder files to get all of your existing audit.rules and sysmon config.xml data into visible logs on Wazuh's dashboard while keeping them maintainable.</p>
</div>
<hr />
<h3 id="auditd">auditd</h3>
<p>You will again need three components:</p>
<ul>
<li>🌐 <a href="https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Auditd/auditd_decoders.xml">Decoder file (for Wazuh server)</a><ul>
<li><code>2a37823495de90ccb54181e4b853e35bafed074a0e464666ec186c79826387ac  auditd_decoders.xml</code></li>
</ul>
</li>
<li>🌐 <a href="https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Auditd/200110-auditd.xml">Rules file (for Wazuh server)</a><ul>
<li><code>3514afbc4fd081318aeea971065e54fc067c6e5243f835a44b6a1aba98680d8e  200110-auditd.xml</code></li>
</ul>
</li>
<li>Auditd Configuration (for Endpoint)<ul>
<li>🌐 <a href="https://github.com/Neo23x0/auditd/blob/master/audit.rules">github/Neo23x0/auditd</a></li>
<li>🌐 <a href="https://github.com/straysheep-dev/auditd/blob/master/40-mitre.rules">github/straysheep-dev/auditd</a> (my fork)</li>
<li>🌐 <a href="https://github.com/socfortress/Wazuh-Rules/blob/main/Auditd/auditd.conf">github/socfortress/Wazuh-Rule</a> (SOCFortress fork)</li>
</ul>
</li>
</ul>
<p>All of these things will work fine out of the box.</p>
<div class="admonition tip">
<p class="admonition-title">Auditd Keys</p>
<p>The most useful component to reviewing your logs after applying these changes is making sure all of your rules have <a href="https://github.com/linux-audit/audit-userspace/blob/e5b0c9d74a54e0c6c83ba402807a53e4544b7898/docs/audit.rules.7#L151">keys (<code>man audit.rules</code>)</a> associated with them. Even without a specific Wazuh rule for each key, the SOCFortress decoder file allows you to visualize and search logs based on the key you've asigned each rule in your own audit.rules file(s).</p>
</div>
<p>Use whatever means of <a href="https://github.com/straysheep-dev/ansible-configs/tree/main/install_auditd">deploying <code>auditd</code> itself and a configuration</a>. Regardless of which way you do this, this line should be included somewhere in your auditd configuration to filter out the Wazuh agent's behavior which could flood the logs. You could even write this to it's own <code>40-wazuh.rules</code> file:</p>
<div class="highlight"><pre><span></span><code>## Ignore Wazuh endpoint agent
-a always,exclude -F gid=wazuh  # from SocFortress config: https://github.com/socfortress/Wazuh-Rules/tree/main/Auditd
</code></pre></div>
<p>Install everything on the Wazuh Server:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/src
<span class="nv">url_list</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Auditd/auditd_decoders.xml</span>
<span class="s1">https://raw.githubusercontent.com/socfortress/Wazuh-Rules/main/Auditd/200110-auditd.xml</span>
<span class="s1">&#39;</span>
<span class="k">for</span><span class="w"> </span>url<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$url_list</span>
<span class="k">do</span>
<span class="w">    </span>curl<span class="w"> </span>-LfO<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$url</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="nv">sha256sums</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">2a37823495de90ccb54181e4b853e35bafed074a0e464666ec186c79826387ac</span>
<span class="s1">3514afbc4fd081318aeea971065e54fc067c6e5243f835a44b6a1aba98680d8e</span>
<span class="s1">&#39;</span>

<span class="k">for</span><span class="w"> </span>hash_value<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$sha256sums</span>
<span class="k">do</span>
<span class="w">    </span>sha256sum<span class="w"> </span>./*.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;\b</span><span class="nv">$hash_value</span><span class="s2">\b&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARNING]checksum error.&quot;</span>
<span class="k">done</span>

<span class="c1"># Necessary decoder and rule files</span>
cat<span class="w"> </span>auditd_decoders.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/var/ossec/etc/decoders/local_decoder.xml<span class="w"> </span>&gt;/dev/null
cat<span class="w"> </span><span class="m">200110</span>-auditd.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/var/ossec/etc/rules/local_rules.xml<span class="w"> </span>&gt;/dev/null

<span class="c1">#systemctl restart wazuh-manager</span>
</code></pre></div>
<p>Finally, you'll need to exclude Wazuh's built-in auditd decoders and rules by adding the following lines:</p>
<ul>
<li><code>&lt;decoder_exclude&gt;ruleset/decoders/0040-auditd_decoders.xml&lt;/decoder_exclude&gt;</code></li>
<li><code>&lt;rule_exclude&gt;0365-auditd_rules.xml&lt;/rule_exclude&gt;</code></li>
</ul>
<p>To <code>/var/ossec/etc/ossec.conf</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;SNIP&gt;</span>
<span class="w">  </span><span class="nt">&lt;ruleset&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Default ruleset --&gt;</span>
<span class="w">    </span><span class="nt">&lt;decoder_dir&gt;</span>ruleset/decoders<span class="nt">&lt;/decoder_dir&gt;</span>
<span class="w">    </span><span class="nt">&lt;decoder_exclude&gt;</span>ruleset/decoders/0040-auditd_decoders.xml<span class="nt">&lt;/decoder_exclude&gt;</span>
<span class="w">    </span><span class="nt">&lt;rule_dir&gt;</span>ruleset/rules<span class="nt">&lt;/rule_dir&gt;</span>
<span class="w">    </span><span class="nt">&lt;rule_exclude&gt;</span>0215-policy_rules.xml<span class="nt">&lt;/rule_exclude&gt;</span>
<span class="w">    </span><span class="nt">&lt;rule_exclude&gt;</span>0365-auditd_rules.xml<span class="nt">&lt;/rule_exclude&gt;</span>
<span class="nt">&lt;SNIP&gt;</span>
</code></pre></div>
<hr />
<h3 id="zeek">Zeek</h3>
<p><a href="https://documentation.wazuh.com/current/proof-of-concept-guide/integrate-network-ids-suricata.html">Documentation already exists for setting up and ingesting logs from Suricata on each endpoint</a>.</p>
<p>This section details doing the same using Zeek.</p>
<p><em>⚠️ TO DO: This section is still under construction, check back later! ⚠️</em></p>
<hr />
<h2 id="reviewing-logs">Reviewing Logs</h2>
<p><em>Now that data is coming in to your Wazuh dashboard, how do you sort through it?</em></p>
<h3 id="general">General</h3>
<p>No matter what you're searching for, filtering based on a minimum severity level is incredibly powerful:</p>
<div class="highlight"><pre><span></span><code>&lt;SNIP&gt; AND rule.level &gt; 3
</code></pre></div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_search_severity_level.png" /></p>
<div class="admonition info">
<p>This is a <a href="https://documentation.wazuh.com/current/proof-of-concept-guide/index.html">quick reference for modules built in to Wazuh</a> that you can keep in mind when thinking of "what" Wazuh has that you may want to search for.</p>
</div>
<p>These three groups are also built in components to Wazuh. They use the agent to perform premade checks and generate the logs. All three need to be configured (in other words enabled) to start generating logs, as detailed below.</p>
<ul>
<li><code>rule.groups:rootcheck</code> Display rootkit-check logs<ul>
<li>Add the <code>full_log</code> field in your columns</li>
<li>🌐 <a href="https://documentation.wazuh.com/current/proof-of-concept-guide/poc-detect-hidden-process.html#configuration">change the <code>&lt;freqency&gt;</code> of the check in each endpoint's /var/ossec/etc/ossec.conf</a></li>
</ul>
</li>
<li><code>rule.groups:syscheck</code> Display file integrity events<ul>
<li>You'll need to <a href="https://documentation.wazuh.com/current/proof-of-concept-guide/poc-file-integrity-monitoring.html#configuration">enable <code>check_all="yes" report_changes="yes" realtime="yes"</code> on each endpoint</a></li>
<li>Functions similar to AIDE but in real time</li>
</ul>
</li>
<li><code>rule.groups:suricata</code> Logs related to suricata NSM<ul>
<li>🌐 <a href="https://documentation.wazuh.com/current/proof-of-concept-guide/integrate-network-ids-suricata.html#configuration">suricata needs to be installed and configured on each enpoint</a></li>
</ul>
</li>
</ul>
<p>Use the DQL search bar when viewing an agent's events to search for <code>rule.groups:rootcheck</code> or <code>rule.groups:suricata</code>.</p>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_event_search.png" /></p>
<hr />
<h3 id="sysmon_1">Sysmon</h3>
<p>If you're using Wazuh's own default <a href="https://wazuh.com/resources/blog/detecting-sysjoker-backdoor-malware-with-wazuh/sysmonforlinux-config.xml">"collect most everything" Sysmon config</a>, you could start by filtering out some noise:</p>
<div class="highlight"><pre><span></span><code>(NOT data.system.eventId:5 AND NOT data.eventdata.image:/usr/bin/dash)
</code></pre></div>
<p>Look for failed login, auth, or escalation attempts:</p>
<div class="highlight"><pre><span></span><code>(NOT data.system.eventId:5 AND NOT data.eventdata.image:/usr/bin/dash) AND location:/var/log/auth.log AND rule.description:*ailed*
</code></pre></div>
<p>Look for <code>sudo</code> usage:</p>
<ul>
<li>Add <code>data.eventdata.commandLine</code> to your columns</li>
</ul>
<div class="highlight"><pre><span></span><code>(data.eventdata.commandLine:*sudo*)
</code></pre></div>
<p>Using <code>Event ID 3: Network connection</code>, add the following fields to the visible columns:</p>
<ul>
<li><code>data.eventdata.destinationHostname</code></li>
<li><code>data.eventdata.DestinationIp</code></li>
<li><code>data.eventdata.destinationPort</code></li>
</ul>
<p>Using what you know about the system, slowly eliminate common binaries used for networking based on what you see in the logs, such as the DNS daemon, tailscaled, apt, NetworkManger, snapd, and so on.</p>
<div class="highlight"><pre><span></span><code>(data.system.eventId:3)
(data.system.eventId:3 AND NOT data.eventdata.image:/usr/sbin/unbound)
(data.system.eventId:3 AND NOT data.eventdata.image:/usr/sbin/unbound AND NOT data.eventdata.image:/usr/sbin/tailscaled)

&lt;SNIP&gt;

(data.system.eventId:3 AND NOT data.eventdata.image:/usr/sbin/unbound AND NOT data.eventdata.image:/usr/sbin/tailscaled AND NOT data.eventdata.image:*NetworkManager AND NOT data.eventdata.image:/usr/lib/apt/methods/http AND NOT data.eventdata.image:/usr/lib/snapd/snapd)
</code></pre></div>
<p>Look for weird destination ports from common network processes:</p>
<ul>
<li>Unbound should only contact certain destination addresses</li>
<li>It should only reach them on ports tcp/853 or udp+tcp/53</li>
</ul>
<div class="highlight"><pre><span></span><code>(data.system.eventId:3 AND data.eventdata.image:/usr/sbin/unbound AND NOT data.eventdata.destinationPort:853 AND NOT data.eventdata.destinationPort:53)
</code></pre></div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_sysmon_visualization.png" /></p>
<p>See what external hosts tailscaled is talking to and how often:</p>
<div class="highlight"><pre><span></span><code>(data.system.eventId:3 AND data.eventdata.image:*tailscaled AND NOT data.eventdata.DestinationIp:0.0.0.0 AND NOT data.eventdata.DestinationIp:100.* AND NOT data.eventdata.DestinationIp:127.* AND NOT data.eventdata.DestinationIp:10.* AND NOT data.eventdata.DestinationIp:192.168.*)
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Network Analysis and Anomaly Detection</p>
<p>Digging into the network activity is where you'll find things like beacons, and can potentially get this data into a pcap and pass it off to <a href="https://github.com/activecm/rita">RITA</a> for a deeper analysis.</p>
</div>
<p>If you walked through the queries in this section, you already can see where to get ideas for additional queries. The real trick is learning when you're digging too deep, and need to pivot to something else. This can be augmented by external alerting on special events, or even simply building really good queries tailored to your environment.</p>
<hr />
<h3 id="auditd_1">auditd</h3>
<p>You'll notice if your events page has the default columns (<code>Time</code>, <code>rule.description</code>, <code>rule.level</code>, and <code>rule.id</code>) You'll need to discern auditd log events by their type, such as SYSCALL, EXECVE, and so on.</p>
<p>It's helpful to add the following columns to your data display:</p>
<ul>
<li><code>data.audit.exe</code></li>
<li><code>data.audit.key</code></li>
</ul>
<p>So you can visualize what's being executed, and what key it relates to. The <code>full_log</code> field is way too large to show here, but with this information you can decide what to focus on while scrolling. <strong><em>You won't always turn up everything with a well crafted DQL query</em></strong>. This is important to remember, always try multiple methods to visualize and look for gaps.</p>
<p>Easily sort through your logs for keys like this:</p>
<div class="highlight"><pre><span></span><code>&quot;data.audit.key&quot;: &quot;T1033_System_User_Discovery&quot;
&quot;data.audit.key&quot;: &quot;T1219_Remote_Access_Software&quot;
</code></pre></div>
<p>Or by any string appearing in an audit log field (notice sometimes quotes work, and other times they don't):</p>
<div class="highlight"><pre><span></span><code>&quot;full_log&quot;: &quot;*/etc/shadow*&quot;
&quot;data.audit.exe&quot;:*gdb*
&quot;data.audit.exe&quot;:*python* AND data.auditd.key:network_connect_4
</code></pre></div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_auditd_visualization.png" /></p>
<p>Interestingly this trick does not work as you'd expect:</p>
<div class="highlight"><pre><span></span><code>&quot;full_log&quot;: &quot;*://*&quot;
</code></pre></div>
<p>If you have a key logging the <code>connect</code> syscall, you could instead try:</p>
<div class="highlight"><pre><span></span><code>data.audit.key:network_connect_4 OR data.audit.key:network_connect_6
</code></pre></div>
<p>Interestingly, even if <code>auditd</code> is set to enrich logs on the endpoint, Wazuh still receives the encoded entries. This means you'll get entries like:</p>
<div class="highlight"><pre><span></span><code>proctitle=746F756368002F7661722F6C6F672F61756469742F746D705F6469726563746F7279312F6D616C776172652E7079
</code></pre></div>
<p>To decode them, you'll need to use <code>xxd</code>. Credit to <a href="https://archive.org/details/HalLinuxForensics">Hal Pomeranz</a> for showing the full <code>tr</code> command as well during <a href="https://wildwesthackinfest.com/about-us/">WWHF</a>.</p>
<div class="highlight"><pre><span></span><code>└─$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;746F756368002F7661722F6C6F672F61756469742F746D705F6469726563746F7279312F6D616C776172652E7079&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xxd<span class="w"> </span>-r<span class="w"> </span>-p<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="se">\\</span><span class="m">000</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
touch<span class="w"> </span>/var/log/audit/tmp_directory1/malware.py
</code></pre></div>
<hr />
<h3 id="data-visualization">Data Visualization</h3>
<p>On the left of the events are all of the fields available to search. Clicking on one reveals these are being tracked and graphed.</p>
<p>To see a graph of <em>all</em> logs based on keys, click <code>Visualize</code> (and delete any DQL query from the serch bar) to see all logs sorted by keys.</p>
<div class="admonition tip">
<p class="admonition-title">Changing the X and Y Axes</p>
<p>It may be easier to read by going to "Metrics &amp; axes", and changing the X-axes to LEFT, then Y-axes to TOP, and clicking <code>&gt; Update</code> so you can read the key names on the LEFT.*</p>
</div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_tailscale_graph_view.png" /></p>
<hr />
<h2 id="external-alerting">External Alerting</h2>
<p>External alerting can be incredibly useful. Defining events of the highest severity to be alerted over an email, text, or some external channel like Slack or Discord can give you the heads up necessary to respond instead of react during an incident.</p>
<div class="admonition abstract">
<p class="admonition-title">Wazuh Custom Integrations</p>
<p>This section looks at the <a href="https://documentation.wazuh.com/current/user-manual/manager/manual-integration.html#custom-integration">custom integration of third-party APIs</a>, and <a href="https://github.com/wazuh/wazuh/tree/master/integrations">their source code</a>, to port the <a href="https://github.com/wazuh/wazuh/blob/master/integrations/slack.py">Slack integration</a> to Discord. Examples of this <a href="https://github.com/eugenio-chaves/eugenio-chaves.github.io/blob/main/blog/2022/creating-a-custom-wazuh-integration/index.md#customizing-the-script">already</a> <a href="https://github.com/maikroservice/wazuh-integrations/blob/main/discord/custom-discord.py">exist</a>.</p>
<p><strong>It should also be noted, prior to publishing this post, an official integration has begun, see the <a href="https://github.com/wazuh/wazuh/pull/24446">pull-request here</a>! 🎉</strong></p>
<p>These make great points of reference to build and revise your own integration. However this port does a few things differently.</p>
<ul>
<li>Uses the existing <a href="https://github.com/wazuh/wazuh/blob/a5f51ad61af5abcf49186cd72d4d73c0c3927021/integrations/slack.py#L132">slack.py <code>generate_msg</code></a> function's code formatting with conditional fields</li>
<li>Adds conditional fields that will be included with certain Sysmon events</li>
<li>Includes the optional <a href="https://github.com/wazuh/wazuh/blob/a5f51ad61af5abcf49186cd72d4d73c0c3927021/integrations/shuffle.py#L166"><code>filter_msg</code> function from shuffle.py</a> to filter events if their rule ID matches any in <code>SKIP_RULE_IDS</code></li>
<li>Use conditional variables to handle arbitrary JSON structures</li>
</ul>
</div>
<p><img alt="" src="../../../../media/wazuh-tailscale/wazuh_integration_discord_3.png" /></p>
<div class="admonition info">
<p class="admonition-title"><strong>🚩 Getting Started</strong></p>
<p>We need a python script that doesn't exist yet to perform the actions. This is where referencing the other integrations will save a huge amount of time, and keep things consistent. This part can be overlooked if you haven't read <a href="https://wazuh.com/blog/how-to-integrate-external-software-using-integrator/">this post</a> before getting started.</p>
</div>
<p>All of the requirements in a list next to each other, will make this easier to understand.</p>
<ol>
<li>We need a python script to generate and send the alert</li>
<li>For Discord, of all the existing integrations, <a href="https://github.com/wazuh/wazuh/blob/master/integrations/slack.py">slack.py</a> is the closest starting point since they both use webhooks and similar data</li>
<li>These scripts can be narrow in scope in what they send, however we want a generic script that can be used for ANY type of alert<ul>
<li>General Wazuh logs and alerts, like rootkit detection and other module logs</li>
<li>Syslog, auditd</li>
<li>Sysmon, sysmonforlinux</li>
</ul>
</li>
<li>With this in mind, controlling when the script executes will primarily happen in the <code>&lt;integration&gt;</code> section of <code>/var/ossec/etc/ossec.conf</code><ul>
<li>Alert on events of a certain severity <code>&lt;level&gt;</code></li>
<li>Alert on a <code>&lt;group&gt;</code> filter (can be multiple, comma separated)</li>
<li>Alert on a <code>&lt;rule_id&gt;</code> filter (can be multiple, comma separated)</li>
<li>Alert on an <code>&lt;event_location&gt;</code> filter (can be multiple, comma separated)</li>
</ul>
</li>
<li>Integrations live under <code>/var/ossec/integrations</code> as two files:<ul>
<li><code>custom-discord</code> Every integration has this shell script, it's the same script for each integration, only the file name changes</li>
<li><code>custom-discord.py</code> The python script to create and send the alert to a platform of our choice (Discord)</li>
<li>Any custom integration must have a name beginning with "custom-"</li>
</ul>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Maintainability</p>
<p>Ultimately, this will give use something expandable that we don't need to constantly rewrite, because it can ingest multiple log and alert types. Thinking back to how ingesting logs requires three components (the logging conf like sysmon.xml or auditd.rules, a wazuh decoder, and a wazuh rule file), we want to only have to maintain the minumum number of pieces everywhere.</p>
</div>
<h3 id="python-script">Python Script</h3>
<p>From the existing <a href="https://github.com/wazuh/wazuh/blob/master/integrations/slack.py">slack.py</a> script, the majority of changes we'll need to make are in the <code>generate_msg()</code> function. We have a few options of how to do this, two of the best are either in plain text using content <code>{'content': '&lt;data&gt;'}</code>, or with embeds <code>{"embeds": [&lt;data&gt;]}"</code> to generate a rich content message.</p>
<hr />
<p><strong>🪺 Discord Embeds</strong></p>
<ul>
<li>🌐 <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks">Discord intro to webhooks</a></li>
<li>🌐 <a href="https://discord.com/safety/using-webhooks-and-embeds">Discord webhook / embed usage</a></li>
<li>🌐 <a href="https://discord.com/developers/docs/resources/channel#embed-object">Discord embed object structure</a></li>
<li>🌐 <a href="https://discord.com/developers/docs/resources/channel#embed-object-embed-field-structure">Discord embed field structure</a></li>
</ul>
<p>The structure of an embed is <code>{"embed": [data]}</code>, where in our case <code>data</code> is a JSON structured dictionary.</p>
<ul>
<li>🌐 <a href="https://github.com/wazuh/wazuh/blob/a5f51ad61af5abcf49186cd72d4d73c0c3927021/integrations/slack.py#L156">slack.py creates this structure already in <code>generate_msg</code> using <code>msg = {}</code></a></li>
<li>We can reuse the list of <code>msg['fields']</code> by changing the keys (<code>'title':</code> becomes <code>'name':</code>, also add a key for <code>'inline':</code>)</li>
<li>Finally update the object sent to the return value to be <code>{'embeds': [msg]}</code> instead of <code>{'attachments': [msg]}</code></li>
</ul>
<p><a href="https://discord.com/developers/docs/resources/channel#embed-object-embed-structure">Knowing the available fields in an embed</a>, we can update any other variables to match what Discord is expecting.</p>
<p>The start of our msg object will look like this:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Slack Version</label><label for="__tabbed_3_2">Discord Version</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;pretext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WAZUH Alert&#39;</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_log&#39;</span><span class="p">)</span>

    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rich&#39;</span> <span class="c1"># Discord specific, default type for embeds</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WAZUH Alert&#39;</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<p><strong>🟣 Discord Colors</strong></p>
<p>Discord colors take the <a href="https://discord.com/developers/docs/resources/channel#embed-object-embed-structure">decimal value of the color's hex code</a>. You can Google a color's hex code, open a calculator app in programming mode, set it to HEX mode, and paste the hex value. Change it to DEC mode to get the decimal representation of that hex code. That is the value to use here.</p>
<p>Here's an example of the color severity section.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Discord Version</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
    <span class="k">if</span> <span class="n">severity</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;255&#39;</span>      <span class="c1"># blue, hex value is #0000FF</span>
    <span class="k">elif</span> <span class="n">severity</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">severity</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;16776960&#39;</span> <span class="c1"># yellow, hex value is #FFFF00</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;16711680&#39;</span> <span class="c1"># red, hex value is #FF0000</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
<hr />
<p><strong>⚙️ Conditional Variables</strong></p>
<p>As mentioned previously, the modularity comes from the conditional values in this script. The slack.py version has an example that's incredibly similar to Ansible's <code>when:</code> conditional statements. This is how python works. Knowing this, we can create fail-safe variables to check if:</p>
<ul>
<li>A full "path" of key:value pairs is available</li>
<li>If not, then if another (default) "path" of key:value pairs is available</li>
<li>Else, 'N/A' (in some cases this is omitted since there will always be a value)</li>
</ul>
<p>Building from the Slack version's example, we can create variables for basically every field we would want to add to an alert.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Slack Version</label><label for="__tabbed_5_2">Discord Version</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">severity</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
<span class="n">description</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">agent_id</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">agent_name</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">rule_id</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">location</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
<span class="n">dest_ip</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">][</span><span class="s1">&#39;DestinationIp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;DestinationIp&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">dest_port</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">][</span><span class="s1">&#39;destinationPort&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;destinationPort&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">dest_host</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">][</span><span class="s1">&#39;destinationHostname&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;destinationHostname&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">src_ip</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">][</span><span class="s1">&#39;sourceIp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sourceIp&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">src_port</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">][</span><span class="s1">&#39;sourcePort&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sourcePort&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">full_log</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;full_log&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;full_log&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">win_message</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;win&#39;</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;system&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;win&#39;</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
<span class="n">log_id</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<p><strong>🛠️ Conditional Fields</strong></p>
<p>Finally, we can copy <a href="https://github.com/wazuh/wazuh/blob/a5f51ad61af5abcf49186cd72d4d73c0c3927021/integrations/slack.py#L163">what slack.py already does</a> to build additional conditional fields.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Slack Version</label><label for="__tabbed_6_2">Discord Version</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="k">if</span> <span class="s1">&#39;agentless&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">:</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Agentless Host&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;agentless&#39;</span><span class="p">][</span><span class="s1">&#39;host&#39;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># The &#39;if&#39; statements wrapping certain fields determine if a field exists in the log data, and if not, that</span>
<span class="c1"># field will be absent entirely in the embed rather than an empty field.</span>
<span class="c1"># Discord embeds can include up to 25 fields. &#39;inline&#39; means it will attempt to put neighboring fields into one line,</span>
<span class="c1"># up to three per row.</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Timestamp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
        <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;agent&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Agent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">) - </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;agentless&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Agentless Host&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">agentless</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Location&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">),</span>
        <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Rule ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> _(Level </span><span class="si">{1}</span><span class="s1">)_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule_id</span><span class="p">,</span> <span class="n">severity</span><span class="p">),</span>
        <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="c1"># The remaining fields have been formatted with a code block using one ` or three ``` backticks to prevent malicious strings from potentially</span>
<span class="c1"># making network requests or being clickable</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;DestinationIp&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Dest IP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;`</span><span class="si">{0}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_ip</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;destinationPort&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Dest Port&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;`</span><span class="si">{0}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_port</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;destinationHostname&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Dest Host&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;`</span><span class="si">{0}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_host</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sourceIp&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Source IP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;`</span><span class="si">{0}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_ip</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;eventdata&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sourcePort&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;eventdata&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Source Port&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;`</span><span class="si">{0}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_port</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;full_log&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Full Log&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;```</span><span class="si">{0}</span><span class="s1">```&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_log</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">alert</span> <span class="ow">and</span> <span class="s1">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;system&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;win&#39;</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">]:</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Message&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;```</span><span class="si">{0}</span><span class="s1">```&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">win_message</span><span class="p">),</span>
            <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Wazuh ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_id</span><span class="p">),</span>
        <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Discord Char Length Limitations</p>
<p>If you look at the <a href="https://github.com/wazuh/wazuh/pull/24446/files#diff-c1e0329772717b48b65b02ff1a95462fc0c267fbf6b4919b342d288f35a5fa84">integrations/discord.py</a> pull request, you'll notice <code>full_log</code> is under the <code>['description']</code> field of the Discord embed data. This is due to Discord's description field having a higher character limit (4096) than the <code>fields.value</code> field (1024). This will cause logs longer than 1024 chars to be dropped and never shipped to Discord!</p>
<p>In both cases you could ensure a limit on the field content with something like this:</p>
<div class="highlight"><pre><span></span><code><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;```</span><span class="si">{0}</span><span class="s1">```&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_log</span><span class="p">[:</span><span class="mi">4096</span><span class="p">]),</span>
</code></pre></div>
<p>Here the char limit for <code>description</code> is set so alerts are trimmed and not dropped.</p>
</div>
<hr />
<p><strong>🧪 Filtering Rule ID's</strong></p>
<p>This is optional and can exist as a list baked in to the script.</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="c1"># Rule filter</span>
<span class="c1"># This is just one additional place to fine tune what alerts are posted</span>
<span class="n">SKIP_RULE_IDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;00000&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
</code></pre></div>
<hr />
<p><strong>📜 Completed Script</strong></p>
<p>The full script is available <a href="https://github.com/straysheep-dev/alert-service/tree/main/wazuh-integrations">here</a>.</p>
<details class="tip">
<summary><strong>Accessing Nested Keys with <code>get(key, default=None)</code></strong></summary>
<p>Asking Google or ChatGPT what's the best way to access a nested dictionary in python, you'll find some examples of the <a href="https://docs.python.org/3/library/stdtypes.html#dict.get"><code>.get()</code> method</a>. This essentially does the same thing in a less verbose way.</p>
<ul>
<li>Traverses the dictionaries, returning the value for <code>key</code>, if it exists</li>
<li>Avoids the <a href="https://docs.python.org/3/library/exceptions.html#KeyError"><code>KeyError</code></a> without requiring a check, when a subsequent key does not exist within the data</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">severity</span> <span class="o">=</span> <span class="n">alert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">alert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">alert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_source&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This was included for future reference, but the "if" "else" style was used to match the style and readability of the original slack.py script.</p>
<p>References:</p>
<ul>
<li>🌐 <a href="https://stackoverflow.com/questions/10399614/accessing-value-inside-nested-dictionaries">Accessing nested keys</a></li>
<li>🌐 <a href="https://stackoverflow.com/questions/28225552/is-there-a-recursive-version-of-the-dict-get-built-in">Traversing varied dictionary structures with <code>.get()</code></a></li>
<li>🌐 <a href="https://stackoverflow.com/questions/11041405/why-dict-getkey-instead-of-dictkey">Using <code>dict.get('key')</code></a></li>
<li>🌐 <a href="https://docs.python.org/3/library/stdtypes.html#dict.get">Python Docs: <code>.get()</code> method</a></li>
<li>🌐 <a href="https://stackoverflow.com/questions/3965104/not-none-test-in-python">Python <code>None</code> test</a></li>
</ul>
</details>
<hr />
<p><strong>📝 Content</strong></p>
<div class="admonition info">
<p class="admonition-title">Ai Usage</p>
<p>ChatGPT helped debug the <code>str()</code> and trailing <code>+</code> to correctly format this block to appear how it looks below.</p>
</div>
<p>If you prefer not to use the <code>embed</code> object, this is an example using the same variables, but replacing the main block in <code>generate_msg</code> to send the <a href="https://discord.com/developers/docs/resources/webhook#execute-webhook-jsonform-params">plaintext <code>content</code> parameter of up to 2000 characters</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_msg</span><span class="p">(</span><span class="n">alert</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>

    <span class="c1"># To ensure formatting, each line must have a trailing `+` until the final line</span>
    <span class="c1"># Each variable must also be concatenated as a str() individually, instead of `&#39;content&#39;: str(...)`</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;=====[ Wazuh Alert ]=====&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Timestamp: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Log ID: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Agent ID: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Agent Name: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Severity: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">severity</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Rule ID: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rule_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Description: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Dest IP: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest_ip</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Dest Port: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest_port</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Dest Host: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest_host</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;- Full Log: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_log</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>🪲 Debugging</strong></p>
<p>You can run these scripts manually for debugging with the following line, where <code>test.json</code> is a single log entry (it does not have to be a single line, just one log entry though) for testing purposes.</p>
<ul>
<li>Before running it, change <code>LOG_FILE = f'{pwd}/logs/integrations.log'</code> to <code>LOG_FILE = f'integrations.log'</code></li>
</ul>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>./custom-discord.py<span class="w"> </span><span class="s1">&#39;test.json&#39;</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="s1">&#39;&lt;webhook&gt;&#39;</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span>
</code></pre></div>
<hr />
<h3 id="integration-block">Integration Block</h3>
<p>You'll need to append one or more <code>&lt;integration&gt;</code> sections to <code>/var/ossec/etc/ossec.conf</code>, that includes the integration name, webhook, and any filters or options.</p>
<p>This section can have multiple entries utilizing the same integration. The sample below is ready to use after modifying or removing the necessary values for your use case. It's written so you can append it directly to <code>ossec.conf</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;ossec_config&gt;</span>
<span class="w">  </span><span class="nt">&lt;integration&gt;</span>
<span class="w">      </span><span class="nt">&lt;name&gt;</span>custom-discord<span class="nt">&lt;/name&gt;</span>
<span class="w">      </span><span class="nt">&lt;hook_url&gt;</span>https://discord.com/api/webhooks/XXXXXXXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXX<span class="nt">&lt;/hook_url&gt;</span>
<span class="w">      </span><span class="nt">&lt;group&gt;</span>GROUP<span class="nt">&lt;/group&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with an optional comma separated list of groups or remove it --&gt;</span>
<span class="w">      </span><span class="nt">&lt;rule_id&gt;</span>RULE_ID<span class="nt">&lt;/rule_id&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with an optional comma separated list of rule ids or remove it --&gt;</span>
<span class="w">      </span><span class="nt">&lt;level&gt;</span>SEVERITY_LEVEL<span class="nt">&lt;/level&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with an optional minimum severity level or remove it --&gt;</span>
<span class="w">      </span><span class="nt">&lt;event_location&gt;</span>EVENT_LOCATION<span class="nt">&lt;/event_location&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with an optional comma separated list of event locations or remove it --&gt;</span>
<span class="w">      </span><span class="nt">&lt;alert_format&gt;</span>json<span class="nt">&lt;/alert_format&gt;</span>
<span class="w">      </span><span class="nt">&lt;options&gt;</span>JSON<span class="nt">&lt;/options&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with your custom JSON object or remove it --&gt;</span>
<span class="w">  </span><span class="nt">&lt;/integration&gt;</span>
<span class="w">  </span><span class="nt">&lt;integration&gt;</span>
<span class="w">      </span><span class="nt">&lt;name&gt;</span>custom-discord<span class="nt">&lt;/name&gt;</span>
<span class="w">      </span><span class="nt">&lt;hook_url&gt;</span>https://discord.com/api/webhooks/XXXXXXXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXX<span class="nt">&lt;/hook_url&gt;</span>
<span class="w">      </span><span class="nt">&lt;group&gt;</span>GROUP<span class="nt">&lt;/group&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Replace with an optional comma separated list of groups or remove it --&gt;</span>
<span class="w">      </span><span class="nt">&lt;alert_format&gt;</span>json<span class="nt">&lt;/alert_format&gt;</span>
<span class="w">  </span><span class="nt">&lt;/integration&gt;</span>
<span class="nt">&lt;/ossec_config&gt;</span>
</code></pre></div>
<hr />
<h2 id="maintenance">Maintenance</h2>
<div class="admonition info">
<p>With limited time and budget, you'll want to walk away knowing exactly what you'll want to maintain, meaning where to focus your efforts as your Wazuh instance lives and grows.</p>
</div>
<p>Huge thanks to Wazuh and SocFortress for the blog posts and configuration templates that do most of this heavy lifting. Because of this, 1) this post exists, and 2) you can focus on maintaining specific components without worrying about making sure changes to your logging conf are reflected in three other places for Wazuh to successfully ingest the information.</p>
<p>Components to maintain and when:</p>
<div class="admonition info">
<p class="admonition-title"><strong>Logging Configs</strong></p>
<ul>
<li>sysmon config.xml: You can start with the recommended config.xml file and do well. Over time you may want to start tailoring your own.</li>
<li>auditd.rules: Make sure every rule has a <code>key</code> value, the SocFortress decoder and rules will let you search in Wazuh based on the full_log as well as the auditd key</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title"><strong>wazuh-manager ossec.conf</strong></p>
<ul>
<li><code>&lt;integrations&gt;</code> section: Define what rules, groups, log locations, and / or log severity ships an alert or data to an external source</li>
<li>Maintain one block you deploy generally on all endpoints</li>
<li>Maintain blocks limited to specific agents</li>
<li>This can help you cut through the noise, and get a heads up on severe events</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title"><strong>wazuh-agent ossec.conf</strong></p>
<ul>
<li>Each endpoint may have varying configurations</li>
<li>File integrity monitoring, mainly adding <code>check_all="yes" report_changes="yes" realtime="yes"</code> to the two default directories if you want realtime monitoring</li>
<li>If you add a network IDS on the endpoint, tell the agent about it here as well</li>
<li>You can deploy this with a shell script or your own Ansible role as you learn what needs done on each endpoint in your environment</li>
</ul>
</div>
<hr />
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="wazuh-dashboard-server-is-not-ready-yet">Wazuh dashboard server is not ready yet</h3>
<div class="admonition quote">
<p class="admonition-title">Related Documentation</p>
<ul>
<li><a href="https://documentation.wazuh.com/current/upgrade-guide/troubleshooting.html#wazuh-dashboard-server-is-not-ready-yet">Wazuh Docs: Wazuh dashboard server is not ready yet</a></li>
<li><a href="https://github.com/wazuh/wazuh-indexer">GitHub: wazuh-indexer</a> (The wazuh-indexer is a customized fork of OpenSearch)</li>
<li><a href="https://github.com/wazuh/wazuh-dashboard">GitHub: wazuh-dashboard</a> (The wazuh-dashboard is a customized fork of OpenSearch's Dashboard)</li>
<li><a href="https://github.com/opensearch-project/OpenSearch-Dashboards/issues/4617">OpenSearch-Dashboards/issues/4617</a></li>
<li><a href="https://docs.opensearch.org/latest/api-reference/cluster-api/cluster-health/">OpenSearch Docs: Cluster API / Cluser Health</a></li>
<li><a href="https://docs.opensearch.org/2.15/upgrade-to/dashboards-upgrade-to/">OpenSearch Docs: Dashboard Upgrades</a></li>
</ul>
</div>
<div class="admonition bug">
<p class="admonition-title">Service Timeout</p>
<p>You may encounter this issue when trying to reach the web interface. Check <code>wazuh-indexer.service</code> first:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>wazuh-indexer
×<span class="w"> </span>wazuh-indexer.service<span class="w"> </span>-<span class="w"> </span>wazuh-indexer
<span class="w">    </span>Loaded:<span class="w"> </span>loaded<span class="w"> </span><span class="o">(</span>/lib/systemd/system/wazuh-indexer.service<span class="p">;</span><span class="w"> </span>enabled<span class="p">;</span><span class="w"> </span>vendor<span class="w"> </span>preset:<span class="w"> </span>enabled<span class="o">)</span>
<span class="w">    </span>Active:<span class="w"> </span>failed<span class="w"> </span><span class="o">(</span>Result:<span class="w"> </span>timeout<span class="o">)</span><span class="w"> </span>since<span class="w"> </span>Sat<span class="w"> </span><span class="m">2025</span>-03-02<span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>UTC<span class="p">;</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>days<span class="w"> </span>ago
<span class="w">    </span>Docs:<span class="w"> </span>https://documentation.wazuh.com
Main<span class="w"> </span>PID:<span class="w"> </span><span class="m">123</span><span class="w"> </span><span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited,<span class="w"> </span><span class="nv">status</span><span class="o">=</span><span class="m">143</span><span class="o">)</span>
<span class="w">        </span>CPU:<span class="w"> </span><span class="m">12</span>.345s

Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.bootstrap.OpenSearch.execute<span class="o">(</span>OpenSearch.java:172<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.cli.EnvironmentAwareCommand.execute<span class="o">(</span>EnvironmentAwareCommand.java:104<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.cli.Command.mainWithoutErrorHandling<span class="o">(</span>Command.java:138<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.cli.Command.main<span class="o">(</span>Command.java:101<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.bootstrap.OpenSearch.main<span class="o">(</span>OpenSearch.java:138<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd-entrypoint<span class="o">[</span><span class="m">123</span><span class="o">]</span>:<span class="w">         </span>at<span class="w"> </span>org.opensearch.bootstrap.OpenSearch.main<span class="o">(</span>OpenSearch.java:104<span class="o">)</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>wazuh-indexer.service:<span class="w"> </span>start<span class="w"> </span>operation<span class="w"> </span>timed<span class="w"> </span>out.<span class="w"> </span>Terminating.
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>wazuh-indexer.service:<span class="w"> </span>Failed<span class="w"> </span>with<span class="w"> </span>result<span class="w"> </span><span class="s1">&#39;timeout&#39;</span>.
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>wazuh-indexer.
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>wazuh-indexer.service:<span class="w"> </span>Consumed<span class="w"> </span><span class="m">12</span>.345s<span class="w"> </span>CPU<span class="w"> </span>time.
</code></pre></div>
<p>If you get the error above, try restarting the indexer on its own. Often restarting the manager, or the entire server will not resolve this, likely due to the timeout issue where it's not initializing fast enough.</p>
<p>Next you could try restarting the <code>wazuh-dashboard.service</code>. Be patient, if you see the error below, wait a minute or two and try to refresh the page. This error will happen when the dashboard is starting up, but hasn't connected to the indexer just yet.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>wazuh-dashboard
●<span class="w"> </span>wazuh-dashboard.service<span class="w"> </span>-<span class="w"> </span>wazuh-dashboard
<span class="w">    </span>Loaded:<span class="w"> </span>loaded<span class="w"> </span><span class="o">(</span>/etc/systemd/system/wazuh-dashboard.service<span class="p">;</span><span class="w"> </span>enabled<span class="p">;</span><span class="w"> </span>vendor<span class="w"> </span>preset:<span class="w"> </span>enabled<span class="o">)</span>
<span class="w">    </span>Active:<span class="w"> </span>active<span class="w"> </span><span class="o">(</span>running<span class="o">)</span><span class="w"> </span>since<span class="w"> </span>Tue<span class="w"> </span><span class="m">2025</span>-03-02<span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span>UTC<span class="p">;</span><span class="w"> </span>1min<span class="w"> </span>23s<span class="w"> </span>ago
Main<span class="w"> </span>PID:<span class="w"> </span><span class="m">12345</span><span class="w"> </span><span class="o">(</span>node<span class="o">)</span>
<span class="w">    </span>Tasks:<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">(</span>limit:<span class="w"> </span><span class="m">9348</span><span class="o">)</span>
<span class="w">    </span>Memory:<span class="w"> </span><span class="m">183</span>.2M
<span class="w">        </span>CPU:<span class="w"> </span><span class="m">12</span>.345s
<span class="w">    </span>CGroup:<span class="w"> </span>/system.slice/wazuh-dashboard.service
<span class="w">            </span>└─12345<span class="w"> </span>/usr/share/wazuh-dashboard/node/bin/node<span class="w"> </span>--no-warnings<span class="w"> </span>--max-http-header-size<span class="o">=</span><span class="m">65536</span><span class="w"> </span>--unhandled-rejections<span class="o">=</span>warn<span class="w"> </span>/usr/share/wazuh-dashboard/src/cli/dist

Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>opensearch-dashboards<span class="o">[</span><span class="m">12345</span><span class="o">]</span>:<span class="w"> </span><span class="o">{</span><span class="s2">&quot;type&quot;</span>:<span class="s2">&quot;log&quot;</span>,<span class="s2">&quot;@timestamp&quot;</span>:<span class="s2">&quot;2025-03-02T01:00:00Z&quot;</span>,<span class="s2">&quot;tags&quot;</span>:<span class="o">[</span><span class="s2">&quot;error&quot;</span>,<span class="s2">&quot;opensearch&quot;</span>,<span class="s2">&quot;data&quot;</span><span class="o">]</span>,<span class="s2">&quot;pid&quot;</span>:12345,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[search_phase_execution_exception]: all shards failed&quot;</span><span class="o">}</span>
Mar<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span>:02:01<span class="w"> </span>wazuh-server<span class="w"> </span>opensearch-dashboards<span class="o">[</span><span class="m">12345</span><span class="o">]</span>:<span class="w"> </span><span class="o">{</span><span class="s2">&quot;type&quot;</span>:<span class="s2">&quot;log&quot;</span>,<span class="s2">&quot;@timestamp&quot;</span>:<span class="s2">&quot;2025-03-02T01:00:00Z&quot;</span>,<span class="s2">&quot;tags&quot;</span>:<span class="o">[</span><span class="s2">&quot;error&quot;</span>,<span class="s2">&quot;opensearch&quot;</span>,<span class="s2">&quot;data&quot;</span><span class="o">]</span>,<span class="s2">&quot;pid&quot;</span>:12345,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[search_phase_execution_exception]: all shards failed&quot;</span><span class="o">}</span>
</code></pre></div>
<p>After a couple minutes the dashboard webpage should finally load.</p>
</div>
<div class="admonition bug">
<p class="admonition-title">Migration Failure</p>
<p>This can happen during upgrades if you're not following the <a href="https://documentation.wazuh.com/current/upgrade-guide/upgrading-central-components.html#wazuh-central-components">upgrade guide</a> which recommends <a href="https://documentation.wazuh.com/current/upgrade-guide/upgrading-central-components.html#preparing-the-wazuh-indexer-cluster-for-upgrade">disabling shard replication</a> on each indexer before upgrading them. Ideally this could be automated so it can run and then be validated after, however if you are simply doing some form of headless apt update + full-upgrade you can run into this issue leading to the dashboard not being able to load.</p>
<p>This process was put together after working with GPT5 (Thinking) to explore each option, and determine what worked in this unique instance. The Wazuh documentation for this error helps you find what's failing and where, but you'll have to know how to manually talk to the underlying components to really get anywhere.</p>
<p>These commands will help you gather the current 'state' of Wazuh at a high level, and hopefully point to what is failing and why.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Rule out connection issues</span>
curl<span class="w"> </span>-v<span class="w"> </span>telnet://&lt;WAZUH_INDEXER_IP_ADDRESS&gt;:9200

<span class="c1"># Dashboard status</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>wazuh-dashboard

<span class="c1"># Dashboard journal (can take a long time to render)</span>
sudo<span class="w"> </span>journalctl<span class="w"> </span>-u<span class="w"> </span>wazuh-dashboard<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;error|warn&quot;</span>
sudo<span class="w"> </span>journalctl<span class="w"> </span>-u<span class="w"> </span>wazuh-dashboard<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;error|warn&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail

<span class="c1"># Indexer status</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>wazuh-indexer

<span class="c1"># Indexer logs</span>
sudo<span class="w"> </span>cat<span class="w"> </span>/var/log/wazuh-indexer/&lt;WAZUH_INDEXER_CLUSTER_NAME&gt;.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;ERROR|WARN|Caused&quot;</span>
</code></pre></div>
<p>In my case, after reviewing the output of all the above commands, the final line in the output of <code>wazuh-dashboard</code>'s journal pointed to the solution:</p>
<div class="highlight"><pre><span></span><code># SNIP
Jan 01 05:22:47 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:22:47Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[search_phase_execution_exception]: all shards failed&quot;}
Jan 01 05:22:49 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:22:49Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[search_phase_execution_exception]: all shards failed&quot;}
Jan 01 05:22:52 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:22:52Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[search_phase_execution_exception]: all shards failed&quot;}
Jan 01 05:22:54 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:22:54Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[search_phase_execution_exception]: all shards failed&quot;}
Jan 01 05:22:57 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:22:57Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[search_phase_execution_exception]: all shards failed&quot;}
Jan 01 05:23:00 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:23:00Z&quot;,&quot;tags&quot;:[&quot;error&quot;,&quot;opensearch&quot;,&quot;data&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;[resource_already_exists_exception]: index [.kibana_3/&lt;string&gt;] already exists&quot;}
Jan 01 05:23:00 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:23:00Z&quot;,&quot;tags&quot;:[&quot;warning&quot;,&quot;savedobjects-service&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;Unable to connect to OpenSearch. Error: resource_already_exists_exception: [resource_already_exists_exception] Reason: index [.kibana_3/&lt;string&gt;] already exists&quot;}
Jan 01 05:23:00 wazuh-standalone opensearch-dashboards[123]: {&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2025-01-01T05:23:00Z&quot;,&quot;tags&quot;:[&quot;warning&quot;,&quot;savedobjects-service&quot;],&quot;pid&quot;:123,&quot;message&quot;:&quot;Another OpenSearch Dashboards instance appears to be migrating the index. Waiting for that migration to complete. If no other OpenSearch Dashboards instance is attempting migrations, you can get past this message by deleting index .kibana_3 and restarting OpenSearchDashboards.&quot;}
</code></pre></div>
<blockquote>
<p>If no other OpenSearch Dashboards instance is attempting migrations, you can get past this message by deleting index .kibana_3 and restarting OpenSearchDashboards."</p>
</blockquote>
<p><em>How</em> to do this, was suggested through numerous steps by GPT5. Ultimately this is exactly what was necessary to clear the "stuck" index of .kibana_3.</p>
<p>First SSH into your manager node, and set your username:password as a temporary environment variable hidden from your shell history.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Safely ingest your authentication information</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Enter Wazuh [username:password]&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-s<span class="w"> </span>wazuh_userpass<span class="p">;</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">WAZUH_USERPASS</span><span class="o">=</span><span class="nv">$wazuh_userpass</span>
</code></pre></div>
<p>Now you can start querying the cluster's health. This will point to any other obvious issues.</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-k<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WAZUH_USERPASS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>https://localhost:9200/_cluster/health?pretty
</code></pre></div>
<p>To clear <code>.kibana_3</code> (steps directly from GPT5):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Stop the dashboard service</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>wazuh-dashboard

<span class="c1"># Remove the .kibana_3 index called out in the indexer log</span>
curl<span class="w"> </span>-k<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WAZUH_USERPASS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span><span class="s1">&#39;https://localhost:9200/.kibana_3&#39;</span>

<span class="c1"># If present, also delete the paired task manager index generated for that generation:</span>
curl<span class="w"> </span>-k<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WAZUH_USERPASS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span><span class="s1">&#39;https://localhost:9200/.kibana_task_manager_3&#39;</span>

<span class="c1"># Restart the dashboard</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>wazuh-dashboard
</code></pre></div>
<p>This addresses the issue of a stuck index migration. You won't lose any log data, and while the dashboard is unavailable in this state, your Wazuh instance will still be functional and gathering logs / taking actions as normal in the background.</p>
</div>
<hr />
<h2 id="migrate-to-proxmox">Migrate to Proxmox</h2>
<p><em>This section mirrors what's mentioned under <a href="../simple-proxmox-proxmox/#migrating-vms">blog/Proxmox</a>. Be sure to check that post if you need to get started with proxmox first and for all related details.</em></p>
<p>Basically, it's fairly straight forward and easy to migrate even a large standalone Hyper-V VM to Proxmox. Keep this in mind if you plan to deploy it in "production" or require more space and a distributed Wazuh cluster.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2024 straysheep-dev
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/straysheep-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.path", "navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.path", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.tooltips"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>